<!--
    DORMANT FILE - NOT CURRENTLY IN USE
    Status: Dormant
    Reason: Backup version - superseded by current ver3
    Last Active: Working backup from 2025-09-21
    
    This is a backup version from September 21, 2025. The current
    active version is quote-maker-v2-ver3.html with latest features.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quote Maker v2 - Indian Natural Hair (BACKUP - DORMANT)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Custom Styles -->
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #081249 0%, #0a1555 100%);
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #081249 0%, #0a1555 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(8, 18, 73, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #081249;
            border: 2px solid #081249;
            padding: 10px 22px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #081249;
            color: white;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .quote-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .quote-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-draft {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-sent {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-accepted {
            background: #d1fae5;
            color: #065f46;
        }

        /* Action buttons */
        .action-btn {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
            font-size: 11px;
            gap: 6px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .action-btn-text {
            font-weight: 500;
            line-height: 1;
            white-space: nowrap;
        }

        .action-btn-icon {
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .action-btn-recall {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .action-btn-recall:hover {
            background: #eff6ff;
            border-color: #2563eb;
        }

        .action-btn-preview {
            border-color: #10b981;
            color: #10b981;
        }

        .action-btn-preview:hover {
            background: #ecfdf5;
            border-color: #059669;
        }

        .action-btn-delete {
            border-color: #ef4444;
            color: #ef4444;
        }

        .action-btn-delete:hover {
            background: #fef2f2;
            border-color: #dc2626;
        }

        .action-btn-convert {
            border-color: #8b5cf6;
            color: #8b5cf6;
        }

        .action-btn-convert:hover {
            background: #f5f3ff;
            border-color: #7c3aed;
        }

        /* Compact action buttons for saved quotes */
        .action-btn-compact {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px 6px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 24px;
            height: 24px;
            font-size: 10px;
        }

        .action-btn-compact:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .action-btn-compact.action-btn-recall {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .action-btn-compact.action-btn-recall:hover {
            background: #eff6ff;
            border-color: #2563eb;
        }

        .action-btn-compact.action-btn-preview {
            border-color: #10b981;
            color: #10b981;
        }

        .action-btn-compact.action-btn-preview:hover {
            background: #ecfdf5;
            border-color: #059669;
        }

        .action-btn-compact.action-btn-delete {
            border-color: #ef4444;
            color: #ef4444;
        }

        .action-btn-compact.action-btn-delete:hover {
            background: #fef2f2;
            border-color: #dc2626;
        }

        .action-btn-compact.action-btn-convert {
            border-color: #8b5cf6;
            color: #8b5cf6;
        }

        .action-btn-compact.action-btn-convert:hover {
            background: #f5f3ff;
            border-color: #7c3aed;
        }

        /* Enhanced tooltips for compact buttons */
        .action-btn-compact {
            position: relative;
        }

        .action-btn-compact::before {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            pointer-events: none;
            z-index: 1000;
            margin-bottom: 5px;
        }

        .action-btn-compact::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            pointer-events: none;
            z-index: 1000;
            margin-bottom: 1px;
        }

        .action-btn-compact:hover::before,
        .action-btn-compact:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Remove default browser tooltip */
        .action-btn-compact[title] {
            position: relative;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #e5e7eb;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold">Quote Maker v2</h1>
                </div>
                <div class="status-indicator" title="Firebase Connection Status">
                    <svg class="w-9 h-9 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M5.803 21.803l5.678-10.44L9.189 6.81l-3.386 14.993zm7.078-11.013L11.189 8.8l1.292-2.49L10.189 3.81l2.692 6.98zm3.908 8.15L14.481 8.8l2.308 10.14z"/>
                        <path d="M18.75 18.94L12 22.5l-6.75-3.56L12 2.5l6.75 16.44z" fill-opacity="0.3"/>
                    </svg>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            
            <!-- Quote Builder -->
            <div class="space-y-6">
                
                <!-- Quote Information -->
                <div class="card p-4">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800">Quote Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div>
                            <input type="text" id="quote-number" class="form-input" placeholder="Quote Number (Auto-generated)" readonly>
                        </div>
                        <div>
                            <input type="date" id="quote-date" class="form-input" placeholder="Date">
                        </div>
                        <div>
                            <select id="client-selector" class="form-select">
                                <option value="">Select Client</option>
                                <option value="add-new">+ Add New Client</option>
                            </select>
                        </div>
                        <div>
                            <select id="salesperson-selector" class="form-select">
                                <option value="">Select Salesperson</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Product Selection -->
                <div class="card p-4">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800">Add Products</h2>
                    
                    <!-- Price List and Currency -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                        <div>
                            <select id="price-list-selector" class="form-select">
                                <option value="">Select Price List</option>
                            </select>
                        </div>
                        <div>
                            <select id="currency-selector" class="form-select">
                                <option value="INR">INR (â‚¹)</option>
                                <option value="USD">USD ($)</option>
                                <option value="EUR">EUR (â‚¬)</option>
                                <option value="GBP">GBP (Â£)</option>
                                <option value="AUD">AUD (A$)</option>
                                <option value="AED">AED (Ø¯.Ø¥)</option>
                                <option value="NGN">NGN (â‚¦)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Product Selectors -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 mb-4">
                        <div>
                            <select id="category-selector" class="form-select" disabled>
                                <option value="">Category</option>
                            </select>
                        </div>
                        <div>
                            <select id="product-selector" class="form-select" disabled>
                                <option value="">Product</option>
                            </select>
                        </div>
                        <div>
                            <select id="density-selector" class="form-select" disabled>
                                <option value="">Density</option>
                            </select>
                        </div>
                        <div>
                            <select id="length-selector" class="form-select" disabled>
                                <option value="">Length</option>
                            </select>
                        </div>
                        <div>
                            <select id="color-type-selector" class="form-select" disabled>
                                <option value="">Color Type</option>
                            </select>
                        </div>
                        <div>
                            <select id="color-selector" class="form-select" disabled>
                                <option value="">Color</option>
                            </select>
                        </div>
                        <div>
                            <select id="style-selector" class="form-select" disabled>
                                <option value="">Style</option>
                            </select>
                        </div>
                    </div>

                    <!-- Quantity and Price -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
                        <div>
                            <input type="number" id="quantity-input" class="form-input" min="1" value="1" placeholder="Quantity">
                        </div>
                        <div>
                            <input type="number" id="unit-price-input" class="form-input" step="0.01" placeholder="Unit Price (Auto-calculated)">
                        </div>
                        <div class="md:col-span-2">
                            <button id="add-item-btn" class="btn-primary w-full" disabled>
                                <span class="mr-2">âž•</span> Add Item
                            </button>
                        </div>
                    </div>

                    <!-- Current Price Display -->
                    <div id="price-display" class="bg-blue-50 border border-blue-200 rounded-lg p-4 hidden">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-blue-800">Calculated Price:</span>
                            <span id="calculated-price" class="text-lg font-bold text-blue-900"></span>
                        </div>
                    </div>
                </div>

                <!-- Quote Items -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Quote Items</h2>
                    <div id="quote-items-container">
                        <div class="text-center text-gray-500 py-8">
                            <p>No items added yet. Use the form above to add products to your quote.</p>
                        </div>
                    </div>
                </div>

                <!-- Quote Summary -->
                <div class="card p-4">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Quote Summary</h2>
                    
                    <div class="space-y-3">
                        <!-- Subtotal Row -->
                        <div class="flex justify-between items-center py-1">
                            <span class="text-gray-600 font-medium">Subtotal</span>
                            <span id="subtotal-amount" class="font-semibold text-right">â‚¹0.00</span>
                        </div>
                        
                        <!-- Discount Field -->
                        <div class="flex justify-between items-center py-1">
                            <div class="flex-1">
                                <input type="text" id="discount-input" class="form-input text-left text-sm w-full" value="0" placeholder="Enter discount (0 or 0%)">
                            </div>
                            <div class="ml-3 text-right min-w-20">
                                <span id="discount-amount" class="text-sm text-gray-600 font-medium">â‚¹0.00</span>
                            </div>
                        </div>
                        
                        <!-- Tax Field -->
                        <div class="flex justify-between items-center py-1">
                            <div class="flex-1">
                                <select id="tax-input" class="form-input text-left text-sm w-full">
                                    <option value="0">Tax: 0%</option>
                                    <option value="5">Tax: 5%</option>
                                    <option value="12">Tax: 12%</option>
                                    <option value="18" selected>Tax: 18%</option>
                                </select>
                            </div>
                            <div class="ml-3 text-right min-w-20">
                                <span id="tax-amount" class="text-sm text-gray-600 font-medium">â‚¹0.00</span>
                            </div>
                        </div>
                        
                        <!-- Shipping Field -->
                        <div class="flex justify-between items-center py-1">
                            <div class="flex-1">
                                <input type="number" id="shipping-input" class="form-input text-left text-sm w-full" min="0" step="0.01" value="0" placeholder="Enter shipping amount">
                            </div>
                            <div class="ml-3 text-right min-w-20">
                                <span id="shipping-currency-symbol" class="text-sm text-gray-600 font-medium">â‚¹</span>
                            </div>
                        </div>
                        
                        <hr class="my-3 border-gray-300">
                        
                        <!-- Total Row -->
                        <div class="flex justify-between items-center py-2 bg-blue-50 px-3 rounded-lg">
                            <span class="text-lg font-bold text-gray-800">Total</span>
                            <span id="total-amount" class="text-lg font-bold text-blue-600 text-right">â‚¹0.00</span>
                        </div>
                    </div>
                    
                    <!-- Save Quote Button -->
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <button id="save-quote-btn" class="btn-primary w-full">
                            <span class="mr-2">ðŸ’¾</span> Save Quote
                        </button>
                    </div>
                </div>

                <!-- Saved Quotes -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Saved Quotes</h2>
                    <div id="saved-quotes-container">
                        <div class="text-center text-gray-500 py-4">
                            <div class="loading mx-auto mb-2"></div>
                            <p class="text-sm">Loading saved quotes...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Client Modal -->
    <div id="add-client-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Add New Client</h3>
                        <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="add-client-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Client Name *</label>
                                <input type="text" id="client-name" class="form-input" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                                <input type="text" id="company-name" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="client-email" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                <input type="tel" id="client-phone" class="form-input">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                            <textarea id="client-address" class="form-input" rows="3"></textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" id="cancel-client-btn" class="btn-secondary">Cancel</button>
                            <button type="submit" class="btn-primary">Add Client</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-lg p-6 text-center">
                <div class="loading mx-auto mb-4"></div>
                <p class="text-gray-600">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="firebase-config.js"></script>
    <script src="firebase-database.js"></script>
    <script src="firebase-error-handler.js"></script>
    <script src="client-management.js"></script>
    
    <script>
        // Global variables
        let currentQuote = {
            number: '',
            date: '',
            client: null,
            salesperson: '',
            currency: 'INR',
            priceList: '',
            items: [],
            subtotal: 0,
            discount: 0,
            tax: 18,
            total: 0,
            status: 'draft'
        };
        
        let productData = [];
        let clientData = [];
        let salesmenData = [];
        let stylesData = [];
        let colorsData = [];
        let isManualPriceEntry = false; // Track if user is manually entering price
        
        // Currency symbols
        const currencySymbols = {
            'INR': 'â‚¹',
            'USD': '$',
            'EUR': 'â‚¬',
            'GBP': 'Â£',
            'AUD': 'A$',
            'AED': 'Ø¯.Ø¥ ',
            'NGN': 'â‚¦',
            'CAD': 'C$',
            'JPY': 'Â¥'
        };

        // Exchange rates (base: INR)
        let exchangeRates = {
            'INR': 1,
            'USD': 0.012,
            'EUR': 0.011,
            'GBP': 0.0095,
            'AUD': 0.018,
            'AED': 0.044,
            'NGN': 19.5,
            'CAD': 0.016,
            'JPY': 1.8
        };

        // Fetch real-time exchange rates
        async function fetchExchangeRates() {
            try {
                // Using multiple APIs for better reliability
                let data = null;
                
                // Try primary API first
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/INR');
                    data = await response.json();
                } catch (e) {
                    console.warn('Primary API failed, trying backup...');
                    // Backup API
                    const response = await fetch('https://api.fixer.io/latest?base=INR&access_key=YOUR_API_KEY');
                    data = await response.json();
                }
                
                if (data && data.rates) {
                    const newRates = {
                        'INR': 1,
                        'USD': data.rates.USD || exchangeRates.USD,
                        'EUR': data.rates.EUR || exchangeRates.EUR,
                        'GBP': data.rates.GBP || exchangeRates.GBP,
                        'AUD': data.rates.AUD || exchangeRates.AUD,
                        'AED': data.rates.AED || exchangeRates.AED,
                        'NGN': data.rates.NGN || exchangeRates.NGN,
                        'CAD': data.rates.CAD || exchangeRates.CAD,
                        'JPY': data.rates.JPY || exchangeRates.JPY
                    };
                    
                    // Update rates and recalculate all prices if rates changed
                    const ratesChanged = JSON.stringify(exchangeRates) !== JSON.stringify(newRates);
                    exchangeRates = newRates;
                    
                    if (ratesChanged && currentQuote.items.length > 0) {
                        updatePricing();
                        updateQuoteSummary();
                    }
                    
                    console.log('âœ… Exchange rates updated successfully', exchangeRates);
                }
            } catch (error) {
                console.warn('âš ï¸ Failed to fetch exchange rates, using default rates:', error);
            }
        }

        // Convert amount between currencies
        function convertCurrency(amount, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) return amount;
            
            // Convert to INR first, then to target currency
            const inrAmount = amount / exchangeRates[fromCurrency];
            return inrAmount * exchangeRates[toCurrency];
        }

        // Start periodic exchange rate updates
        function startExchangeRateUpdates() {
            // Update rates every 30 minutes
            setInterval(async () => {
                console.log('ðŸ”„ Updating exchange rates...');
                await fetchExchangeRates();
                // Recalculate current quote with new rates
                recalculateWithCurrentRates();
            }, 30 * 60 * 1000);
        }

        // Recalculate all prices with current exchange rates
        function recalculateWithCurrentRates() {
            if (currentQuote && currentQuote.items && currentQuote.items.length > 0) {
                console.log('ðŸ”„ Recalculating quote with current exchange rates...');
                
                // Update pricing for current product selection
                updatePricing();
                
                // Update quote summary
                updateQuoteSummary();
                
                // Update quote items display
                updateQuoteItemsDisplay();
                
                console.log('âœ… Quote recalculated with current exchange rates');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading(true);
            
            try {
                // Initialize Firebase
                await initializeFirebase();
                
                // Fetch real-time exchange rates
                await fetchExchangeRates();
                
                // Start periodic exchange rate updates
                startExchangeRateUpdates();
                
                // Load initial data
                await loadAllData();
                
                // Setup event listeners
                setupEventListeners();
                
                // Initialize quote
                initializeQuote();
                
                // Load saved quotes
                await loadSavedQuotes();
                
                console.log('âœ… Quote Maker v2 initialized successfully');
                
            } catch (error) {
                console.error('âŒ Initialization error:', error);
                showError('Failed to initialize application. Please refresh the page.');
            } finally {
                showLoading(false);
            }
        });

        // Initialize Firebase
        async function initializeFirebase() {
            try {
                if (window.firebaseDB) {
                    console.log('ðŸ”„ Initializing Firebase...');
                    await window.firebaseDB.initialize();
                    
                    if (window.firebaseDB.isAvailable()) {
                        updateConnectionStatus(true);
                        console.log('âœ… Firebase connected successfully');
                    } else {
                        updateConnectionStatus(false);
                        console.warn('âš ï¸ Firebase not available, using fallback data');
                    }
                } else {
                    console.warn('âš ï¸ Firebase database module not found, using fallback data');
                    updateConnectionStatus(false);
                }
            } catch (error) {
                console.error('âŒ Firebase initialization failed:', error);
                updateConnectionStatus(false);
                // Continue with fallback data instead of failing
            }
        }

        // Load all required data
        async function loadAllData() {
            try {
                // Load data in parallel for better performance
                const [products, clients, salesmen, styles, colors] = await Promise.all([
                    loadProducts(),
                    loadClients(),
                    loadSalesmen(),
                    loadStyles(),
                    loadColors()
                ]);
                
                console.log('ðŸ” DEBUG: Loaded styles data:', styles);
                console.log('ðŸ” DEBUG: Loaded colors data:', colors);
                console.log('âœ… All data loaded successfully');
                
            } catch (error) {
                console.error('âŒ Error loading data:', error);
                throw error;
            }
        }

        // Load products from Firebase
        async function loadProducts() {
            try {

                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    productData = await window.firebaseDB.getProducts();
                    console.log(`ðŸ“¦ Loaded ${productData.length} products from Firebase`);
                } else {
                    // Fallback to embedded data if available
                    productData = window.embeddedProductData || [];
                    console.log(`ðŸ“¦ Using ${productData.length} embedded products`);
                }
                
                populatePriceListDropdown();
                return productData;
                
            } catch (error) {
                console.error('âŒ Error loading products:', error);
                productData = [];
                return [];
            }
        }

        // Load clients from Firebase
        async function loadClients() {
            try {
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    clientData = await window.firebaseDB.getClients();
                    console.log(`ðŸ‘¥ Loaded ${clientData.length} clients from Firebase`);
                } else {
                    clientData = [];
                    console.log('ðŸ‘¥ No clients loaded (Firebase unavailable)');
                }
                
                populateClientDropdown();
                return clientData;
                
            } catch (error) {
                console.error('âŒ Error loading clients:', error);
                clientData = [];
                return [];
            }
        }

        // Load salesmen from Firebase
        async function loadSalesmen() {
            try {
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    salesmenData = await window.firebaseDB.getSalesmen();
                    console.log(`ðŸ‘¨â€ðŸ’¼ Loaded ${salesmenData.length} salesmen from Firebase`);
                } else {
                    salesmenData = [];
                    console.log('ðŸ‘¨â€ðŸ’¼ No salesmen loaded (Firebase unavailable)');
                }
                
                populateSalespersonDropdown();
                return salesmenData;
                
            } catch (error) {
                console.error('âŒ Error loading salesmen:', error);
                salesmenData = [];
                return [];
            }
        }

        // Load styles from Firebase
        async function loadStyles() {
            try {
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    stylesData = await window.firebaseDB.getStyles();
                    console.log(`ðŸŽ¨ Loaded ${stylesData.length} styles from Firebase`);
                } else {
                    stylesData = [];
                    console.log('ðŸŽ¨ No styles loaded (Firebase unavailable)');
                }
                
                populateStylesFromCollection();
                
                // Enable style selector since styles are independent of product selection
                enableSelector('style-selector');
                
                return stylesData;
                
            } catch (error) {
                console.error('âŒ Error loading styles:', error);
                stylesData = [];
                populateStylesFromCollection(); // Still call to show "No styles available"
                return [];
            }
        }

        // Load colors from Firebase
        async function loadColors() {
            try {
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    colorsData = await window.firebaseDB.getColors();
                    console.log(`ðŸŒˆ Loaded ${colorsData.length} colors from Firebase`);
                } else {
                    colorsData = [];
                    console.log('ðŸŒˆ No colors loaded (Firebase unavailable)');
                }
                
                populateColors();
                return colorsData;
                
            } catch (error) {
                console.error('âŒ Error loading colors:', error);
                colorsData = [];
                return [];
            }
        }

        // Populate price list dropdown
        function populatePriceListDropdown() {
            const selector = document.getElementById('price-list-selector');
            const priceLists = [...new Set(productData.map(p => p['Price List Name'] || p.PriceListName || p.PriceList).filter(Boolean))];
            
            selector.innerHTML = '<option value="">Select Price List</option>';
            
            priceLists.sort().forEach(priceList => {
                const option = document.createElement('option');
                option.value = priceList;
                option.textContent = priceList;
                selector.appendChild(option);
            });
            
            console.log(`ðŸ“‹ Populated ${priceLists.length} price lists`);
        }

        // Populate client dropdown
        function populateClientDropdown() {
            const selector = document.getElementById('client-selector');
            
            // Clear existing options except default and add new
            selector.innerHTML = '<option value="">Select Client</option><option value="add-new">+ Add New Client</option>';
            
            clientData.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.clientName} (${client.companyName || 'No Company'})`;
                selector.appendChild(option);
            });
            
            console.log(`ðŸ‘¥ Populated ${clientData.length} clients`);
        }

        // Populate salesperson dropdown
        function populateSalespersonDropdown() {
            const selector = document.getElementById('salesperson-selector');
            
            selector.innerHTML = '<option value="">Select Salesperson</option>';
            
            salesmenData.forEach(salesman => {
                const option = document.createElement('option');
                option.value = salesman.name || salesman.Name;
                option.textContent = salesman.name || salesman.Name;
                selector.appendChild(option);
            });
            
            console.log(`ðŸ‘¨â€ðŸ’¼ Populated ${salesmenData.length} salespeople`);
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('ðŸ”§ Setting up event listeners...');
            
            // Price list change
            document.getElementById('price-list-selector').addEventListener('change', onPriceListChange);
            
            // Category change
            document.getElementById('category-selector').addEventListener('change', onCategoryChange);
            
            // Product change
            document.getElementById('product-selector').addEventListener('change', onProductChange);
            
            // Other selectors
            document.getElementById('density-selector').addEventListener('change', () => {
                console.log('ðŸŽ¯ Density changed');
                isManualPriceEntry = false; // Reset manual entry flag
                updatePricing();
            });
            document.getElementById('length-selector').addEventListener('change', () => {
                console.log('ðŸŽ¯ Length changed');
                isManualPriceEntry = false; // Reset manual entry flag
                updatePricing();
            });
            document.getElementById('color-type-selector').addEventListener('change', onColorTypeChange);
            document.getElementById('color-selector').addEventListener('change', () => {
                console.log('ðŸŽ¯ Color changed');
                isManualPriceEntry = false; // Reset manual entry flag
                updatePricing();
            });
            document.getElementById('style-selector').addEventListener('change', () => {
                console.log('ðŸŽ¯ Style changed');
                isManualPriceEntry = false; // Reset manual entry flag
                updatePricing();
            });
            
            // Quantity and price inputs
            document.getElementById('quantity-input').addEventListener('input', () => {
                console.log('ðŸŽ¯ Quantity changed');
                updatePricing();
            });
            document.getElementById('unit-price-input').addEventListener('input', () => {
                console.log('ðŸŽ¯ Unit price changed');
                isManualPriceEntry = true; // User is manually entering price
                updatePricing();
            });
            
            // Currency change
            document.getElementById('currency-selector').addEventListener('change', onCurrencyChange);
            
            // Client selector
            document.getElementById('client-selector').addEventListener('change', onClientChange);
            
            // Add item button
            document.getElementById('add-item-btn').addEventListener('click', addQuoteItem);
            
            // Summary inputs
            document.getElementById('discount-input').addEventListener('input', updateQuoteSummary);
            document.getElementById('tax-input').addEventListener('input', updateQuoteSummary);
            
            // Shipping input with error handling
            const shippingInput = document.getElementById('shipping-input');
            if (shippingInput) {
                shippingInput.addEventListener('input', updateQuoteSummary);
            } else {
                console.error('âŒ Shipping input element not found');
            }
            
            // Action buttons
            document.getElementById('save-quote-btn').addEventListener('click', saveQuote);
            
            // Optional buttons with null checks
            const clearQuoteBtn = document.getElementById('clear-quote-btn');
            if (clearQuoteBtn) {
                clearQuoteBtn.addEventListener('click', clearQuote);
            } else {
                console.log('â„¹ï¸ Clear quote button not found - feature not available');
            }
            
            const duplicateQuoteBtn = document.getElementById('duplicate-quote-btn');
            if (duplicateQuoteBtn) {
                duplicateQuoteBtn.addEventListener('click', duplicateQuote);
            } else {
                console.log('â„¹ï¸ Duplicate quote button not found - feature not available');
            }
            
            const loadQuoteBtn = document.getElementById('load-quote-btn');
            if (loadQuoteBtn) {
                loadQuoteBtn.addEventListener('click', loadQuote);
            } else {
                console.log('â„¹ï¸ Load quote button not found - feature not available');
            }
            
            // Modal events
            document.getElementById('close-modal-btn').addEventListener('click', closeAddClientModal);
            document.getElementById('cancel-client-btn').addEventListener('click', closeAddClientModal);
            document.getElementById('add-client-form').addEventListener('submit', addNewClient);
        }

        // Price list change handler
        function onPriceListChange() {
            const priceList = document.getElementById('price-list-selector').value;
            currentQuote.priceList = priceList;
            
            if (priceList) {
                populateCategories(priceList);
                enableSelector('category-selector');
            } else {
                clearCascadeSelectors(['category-selector', 'product-selector', 'density-selector', 'length-selector', 'color-type-selector', 'color-selector']);
            }
        }

        // Populate categories based on price list
        function populateCategories(priceList) {
            const selector = document.getElementById('category-selector');
            const categories = [...new Set(
                productData
                    .filter(p => (p['Price List Name'] || p.PriceListName || p.PriceList) === priceList)
                    .map(p => p.Category || p.category)
                    .filter(Boolean)
            )];
            
            selector.innerHTML = '<option value="">Select Category</option>';
            
            categories.sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                selector.appendChild(option);
            });
            
            // Auto-select if only one option is available
            if (categories.length === 1) {
                selector.value = categories[0];
                console.log(`ðŸŽ¯ Auto-selected category: ${categories[0]}`);
                // Trigger the change event to populate dependent dropdowns
                onCategoryChange();
            }
            
            console.log(`ðŸ“‚ Populated ${categories.length} categories for ${priceList}`);
        }

        // Category change handler
        function onCategoryChange() {
            const priceList = document.getElementById('price-list-selector').value;
            const category = document.getElementById('category-selector').value;
            
            if (priceList && category) {
                populateProducts(priceList, category);
                enableSelector('product-selector');
            } else {
                clearCascadeSelectors(['product-selector', 'density-selector', 'length-selector', 'color-type-selector', 'color-selector']);
            }
        }

        // Populate products based on price list and category
        function populateProducts(priceList, category) {
            const selector = document.getElementById('product-selector');
            const products = [...new Set(
                productData
                    .filter(p => 
                        (p['Price List Name'] || p.PriceListName || p.PriceList) === priceList &&
                        (p.Category || p.category) === category
                    )
                    .map(p => p.Product || p.product)
                    .filter(Boolean)
            )];
            
            selector.innerHTML = '<option value="">Select Product</option>';
            
            products.sort().forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                selector.appendChild(option);
            });
            
            // Auto-select if only one option is available
            if (products.length === 1) {
                selector.value = products[0];
                console.log(`ðŸŽ¯ Auto-selected product: ${products[0]}`);
                // Trigger the change event to populate dependent dropdowns
                onProductChange();
            }
            
            console.log(`ðŸ“¦ Populated ${products.length} products for ${category}`);
        }

        // Product change handler
        function onProductChange() {
            const priceList = document.getElementById('price-list-selector').value;
            const category = document.getElementById('category-selector').value;
            const product = document.getElementById('product-selector').value;
            
            if (priceList && category && product) {
                populateDensities(priceList, category, product);
                populateLengths(priceList, category, product);
                populateColorTypes(priceList, category, product);
                
                enableSelector('density-selector');
                enableSelector('length-selector');
                enableSelector('color-type-selector');
                enableSelector('color-selector');
                enableSelector('style-selector');
                
                updatePricing();
            } else {
                clearCascadeSelectors(['density-selector', 'length-selector', 'color-type-selector', 'color-selector']);
            }
        }

        // Color type change handler
        function onColorTypeChange() {
            updatePricing();
        }

        // Populate densities
        function populateDensities(priceList, category, product) {
            const selector = document.getElementById('density-selector');
            const densities = [...new Set(
                productData
                    .filter(p => 
                        (p['Price List Name'] || p.PriceListName || p.PriceList) === priceList &&
                        (p.Category || p.category) === category &&
                        (p.Product || p.product) === product
                    )
                    .map(p => p.Density || p.density)
                    .filter(Boolean)
            )];
            
            selector.innerHTML = '<option value="">Select Density</option>';
            
            densities.sort().forEach(density => {
                const option = document.createElement('option');
                option.value = density;
                option.textContent = density;
                selector.appendChild(option);
            });
            
            // Auto-select if only one option is available
            if (densities.length === 1) {
                selector.value = densities[0];
                console.log(`ðŸŽ¯ Auto-selected density: ${densities[0]}`);
                updatePricing();
            }
            
            console.log(`âš–ï¸ Populated ${densities.length} densities for ${product}`);
        }

        // Populate lengths
        function populateLengths(priceList, category, product) {
            const selector = document.getElementById('length-selector');
            const lengths = [...new Set(
                productData
                    .filter(p => 
                        (p['Price List Name'] || p.PriceListName || p.PriceList) === priceList &&
                        (p.Category || p.category) === category &&
                        (p.Product || p.product) === product
                    )
                    .map(p => p.Length || p.length)
                    .filter(Boolean)
            )];
            
            selector.innerHTML = '<option value="">Select Length</option>';
            
            lengths.sort((a, b) => {
                const numA = parseFloat(a);
                const numB = parseFloat(b);
                return !isNaN(numA) && !isNaN(numB) ? numA - numB : a.localeCompare(b);
            }).forEach(length => {
                const option = document.createElement('option');
                option.value = length;
                option.textContent = length;
                selector.appendChild(option);
            });
            
            // Auto-select if only one option is available
            if (lengths.length === 1) {
                selector.value = lengths[0];
                console.log(`ðŸŽ¯ Auto-selected length: ${lengths[0]}`);
                updatePricing();
            }
            
            console.log(`ðŸ“ Populated ${lengths.length} lengths for ${product}`);
        }

        // Populate color types
        function populateColorTypes(priceList, category, product) {
            const selector = document.getElementById('color-type-selector');
            const colors = [...new Set(
                productData
                    .filter(p => 
                        (p['Price List Name'] || p.PriceListName || p.PriceList) === priceList &&
                        (p.Category || p.category) === category &&
                        (p.Product || p.product) === product
                    )
                    .map(p => p.Colors || p.Color || p.color)
                    .filter(Boolean)
                    .flatMap(colorString => colorString.split(',').map(c => c.trim()))
                    .filter(Boolean)
            )];
            
            selector.innerHTML = '<option value="">Select Color Type</option>';
            
            colors.sort().forEach(color => {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                selector.appendChild(option);
            });
            
            // Auto-select if only one option is available
            if (colors.length === 1) {
                selector.value = colors[0];
                console.log(`ðŸŽ¯ Auto-selected color type: ${colors[0]}`);
                onColorTypeChange();
            }
            
            console.log(`ðŸŽ¨ Populated ${colors.length} color types for ${product}`);
        }

        // Populate colors from colors collection
        function populateColors() {
            const selector = document.getElementById('color-selector');
            
            if (!colorsData || colorsData.length === 0) {
                selector.innerHTML = '<option value="">No colors available</option>';
                return;
            }
            
            selector.innerHTML = '<option value="">Select Color</option>';
            
            colorsData.forEach(colorItem => {
                const colorName = colorItem.colorname || colorItem.Color || colorItem.color || colorItem.name;
                if (colorName) {
                    const option = document.createElement('option');
                    option.value = colorName;
                    option.textContent = colorName;
                    selector.appendChild(option);
                }
            });
            
            console.log(`ðŸŒˆ Populated ${colorsData.length} colors from colors collection`);
        }

        // Populate styles from styles collection
        function populateStylesFromCollection() {
            const selector = document.getElementById('style-selector');
            
            if (!selector) {
                console.error('âŒ Style selector element not found');
                return;
            }
            
            if (!stylesData || stylesData.length === 0) {
                selector.innerHTML = '<option value="">No styles available</option>';
                console.log('âš ï¸ No styles data available for population');
                return;
            }
            
            selector.innerHTML = '<option value="">Select Style</option>';
            
            let populatedCount = 0;
            stylesData.forEach(styleItem => {
                const styleName = styleItem.stylename || styleItem.Style || styleItem.style || styleItem.name;
                if (styleName) {
                    const option = document.createElement('option');
                    option.value = styleName;
                    option.textContent = styleName;
                    selector.appendChild(option);
                    populatedCount++;
                }
            });
            
            console.log(`âœ¨ Populated ${populatedCount} styles from ${stylesData.length} style items`);
        }

        // Populate styles


        // Update pricing based on current selections
        function updatePricing() {
            console.log('ðŸ”„ updatePricing called');
            
            const priceList = document.getElementById('price-list-selector').value;
            const category = document.getElementById('category-selector').value;
            const product = document.getElementById('product-selector').value;
            const density = document.getElementById('density-selector').value;
            const length = document.getElementById('length-selector').value;
            const colorType = document.getElementById('color-type-selector').value;
            const quantity = parseFloat(document.getElementById('quantity-input').value) || 1;
            const overridePrice = parseFloat(document.getElementById('unit-price-input').value);
            
            console.log('ðŸ“‹ Current form values:', {
                priceList, category, product, density, length, colorType, quantity, overridePrice
            });
            
            console.log('ðŸ“Š ProductData status:', {
                loaded: !!productData,
                length: productData ? productData.length : 0,
                sample: productData && productData.length > 0 ? productData[0] : null
            });
            
            let unitPrice = 0;
            
            // Always try to calculate price from product data first
            if (priceList && category && product && density && length) {
                // Find matching product for pricing
                const matchingProduct = productData.find(p => {
                    const productColors = p.Colors || p.Color || p.color || '';
                    const colorMatches = !colorType || 
                        productColors === colorType || 
                        productColors.split(',').map(c => c.trim()).includes(colorType);
                    
                    return (p['Price List Name'] || p.PriceListName || p.PriceList) === priceList &&
                        (p.Category || p.category) === category &&
                        (p.Product || p.product) === product &&
                        (p.Density || p.density) === density &&
                        (p.Length || p.length) === length &&
                        colorMatches;
                });
                
                if (matchingProduct) {
                    const calculatedPrice = parseFloat(matchingProduct.Rate || matchingProduct.Price || matchingProduct.price || 0);
                    const productCurrency = matchingProduct.Currency || 'INR';
                    const selectedCurrency = document.getElementById('currency-selector').value;
                    
                    console.log('ðŸ’° Found matching product for pricing:', {
                        product: matchingProduct,
                        calculatedPrice: calculatedPrice,
                        productCurrency: productCurrency,
                        selectedCurrency: selectedCurrency
                    });
                    
                    // Apply currency conversion to the calculated price
                    const convertedPrice = convertCurrency(calculatedPrice, productCurrency, selectedCurrency);
                    
                    // Use override price if manually entered, otherwise use converted calculated price
                     if (isManualPriceEntry && overridePrice && overridePrice > 0) {
                         unitPrice = overridePrice;
                         console.log('ðŸ”§ Using manual override price:', overridePrice);
                     } else {
                         unitPrice = convertedPrice;
                         console.log('ðŸ’± Applied currency conversion:', {
                             original: calculatedPrice,
                             converted: convertedPrice,
                             from: productCurrency,
                             to: selectedCurrency
                         });
                         // Update the input field with converted price only if not manually entered
                         if (!isManualPriceEntry) {
                             document.getElementById('unit-price-input').value = unitPrice > 0 ? unitPrice.toFixed(2) : '';
                         }
                     }
                } else {
                    console.log('âš ï¸ No matching product found for pricing with criteria:', {
                        priceList, category, product, density, length, colorType
                    });
                    
                    // Use override price if available, otherwise no price
                    if (overridePrice && overridePrice > 0) {
                        unitPrice = overridePrice;
                    } else {
                        unitPrice = 0;
                        document.getElementById('unit-price-input').value = '';
                    }
                }
            } else {
                // No product data available, use override price if entered
                if (overridePrice && overridePrice > 0) {
                    unitPrice = overridePrice;
                } else {
                    unitPrice = 0;
                    document.getElementById('unit-price-input').value = '';
                }
            }
            
            // Update price display
            const priceDisplay = document.getElementById('price-display');
            const calculatedPrice = document.getElementById('calculated-price');
            
            if (unitPrice > 0) {
                const totalPrice = unitPrice * quantity;
                const currency = document.getElementById('currency-selector').value;
                const symbol = currencySymbols[currency] || currency + ' ';
                
                calculatedPrice.textContent = `${symbol}${totalPrice.toFixed(2)}`;
                priceDisplay.classList.remove('hidden');
                
                // Enable add button if all required fields are filled
                const addBtn = document.getElementById('add-item-btn');
                if (priceList && category && product && density && length) {
                    addBtn.disabled = false;
                } else {
                    addBtn.disabled = true;
                }
            } else {
                priceDisplay.classList.add('hidden');
                document.getElementById('add-item-btn').disabled = true;
            }
        }

        // Currency change handler
        async function onCurrencyChange() {
            const newCurrency = document.getElementById('currency-selector').value;
            const oldCurrency = currentQuote.currency || 'INR';
            
            if (newCurrency !== oldCurrency) {
                // Convert existing quote values to new currency
                if (currentQuote.items && currentQuote.items.length > 0) {
                    currentQuote.items.forEach(item => {
                        if (item.unitPrice) {
                            item.unitPrice = convertCurrency(item.unitPrice, oldCurrency, newCurrency);
                            item.totalPrice = item.unitPrice * item.quantity;
                        }
                      });
                }
                
                // Convert summary amounts
                if (currentQuote.subtotal) {
                    currentQuote.subtotal = convertCurrency(currentQuote.subtotal, oldCurrency, newCurrency);
                }
                if (currentQuote.discountAmount) {
                    currentQuote.discountAmount = convertCurrency(currentQuote.discountAmount, oldCurrency, newCurrency);
                }
                if (currentQuote.taxAmount) {
                    currentQuote.taxAmount = convertCurrency(currentQuote.taxAmount, oldCurrency, newCurrency);
                }
                if (currentQuote.shipping) {
                    currentQuote.shipping = convertCurrency(currentQuote.shipping, oldCurrency, newCurrency);
                }
                if (currentQuote.total) {
                    currentQuote.total = convertCurrency(currentQuote.total, oldCurrency, newCurrency);
                }
                
                // Update shipping input field
                const shippingInput = document.getElementById('shipping-input');
                if (shippingInput && shippingInput.value) {
                    const convertedShipping = convertCurrency(parseFloat(shippingInput.value), oldCurrency, newCurrency);
                    shippingInput.value = convertedShipping.toFixed(2);
                }
                
                // Update discount input field (only if it's a fixed amount, not percentage)
                const discountInput = document.getElementById('discount-input');
                if (discountInput && discountInput.value && !discountInput.value.includes('%')) {
                    const convertedDiscount = convertCurrency(parseFloat(discountInput.value), oldCurrency, newCurrency);
                    discountInput.value = convertedDiscount.toFixed(2);
                }
                
                // Update shipping currency symbol
                const shippingSymbol = document.getElementById('shipping-currency-symbol');
                if (shippingSymbol) {
                    shippingSymbol.textContent = currencySymbols[newCurrency] || newCurrency + ' ';
                }
                
                // Update shipping input placeholder
                if (shippingInput) {
                    shippingInput.placeholder = `Enter shipping amount in ${newCurrency}`;
                }
            }
            
            currentQuote.currency = newCurrency;
            updatePricing();
            updateQuoteItemsDisplay();
            updateQuoteSummary();
        }

        // Client change handler
        function onClientChange() {
            const clientId = document.getElementById('client-selector').value;
            
            if (clientId === 'add-new') {
                openAddClientModal();
                document.getElementById('client-selector').value = '';
            } else if (clientId) {
                const client = clientData.find(c => c.id === clientId);
                currentQuote.client = client;
            } else {
                currentQuote.client = null;
            }
        }

        // Add quote item
        function addQuoteItem() {
            const priceList = document.getElementById('price-list-selector').value;
            const category = document.getElementById('category-selector').value;
            const product = document.getElementById('product-selector').value;
            const density = document.getElementById('density-selector').value;
            const length = document.getElementById('length-selector').value;
            const colorType = document.getElementById('color-type-selector').value;
            const color = document.getElementById('color-selector').value;
            const style = document.getElementById('style-selector').value;
            const quantity = parseFloat(document.getElementById('quantity-input').value) || 1;
            const unitPrice = parseFloat(document.getElementById('unit-price-input').value) || 0;
            
            if (!priceList || !category || !product || !density || !length || unitPrice <= 0) {
                showError('Please fill in all required fields and ensure a valid price is calculated.');
                return;
            }
            
            const item = {
                id: Date.now().toString(),
                priceList,
                category,
                product,
                density,
                length,
                colorType: colorType || 'N/A',
                color: color || 'N/A',
                style: style || 'N/A',
                quantity,
                unitPrice,
                totalPrice: unitPrice * quantity
            };
            
            currentQuote.items.push(item);
            
            // Clear form
            clearProductForm();
            
            // Update display
            updateQuoteItemsDisplay();
            updateQuoteSummary();
            
            console.log('âœ… Item added to quote:', item);
        }

        // Clear product form
        function clearProductForm() {
            document.getElementById('quantity-input').value = '1';
            document.getElementById('unit-price-input').value = '';
            document.getElementById('price-display').classList.add('hidden');
            document.getElementById('add-item-btn').disabled = true;
            
            // Clear selectors except price list
            clearCascadeSelectors(['category-selector', 'product-selector', 'density-selector', 'length-selector', 'color-type-selector', 'color-selector']);
            
            // Re-enable category selector if price list is selected
            const priceList = document.getElementById('price-list-selector').value;
            if (priceList) {
                document.getElementById('category-selector').disabled = false;
                populateCategories(priceList);
            }
        }

        // Update quote items display
        function updateQuoteItemsDisplay() {
            const container = document.getElementById('quote-items-container');
            
            if (currentQuote.items.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>No items added yet. Use the form above to add products to your quote.</p>
                    </div>
                `;
                return;
            }
            
            const currency = currentQuote.currency;
            const symbol = currencySymbols[currency] || currency + ' ';
            
            container.innerHTML = currentQuote.items.map((item, index) => `
                <div class="quote-item">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">${item.product}</h4>
                            <p class="text-sm text-gray-600">
                                ${item.category} â€¢ ${item.density} â€¢ ${item.length}" â€¢ ${item.colorType}
                                ${item.color !== 'N/A' ? ' â€¢ Color: ' + item.color : ''}
                                ${item.style !== 'N/A' ? ' â€¢ Style: ' + item.style : ''}
                            </p>
                            <p class="text-sm text-gray-500 mt-1">
                                Qty: ${item.quantity} Ã— ${symbol}${item.unitPrice.toFixed(2)}
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-gray-800">${symbol}${item.totalPrice.toFixed(2)}</p>
                            <button onclick="removeQuoteItem(${index})" class="text-red-500 hover:text-red-700 text-sm mt-1">
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Remove quote item
        function removeQuoteItem(index) {
            currentQuote.items.splice(index, 1);
            updateQuoteItemsDisplay();
            updateQuoteSummary();
        }

        // Update quote summary
        function updateQuoteSummary() {
            const currency = currentQuote.currency;
            const symbol = currencySymbols[currency] || currency + ' ';
            
            // Calculate subtotal
            const subtotal = currentQuote.items.reduce((sum, item) => sum + item.totalPrice, 0);
            
            // Get discount input and determine if it's percentage or amount
            const discountInput = document.getElementById('discount-input').value.trim();
            let discountAmount = 0;
            let discountType = 'amount';
            
            if (discountInput.includes('%')) {
                // Percentage discount
                const discountPercent = parseFloat(discountInput.replace('%', '')) || 0;
                discountAmount = subtotal * (discountPercent / 100);
                discountType = 'percentage';
            } else {
                // Amount discount
                discountAmount = parseFloat(discountInput) || 0;
                discountType = 'amount';
            }
            
            // Get tax and shipping
            const taxPercent = parseFloat(document.getElementById('tax-input').value) || 0;
            const shippingAmount = parseFloat(document.getElementById('shipping-input').value) || 0;
            
            // Calculate amounts
            const taxableAmount = subtotal - discountAmount;
            const taxAmount = taxableAmount * (taxPercent / 100);
            const total = taxableAmount + taxAmount + shippingAmount;
            
            // Update display
            document.getElementById('subtotal-amount').textContent = `${symbol}${subtotal.toFixed(2)}`;
            document.getElementById('discount-amount').textContent = `${symbol}${discountAmount.toFixed(2)}`;
            document.getElementById('tax-amount').textContent = `${symbol}${taxAmount.toFixed(2)}`;
            document.getElementById('total-amount').textContent = `${symbol}${total.toFixed(2)}`;
            
            // Update current quote
            currentQuote.subtotal = subtotal;
            currentQuote.discountAmount = discountAmount;
            currentQuote.discountType = discountType;
            currentQuote.discountInput = discountInput;
            currentQuote.tax = taxPercent;
            currentQuote.taxAmount = taxAmount;
            currentQuote.shipping = shippingAmount;
            currentQuote.total = total;
        }

        // Utility functions
        function enableSelector(selectorId) {
            document.getElementById(selectorId).disabled = false;
        }

        function clearCascadeSelectors(selectorIds) {
            selectorIds.forEach(id => {
                const selector = document.getElementById(id);
                selector.innerHTML = '<option value="">Select ' + id.replace('-selector', '').replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) + '</option>';
                selector.disabled = true;
            });
            
            // Clear pricing
            document.getElementById('unit-price-input').value = '';
            document.getElementById('price-display').classList.add('hidden');
            document.getElementById('add-item-btn').disabled = true;
        }

        function updateConnectionStatus(connected) {
            const indicator = document.querySelector('.status-indicator');
            if (connected) {
                // Green Firebase logo for connected state
                indicator.innerHTML = `
                    <svg class="w-9 h-9 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M5.803 21.803l5.678-10.44L9.189 6.81l-3.386 14.993zm7.078-11.013L11.189 8.8l1.292-2.49L10.189 3.81l2.692 6.98zm3.908 8.15L14.481 8.8l2.308 10.14z"/>
                        <path d="M18.75 18.94L12 22.5l-6.75-3.56L12 2.5l6.75 16.44z" fill-opacity="0.3"/>
                    </svg>
                `;
                indicator.title = "Firebase Connected";
            } else {
                // Red Firebase logo for disconnected state
                indicator.innerHTML = `
                    <svg class="w-9 h-9 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M5.803 21.803l5.678-10.44L9.189 6.81l-3.386 14.993zm7.078-11.013L11.189 8.8l1.292-2.49L10.189 3.81l2.692 6.98zm3.908 8.15L14.481 8.8l2.308 10.14z"/>
                        <path d="M18.75 18.94L12 22.5l-6.75-3.56L12 2.5l6.75 16.44z" fill-opacity="0.3"/>
                    </svg>
                `;
                indicator.title = "Firebase Disconnected";
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function showError(message) {
            alert(message); // Simple alert for now, can be enhanced with a proper modal
        }

        function showSuccess(message) {
            alert(message); // Simple alert for now, can be enhanced with a proper modal
        }

        // Initialize quote
        function initializeQuote() {
            // Generate quote number
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            currentQuote.number = `INH-${dateStr}-${randomNum}`;
            
            // Set current date
            currentQuote.date = today.toISOString().split('T')[0];
            
            // Update form
            document.getElementById('quote-number').value = currentQuote.number;
            document.getElementById('quote-date').value = currentQuote.date;
            
            // Initialize shipping currency symbol
            const defaultCurrency = currentQuote.currency || 'INR';
            const shippingSymbol = document.getElementById('shipping-currency-symbol');
            if (shippingSymbol) {
                shippingSymbol.textContent = currencySymbols[defaultCurrency] || defaultCurrency + ' ';
            }
            
            // Initialize shipping input placeholder
            const shippingInput = document.getElementById('shipping-input');
            if (shippingInput) {
                shippingInput.placeholder = `Enter shipping amount in ${defaultCurrency}`;
            }
        }

        // Modal functions
        function openAddClientModal() {
            document.getElementById('add-client-modal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('client-name').focus();
            }, 100);
        }

        function closeAddClientModal() {
            document.getElementById('add-client-modal').classList.add('hidden');
            document.getElementById('add-client-form').reset();
        }

        // Add new client
        async function addNewClient(event) {
            event.preventDefault();
            
            const clientName = document.getElementById('client-name').value.trim();
            const companyName = document.getElementById('company-name').value.trim();
            const email = document.getElementById('client-email').value.trim();
            const phone = document.getElementById('client-phone').value.trim();
            const address = document.getElementById('client-address').value.trim();
            
            if (!clientName) {
                showError('Client name is required');
                return;
            }
            
            try {
                showLoading(true);
                
                const newClient = {
                    clientName,
                    companyName,
                    email,
                    phone,
                    address,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    const savedClient = await window.firebaseDB.saveClient(newClient);
                    clientData.push(savedClient);
                    
                    // Add to dropdown
                    const selector = document.getElementById('client-selector');
                    const option = document.createElement('option');
                    option.value = savedClient.id;
                    option.textContent = `${clientName} (${companyName || 'No Company'})`;
                    
                    // Insert before "Add New Client" option
                    const addNewOption = selector.querySelector('option[value="add-new"]');
                    selector.insertBefore(option, addNewOption);
                    
                    // Select the new client
                    selector.value = savedClient.id;
                    currentQuote.client = savedClient;
                    
                    showSuccess('Client added successfully!');
                } else {
                    showError('Cannot add client: Firebase not available');
                }
                
                closeAddClientModal();
                
            } catch (error) {
                console.error('Error adding client:', error);
                showError('Failed to add client. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Save quote
        async function saveQuote() {
            if (currentQuote.items.length === 0) {
                showError('Cannot save empty quote. Please add at least one item.');
                return;
            }
            
            try {
                showLoading(true);
                
                // Update quote data from form
                const quoteData = {
                    ...currentQuote,
                    number: document.getElementById('quote-number').value || generateQuoteNumber(),
                    date: document.getElementById('quote-date').value || new Date().toISOString().split('T')[0],
                    salesperson: document.getElementById('salesperson-selector').value,
                    discount: parseFloat(document.getElementById('discount-input').value) || 0,
                    tax: parseFloat(document.getElementById('tax-input').value) || 18,
                    shipping: parseFloat(document.getElementById('shipping-input').value) || 0,
                    subtotal: calculateSubtotal(),
                    total: calculateTotal(),
                    status: 'draft',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    // Save to Firebase quotes collection
                    const savedQuote = await window.firebaseDB.saveQuote(quoteData);
                    showSuccess('Quote saved successfully to Firebase!');
                    
                    // Update current quote with saved data
                    currentQuote = { ...quoteData, id: savedQuote.id };
                    
                    // Refresh saved quotes list
                    await loadSavedQuotes();
                } else {
                    // Save to localStorage as fallback
                    const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                    quoteData.id = Date.now().toString();
                    savedQuotes.push(quoteData);
                    localStorage.setItem('savedQuotes', JSON.stringify(savedQuotes));
                    showSuccess('Quote saved locally!');
                    
                    // Update current quote
                    currentQuote = quoteData;
                    
                    // Refresh saved quotes list
                    loadSavedQuotesFromLocal();
                }
                
            } catch (error) {
                console.error('Error saving quote:', error);
                showError('Failed to save quote. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Load saved quotes from Firebase
        async function loadSavedQuotes() {
            try {
                const container = document.getElementById('saved-quotes-container');
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    const quotes = await window.firebaseDB.getQuotes();
                    displaySavedQuotes(quotes);
                } else {
                    loadSavedQuotesFromLocal();
                }
                
            } catch (error) {
                console.error('Error loading saved quotes:', error);
                const container = document.getElementById('saved-quotes-container');
                container.innerHTML = '<div class="text-center text-red-500 py-4"><p class="text-sm">Error loading quotes</p></div>';
            }
        }

        // Load saved quotes from localStorage
        function loadSavedQuotesFromLocal() {
            try {
                const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                displaySavedQuotes(savedQuotes);
            } catch (error) {
                console.error('Error loading local quotes:', error);
                const container = document.getElementById('saved-quotes-container');
                container.innerHTML = '<div class="text-center text-red-500 py-4"><p class="text-sm">Error loading local quotes</p></div>';
            }
        }

        // Display saved quotes in the UI
        function displaySavedQuotes(quotes) {
            const container = document.getElementById('saved-quotes-container');
            
            if (!quotes || quotes.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4"><p class="text-sm">No saved quotes yet</p></div>';
                return;
            }
            
            // Sort quotes by creation date (newest first)
            const sortedQuotes = quotes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            container.innerHTML = sortedQuotes.slice(0, 5).map(quote => {
                // Calculate total amount with currency symbol
                const total = quote.total || 0;
                const currency = quote.currency || 'INR';
                const symbol = currencySymbols[currency] || currency + ' ';
                const totalDisplay = `${symbol}${total.toFixed(2)}`;
                
                return `
                <div class="quote-item border rounded-lg p-1 mb-1 hover:bg-gray-50">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="text-xs text-gray-700">
                                <span class="font-semibold">${quote.number || 'No Number'}</span>
                                <span class="mx-1">-</span>
                                <span>${quote.client ? quote.client.clientName : 'No Client'}</span>
                                <span class="mx-1">-</span>
                                <span>${quote.items ? quote.items.length : 0} items</span>
                                <span class="mx-1">-</span>
                                <span class="font-semibold text-green-600">${totalDisplay}</span>
                                <span class="mx-1">-</span>
                                <span class="text-gray-500">${formatDate(quote.createdAt)}</span>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex items-center space-x-1">
                            <button onclick="recallQuote('${quote.id}')" class="action-btn-compact action-btn-recall" title="Recall for editing">
                                <span class="text-xs">ðŸ“</span>
                            </button>
                            <button onclick="previewQuote('${quote.id}')" class="action-btn-compact action-btn-preview" title="Generate proforma invoice">
                                <span class="text-xs">ðŸ‘ï¸</span>
                            </button>
                            <button onclick="deleteQuote('${quote.id}')" class="action-btn-compact action-btn-delete" title="Delete quote">
                                <span class="text-xs">ðŸ—‘ï¸</span>
                            </button>
                            <button onclick="convertToOrder('${quote.id}')" class="action-btn-compact action-btn-convert" title="Convert to order">
                                <span class="text-xs">ðŸ“¦</span>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Load quote data into the form
        async function loadQuoteData(quoteId) {
            try {
                showLoading(true);
                
                let quote = null;
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    const quotes = await window.firebaseDB.getQuotes();
                    quote = quotes.find(q => q.id === quoteId);
                } else {
                    const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                    quote = savedQuotes.find(q => q.id === quoteId);
                }
                
                if (quote) {
                    // Load quote data into form
                    currentQuote = { ...quote };
                    
                    // Set currency selector and apply conversion if needed
                    const quoteCurrency = quote.currency || 'INR';
                    const currentCurrency = document.getElementById('currency-selector').value;
                    document.getElementById('currency-selector').value = quoteCurrency;
                    
                    // Apply currency conversion to all quote items if currency has changed
                    if (quoteCurrency !== currentCurrency && currentQuote.items) {
                        console.log('ðŸ’± Converting loaded quote from', quoteCurrency, 'to', currentCurrency);
                        currentQuote.items.forEach(item => {
                            if (item.unitPrice) {
                                item.unitPrice = convertCurrency(item.unitPrice, quoteCurrency, currentCurrency);
                                item.totalPrice = item.unitPrice * item.quantity;
                            }
                        });
                        
                        // Convert summary amounts
                        if (currentQuote.subtotal) {
                            currentQuote.subtotal = convertCurrency(currentQuote.subtotal, quoteCurrency, currentCurrency);
                        }
                        if (currentQuote.discountAmount) {
                            currentQuote.discountAmount = convertCurrency(currentQuote.discountAmount, quoteCurrency, currentCurrency);
                        }
                        if (currentQuote.taxAmount) {
                            currentQuote.taxAmount = convertCurrency(currentQuote.taxAmount, quoteCurrency, currentCurrency);
                        }
                        if (currentQuote.shipping) {
                            currentQuote.shipping = convertCurrency(currentQuote.shipping, quoteCurrency, currentCurrency);
                        }
                        if (currentQuote.total) {
                            currentQuote.total = convertCurrency(currentQuote.total, quoteCurrency, currentCurrency);
                        }
                        
                        // Update currency in quote
                        currentQuote.currency = currentCurrency;
                    }
                    
                    // Update form fields
                    document.getElementById('quote-number').value = quote.number || '';
                    document.getElementById('quote-date').value = quote.date || '';
                    document.getElementById('salesperson-selector').value = quote.salesperson || '';
                    document.getElementById('discount-input').value = quote.discount || 0;
                    document.getElementById('tax-input').value = quote.tax || 18;
                    document.getElementById('shipping-input').value = quote.shipping || 0;
                    
                    // Set client if available
                    if (quote.client) {
                        document.getElementById('client-selector').value = quote.client.id || '';
                    }
                    
                    // Update displays
                    updateQuoteItemsDisplay();
                    updateQuoteSummary();
                    
                    showSuccess('Quote loaded successfully!');
                } else {
                    showError('Quote not found.');
                }
                
            } catch (error) {
                console.error('Error loading quote:', error);
                showError('Failed to load quote.');
            } finally {
                showLoading(false);
            }
        }

        // Helper function to calculate subtotal
        function calculateSubtotal() {
            return currentQuote.items.reduce((sum, item) => sum + item.totalPrice, 0);
        }

        // Helper function to calculate total
        function calculateTotal() {
            const subtotal = calculateSubtotal();
            const discount = parseFloat(document.getElementById('discount-input').value) || 0;
            const tax = parseFloat(document.getElementById('tax-input').value) || 0;
            const shipping = parseFloat(document.getElementById('shipping-input').value) || 0;
            
            const discountAmount = subtotal * (discount / 100);
            const taxableAmount = subtotal - discountAmount;
            const taxAmount = taxableAmount * (tax / 100);
            
            return taxableAmount + taxAmount + shipping;
        }

        // Helper function to format currency
        function formatCurrency(amount, currency) {
            const symbol = currencySymbols[currency] || currency + ' ';
            return `${symbol}${amount.toFixed(2)}`;
        }

        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Generate quote number
        function generateQuoteNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const time = String(date.getHours()).padStart(2, '0') + String(date.getMinutes()).padStart(2, '0');
            return `INH-${year}${month}${day}-${time}`;
        }



        // Clear quote
        function clearQuote() {
            if (confirm('Are you sure you want to clear the current quote? This action cannot be undone.')) {
                currentQuote.items = [];
                currentQuote.client = null;
                
                // Reset form
                document.getElementById('client-selector').value = '';
                document.getElementById('salesperson-selector').value = '';
                document.getElementById('price-list-selector').value = '';
                document.getElementById('discount-input').value = '0';
                document.getElementById('tax-input').value = '18';
                document.getElementById('shipping-input').value = '0';
                
                clearProductForm();
                updateQuoteItemsDisplay();
                updateQuoteSummary();
                
                showSuccess('Quote cleared successfully!');
            }
        }

        // Duplicate quote (placeholder)
        function duplicateQuote() {
            showError('Duplicate functionality will be implemented soon.');
        }

        // Load quote (placeholder)
        function loadQuote() {
            showError('Load quote functionality will be implemented soon.');
        }

        // Quote Management Actions

        // Recall quote for editing
        async function recallQuote(quoteId) {
            try {
                showLoading(true);
                
                let quote = null;
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    const quotes = await window.firebaseDB.getQuotes();
                    quote = quotes.find(q => q.id === quoteId);
                } else {
                    const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                    quote = savedQuotes.find(q => q.id === quoteId);
                }
                
                if (quote) {
                    // Load quote data into form
                    currentQuote = { ...quote };
                    
                    // Update form fields
                    document.getElementById('quote-number').value = quote.number || '';
                    document.getElementById('quote-date').value = quote.date || '';
                    document.getElementById('salesperson-selector').value = quote.salesperson || '';
                    document.getElementById('discount-input').value = quote.discount || 0;
                    document.getElementById('tax-input').value = quote.tax || 18;
                    document.getElementById('shipping-input').value = quote.shipping || 0;
                    
                    // Set client if available
                    if (quote.client) {
                        document.getElementById('client-selector').value = quote.client.id || '';
                    }
                    
                    // Update displays
                    updateQuoteItemsDisplay();
                    updateQuoteSummary();
                    
                    showSuccess('Quote recalled for editing!');
                    
                    // Scroll to top for better UX
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    showError('Quote not found.');
                }
                
            } catch (error) {
                console.error('Error recalling quote:', error);
                showError('Failed to recall quote.');
            } finally {
                showLoading(false);
            }
        }

        // Preview quote (generate proforma invoice)
        async function previewQuote(quoteId) {
            try {
                showLoading(true);
                
                let quote = null;
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    const quotes = await window.firebaseDB.getQuotes();
                    quote = quotes.find(q => q.id === quoteId);
                } else {
                    const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                    quote = savedQuotes.find(q => q.id === quoteId);
                }
                
                if (quote) {
                    // Generate proforma invoice preview (thermal printer format)
                    const proformaWindow = window.open('', '_blank', 'width=400,height=800');
                    const proformaHTML = generateProformaHTML(quote);
                    
                    proformaWindow.document.write(proformaHTML);
                    proformaWindow.document.close();
                    
                    // Pass quote data to the preview window for PDF generation
                    setTimeout(() => {
                        proformaWindow.postMessage({ type: 'QUOTE_DATA', quote: quote }, '*');
                    }, 100);
                    
                    showSuccess('Proforma invoice generated!');
                } else {
                    showError('Quote not found.');
                }
                
            } catch (error) {
                console.error('Error generating preview:', error);
                showError('Failed to generate preview.');
            } finally {
                showLoading(false);
            }
        }

        // Delete quote (update status to 'hold')
        async function deleteQuote(quoteId) {
            if (!confirm('Are you sure you want to delete this quote? It will be marked as "hold" status.')) {
                return;
            }
            
            try {
                showLoading(true);
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    // Update quote status to 'hold' in Firebase
                    await window.firebaseDB.updateAllData('quotes', quoteId, { status: 'hold', updatedAt: new Date().toISOString() });
                    showSuccess('Quote moved to hold status!');
                    
                    // Refresh saved quotes list
                    await loadSavedQuotes();
                } else {
                    // Update in localStorage
                    const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                    const quoteIndex = savedQuotes.findIndex(q => q.id === quoteId);
                    
                    if (quoteIndex !== -1) {
                        savedQuotes[quoteIndex].status = 'hold';
                        savedQuotes[quoteIndex].updatedAt = new Date().toISOString();
                        localStorage.setItem('savedQuotes', JSON.stringify(savedQuotes));
                        showSuccess('Quote moved to hold status!');
                        
                        // Refresh saved quotes list
                        loadSavedQuotesFromLocal();
                    } else {
                        showError('Quote not found.');
                    }
                }
                
            } catch (error) {
                console.error('Error deleting quote:', error);
                showError('Failed to delete quote.');
            } finally {
                showLoading(false);
            }
        }

        // Convert quote to order
        async function convertToOrder(quoteId) {
            if (!confirm('Are you sure you want to convert this quote to an order? This action cannot be undone.')) {
                return;
            }
            
            try {
                showLoading(true);
                
                let quote = null;
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    const quotes = await window.firebaseDB.getQuotes();
                    quote = quotes.find(q => q.id === quoteId);
                } else {
                    const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                    quote = savedQuotes.find(q => q.id === quoteId);
                }
                
                if (quote) {
                    // Create order data from quote
                    const orderData = {
                        ...quote,
                        id: undefined, // Remove quote ID
                        orderId: generateOrderNumber(),
                        quoteId: quote.id,
                        status: 'pending',
                        orderDate: new Date().toISOString(),
                        type: 'order'
                    };
                    
                    if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                        // Save to orders collection
                        await window.firebaseDB.saveOrder(orderData);
                        
                        // Update quote status to 'converted'
                        await window.firebaseDB.updateAllData('quotes', quoteId, { status: 'converted', updatedAt: new Date().toISOString() });
                        
                        showSuccess(`Quote converted to order ${orderData.orderId}!`);
                        
                        // Refresh saved quotes list
                        await loadSavedQuotes();
                    } else {
                        // Save to localStorage orders
                        const savedOrders = JSON.parse(localStorage.getItem('savedOrders') || '[]');
                        savedOrders.push(orderData);
                        localStorage.setItem('savedOrders', JSON.stringify(savedOrders));
                        
                        // Update quote status
                        const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                        const quoteIndex = savedQuotes.findIndex(q => q.id === quoteId);
                        if (quoteIndex !== -1) {
                            savedQuotes[quoteIndex].status = 'converted';
                            savedQuotes[quoteIndex].updatedAt = new Date().toISOString();
                            localStorage.setItem('savedQuotes', JSON.stringify(savedQuotes));
                        }
                        
                        showSuccess(`Quote converted to order ${orderData.orderId}!`);
                        
                        // Refresh saved quotes list
                        loadSavedQuotesFromLocal();
                    }
                } else {
                    showError('Quote not found.');
                }
                
            } catch (error) {
                console.error('Error converting to order:', error);
                showError('Failed to convert quote to order.');
            } finally {
                showLoading(false);
            }
        }

        // Generate proforma invoice HTML
        function generateProformaHTML(quote) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Proforma Invoice - ${quote.number}</title>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        /* Thermal Printer Optimized Styles */
                        * { box-sizing: border-box; }
                        body { 
                            font-family: 'Courier New', monospace; 
                            margin: 0; 
                            padding: 8px; 
                            max-width: 380px; 
                            width: 100%; 
                            font-size: 11px; 
                            line-height: 1.2; 
                            color: #000; 
                            background: #fff;
                        }
                        
                        .header { 
                            text-align: center; 
                            margin-bottom: 15px; 
                            border-bottom: 1px solid #000;
                            padding-bottom: 8px;
                        }
                        .header h1 { 
                            font-size: 14px; 
                            margin: 0 0 4px 0; 
                            font-weight: bold; 
                        }
                        .header h2 { 
                            font-size: 12px; 
                            margin: 0; 
                            font-weight: normal; 
                        }
                        
                        .quote-info { 
                            margin-bottom: 15px; 
                            font-size: 10px;
                        }
                        .quote-info p { 
                            margin: 2px 0; 
                            word-wrap: break-word;
                        }
                        
                        /* Thermal printer friendly item list */
                        .items-section {
                            margin-bottom: 15px;
                            border-top: 1px solid #000;
                            border-bottom: 1px solid #000;
                            padding: 8px 0;
                        }
                        .items-header {
                            font-weight: bold;
                            font-size: 11px;
                            margin-bottom: 8px;
                            text-align: center;
                        }
                        .item {
                            margin-bottom: 8px;
                            padding-bottom: 6px;
                            border-bottom: 1px dashed #000;
                        }
                        .item:last-child {
                            border-bottom: none;
                            margin-bottom: 0;
                        }
                        .item-line {
                            margin: 1px 0;
                            font-size: 10px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        .item-details {
                            flex: 1;
                            margin-right: 10px;
                        }
                        .item-calculation {
                            text-align: right;
                            font-weight: bold;
                            white-space: nowrap;
                        }
                        .item-price {
                            text-align: right;
                            font-weight: bold;
                        }
                        
                        .totals { 
                            font-size: 10px;
                            border-top: 2px solid #000;
                            padding-top: 8px;
                        }
                        .totals p { 
                            margin: 2px 0; 
                            display: flex; 
                            justify-content: space-between;
                        }
                        .total-row { 
                            font-weight: bold; 
                            font-size: 12px; 
                            border-top: 1px solid #000;
                            padding-top: 4px;
                            margin-top: 4px;
                        }
                        
                        /* Print optimizations */
                        @media print {
                            body { margin: 0; padding: 4px; }
                            .header { page-break-inside: avoid; }
                            .item { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>PROFORMA INVOICE</h1>
                        <h2>Indian Natural Hair</h2>
                    </div>
                    
                    <div class="quote-info">
                        <p><strong>Quote #:</strong> ${quote.number || 'N/A'}</p>
                        <p><strong>Date:</strong> ${quote.date || 'N/A'}</p>
                        <p><strong>Client:</strong> ${quote.client ? quote.client.clientName : 'N/A'}</p>
                        <p><strong>Salesperson:</strong> ${quote.salesperson || 'N/A'}</p>
                    </div>
                    
                    <div class="items-section">
                        <div class="items-header">ITEMS</div>
                        ${quote.items ? quote.items.map((item, index) => 
                            '<div class="item">' +
                                '<div class="item-line">' +
                                    '<span class="item-details">' +
                                        '<strong>' + (item.product || 'N/A') + '</strong> | ' +
                                        (item.category || 'N/A') + ' | ' +
                                        (item.density || 'N/A') + ' | ' +
                                        (item.length || 'N/A') + ' | ' +
                                        (item.color || 'N/A') + ' | ' +
                                        (item.style || 'N/A') +
                                    '</span>' +
                                    '<span class="item-calculation">' +
                                        'Qty: ' + (item.quantity || 0) + ' x ' + formatCurrency(item.unitPrice || 0, quote.currency || 'INR') + ' = ' +
                                        formatCurrency(item.totalPrice || 0, quote.currency || 'INR') +
                                    '</span>' +
                                '</div>' +
                            '</div>'
                        ).join('') : '<div class="item">No items</div>'}
                    </div>
                    
                    <div class="totals">
                        <p><span>Subtotal:</span><span>${formatCurrency(quote.subtotal || 0, quote.currency || 'INR')}</span></p>
                        <p><span>Discount:</span><span>${formatCurrency(quote.discountAmount || 0, quote.currency || 'INR')}</span></p>
                        <p><span>Tax (${quote.tax || 0}%):</span><span>${formatCurrency(quote.taxAmount || 0, quote.currency || 'INR')}</span></p>
                        <p><span>Shipping:</span><span>${formatCurrency(quote.shipping || 0, quote.currency || 'INR')}</span></p>
                        <p class="total-row"><span>TOTAL:</span><span>${formatCurrency(quote.total || 0, quote.currency || 'INR')}</span></p>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center; border-top: 1px solid #000; padding-top: 15px;">
                        <button onclick="downloadPDF()" style="background-color: #081249; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 12px; cursor: pointer; margin-right: 10px;">
                            ðŸ“„ Download PDF
                        </button>
                        <button onclick="window.print()" style="background-color: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 12px; cursor: pointer;">
                            ðŸ–¨ï¸ Print
                        </button>
                    </div>
                    
                    <scr` + `ipt>
                        // Include jsPDF in the preview window
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                        document.head.appendChild(script);
                        
                        // Quote data will be received via postMessage
                        let quoteData = null;
                        
                        // Listen for quote data from parent window
                        window.addEventListener('message', function(event) {
                            if (event.data.type === 'QUOTE_DATA') {
                                quoteData = event.data.quote;
                            }
                        });
                        
                        // Format currency function
                        function formatCurrency(amount, currency = 'INR') {
                            const symbols = {
                                'INR': 'â‚¹',
                                'USD': '$',
                                'EUR': 'â‚¬',
                                'GBP': 'Â£'
                            };
                            const symbol = symbols[currency] || currency;
                            return symbol + ' ' + parseFloat(amount || 0).toFixed(2);
                        }
                        
                        // Download PDF function
                        async function downloadPDF() {
                            try {
                                // Wait for jsPDF to load
                                if (!window.jspdf) {
                                    alert('PDF library is loading, please try again in a moment.');
                                    return;
                                }
                                
                                const { jsPDF } = window.jspdf;
                                const doc = new jsPDF({
                                    orientation: 'portrait',
                                    unit: 'mm',
                                    format: 'a4'
                                });

                                // Set font
                                doc.setFont('helvetica');
                                
                                // Header
                                doc.setFontSize(18);
                                doc.setFont('helvetica', 'bold');
                                doc.text('PROFORMA INVOICE', 105, 20, { align: 'center' });
                                
                                doc.setFontSize(14);
                                doc.setFont('helvetica', 'normal');
                                doc.text('Indian Natural Hair', 105, 30, { align: 'center' });
                                
                                // Quote information
                                let yPos = 50;
                                doc.setFontSize(10);
                                doc.setFont('helvetica', 'bold');
                                doc.text('Quote #:', 20, yPos);
                                doc.setFont('helvetica', 'normal');
                                doc.text(quoteData.number || 'N/A', 50, yPos);
                                
                                yPos += 7;
                                doc.setFont('helvetica', 'bold');
                                doc.text('Date:', 20, yPos);
                                doc.setFont('helvetica', 'normal');
                                doc.text(quoteData.date || 'N/A', 50, yPos);
                                
                                yPos += 7;
                                doc.setFont('helvetica', 'bold');
                                doc.text('Client:', 20, yPos);
                                doc.setFont('helvetica', 'normal');
                                doc.text(quoteData.client ? quoteData.client.clientName : 'N/A', 50, yPos);
                                
                                yPos += 7;
                                doc.setFont('helvetica', 'bold');
                                doc.text('Salesperson:', 20, yPos);
                                doc.setFont('helvetica', 'normal');
                                doc.text(quoteData.salesperson || 'N/A', 50, yPos);
                                
                                // Items section
                                yPos += 15;
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(12);
                                doc.text('ITEMS', 20, yPos);
                                
                                yPos += 10;
                                doc.setFontSize(9);
                                
                                // Table headers
                                doc.setFont('helvetica', 'bold');
                                doc.text('Product', 20, yPos);
                                doc.text('Details', 60, yPos);
                                doc.text('Qty', 130, yPos);
                                doc.text('Unit Price', 150, yPos);
                                doc.text('Total', 180, yPos);
                                
                                yPos += 5;
                                doc.line(20, yPos, 190, yPos);
                                yPos += 5;
                                
                                // Items
                                doc.setFont('helvetica', 'normal');
                                if (quoteData.items && quoteData.items.length > 0) {
                                    quoteData.items.forEach((item) => {
                                        if (yPos > 250) {
                                            doc.addPage();
                                            yPos = 20;
                                        }
                                        
                                        doc.text(item.product || 'N/A', 20, yPos);
                                        
                                        const details = [
                                            item.category || '',
                                            item.density || '',
                                            item.length || '',
                                            item.color || '',
                                            item.style || ''
                                        ].filter(d => d).join(' | ');
                                        
                                        const detailsLines = doc.splitTextToSize(details, 65);
                                        doc.text(detailsLines, 60, yPos);
                                        
                                        doc.text(String(item.quantity || 0), 130, yPos);
                                        doc.text(formatCurrency(item.unitPrice || 0, quoteData.currency || 'INR'), 150, yPos);
                                        doc.text(formatCurrency(item.totalPrice || 0, quoteData.currency || 'INR'), 180, yPos);
                                        
                                        yPos += Math.max(7, detailsLines.length * 4);
                                    });
                                } else {
                                    doc.text('No items', 20, yPos);
                                    yPos += 7;
                                }
                                
                                // Totals section
                                yPos += 10;
                                doc.line(20, yPos, 190, yPos);
                                yPos += 10;
                                
                                doc.setFont('helvetica', 'normal');
                                doc.text('Subtotal:', 130, yPos);
                                doc.text(formatCurrency(quoteData.subtotal || 0, quoteData.currency || 'INR'), 180, yPos);
                                
                                yPos += 7;
                                doc.text('Discount:', 130, yPos);
                                doc.text(formatCurrency(quoteData.discountAmount || 0, quoteData.currency || 'INR'), 180, yPos);
                                
                                yPos += 7;
                                doc.text('Tax (' + (quoteData.tax || 0) + '%):', 130, yPos);
                                doc.text(formatCurrency(quoteData.taxAmount || 0, quoteData.currency || 'INR'), 180, yPos);
                                
                                yPos += 7;
                                doc.text('Shipping:', 130, yPos);
                                doc.text(formatCurrency(quoteData.shipping || 0, quoteData.currency || 'INR'), 180, yPos);
                                
                                yPos += 10;
                                doc.line(130, yPos, 190, yPos);
                                yPos += 7;
                                
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(12);
                                doc.text('TOTAL:', 130, yPos);
                                doc.text(formatCurrency(quoteData.total || 0, quoteData.currency || 'INR'), 180, yPos);
                                
                                // Save the PDF
                                const fileName = 'Proforma_Invoice_' + (quoteData.number || 'Quote') + '.pdf';
                                doc.save(fileName);
                                
                            } catch (error) {
                                console.error('Error generating PDF:', error);
                                alert('Error generating PDF. Please try again.');
                            }
                         }
                     });
    </scr` + `ipt>
                </body>
                </html>
            `;
        }

        // Generate order number
        function generateOrderNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const time = String(date.getHours()).padStart(2, '0') + String(date.getMinutes()).padStart(2, '0');
            return `ORD-${year}${month}${day}-${time}`;
        }

    </script>
</body>
</html>