<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotes - Indian Natural Hair</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    
    <!-- Language Configuration (Load First) -->
    <script src="js/language-config.js"></script>
    
    <!-- Firebase Configuration (Load Before Global Init) -->
    <script src="firebase-config.js?v=2"></script>
    
    <!-- Firebase global initialization -->
    <script src="firebase-global-init.js?v=2"></script>
    <script src="firebase-database.js?v=2"></script>
    <script src="firebase-error-handler.js?v=2"></script>
    <script src="client-management.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- HTML2Canvas for image generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Unified Button System -->
    <link rel="stylesheet" href="unified-button-system.css">
    
    <!-- Custom Styles -->
    <style>
        /* Custom CSS for responsive design and styling */
        .mobile-padding { padding: 1rem; }
        .shadow-soft { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        /* Mobile-first responsive design */
        @media (max-width: 640px) {
            .mobile-padding { padding: 0.75rem; }
        }
        
        @media (max-width: 480px) {
            .mobile-padding { padding: 0.5rem; }
        }
        
        /* Header styles matching reference files */
        .page-header {
            background: linear-gradient(135deg, #081249 0%, #1e3a8a 50%, #9b7952 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Navigation back button */
        .nav-back {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        
        .nav-back:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(-2px);
        }
        
        /* Card hover effects matching reference files */
        .card-hover {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Button styles now handled by unified-button-system.css */
        .btn-primary {
            background: linear-gradient(135deg, #081249 0%, #1e3a8a 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        /* Enhanced Custom Container Styles */
        .custom-color-container, .custom-style-container {
            margin-top: 8px;
            padding: 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(-5px);
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            min-width: 320px;
        }
        
        .custom-color-container.show, .custom-style-container.show {
            opacity: 1;
            max-height: 120px;
            transform: translateY(0);
        }
        
        /* Collapsed state when content is present - higher specificity */
        .custom-color-container.show.collapsed, .custom-style-container.show.collapsed {
            opacity: 1;
            max-height: 60px !important;
            padding: 12px 16px;
            transform: translateY(0);
        }
        
        /* Expanded state when image is uploaded */
        .custom-color-container.show.has-image, .custom-style-container.show.has-image {
            max-height: 240px;
            min-height: 180px;
        }
        
        /* Ensure smooth transition when expanding for images */
        .custom-color-container.has-image, .custom-style-container.has-image {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .custom-color-container.show.collapsed textarea, 
        .custom-style-container.show.collapsed textarea {
            min-height: 32px !important;
            padding: 8px 12px !important;
            font-size: 14px !important;
        }
        
        .custom-color-container:hover, .custom-style-container:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        /* Enhanced Custom Input Field Styling */
        .custom-color-container textarea, 
        .custom-style-container textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.3s ease;
            background: white;
            margin-bottom: 0;
            min-height: 40px;
            resize: vertical;
            line-height: 1.4;
        }
        
        .custom-color-container textarea:focus, 
        .custom-style-container textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Image Upload Button Styling */
        .custom-color-container button, 
        .custom-style-container button {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .custom-color-container button:hover, 
        .custom-style-container button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
        }
        
        .custom-color-container button:disabled, 
        .custom-style-container button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Enhanced Image Preview Styling */
        .custom-color-container .image-preview, 
        .custom-style-container .image-preview {
            position: relative;
            margin-top: 12px;
            padding: 12px;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .custom-color-container .image-preview:hover, 
        .custom-style-container .image-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border-color: #007bff;
        }
        
        .custom-color-container .image-preview img, 
        .custom-style-container .image-preview img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        
        .custom-color-container .image-preview:hover img, 
        .custom-style-container .image-preview:hover img {
            transform: scale(1.05);
        }
        
        /* Remove Image Button */
        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 8px rgba(239, 68, 68, 0.4);
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .remove-image-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.6);
        }
        
        .remove-image-btn:active {
            transform: scale(0.95);
        }
        
        /* Image Upload Loading State */
        .image-upload-loading {
            position: relative;
            pointer-events: none;
        }
        
        .image-upload-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Validation Error Styling */
        .custom-input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        /* Enhanced Tooltip Styling */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: left;
            border-radius: 8px;
            padding: 12px 16px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
            line-height: 1.4;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #667eea transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(-5px);
        }

        /* Responsive tooltip positioning */
        @media (max-width: 768px) {
            .tooltip .tooltiptext {
                width: 180px;
                margin-left: -90px;
                font-size: 12px;
                padding: 10px 12px;
            }
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(8, 18, 73, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #081249;
            border: 2px solid #081249;
            padding: 10px 22px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #081249;
            color: white;
        }
        
        .form-input {
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: all 0.3s ease;
            background: white;
            width: 100%;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-select {
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: all 0.3s ease;
            background: white;
            width: 100%;
        }
        
        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .quote-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .quote-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-draft {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-sent {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-accepted {
            background: #d1fae5;
            color: #065f46;
        }

        /* Action buttons */
        .action-btn {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
            font-size: 11px;
            gap: 6px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .action-btn-text {
            font-weight: 500;
            line-height: 1;
            white-space: nowrap;
        }

        .action-btn-icon {
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .action-btn-recall {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .action-btn-recall:hover {
            background: #eff6ff;
            border-color: #2563eb;
        }

        .action-btn-preview {
            border-color: #10b981;
            color: #10b981;
        }

        .action-btn-preview:hover {
            background: #ecfdf5;
            border-color: #059669;
        }

        .action-btn-delete {
            border-color: #ef4444;
            color: #ef4444;
        }

        .action-btn-delete:hover {
            background: #fef2f2;
            border-color: #dc2626;
        }

        .action-btn-convert {
            border-color: #8b5cf6;
            color: #8b5cf6;
        }

        .action-btn-convert:hover {
            background: #f5f3ff;
            border-color: #7c3aed;
        }

        /* Compact action buttons for saved quotes */
        .action-btn-compact {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px 6px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 24px;
            height: 24px;
            font-size: 10px;
        }

        .action-btn-compact:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .action-btn-compact.action-btn-recall {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        /* Mobile responsive design matching other pages */
        @media (max-width: 768px) {
            .page-header {
                padding: 1.5rem 0;
            }
            
            .page-header h1 {
                font-size: 2rem;
            }
            
            .page-header p {
                font-size: 1rem;
            }
            
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .card {
                margin-bottom: 1rem;
            }
            
            .grid {
                gap: 0.75rem;
            }
            
            .btn-primary {
                padding: 10px 20px;
                font-size: 0.875rem;
            }
        }
        
        /* Shadow effects matching other pages */
        .shadow-soft {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Card hover effects matching other pages */
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .action-btn-compact.action-btn-recall:hover {
            background: #eff6ff;
            border-color: #2563eb;
        }

        .action-btn-compact.action-btn-preview {
            border-color: #10b981;
            color: #10b981;
        }

        .action-btn-compact.action-btn-preview:hover {
            background: #ecfdf5;
            border-color: #059669;
        }

        .action-btn-compact.action-btn-delete {
            border-color: #ef4444;
            color: #ef4444;
        }

        .action-btn-compact.action-btn-delete:hover {
            background: #fef2f2;
            border-color: #dc2626;
        }

        .action-btn-compact.action-btn-convert {
            border-color: #8b5cf6;
            color: #8b5cf6;
        }

        .action-btn-compact.action-btn-convert:hover {
            background: #f5f3ff;
            border-color: #7c3aed;
        }

        /* Enhanced tooltips for compact buttons */
        .action-btn-compact {
            position: relative;
        }

        .action-btn-compact::before {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            pointer-events: none;
            z-index: 1000;
            margin-bottom: 5px;
        }

        .action-btn-compact::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            pointer-events: none;
            z-index: 1000;
            margin-bottom: 1px;
        }

        .action-btn-compact:hover::before,
        .action-btn-compact:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Remove default browser tooltip */
        .action-btn-compact[title] {
            position: relative;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #e5e7eb;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-slate-800">

    <!-- Navigation Component -->
    <nav class="bg-gradient-to-r from-blue-900 via-blue-800 to-amber-700 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo and Title -->
                <div class="flex items-center space-x-3">
                    <img src="images/logo.png" alt="Logo" class="h-8 w-auto opacity-90">
                    <span class="text-lg font-bold">InstaQuote</span>
                </div>
                
                <!-- Navigation Links -->
                <div class="hidden md:flex items-center space-x-4">
                    <span class="px-3 py-2 rounded-md text-sm font-medium bg-white/20">
                        <i class="fas fa-file-invoice-dollar mr-1"></i> Quote Maker
                    </span>
                    <a href="price-calculator.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-white/10 transition-colors">
                        <i class="fas fa-calculator mr-1"></i> Calculator
                    </a>
                    <a href="product-catalog.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-white/10 transition-colors">
                        <i class="fas fa-th-large mr-1"></i> Catalog
                    </a>
                    <a href="admin-panel.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-white/10 transition-colors">
                        <i class="fas fa-cog mr-1"></i> Admin
                    </a>
                </div>
                
                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button id="mobile-menu-btn" class="p-2 rounded-md hover:bg-white/10 transition-colors">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Menu -->
            <div id="mobile-menu" class="md:hidden hidden pb-3">
                <div class="space-y-1">
                    <span class="block px-3 py-2 rounded-md text-sm font-medium bg-white/20">
                        <i class="fas fa-file-invoice-dollar mr-2"></i> Quote Maker
                    </span>
                    <a href="price-calculator.html" class="block px-3 py-2 rounded-md text-sm font-medium hover:bg-white/10 transition-colors">
                        <i class="fas fa-calculator mr-2"></i> Price Calculator
                    </a>
                    <a href="product-catalog.html" class="block px-3 py-2 rounded-md text-sm font-medium hover:bg-white/10 transition-colors">
                        <i class="fas fa-th-large mr-2"></i> Product Catalog
                    </a>
                    <a href="admin-panel.html" class="block px-3 py-2 rounded-md text-sm font-medium hover:bg-white/10 transition-colors">
                        <i class="fas fa-cog mr-2"></i> Admin Panel
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <!-- Page Header -->
        <div class="text-left mb-8">
            <h1 class="text-3xl font-bold mb-2" style="color: #081249;">Quotes</h1>
        </div>
            
            <!-- Quote Builder -->
            <div class="space-y-6">
                
                <!-- Quote Information -->
                <section class="bg-white rounded-xl shadow-soft p-4 sm:p-6 mb-4 mobile-padding" style="background: #eef2ff;">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Quote Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div>
                            <input type="text" id="quote-number" class="form-input" placeholder="Quote Number (Auto-generated)" readonly>
                        </div>
                        <div>
                            <input type="date" id="quote-date" class="form-input" placeholder="Date">
                        </div>
                        <div>
                            <select id="client-selector" class="form-select">
                                <option value="">Select Client</option>
                                <option value="add-new">+ Add New Client</option>
                            </select>
                        </div>
                        <div>
                            <select id="salesperson-selector" class="form-select">
                                <option value="">Select Salesperson</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- Product Selection -->
                <section class="bg-white rounded-xl shadow-soft p-4 sm:p-6 mb-4 mobile-padding" style="background: #eef2ff;">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Add Products</h2>
                    
                    <!-- Price List and Currency -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                        <div>
                            <select id="price-list-selector" class="form-select">
                                <option value="">Select Price List</option>
                            </select>
                        </div>
                        <div>
                            <select id="currency-selector" class="form-select">
                                <option value="INR">INR (₹)</option>
                                <option value="USD">USD ($)</option>
                                <option value="EUR">EUR (€)</option>
                                <option value="GBP">GBP (£)</option>
                                <option value="AUD">AUD (A$)</option>
                                <option value="AED">AED (د.إ)</option>
                                <option value="NGN">NGN (₦)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Product Selectors -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 mb-4">
                        <div>
                            <select id="category-selector" class="form-select" disabled>
                                <option value="">Category</option>
                            </select>
                        </div>
                        <div>
                            <select id="product-selector" class="form-select" disabled>
                                <option value="">Product</option>
                            </select>
                        </div>
                        <div>
                            <select id="density-selector" class="form-select" disabled>
                                <option value="">Density</option>
                            </select>
                        </div>
                        <div>
                            <select id="length-selector" class="form-select" disabled>
                                <option value="">Length</option>
                            </select>
                        </div>
                        <div>
                            <select id="color-type-selector" class="form-select" disabled>
                                <option value="">Color Type</option>
                            </select>
                        </div>
                        <div>
                            <select id="color-selector" class="form-select mb-2" disabled>
                                <option value="">Select Color</option>
                            </select>
                            <div class="custom-color-container" style="display: none;">
                                <div class="flex gap-2 items-start">
                                    <div class="flex-1 tooltip">
                                        <textarea id="custom-color-input" class="form-input w-full" placeholder="Enter custom color name or description" disabled rows="1"></textarea>
                                        <span class="tooltiptext">Enter a descriptive name for your custom color (e.g., "Midnight Blue", "Rose Gold")</span>
                                        <div class="error-message" id="custom-color-error">Please enter a color name</div>
                                    </div>
                                    <div class="flex gap-2 items-center">
                                        <div class="tooltip">
                                            <button type="button" id="color-image-btn" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300" disabled>
                                                <i class="fas fa-camera mr-1"></i> Image
                                            </button>
                                            <span class="tooltiptext">Upload an image to show the color reference</span>
                                        </div>
                                        <button type="button" id="custom-color-ok-btn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm whitespace-nowrap">
                                            <i class="fas fa-check mr-1"></i> OK
                                        </button>
                                    </div>
                                </div>
                                <input type="file" id="color-image-input" accept="image/*" class="hidden">
                                <div id="color-image-preview" class="image-preview hidden mt-2">
                                    <img id="color-image-display" class="w-16 h-16 object-cover rounded border" alt="Color image">
                                    <button type="button" id="remove-color-image" class="ml-2 text-red-500 hover:text-red-700 text-sm">
                                        <i class="fas fa-times mr-1"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <select id="style-selector" class="form-select mb-2" disabled>
                                <option value="">Select Style</option>
                            </select>
                            <div class="custom-style-container" style="display: none;">
                                <div class="flex gap-2 items-start">
                                    <div class="flex-1 tooltip">
                                        <textarea id="custom-style-input" class="form-input w-full" placeholder="Enter custom style name or description" disabled rows="1"></textarea>
                                        <span class="tooltiptext">Enter a descriptive name for your custom style (e.g., "Beach Waves", "Straight & Silky")</span>
                                        <div class="error-message" id="custom-style-error">Please enter a style name</div>
                                    </div>
                                    <div class="flex gap-2 items-center">
                                        <div class="tooltip">
                                            <button type="button" id="style-image-btn" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300" disabled>
                                                <i class="fas fa-camera mr-1"></i> Image
                                            </button>
                                            <span class="tooltiptext">Upload an image to show the style reference</span>
                                        </div>
                                        <button type="button" id="custom-style-ok-btn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm whitespace-nowrap">
                                            <i class="fas fa-check mr-1"></i> OK
                                        </button>
                                    </div>
                                </div>
                                <input type="file" id="style-image-input" accept="image/*" class="hidden">
                                <div id="style-image-preview" class="image-preview hidden mt-2">
                                    <img id="style-image-display" class="w-16 h-16 object-cover rounded border" alt="Style image">
                                    <button type="button" id="remove-style-image" class="ml-2 text-red-500 hover:text-red-700 text-sm">
                                        <i class="fas fa-times mr-1"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quantity and Price -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
                        <div>
                            <input type="number" id="quantity-input" class="form-input" min="1" value="1" placeholder="Quantity">
                        </div>
                        <div>
                            <input type="number" id="unit-price-input" class="form-input" step="0.01" placeholder="Unit Price (Auto-calculated)">
                        </div>
                        <div class="md:col-span-2">
                            <button id="add-item-btn" class="btn-primary w-full" disabled>
                                <span class="mr-2">➕</span> Add Item
                            </button>
                        </div>
                    </div>

                    <!-- Current Price Display -->
                    <div id="price-display" class="bg-blue-50 border border-blue-200 rounded-lg p-4 hidden">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-blue-800">Calculated Price:</span>
                            <span id="calculated-price" class="text-lg font-bold text-blue-900"></span>
                        </div>
                    </div>
                </section>

                <!-- Quote Items -->
                <section class="bg-white rounded-xl shadow-soft p-4 sm:p-6 mb-4 mobile-padding" style="background: #eef2ff;">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Quote Items</h2>
                    <div id="quote-items-container">
                        <div class="text-center text-gray-500 py-8">
                            <p>No items added yet. Use the form above to add products to your quote.</p>
                        </div>
                    </div>
                </section>

                <!-- Quote Summary -->
                <section class="bg-white rounded-xl shadow-soft p-4 sm:p-6 mb-4 mobile-padding" style="background: #eef2ff;">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Quote Summary</h2>
                    
                    <div class="space-y-3">
                        <!-- Subtotal Row -->
                        <div class="flex justify-between items-center py-1">
                            <span class="text-gray-600 font-medium">Subtotal</span>
                            <span id="subtotal-amount" class="font-semibold text-right">₹0.00</span>
                        </div>
                        
                        <!-- Discount Field -->
                        <div class="flex justify-between items-center py-1">
                            <div class="flex-1 relative">
                                <label for="discount-input" class="absolute left-2 top-1/2 transform -translate-y-1/2 text-xs text-gray-500 pointer-events-none">Discount</label>
                                <input type="text" id="discount-input" class="form-input text-left text-sm w-full pl-16" value="0" placeholder="Enter discount (0 or 0%)">
                            </div>
                            <div class="ml-3 text-right min-w-20">
                                <span id="discount-amount" class="text-sm text-gray-600 font-medium">₹0.00</span>
                            </div>
                        </div>
                        
                        <!-- Tax Field -->
                        <div class="flex justify-between items-center py-1">
                            <div class="flex-1">
                                <select id="tax-input" class="form-input text-left text-sm w-full">
                                    <option value="0">Tax: 0%</option>
                                    <option value="5">Tax: 5%</option>
                                    <option value="12">Tax: 12%</option>
                                    <option value="18" selected>Tax: 18%</option>
                                </select>
                            </div>
                            <div class="ml-3 text-right min-w-20">
                                <span id="tax-amount" class="text-sm text-gray-600 font-medium">₹0.00</span>
                            </div>
                        </div>
                        
                        <!-- Shipping Field -->
                        <div class="flex justify-between items-center py-1">
                            <div class="flex-1 relative">
                                <label for="shipping-input" class="absolute left-2 top-1/2 transform -translate-y-1/2 text-xs text-gray-500 pointer-events-none">Shipping</label>
                                <input type="number" id="shipping-input" class="form-input text-left text-sm w-full pl-16" min="0" step="0.01" value="0" placeholder="Enter shipping amount">
                            </div>
                            <div class="ml-3 text-right min-w-20">
                                <span id="shipping-currency-symbol" class="text-sm text-gray-600 font-medium">₹</span>
                            </div>
                        </div>
                        
                        <hr class="my-3 border-gray-300">
                        
                        <!-- Total Row -->
                        <div class="flex justify-between items-center py-2 bg-blue-50 px-3 rounded-lg">
                            <span class="text-lg font-bold text-gray-800">Total</span>
                            <span id="total-amount" class="text-lg font-bold text-blue-600 text-right">₹0.00</span>
                        </div>
                    </div>
                    
                    <!-- Save Quote Button -->
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <button id="save-quote-btn" class="btn-primary w-full">
                            <span class="mr-2">💾</span> Save Quote
                        </button>
                    </div>
                </section>

                <!-- Saved Quotes -->
                <section class="bg-white rounded-xl shadow-soft p-4 sm:p-6 mb-4 mobile-padding" style="background: #eef2ff;">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Saved Quotes</h2>
                    <div id="saved-quotes-container">
                        <div class="text-center text-gray-500 py-4">
                            <div class="loading mx-auto mb-2"></div>
                            <p class="text-sm">Loading saved quotes...</p>
                        </div>
                    </div>
                </section>
            </div>
    </div>

    <!-- Add Client Modal -->
    <div id="add-client-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Add New Client</h3>
                        <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="add-client-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Client Name *</label>
                                <input type="text" id="client-name" class="form-input" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                                <input type="text" id="company-name" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="client-email" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                <input type="tel" id="client-phone" class="form-input">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                            <textarea id="client-address" class="form-input" rows="3"></textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" id="cancel-client-btn" class="btn-secondary">Cancel</button>
                            <button type="submit" class="btn-primary">Add Client</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-lg p-6 text-center">
                <div class="loading mx-auto mb-4"></div>
                <p class="text-gray-600">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/universal-firebase-data-manager.js"></script>
    
    <!-- Fallback System Components -->
    <script src="js/local-fallback-manager.js?v=3"></script>
    <script src="js/fallback-detector.js"></script>
    <script src="js/unified-data-access.js"></script>
    
    <script>
        // Firebase Readiness Check
        function waitForFirebase() {
            return new Promise((resolve) => {
                if (window.globalFirebase && window.globalFirebase.isAvailable()) {
                    resolve();
                } else {
                    // Wait for global Firebase to be ready
                    const checkInterval = setInterval(() => {
                        if (window.globalFirebase && window.globalFirebase.isAvailable()) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                    
                    // Fallback timeout
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        console.warn('⚠️ Global Firebase not ready, proceeding with local initialization');
                        resolve();
                    }, 5000);
                }
            });
        }
        
        // Firebase ready check will be handled in main initialization
    </script>
    
    <script>
        // Global variables
        let currentQuote = {
            number: '',
            date: '',
            client: null,
            salesperson: '',
            currency: 'INR',
            priceList: '',
            items: [],
            subtotal: 0,
            discount: 0,
            tax: 18,
            total: 0,
            status: 'draft'
        };
        
        // Defensive variable declarations to prevent redeclaration errors
        if (typeof productData === 'undefined') {
            var productData = [];
        }
        if (typeof clientData === 'undefined') {
            var clientData = [];
        }
        if (typeof salesmenData === 'undefined') {
            var salesmenData = [];
        }
        if (typeof stylesData === 'undefined') {
            var stylesData = [];
        }
        if (typeof colorsData === 'undefined') {
            var colorsData = [];
        }
        
        // All data will be loaded directly from Firebase
        // No fallback data - Firebase connection is required
        
        let isManualPriceEntry = false; // Track if user is manually entering price
        
        // Currency symbols
        const currencySymbols = {
            'INR': '₹',
            'USD': '$',
            'EUR': '€',
            'GBP': '£',
            'AUD': 'A$',
            'AED': 'د.إ ',
            'NGN': '₦',
            'CAD': 'C$',
            'JPY': '¥'
        };

        // Exchange rates (base: INR)
        let exchangeRates = {
            'INR': 1,
            'USD': 0.012,
            'EUR': 0.011,
            'GBP': 0.0095,
            'AUD': 0.018,
            'AED': 0.044,
            'NGN': 19.5,
            'CAD': 0.016,
            'JPY': 1.8
        };

        // Fetch real-time exchange rates
        async function fetchExchangeRates() {
            try {
                // Using multiple APIs for better reliability
                let data = null;
                
                // Try primary API first
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/INR');
                    data = await response.json();
                } catch (e) {
                    console.warn('Primary API failed, trying backup...');
                    // Backup API
                    const response = await fetch('https://api.fixer.io/latest?base=INR&access_key=YOUR_API_KEY');
                    data = await response.json();
                }
                
                if (data && data.rates) {
                    const newRates = {
                        'INR': 1,
                        'USD': data.rates.USD || exchangeRates.USD,
                        'EUR': data.rates.EUR || exchangeRates.EUR,
                        'GBP': data.rates.GBP || exchangeRates.GBP,
                        'AUD': data.rates.AUD || exchangeRates.AUD,
                        'AED': data.rates.AED || exchangeRates.AED,
                        'NGN': data.rates.NGN || exchangeRates.NGN,
                        'CAD': data.rates.CAD || exchangeRates.CAD,
                        'JPY': data.rates.JPY || exchangeRates.JPY
                    };
                    
                    // Update rates and recalculate all prices if rates changed
                    const ratesChanged = JSON.stringify(exchangeRates) !== JSON.stringify(newRates);
                    exchangeRates = newRates;
                    
                    if (ratesChanged && currentQuote.items.length > 0) {
                        updatePricing();
                        updateQuoteSummary();
                    }
                    
                    console.log('✅ Exchange rates updated successfully', exchangeRates);
                }
            } catch (error) {
                console.warn('⚠️ Failed to fetch exchange rates, using default rates:', error);
            }
        }

        // Convert amount between currencies
        function convertCurrency(amount, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) return amount;
            
            // Convert to INR first, then to target currency
            const inrAmount = amount / exchangeRates[fromCurrency];
            return inrAmount * exchangeRates[toCurrency];
        }

        // Start periodic exchange rate updates
        function startExchangeRateUpdates() {
            // Update rates every 30 minutes
            setInterval(async () => {
                console.log('🔄 Updating exchange rates...');
                await fetchExchangeRates();
                // Recalculate current quote with new rates
                recalculateWithCurrentRates();
            }, 30 * 60 * 1000);
        }

        // Recalculate all prices with current exchange rates
        function recalculateWithCurrentRates() {
            if (currentQuote && currentQuote.items && currentQuote.items.length > 0) {
                console.log('🔄 Recalculating quote with current exchange rates...');
                
                // Update pricing for current product selection
                updatePricing();
                
                // Update quote summary
                updateQuoteSummary();
                
                // Update quote items display
                updateQuoteItemsDisplay();
                
                console.log('✅ Quote recalculated with current exchange rates');
            }
        }



        // Global initialization function that can be called manually
        async function initializeQuoteMaker() {
            console.log('🔍 DEBUG: initializeQuoteMaker called');
            console.log('🔍 DEBUG: Current window.quoteMakerInitialized:', window.quoteMakerInitialized);
            console.log('🔍 DEBUG: Current window.universalDataManager:', window.universalDataManager);
            
            // Prevent multiple initializations
            if (window.quoteMakerInitialized) {
                console.log('Quote Maker already initialized, skipping...');
                return;
            }
            
            console.log('🚀 Starting Quote Maker initialization...');
            showLoading(true);
            
            try {
                // Initialize fallback system first
                console.log('🔍 DEBUG: Initializing fallback system...');
                try {
                    window.localFallbackManager = new LocalFallbackManager();
                    window.fallbackDetector = new FallbackDetector(window.localFallbackManager);
                    window.unifiedDataAccess = new UnifiedDataAccess(window.fallbackDetector, window.localFallbackManager);
                    
                    await window.fallbackDetector.initialize();
                    console.log('✅ Fallback system initialized for quote maker');
                } catch (fallbackError) {
                    console.warn('⚠️ Fallback system initialization failed, continuing with Firebase only:', fallbackError);
                }
                
                console.log('🔍 DEBUG: About to wait for Firebase...');
                // Wait for Firebase to be ready first
                await waitForFirebase();
                console.log('✅ Firebase ready for quote maker');
                
                console.log('🔍 DEBUG: About to initialize Firebase...');
                // Initialize Firebase
                await initializeFirebase();
                console.log('🔍 DEBUG: Firebase initialization completed');
                
                console.log('🔍 DEBUG: About to fetch exchange rates...');
                // Fetch real-time exchange rates
                await fetchExchangeRates();
                console.log('🔍 DEBUG: Exchange rates fetched');
                
                console.log('🔍 DEBUG: Starting exchange rate updates...');
                // Start periodic exchange rate updates
                startExchangeRateUpdates();
                
                console.log('🔍 DEBUG: About to load all data...');
                // Load initial data
                await loadAllData();
                console.log('🔍 DEBUG: All data loaded');
                
                console.log('🔍 DEBUG: Setting up event listeners...');
                // Setup event listeners
                setupEventListeners();
                
                console.log('🔍 DEBUG: Initializing quote...');
                // Initialize quote
                initializeQuote();
                
                console.log('🔍 DEBUG: Loading saved quotes...');
                // Load saved quotes
                await loadSavedQuotes();
                
                // Mark as initialized
                window.quoteMakerInitialized = true;
                
                console.log('✅ Quote Maker v2 initialized successfully');
                
            } catch (error) {
                console.error('❌ Initialization error:', error);
                console.error('❌ DEBUG: Error details:', error.stack);
                showError('Failed to initialize application. Please refresh the page.');
            } finally {
                showLoading(false);
            }
        }

        // Make the initialization function globally available
        window.initializeQuoteMaker = initializeQuoteMaker;

        // Initialize the application when DOM is ready (for direct access) or immediately if already loaded (for menu system)
        if (document.readyState === 'loading') {
            // DOM is still loading, wait for DOMContentLoaded
            console.log('🔍 DEBUG: DOM is loading, waiting for DOMContentLoaded...');
            document.addEventListener('DOMContentLoaded', async function() {
                console.log('🔍 DEBUG: DOMContentLoaded event fired, initializing...');
                await initializeQuoteMaker();
            });
        } else {
            // DOM is already loaded, initialize immediately (this happens when loaded via menu)
            console.log('🔍 DEBUG: DOM already loaded, initializing immediately...');
            setTimeout(async () => {
                console.log('🔍 DEBUG: Timeout fired, starting initialization...');
                await initializeQuoteMaker();
            }, 100); // Small delay to ensure all scripts are loaded
        }

        // Initialize universal Firebase data manager
        async function initializeFirebase() {
            try {
                console.log('🔄 Waiting for universal Firebase data manager...');
                
                // Wait for universal data manager to be available
                let attempts = 0;
                const maxAttempts = 20; // 10 seconds max wait
                
                while (!window.universalDataManager && attempts < maxAttempts) {
                    console.log(`⏳ Waiting for universalDataManager... (attempt ${attempts + 1}/${maxAttempts})`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                if (!window.universalDataManager) {
                    throw new Error('Universal data manager not available after waiting');
                }
                
                // Wait for universal data manager to be ready
                await window.universalDataManager.waitForReady();
                
                const status = window.universalDataManager.getStatus();
                if (status.isInitialized && status.isDataLoaded) {
                    updateConnectionStatus(true);
                    console.log('✅ Universal Firebase data manager ready');
                } else {
                    updateConnectionStatus(false);
                    throw new Error('Universal Firebase data manager not ready. Please check your connection.');
                }
                
            } catch (error) {
                console.error('❌ Centralized Firebase access failed:', error);
                updateConnectionStatus(false);
                throw error;
            }
        }

        // Load all required data
        async function loadAllData() {
            console.log('🔍 DEBUG: loadAllData started');
            console.log('🔍 DEBUG: window.universalDataManager available:', !!window.universalDataManager);
            
            try {
                console.log('🔍 DEBUG: Starting parallel data loading...');
                // Load data in parallel for better performance
                const [products, clients, salesmen, styles, colors] = await Promise.all([
                    loadProducts(),
                    loadClients(),
                    loadSalesmen(),
                    loadStyles(),
                    loadColors()
                ]);
                
                console.log('🔍 DEBUG: Loaded products count:', products?.length || 0);
                console.log('🔍 DEBUG: Loaded clients count:', clients?.length || 0);
                console.log('🔍 DEBUG: Loaded salesmen count:', salesmen?.length || 0);
                console.log('🔍 DEBUG: Loaded styles data:', styles);
                console.log('🔍 DEBUG: Loaded colors data:', colors);
                console.log('✅ All data loaded successfully');
                
            } catch (error) {
                console.error('❌ Error loading data:', error);
                console.error('❌ DEBUG: loadAllData error details:', error.stack);
                throw error;
            }
        }

        // Load products from unified data access or fallback to universal data manager
        async function loadProducts() {
            try {
                // Try unified data access first
                if (window.unifiedDataAccess) {
                    try {
                        productData = await window.unifiedDataAccess.getProducts();
                        console.log(`📦 Loaded ${productData.length} products from unified data access`);
                    } catch (unifiedError) {
                        console.warn('⚠️ Unified data access failed, falling back to universal data manager:', unifiedError);
                        productData = await window.universalDataManager.getProducts();
                        console.log(`📦 Loaded ${productData.length} products from universal data manager (fallback)`);
                    }
                } else {
                    productData = await window.universalDataManager.getProducts();
                    console.log(`📦 Loaded ${productData.length} products from universal data manager`);
                }
                
                populatePriceListDropdown();
                return productData;
                
            } catch (error) {
                console.error('❌ Error loading products:', error);
                throw new Error('Failed to load products. Please check your connection.');
            }
        }

        // Load clients from unified data access or fallback to universal data manager
        async function loadClients() {
            try {
                // Try unified data access first
                if (window.unifiedDataAccess) {
                    try {
                        clientData = await window.unifiedDataAccess.getClients();
                        console.log(`👥 Loaded ${clientData.length} clients from unified data access`);
                    } catch (unifiedError) {
                        console.warn('⚠️ Unified data access failed, falling back to universal data manager:', unifiedError);
                        clientData = await window.universalDataManager.getClients();
                        console.log(`👥 Loaded ${clientData.length} clients from universal data manager (fallback)`);
                    }
                } else {
                    clientData = await window.universalDataManager.getClients();
                    console.log(`👥 Loaded ${clientData.length} clients from universal data manager`);
                }
                
                populateClientDropdown();
                return clientData;
                
            } catch (error) {
                console.error('❌ Error loading clients:', error);
                throw new Error('Failed to load clients. Please check your connection.');
            }
        }

        // Load salesmen from unified data access or fallback to universal data manager
        async function loadSalesmen() {
            try {
                // Try unified data access first
                if (window.unifiedDataAccess) {
                    try {
                        salesmenData = await window.unifiedDataAccess.getSalespeople();
                        console.log(`👨‍💼 Loaded ${salesmenData.length} salespeople from unified data access`);
                    } catch (unifiedError) {
                        console.warn('⚠️ Unified data access failed, falling back to universal data manager:', unifiedError);
                        salesmenData = await window.universalDataManager.getSalespeople();
                        console.log(`👨‍💼 Loaded ${salesmenData.length} salespeople from universal data manager (fallback)`);
                    }
                } else {
                    salesmenData = await window.universalDataManager.getSalespeople();
                    console.log(`👨‍💼 Loaded ${salesmenData.length} salespeople from universal data manager`);
                }
                
                populateSalespersonDropdown();
                return salesmenData;
                
            } catch (error) {
                console.error('❌ Error loading salespeople:', error);
                throw new Error('Failed to load salespeople. Please check your connection.');
            }
        }

        // Load styles from unified data access or fallback to universal data manager
        async function loadStyles() {
            try {
                // Try unified data access first
                if (window.unifiedDataAccess) {
                    try {
                        stylesData = await window.unifiedDataAccess.getStyles();
                        console.log(`🎨 Loaded ${stylesData.length} styles from unified data access`);
                    } catch (unifiedError) {
                        console.warn('⚠️ Unified data access failed, falling back to universal data manager:', unifiedError);
                        stylesData = await window.universalDataManager.getStyles();
                        console.log(`🎨 Loaded ${stylesData.length} styles from universal data manager (fallback)`);
                    }
                } else {
                    stylesData = await window.universalDataManager.getStyles();
                    console.log(`🎨 Loaded ${stylesData.length} styles from universal data manager`);
                }
                
                populateStylesFromCollection();
                
                // Enable style selector since styles are independent of product selection
                enableSelector('style-selector');
                
                return stylesData;
                
            } catch (error) {
                console.error('❌ Error loading styles:', error);
                stylesData = [];
                return [];
            }
        }

        // Load colors from unified data access or fallback to universal data manager
        async function loadColors() {
            try {
                // Try unified data access first
                if (window.unifiedDataAccess) {
                    try {
                        colorsData = await window.unifiedDataAccess.getColors();
                        console.log(`🌈 Loaded ${colorsData.length} colors from unified data access`);
                    } catch (unifiedError) {
                        console.warn('⚠️ Unified data access failed, falling back to universal data manager:', unifiedError);
                        colorsData = await window.universalDataManager.getColors();
                        console.log(`🌈 Loaded ${colorsData.length} colors from universal data manager (fallback)`);
                    }
                } else {
                    colorsData = await window.universalDataManager.getColors();
                    console.log(`🌈 Loaded ${colorsData.length} colors from universal data manager`);
                }
                
                populateColors();
                return colorsData;
                
            } catch (error) {
                console.error('❌ Error loading colors:', error);
                colorsData = [];
                return [];
            }
        }

        // Populate price list dropdown
        function populatePriceListDropdown() {
            const selector = document.getElementById('price-list-selector');
            const priceLists = [...new Set(productData.map(p => p['Price List Name'] || p.PriceListName || p.PriceList).filter(Boolean))];
            
            selector.innerHTML = '<option value="">Select Price List</option>';
            
            priceLists.sort().forEach(priceList => {
                const option = document.createElement('option');
                option.value = priceList;
                option.textContent = priceList;
                selector.appendChild(option);
            });
            
            console.log(`📋 Populated ${priceLists.length} price lists`);
        }

        // Populate client dropdown
        function populateClientDropdown() {
            const selector = document.getElementById('client-selector');
            
            // Clear existing options except default and add new
            selector.innerHTML = '<option value="">Select Client</option><option value="add-new">+ Add New Client</option>';
            
            clientData.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.clientName} (${client.companyName || 'No Company'})`;
                selector.appendChild(option);
            });
            
            console.log(`👥 Populated ${clientData.length} clients`);
        }

        // Populate salesperson dropdown
        function populateSalespersonDropdown() {
            const selector = document.getElementById('salesperson-selector');
            
            selector.innerHTML = '<option value="">Select Salesperson</option>';
            
            salesmenData.forEach(salesman => {
                const option = document.createElement('option');
                option.value = salesman.name || salesman.Name;
                option.textContent = salesman.name || salesman.Name;
                selector.appendChild(option);
            });
            
            console.log(`👨‍💼 Populated ${salesmenData.length} salespeople`);
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('🔧 Setting up event listeners...');
            
            // Price list change
            document.getElementById('price-list-selector').addEventListener('change', onPriceListChange);
            
            // Category change
            document.getElementById('category-selector').addEventListener('change', onCategoryChange);
            
            // Product change
            document.getElementById('product-selector').addEventListener('change', onProductChange);
            
            // Other selectors
            document.getElementById('density-selector').addEventListener('change', () => {
                console.log('🎯 Density changed');
                isManualPriceEntry = false; // Reset manual entry flag
                updatePricing();
            });
            document.getElementById('length-selector').addEventListener('change', () => {
                console.log('🎯 Length changed');
                isManualPriceEntry = false; // Reset manual entry flag
                updatePricing();
            });
            document.getElementById('color-type-selector').addEventListener('change', onColorTypeChange);
            document.getElementById('color-selector').addEventListener('change', (e) => {
                console.log('🎯 Color changed');
                const customColorContainer = document.querySelector('.custom-color-container');
                const colorImageBtn = document.getElementById('color-image-btn');
                const customColorInput = document.getElementById('custom-color-input');
                
                if (e.target.value === 'Custom') {
                    // Show with smooth animation
                    customColorContainer.style.display = 'block';
                    setTimeout(() => {
                        customColorContainer.classList.add('show');
                    }, 10);
                    customColorInput.disabled = false;
                    colorImageBtn.disabled = false;
                    customColorInput.focus(); // Auto-focus for better UX
                } else {
                    // Hide with smooth animation
                    customColorContainer.classList.remove('show');
                    setTimeout(() => {
                        customColorContainer.style.display = 'none';
                    }, 300);
                    customColorInput.disabled = true;
                    customColorInput.value = '';
                    customColorInput.classList.remove('custom-input-error');
                    colorImageBtn.disabled = true;
                    // Clear any uploaded color image
                    const colorImageInput = document.getElementById('color-image-input');
                    const colorImagePreview = document.getElementById('color-image-preview');
                    if (colorImageInput) colorImageInput.value = '';
                    if (colorImagePreview) {
                        colorImagePreview.style.display = 'none';
                        colorImagePreview.innerHTML = '';
                    }
                }
                isManualPriceEntry = false; // Reset manual entry flag
                updatePricing();
            });
            document.getElementById('style-selector').addEventListener('change', (e) => {
                console.log('🎯 Style changed');
                const customStyleContainer = document.querySelector('.custom-style-container');
                const styleImageBtn = document.getElementById('style-image-btn');
                const customStyleInput = document.getElementById('custom-style-input');
                
                if (e.target.value === 'Custom') {
                    // Show with smooth animation
                    customStyleContainer.style.display = 'block';
                    setTimeout(() => {
                        customStyleContainer.classList.add('show');
                    }, 10);
                    customStyleInput.disabled = false;
                    styleImageBtn.disabled = false;
                    customStyleInput.focus(); // Auto-focus for better UX
                } else {
                    // Hide with smooth animation
                    customStyleContainer.classList.remove('show');
                    setTimeout(() => {
                        customStyleContainer.style.display = 'none';
                    }, 300);
                    customStyleInput.disabled = true;
                    customStyleInput.value = '';
                    customStyleInput.classList.remove('custom-input-error');
                    styleImageBtn.disabled = true;
                    // Clear any uploaded style image
                    const styleImageInput = document.getElementById('style-image-input');
                    const styleImagePreview = document.getElementById('style-image-preview');
                    if (styleImageInput) styleImageInput.value = '';
                    if (styleImagePreview) {
                        styleImagePreview.style.display = 'none';
                        styleImagePreview.innerHTML = '';
                    }
                }
                isManualPriceEntry = false; // Reset manual entry flag
                updatePricing();
            });
            
            // Quantity and price inputs
            document.getElementById('quantity-input').addEventListener('input', () => {
                console.log('🎯 Quantity changed');
                updatePricing();
            });
            document.getElementById('unit-price-input').addEventListener('input', () => {
                console.log('🎯 Unit price changed');
                isManualPriceEntry = true; // User is manually entering price
                updatePricing();
            });
            
            // Currency change
            document.getElementById('currency-selector').addEventListener('change', onCurrencyChange);
            
            // Client selector
            document.getElementById('client-selector').addEventListener('change', onClientChange);
            
            // Add item button
            document.getElementById('add-item-btn').addEventListener('click', addQuoteItem);
            
            // Custom input validation
            document.getElementById('custom-color-input').addEventListener('input', function() {
                validateCustomInputs();
            });
            
            document.getElementById('custom-style-input').addEventListener('input', function() {
                validateCustomInputs();
            });
            
            // Auto-expand on focus and auto-collapse on blur
            document.getElementById('custom-color-input').addEventListener('focus', function() {
                const container = document.querySelector('.custom-color-container');
                if (container && container.classList.contains('show')) {
                    container.classList.remove('collapsed');
                }
            });
            
            document.getElementById('custom-color-input').addEventListener('blur', function() {
                // Small delay to allow for potential focus on related elements
                setTimeout(() => {
                    const container = document.querySelector('.custom-color-container');
                    if (container && container.classList.contains('show')) {
                        container.classList.add('collapsed');
                    }
                }, 150);
            });
            
            document.getElementById('custom-style-input').addEventListener('focus', function() {
                const container = document.querySelector('.custom-style-container');
                if (container && container.classList.contains('show')) {
                    container.classList.remove('collapsed');
                }
            });
            
            document.getElementById('custom-style-input').addEventListener('blur', function() {
                // Small delay to allow for potential focus on related elements
                setTimeout(() => {
                    const container = document.querySelector('.custom-style-container');
                    if (container && container.classList.contains('show')) {
                        container.classList.add('collapsed');
                    }
                }, 150);
            });
            
            // Summary inputs
            document.getElementById('discount-input').addEventListener('input', updateQuoteSummary);
            document.getElementById('tax-input').addEventListener('input', updateQuoteSummary);
            
            // Shipping input with error handling
            const shippingInput = document.getElementById('shipping-input');
            if (shippingInput) {
                shippingInput.addEventListener('input', updateQuoteSummary);
            } else {
                console.error('❌ Shipping input element not found');
            }
            
            // Action buttons
            document.getElementById('save-quote-btn').addEventListener('click', saveQuote);
            
            // Optional buttons with null checks
            const clearQuoteBtn = document.getElementById('clear-quote-btn');
            if (clearQuoteBtn) {
                clearQuoteBtn.addEventListener('click', clearQuote);
            } else {
                console.log('ℹ️ Clear quote button not found - feature not available');
            }
            
            const duplicateQuoteBtn = document.getElementById('duplicate-quote-btn');
            if (duplicateQuoteBtn) {
                duplicateQuoteBtn.addEventListener('click', duplicateQuote);
            } else {
                console.log('ℹ️ Duplicate quote button not found - feature not available');
            }
            
            const loadQuoteBtn = document.getElementById('load-quote-btn');
            if (loadQuoteBtn) {
                loadQuoteBtn.addEventListener('click', loadQuote);
            } else {
                console.log('ℹ️ Load quote button not found - feature not available');
            }
            
            // Modal events
            document.getElementById('close-modal-btn').addEventListener('click', closeAddClientModal);
            document.getElementById('cancel-client-btn').addEventListener('click', closeAddClientModal);
            document.getElementById('add-client-form').addEventListener('submit', addNewClient);
            
            // Image upload functionality
            setupImageUploadListeners();
        }
        
        // Enhanced image upload functionality
        function setupImageUploadListeners() {
            // Color image upload
            const colorImageBtn = document.getElementById('color-image-btn');
            const colorImageInput = document.getElementById('color-image-input');
            const colorImagePreview = document.getElementById('color-image-preview');
            const colorImageDisplay = document.getElementById('color-image-display');
            const removeColorImageBtn = document.getElementById('remove-color-image');
            
            // Check if all required elements exist before setting up listeners
            if (!colorImageBtn || !colorImageInput || !colorImagePreview || !colorImageDisplay || !removeColorImageBtn) {
                console.log('ℹ️ Color image upload elements not found - feature not available');
                return;
            }
            
            colorImageBtn.addEventListener('click', () => {
                colorImageInput.click();
            });
            
            colorImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        showError('Please select a valid image file.');
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        showError('Image file size must be less than 5MB.');
                        return;
                    }
                    
                    // Show loading state
                    colorImageBtn.classList.add('image-upload-loading');
                    colorImageBtn.disabled = true;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        colorImageDisplay.src = e.target.result;
                        colorImagePreview.classList.remove('hidden');
                        colorImagePreview.style.display = ''; // Reset display style
                        
                        // Add has-image class to expand container for thumbnail
                        const customColorContainer = document.querySelector('.custom-color-container');
                        if (customColorContainer) {
                            customColorContainer.classList.add('has-image');
                        }
                        
                        // Remove loading state
                        colorImageBtn.classList.remove('image-upload-loading');
                        colorImageBtn.disabled = false;
                    };
                    reader.onerror = () => {
                        showError('Failed to load image. Please try again.');
                        colorImageBtn.classList.remove('image-upload-loading');
                        colorImageBtn.disabled = false;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            removeColorImageBtn.addEventListener('click', () => {
                colorImageInput.value = '';
                colorImagePreview.classList.add('hidden');
                colorImageDisplay.src = '';
                
                // Remove has-image class to collapse container
                const customColorContainer = document.querySelector('.custom-color-container');
                if (customColorContainer) {
                    customColorContainer.classList.remove('has-image');
                }
                
                // Check if container should expand back when image is removed
                handleCustomAreaCollapse('color');
            });
            
            // Style image upload
            const styleImageBtn = document.getElementById('style-image-btn');
            const styleImageInput = document.getElementById('style-image-input');
            const styleImagePreview = document.getElementById('style-image-preview');
            const styleImageDisplay = document.getElementById('style-image-display');
            const removeStyleImageBtn = document.getElementById('remove-style-image');
            
            // Check if all required elements exist before setting up listeners
            if (!styleImageBtn || !styleImageInput || !styleImagePreview || !styleImageDisplay || !removeStyleImageBtn) {
                console.log('ℹ️ Style image upload elements not found - feature not available');
                return;
            }
            
            styleImageBtn.addEventListener('click', () => {
                styleImageInput.click();
            });
            
            styleImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        showError('Please select a valid image file.');
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        showError('Image file size must be less than 5MB.');
                        return;
                    }
                    
                    // Show loading state
                    styleImageBtn.classList.add('image-upload-loading');
                    styleImageBtn.disabled = true;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        styleImageDisplay.src = e.target.result;
                        styleImagePreview.classList.remove('hidden');
                        styleImagePreview.style.display = ''; // Reset display style
                        
                        // Add has-image class to expand container for thumbnail
                        const customStyleContainer = document.querySelector('.custom-style-container');
                        if (customStyleContainer) {
                            customStyleContainer.classList.add('has-image');
                        }
                        
                        // Remove loading state
                        styleImageBtn.classList.remove('image-upload-loading');
                        styleImageBtn.disabled = false;
                    };
                    reader.onerror = () => {
                        showError('Failed to load image. Please try again.');
                        styleImageBtn.classList.remove('image-upload-loading');
                        styleImageBtn.disabled = false;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            removeStyleImageBtn.addEventListener('click', () => {
                styleImageInput.value = '';
                styleImagePreview.classList.add('hidden');
                styleImageDisplay.src = '';
                
                // Remove has-image class to collapse container
                const customStyleContainer = document.querySelector('.custom-style-container');
                if (customStyleContainer) {
                    customStyleContainer.classList.remove('has-image');
                }
                
                // Check if container should expand back when image is removed
                handleCustomAreaCollapse('style');
            });
            
            // Custom input change handlers
            document.getElementById('custom-color-input').addEventListener('input', () => {
                console.log('🎯 Custom color input changed');
                isManualPriceEntry = false;
                updatePricing();
            });
            
            document.getElementById('custom-style-input').addEventListener('input', () => {
                console.log('🎯 Custom style input changed');
                isManualPriceEntry = false;
                updatePricing();
            });
            
            // OK button event listeners
            document.getElementById('custom-color-ok-btn').addEventListener('click', () => {
                console.log('🎯 Custom color OK button clicked');
                handleCustomAreaCollapse('color');
            });
            
            document.getElementById('custom-style-ok-btn').addEventListener('click', () => {
                console.log('🎯 Custom style OK button clicked');
                handleCustomAreaCollapse('style');
            });
        }

        // Price list change handler
        function onPriceListChange() {
            const priceList = document.getElementById('price-list-selector').value;
            currentQuote.priceList = priceList;
            
            if (priceList) {
                populateCategories(priceList);
                enableSelector('category-selector');
            } else {
                clearCascadeSelectors(['category-selector', 'product-selector', 'density-selector', 'length-selector', 'color-type-selector', 'color-selector']);
            }
        }

        // Populate categories based on price list
        function populateCategories(priceList) {
            const selector = document.getElementById('category-selector');
            const categories = [...new Set(
                productData
                    .filter(p => (p['Price List Name'] || p.PriceListName || p.PriceList) === priceList)
                    .map(p => p.Category || p.category)
                    .filter(Boolean)
            )];
            
            selector.innerHTML = '<option value="">Select Category</option>';
            
            categories.sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                selector.appendChild(option);
            });
            
            // Auto-select if only one option is available
            if (categories.length === 1) {
                selector.value = categories[0];
                console.log(`🎯 Auto-selected category: ${categories[0]}`);
                // Trigger the change event to populate dependent dropdowns
                onCategoryChange();
            }
            
            console.log(`📂 Populated ${categories.length} categories for ${priceList}`);
        }

        // Category change handler
        function onCategoryChange() {
            const priceList = document.getElementById('price-list-selector').value;
            const category = document.getElementById('category-selector').value;
            
            if (priceList && category) {
                populateProducts(priceList, category);
                enableSelector('product-selector');
            } else {
                clearCascadeSelectors(['product-selector', 'density-selector', 'length-selector', 'color-type-selector', 'color-selector']);
            }
        }

        // Populate products based on price list and category
        function populateProducts(priceList, category) {
            const selector = document.getElementById('product-selector');
            const products = [...new Set(
                productData
                    .filter(p => 
                        (p['Price List Name'] || p.PriceListName || p.PriceList) === priceList &&
                        (p.Category || p.category) === category
                    )
                    .map(p => p.Product || p.product)
                    .filter(Boolean)
            )];
            
            selector.innerHTML = '<option value="">Select Product</option>';
            
            products.sort().forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                selector.appendChild(option);
            });
            
            // Auto-select if only one option is available
            if (products.length === 1) {
                selector.value = products[0];
                console.log(`🎯 Auto-selected product: ${products[0]}`);
                // Trigger the change event to populate dependent dropdowns
                onProductChange();
            }
            
            console.log(`📦 Populated ${products.length} products for ${category}`);
        }

        // Product change handler
        function onProductChange() {
            const priceList = document.getElementById('price-list-selector').value;
            const category = document.getElementById('category-selector').value;
            const product = document.getElementById('product-selector').value;
            
            if (priceList && category && product) {
                populateDensities(priceList, category, product);
                populateLengths(priceList, category, product);
                populateColorTypes(priceList, category, product);
                
                enableSelector('density-selector');
                enableSelector('length-selector');
                enableSelector('color-type-selector');
                enableSelector('color-selector');
                enableSelector('style-selector');
                
                updatePricing();
            } else {
                clearCascadeSelectors(['density-selector', 'length-selector', 'color-type-selector', 'color-selector', 'style-selector']);
                
                // Re-enable color and style selectors since they have independent data sources
                if (colorsData && colorsData.length > 0) {
                    populateColors();
                    enableSelector('color-selector');
                }
                if (stylesData && stylesData.length > 0) {
                    populateStylesFromCollection();
                    enableSelector('style-selector');
                }
            }
        }

        // Color type change handler
        function onColorTypeChange() {
            updatePricing();
        }

        // Populate densities
        function populateDensities(priceList, category, product) {
            const selector = document.getElementById('density-selector');
            const densities = [...new Set(
                productData
                    .filter(p => 
                        (p['Price List Name'] || p.PriceListName || p.PriceList) === priceList &&
                        (p.Category || p.category) === category &&
                        (p.Product || p.product) === product
                    )
                    .map(p => p.Density || p.density)
                    .filter(Boolean)
            )];
            
            selector.innerHTML = '<option value="">Select Density</option>';
            
            densities.sort().forEach(density => {
                const option = document.createElement('option');
                option.value = density;
                option.textContent = density;
                selector.appendChild(option);
            });
            
            // Auto-select if only one option is available
            if (densities.length === 1) {
                selector.value = densities[0];
                console.log(`🎯 Auto-selected density: ${densities[0]}`);
                updatePricing();
            }
            
            console.log(`⚖️ Populated ${densities.length} densities for ${product}`);
        }

        // Populate lengths
        function populateLengths(priceList, category, product) {
            const selector = document.getElementById('length-selector');
            const lengths = [...new Set(
                productData
                    .filter(p => 
                        (p['Price List Name'] || p.PriceListName || p.PriceList) === priceList &&
                        (p.Category || p.category) === category &&
                        (p.Product || p.product) === product
                    )
                    .map(p => p.Length || p.length)
                    .filter(Boolean)
            )];
            
            selector.innerHTML = '<option value="">Select Length</option>';
            
            lengths.sort((a, b) => {
                const numA = parseFloat(a);
                const numB = parseFloat(b);
                return !isNaN(numA) && !isNaN(numB) ? numA - numB : a.localeCompare(b);
            }).forEach(length => {
                const option = document.createElement('option');
                option.value = length;
                option.textContent = length;
                selector.appendChild(option);
            });
            
            // Auto-select if only one option is available
            if (lengths.length === 1) {
                selector.value = lengths[0];
                console.log(`🎯 Auto-selected length: ${lengths[0]}`);
                updatePricing();
            }
            
            console.log(`📏 Populated ${lengths.length} lengths for ${product}`);
        }

        // Populate color types
        function populateColorTypes(priceList, category, product) {
            const selector = document.getElementById('color-type-selector');
            const colors = [...new Set(
                productData
                    .filter(p => 
                        (p['Price List Name'] || p.PriceListName || p.PriceList) === priceList &&
                        (p.Category || p.category) === category &&
                        (p.Product || p.product) === product
                    )
                    .map(p => p.Colors || p.Color || p.color)
                    .filter(Boolean)
                    .flatMap(colorString => colorString.split(',').map(c => c.trim()))
                    .filter(Boolean)
            )];
            
            selector.innerHTML = '<option value="">Select Color Type</option>';
            
            colors.sort().forEach(color => {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                selector.appendChild(option);
            });
            
            // Auto-select if only one option is available
            if (colors.length === 1) {
                selector.value = colors[0];
                console.log(`🎯 Auto-selected color type: ${colors[0]}`);
                onColorTypeChange();
            }
            
            console.log(`🎨 Populated ${colors.length} color types for ${product}`);
        }

        // Populate colors from colors collection
        function populateColors() {
            const selector = document.getElementById('color-selector');
            
            if (!colorsData || colorsData.length === 0) {
                selector.innerHTML = '<option value="">No colors available</option>';
                // Add Custom option even when no colors available
                const customOption = document.createElement('option');
                customOption.value = 'Custom';
                customOption.textContent = 'Custom';
                selector.appendChild(customOption);
                return;
            }
            
            selector.innerHTML = '<option value="">Select Color</option>';
            
            // Add Custom option at the top
            const customOption = document.createElement('option');
            customOption.value = 'Custom';
            customOption.textContent = 'Custom';
            selector.appendChild(customOption);
            
            colorsData.forEach(colorItem => {
                const colorName = colorItem.colorname || colorItem.Color || colorItem.color || colorItem.name;
                if (colorName) {
                    const option = document.createElement('option');
                    option.value = colorName;
                    option.textContent = colorName;
                    selector.appendChild(option);
                }
            });
            
            console.log(`🌈 Populated ${colorsData.length} colors from colors collection + Custom option`);
        }

        // Populate styles from styles collection
        function populateStylesFromCollection() {
            const selector = document.getElementById('style-selector');
            
            if (!selector) {
                console.error('❌ Style selector element not found');
                return;
            }
            
            if (!stylesData || stylesData.length === 0) {
                selector.innerHTML = '<option value="">No styles available</option>';
                // Add Custom option even when no styles available
                const customOption = document.createElement('option');
                customOption.value = 'Custom';
                customOption.textContent = 'Custom';
                selector.appendChild(customOption);
                console.log('⚠️ No styles data available for population');
                return;
            }
            
            selector.innerHTML = '<option value="">Select Style</option>';
            
            // Add Custom option at the top
            const customOption = document.createElement('option');
            customOption.value = 'Custom';
            customOption.textContent = 'Custom';
            selector.appendChild(customOption);
            
            let populatedCount = 0;
            stylesData.forEach(styleItem => {
                const styleName = styleItem.stylename || styleItem.Style || styleItem.style || styleItem.name;
                if (styleName) {
                    const option = document.createElement('option');
                    option.value = styleName;
                    option.textContent = styleName;
                    selector.appendChild(option);
                    populatedCount++;
                }
            });
            
            console.log(`✨ Populated ${populatedCount} styles from ${stylesData.length} style items + Custom option`);
        }

        // Populate styles


        // Update pricing based on current selections
        function updatePricing() {
            console.log('🔄 updatePricing called');
            
            const priceList = document.getElementById('price-list-selector').value;
            const category = document.getElementById('category-selector').value;
            const product = document.getElementById('product-selector').value;
            const density = document.getElementById('density-selector').value;
            const length = document.getElementById('length-selector').value;
            const colorType = document.getElementById('color-type-selector').value;
            const quantity = parseFloat(document.getElementById('quantity-input').value) || 1;
            const overridePrice = parseFloat(document.getElementById('unit-price-input').value);
            
            console.log('📋 Current form values:', {
                priceList, category, product, density, length, colorType, quantity, overridePrice
            });
            
            console.log('📊 ProductData status:', {
                loaded: !!productData,
                length: productData ? productData.length : 0,
                sample: productData && productData.length > 0 ? productData[0] : null,
                sampleKeys: productData && productData.length > 0 ? Object.keys(productData[0]) : null
            });
            
            // Log first few products for debugging
            if (productData && productData.length > 0) {
                console.log('📦 First 3 products for debugging:', productData.slice(0, 3));
            }
            
            let unitPrice = 0;
            
            // Always try to calculate price from product data first
            if (priceList && category && product && density && length) {
                console.log('🔍 Searching for matching product with criteria:', {
                    priceList, category, product, density, length, colorType
                });
                
                // Find matching product for pricing
                const matchingProduct = productData.find(p => {
                    const productColors = p.Colors || p.Color || p.color || '';
                    const colorMatches = !colorType || 
                        productColors === colorType || 
                        productColors.split(',').map(c => c.trim()).includes(colorType);
                    
                    const priceListMatch = (p['Price List Name'] || p.PriceListName || p.PriceList) === priceList;
                    const categoryMatch = (p.Category || p.category) === category;
                    const productMatch = (p.Product || p.product) === product;
                    const densityMatch = (p.Density || p.density) === density;
                    const lengthMatch = (p.Length || p.length) === length;
                    
                    console.log('🔍 Checking product:', {
                        productData: {
                            priceList: p['Price List Name'] || p.PriceListName || p.PriceList,
                            category: p.Category || p.category,
                            product: p.Product || p.product,
                            density: p.Density || p.density,
                            length: p.Length || p.length,
                            colors: productColors
                        },
                        matches: {
                            priceListMatch,
                            categoryMatch,
                            productMatch,
                            densityMatch,
                            lengthMatch,
                            colorMatches
                        }
                    });
                    
                    return priceListMatch && categoryMatch && productMatch && densityMatch && lengthMatch && colorMatches;
                });
                
                if (matchingProduct) {
                    const calculatedPrice = parseFloat(matchingProduct.Rate || matchingProduct.Price || matchingProduct.price || 0);
                    const productCurrency = matchingProduct.Currency || 'INR';
                    const selectedCurrency = document.getElementById('currency-selector').value;
                    
                    console.log('💰 Found matching product for pricing:', {
                        product: matchingProduct,
                        calculatedPrice: calculatedPrice,
                        productCurrency: productCurrency,
                        selectedCurrency: selectedCurrency
                    });
                    
                    // Apply currency conversion to the calculated price
                    const convertedPrice = convertCurrency(calculatedPrice, productCurrency, selectedCurrency);
                    
                    // Use override price if manually entered, otherwise use converted calculated price
                     if (isManualPriceEntry && overridePrice && overridePrice > 0) {
                         unitPrice = overridePrice;
                         console.log('🔧 Using manual override price:', overridePrice);
                     } else {
                         unitPrice = convertedPrice;
                         console.log('💱 Applied currency conversion:', {
                             original: calculatedPrice,
                             converted: convertedPrice,
                             from: productCurrency,
                             to: selectedCurrency
                         });
                         // Update the input field with converted price only if not manually entered
                         if (!isManualPriceEntry) {
                             document.getElementById('unit-price-input').value = unitPrice > 0 ? unitPrice.toFixed(2) : '';
                         }
                     }
                } else {
                    console.log('⚠️ No matching product found for pricing with criteria:', {
                        priceList, category, product, density, length, colorType
                    });
                    
                    // Use override price if available, otherwise no price
                    if (overridePrice && overridePrice > 0) {
                        unitPrice = overridePrice;
                    } else {
                        unitPrice = 0;
                        document.getElementById('unit-price-input').value = '';
                    }
                }
            } else {
                // No product data available, use override price if entered
                if (overridePrice && overridePrice > 0) {
                    unitPrice = overridePrice;
                } else {
                    unitPrice = 0;
                    document.getElementById('unit-price-input').value = '';
                }
            }
            
            // Update price display
            const priceDisplay = document.getElementById('price-display');
            const calculatedPrice = document.getElementById('calculated-price');
            
            // Check if price display elements exist
            if (!priceDisplay || !calculatedPrice) {
                console.log('ℹ️ Price display elements not found');
                return;
            }
            
            console.log('🔍 Button enabling check:', {
                unitPrice,
                priceList,
                category,
                product,
                density,
                length,
                allFieldsFilled: !!(priceList && category && product && density && length),
                shouldEnable: unitPrice > 0 && priceList && category && product && density && length
            });
            
            if (unitPrice > 0) {
                const totalPrice = unitPrice * quantity;
                const currency = document.getElementById('currency-selector').value;
                const symbol = currencySymbols[currency] || currency + ' ';
                
                calculatedPrice.textContent = `${symbol}${totalPrice.toFixed(2)}`;
                priceDisplay.classList.remove('hidden');
                
                // Enable add button if all required fields are filled
                const addBtn = document.getElementById('add-item-btn');
                if (addBtn) {
                    if (priceList && category && product && density && length) {
                        addBtn.disabled = false;
                        console.log('✅ Add item button ENABLED');
                    } else {
                        addBtn.disabled = true;
                        console.log('❌ Add item button DISABLED - missing required fields');
                    }
                }
            } else {
                priceDisplay.classList.add('hidden');
                const addBtn = document.getElementById('add-item-btn');
                if (addBtn) {
                    addBtn.disabled = true;
                }
                console.log('❌ Add item button DISABLED - no valid price');
            }
        }

        // Currency change handler
        async function onCurrencyChange() {
            const newCurrency = document.getElementById('currency-selector').value;
            const oldCurrency = currentQuote.currency || 'INR';
            
            if (newCurrency !== oldCurrency) {
                // Convert existing quote values to new currency
                if (currentQuote.items && currentQuote.items.length > 0) {
                    currentQuote.items.forEach(item => {
                        if (item.unitPrice) {
                            item.unitPrice = convertCurrency(item.unitPrice, oldCurrency, newCurrency);
                            item.totalPrice = item.unitPrice * item.quantity;
                        }
                      });
                }
                
                // Convert summary amounts
                if (currentQuote.subtotal) {
                    currentQuote.subtotal = convertCurrency(currentQuote.subtotal, oldCurrency, newCurrency);
                }
                if (currentQuote.discountAmount) {
                    currentQuote.discountAmount = convertCurrency(currentQuote.discountAmount, oldCurrency, newCurrency);
                }
                if (currentQuote.taxAmount) {
                    currentQuote.taxAmount = convertCurrency(currentQuote.taxAmount, oldCurrency, newCurrency);
                }
                if (currentQuote.shipping) {
                    currentQuote.shipping = convertCurrency(currentQuote.shipping, oldCurrency, newCurrency);
                }
                if (currentQuote.total) {
                    currentQuote.total = convertCurrency(currentQuote.total, oldCurrency, newCurrency);
                }
                
                // Update shipping input field
                const shippingInput = document.getElementById('shipping-input');
                if (shippingInput && shippingInput.value) {
                    const convertedShipping = convertCurrency(parseFloat(shippingInput.value), oldCurrency, newCurrency);
                    shippingInput.value = convertedShipping.toFixed(2);
                }
                
                // Update discount input field (only if it's a fixed amount, not percentage)
                const discountInput = document.getElementById('discount-input');
                if (discountInput && discountInput.value && !discountInput.value.includes('%')) {
                    const convertedDiscount = convertCurrency(parseFloat(discountInput.value), oldCurrency, newCurrency);
                    discountInput.value = convertedDiscount.toFixed(2);
                }
                
                // Update shipping currency symbol
                const shippingSymbol = document.getElementById('shipping-currency-symbol');
                if (shippingSymbol) {
                    shippingSymbol.textContent = currencySymbols[newCurrency] || newCurrency + ' ';
                }
                
                // Update shipping input placeholder
                if (shippingInput) {
                    shippingInput.placeholder = `Enter shipping amount in ${newCurrency}`;
                }
            }
            
            currentQuote.currency = newCurrency;
            updatePricing();
            updateQuoteItemsDisplay();
            updateQuoteSummary();
        }

        // Client change handler
        function onClientChange() {
            const clientId = document.getElementById('client-selector').value;
            
            if (clientId === 'add-new') {
                openAddClientModal();
                document.getElementById('client-selector').value = '';
            } else if (clientId) {
                const client = clientData.find(c => c.id === clientId);
                currentQuote.client = client;
            } else {
                currentQuote.client = null;
            }
        }

        // Add quote item
        // Validation functions for custom inputs
        function validateCustomInputs() {
            const colorSelector = document.getElementById('color-selector');
            const styleSelector = document.getElementById('style-selector');
            const customColorInput = document.getElementById('custom-color-input');
            const customStyleInput = document.getElementById('custom-style-input');
            const colorErrorMsg = document.getElementById('color-error-message');
            const styleErrorMsg = document.getElementById('style-error-message');
            
            let isValid = true;
            

            
            // Clear previous error states
            customColorInput.classList.remove('error');
            customStyleInput.classList.remove('error');
            if (colorErrorMsg) colorErrorMsg.textContent = '';
            if (styleErrorMsg) styleErrorMsg.textContent = '';
            
            // Validate custom color if "Custom" is selected
            if (colorSelector.value === 'Custom') {
                // Check if custom value has been confirmed (collapsed)
                if (colorSelector.dataset.customConfirmed === 'true') {
                    // Custom value already confirmed, validation passes
                } else {
                    // Validate the input field if not yet confirmed
                    const customColorValue = customColorInput.value.trim();
                    if (!customColorValue) {
                        customColorInput.classList.add('error');
                        if (colorErrorMsg) colorErrorMsg.textContent = 'Please enter a custom color name';
                        isValid = false;
                    } else if (customColorValue.length < 2) {
                        customColorInput.classList.add('error');
                        if (colorErrorMsg) colorErrorMsg.textContent = 'Color name must be at least 2 characters';
                        isValid = false;
                    }
                }
            }
            
            // Validate custom style if "Custom" is selected
            if (styleSelector.value === 'Custom') {
                // Check if custom value has been confirmed (collapsed)
                if (styleSelector.dataset.customConfirmed === 'true') {
                    // Custom value already confirmed, validation passes
                } else {
                    // Validate the input field if not yet confirmed
                    const customStyleValue = customStyleInput.value.trim();
                    if (!customStyleValue) {
                        customStyleInput.classList.add('error');
                        if (styleErrorMsg) styleErrorMsg.textContent = 'Please enter a custom style name';
                        isValid = false;
                    } else if (customStyleValue.length < 2) {
                        customStyleInput.classList.add('error');
                        if (styleErrorMsg) styleErrorMsg.textContent = 'Style name must be at least 2 characters';
                        isValid = false;
                    }
                }
            }
            
            return isValid;
        }

        // Function to handle auto-collapse of custom areas
        function handleCustomAreaCollapse(type) {
            const container = document.querySelector(`.custom-${type}-container`);
            const input = document.getElementById(`custom-${type}-input`);
            const imagePreview = document.getElementById(`${type}-image-preview`);
            const selector = document.getElementById(`${type}-selector`);
            
            if (!container || !selector) return;
            
            // Check if there's content (text or image)
            const hasText = input && input.value.trim().length > 0;
            const hasImage = imagePreview && !imagePreview.classList.contains('hidden');
            
            // If container is visible and there's content, collapse it
            if (container.classList.contains('show') && (hasText || hasImage)) {
                // Hide the container with smooth animation
                container.classList.remove('show');
                setTimeout(() => {
                    container.style.display = 'none';
                }, 300);
                
                // Update the dropdown to show "Custom" as selected
                selector.value = 'Custom';
                
                // Create a visual indicator that custom content is set
                const customText = hasText ? input.value.trim() : 'Custom';
                
                // Update the dropdown option text to show the custom value
                const customOption = selector.querySelector('option[value="Custom"]');
                if (customOption) {
                    // Store original text if not already stored
                    if (!customOption.dataset.originalText) {
                        customOption.dataset.originalText = customOption.textContent;
                    }
                    customOption.textContent = `Custom: ${customText}`;
                }
                
                // Mark this custom input as confirmed
                selector.dataset.customConfirmed = 'true';
                selector.dataset.customValue = customText;
                
                console.log(`✅ ${type} custom area collapsed with content: ${customText}`);
            }
        }

        function addQuoteItem() {
            console.log('🚀 addQuoteItem function called');
            console.log('📊 Current quote items before adding:', currentQuote.items.length);
            
            const priceList = document.getElementById('price-list-selector').value;
            const category = document.getElementById('category-selector').value;
            const product = document.getElementById('product-selector').value;
            const density = document.getElementById('density-selector').value;
            const length = document.getElementById('length-selector').value;
            const colorType = document.getElementById('color-type-selector').value;
            const color = document.getElementById('color-selector').value;
            const style = document.getElementById('style-selector').value;
            const quantity = parseFloat(document.getElementById('quantity-input').value) || 1;
            const unitPrice = parseFloat(document.getElementById('unit-price-input').value) || 0;
            
            console.log('📝 Form values:', { priceList, category, product, density, length, colorType, color, style, quantity, unitPrice });
            
            // Get custom inputs - use confirmed values if available
            const colorSelector = document.getElementById('color-selector');
            const styleSelector = document.getElementById('style-selector');
            
            const customColor = colorSelector.dataset.customConfirmed === 'true' 
                ? colorSelector.dataset.customValue 
                : document.getElementById('custom-color-input').value.trim();
            const customStyle = styleSelector.dataset.customConfirmed === 'true' 
                ? styleSelector.dataset.customValue 
                : document.getElementById('custom-style-input').value.trim();
            
            console.log('🎨 Custom inputs:', { customColor, customStyle, 
                colorConfirmed: colorSelector.dataset.customConfirmed,
                styleConfirmed: styleSelector.dataset.customConfirmed });
            
            // Get image data
            const colorImageInput = document.getElementById('color-image-input');
            const styleImageInput = document.getElementById('style-image-input');
            const colorImageDisplay = document.getElementById('color-image-display');
            const styleImageDisplay = document.getElementById('style-image-display');
            
            console.log('🖼️ Image elements:', {
                colorImageDisplay: !!colorImageDisplay,
                styleImageDisplay: !!styleImageDisplay,
                colorImageSrc: colorImageDisplay ? colorImageDisplay.src.substring(0, 50) + '...' : 'none',
                styleImageSrc: styleImageDisplay ? styleImageDisplay.src.substring(0, 50) + '...' : 'none'
            });
            
            // Basic validation
            if (!priceList || !category || !product || !density || !length || unitPrice <= 0) {
                console.log('❌ Basic validation failed');
                showError('Please fill in all required fields and ensure a valid price is calculated.');
                return;
            }
            console.log('✅ Basic validation passed');
            
            // Validate custom inputs
            if (!validateCustomInputs()) {
                console.log('❌ Custom validation failed');
                showError('Please correct the validation errors in custom fields.');
                return;
            }
            console.log('✅ Custom validation passed');
            
            const item = {
                id: Date.now().toString(),
                priceList,
                category,
                product,
                density,
                length,
                colorType: colorType || 'N/A',
                color: customColor || color || 'N/A',
                style: customStyle || style || 'N/A',
                quantity,
                unitPrice,
                totalPrice: unitPrice * quantity,
                // Store custom data
                customColor: customColor || null,
                customStyle: customStyle || null,
                colorImage: colorImageDisplay && colorImageDisplay.src && colorImageDisplay.src.includes('data:') ? colorImageDisplay.src : null,
                styleImage: styleImageDisplay && styleImageDisplay.src && styleImageDisplay.src.includes('data:') ? styleImageDisplay.src : null
            };
            
            console.log('🖼️ Image data stored:', {
                hasColorImage: !!item.colorImage,
                hasStyleImage: !!item.styleImage,
                colorImageLength: item.colorImage ? item.colorImage.length : 0,
                styleImageLength: item.styleImage ? item.styleImage.length : 0
            });
            
            currentQuote.items.push(item);
            console.log('✅ Item added to quote:', item);
            console.log('📊 Current quote items after adding:', currentQuote.items.length);
            console.log('📋 All items in quote:', currentQuote.items);
            
            // Clear form
            console.log('🧹 Clearing product form...');
            clearProductForm();
            
            // Update display
            console.log('🔄 Updating quote items display...');
            updateQuoteItemsDisplay();
            console.log('💰 Updating quote summary...');
            updateQuoteSummary();
        }

        // Clear product form
        function clearProductForm() {
            document.getElementById('quantity-input').value = '1';
            document.getElementById('unit-price-input').value = '';
            
            const priceDisplay = document.getElementById('price-display');
            if (priceDisplay) {
                priceDisplay.classList.add('hidden');
            }
            
            const addBtn = document.getElementById('add-item-btn');
            if (addBtn) {
                addBtn.disabled = true;
            }
            
            // Clear product selection fields but preserve Price List and Currency
            // Reset all product selectors except price-list-selector and currency-selector
            const selectorsToReset = [
                'category-selector', 
                'product-selector', 
                'density-selector', 
                'length-selector', 
                'color-type-selector', 
                'color-selector',
                'style-selector'
            ];
            
            selectorsToReset.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    selector.value = '';
                    selector.disabled = true;
                }
            });
            
            // Re-enable category selector if price list is selected
            const priceList = document.getElementById('price-list-selector').value;
            if (priceList) {
                const categorySelector = document.getElementById('category-selector');
                if (categorySelector) {
                    categorySelector.disabled = false;
                    populateCategories(priceList);
                }
            }
            
            // Reset custom confirmed flags and restore original option text
            const colorSelector = document.getElementById('color-selector');
            const styleSelector = document.getElementById('style-selector');
            
            if (colorSelector) {
                delete colorSelector.dataset.customConfirmed;
                delete colorSelector.dataset.customValue;
                const colorCustomOption = colorSelector.querySelector('option[value="Custom"]');
                if (colorCustomOption && colorCustomOption.dataset.originalText) {
                    colorCustomOption.textContent = colorCustomOption.dataset.originalText;
                }
            }
            
            if (styleSelector) {
                delete styleSelector.dataset.customConfirmed;
                delete styleSelector.dataset.customValue;
                const styleCustomOption = styleSelector.querySelector('option[value="Custom"]');
                if (styleCustomOption && styleCustomOption.dataset.originalText) {
                    styleCustomOption.textContent = styleCustomOption.dataset.originalText;
                }
            }
            
            // Hide custom containers and remove has-image class
            const customColorContainer = document.querySelector('.custom-color-container');
            const customStyleContainer = document.querySelector('.custom-style-container');
            if (customColorContainer) {
                customColorContainer.style.display = 'none';
                customColorContainer.classList.remove('has-image');
            }
            if (customStyleContainer) {
                customStyleContainer.style.display = 'none';
                customStyleContainer.classList.remove('has-image');
            }
            
            // Clear custom inputs and disable them
            document.getElementById('custom-color-input').value = '';
            document.getElementById('custom-style-input').value = '';
            document.getElementById('custom-color-input').disabled = true;
            document.getElementById('custom-style-input').disabled = true;
            
            // Clear uploaded images properly without removing DOM elements
            document.getElementById('color-image-input').value = '';
            document.getElementById('style-image-input').value = '';
            
            // Hide preview containers and reset image sources
            const colorImagePreview = document.getElementById('color-image-preview');
            const styleImagePreview = document.getElementById('style-image-preview');
            const colorImageDisplay = document.getElementById('color-image-display');
            const styleImageDisplay = document.getElementById('style-image-display');
            
            if (colorImagePreview) {
                colorImagePreview.style.display = 'none';
                colorImagePreview.classList.add('hidden');
            }
            if (styleImagePreview) {
                styleImagePreview.style.display = 'none';
                styleImagePreview.classList.add('hidden');
            }
            if (colorImageDisplay) {
                colorImageDisplay.src = '';
            }
            if (styleImageDisplay) {
                styleImageDisplay.src = '';
            }
            
            // Update pricing to re-evaluate add button state
            updatePricing();
        }

        // Update quote items display
        function updateQuoteItemsDisplay() {
            console.log('🖼️ updateQuoteItemsDisplay called with', currentQuote.items.length, 'items');
            const container = document.getElementById('quote-items-container');
            console.log('📦 Container element found:', !!container);
            
            if (currentQuote.items.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>No items added yet. Use the form above to add products to your quote.</p>
                    </div>
                `;
                return;
            }
            
            const currency = currentQuote.currency;
            const symbol = currencySymbols[currency] || currency + ' ';
            
            console.log('🎨 Generating HTML for', currentQuote.items.length, 'items');
            container.innerHTML = currentQuote.items.map((item, index) => {
                console.log(`🔍 Processing item ${index + 1}/${currentQuote.items.length}:`, {
                    product: item.product,
                    category: item.category,
                    hasColorImage: !!item.colorImage,
                    hasStyleImage: !!item.styleImage
                });
                const imagePath = getProductImagePath(item.product, item.category, item.density, item.length, item.colorType, item.color);
                console.log(`🖼️ Image path for item ${index + 1}:`, imagePath);
                
                // Determine color and style display
                const colorDisplay = item.customColor ? `${item.color} (Custom)` : item.color;
                const styleDisplay = item.customStyle ? `${item.style} (Custom)` : item.style;
                
                // Create custom images section
                let customImagesHtml = '';
                console.log('🖼️ Processing item images:', {
                    itemId: item.id,
                    hasColorImage: !!item.colorImage,
                    hasStyleImage: !!item.styleImage,
                    colorImageLength: item.colorImage ? item.colorImage.length : 0,
                    styleImageLength: item.styleImage ? item.styleImage.length : 0
                });
                
                if (item.colorImage || item.styleImage) {
                    customImagesHtml = `
                        <div class="flex space-x-2 mt-2">
                            ${item.colorImage ? `
                                <div class="text-center">
                                    <img src="${item.colorImage}" 
                                         alt="Color Reference" 
                                         class="w-12 h-12 object-cover rounded border border-gray-300"
                                         onerror="console.error('❌ Custom color image failed to load for item ${index + 1}'); this.style.display='none';"
                                         onload="console.log('✅ Custom color image loaded for item ${index + 1}')">
                                    <p class="text-xs text-gray-500 mt-1">Color</p>
                                </div>
                            ` : ''}
                            ${item.styleImage ? `
                                <div class="text-center">
                                    <img src="${item.styleImage}" 
                                         alt="Style Reference" 
                                         class="w-12 h-12 object-cover rounded border border-gray-300"
                                         onerror="console.error('❌ Custom style image failed to load for item ${index + 1}'); this.style.display='none';"
                                         onload="console.log('✅ Custom style image loaded for item ${index + 1}')">
                                    <p class="text-xs text-gray-500 mt-1">Style</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                const itemHtml = `
                <div class="quote-item">
                    <div class="flex justify-between items-start">
                        <div class="flex items-start space-x-3 flex-1">
                            <div class="flex-shrink-0">
                                <img src="${imagePath}" 
                                     alt="${item.product}" 
                                     class="w-16 h-16 object-cover rounded-lg border border-gray-200"
                                     onerror="console.error('❌ Image failed to load:', this.src); this.src='images/Products/Genius.png'; this.onerror=null;"
                                     onload="console.log('✅ Image loaded successfully:', this.src)"
                                     loading="lazy">
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-semibold text-gray-800">${item.product}</h4>
                                <p class="text-sm text-gray-600">
                                    ${item.category} • ${item.density} • ${item.length}" • ${item.colorType}
                                    ${colorDisplay !== 'N/A' ? ' • Color: ' + colorDisplay : ''}
                                    ${styleDisplay !== 'N/A' ? ' • Style: ' + styleDisplay : ''}
                                </p>
                                <p class="text-sm text-gray-500 mt-1">
                                    Qty: ${item.quantity} × ${symbol}${item.unitPrice.toFixed(2)}
                                </p>
                                ${customImagesHtml}
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="font-semibold text-gray-800">${symbol}${item.totalPrice.toFixed(2)}</p>
                            <button onclick="removeQuoteItem(${index})" class="text-red-500 hover:text-red-700 text-sm mt-1">
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
                `;
                console.log(`✅ Generated HTML for item ${index + 1}, length:`, itemHtml.length);
                return itemHtml;
            }).join('');
            console.log('✅ HTML set in container, length:', container.innerHTML.length);
        }

        // Remove quote item
        function removeQuoteItem(index) {
            currentQuote.items.splice(index, 1);
            updateQuoteItemsDisplay();
            updateQuoteSummary();
        }

        // Update quote summary
        function updateQuoteSummary() {
            const currency = currentQuote.currency;
            const symbol = currencySymbols[currency] || currency + ' ';
            
            // Calculate subtotal
            const subtotal = currentQuote.items.reduce((sum, item) => sum + item.totalPrice, 0);
            
            // Get discount input and determine if it's percentage or amount
            const discountInput = document.getElementById('discount-input').value.trim();
            let discountAmount = 0;
            let discountType = 'amount';
            
            if (discountInput.includes('%')) {
                // Percentage discount
                const discountPercent = parseFloat(discountInput.replace('%', '')) || 0;
                discountAmount = subtotal * (discountPercent / 100);
                discountType = 'percentage';
            } else {
                // Amount discount
                discountAmount = parseFloat(discountInput) || 0;
                discountType = 'amount';
            }
            
            // Get tax and shipping
            const taxPercent = parseFloat(document.getElementById('tax-input').value) || 0;
            const shippingAmount = parseFloat(document.getElementById('shipping-input').value) || 0;
            
            // Calculate amounts
            const taxableAmount = subtotal - discountAmount;
            const taxAmount = taxableAmount * (taxPercent / 100);
            const total = taxableAmount + taxAmount + shippingAmount;
            
            // Update display
            document.getElementById('subtotal-amount').textContent = `${symbol}${subtotal.toFixed(2)}`;
            document.getElementById('discount-amount').textContent = `${symbol}${discountAmount.toFixed(2)}`;
            document.getElementById('tax-amount').textContent = `${symbol}${taxAmount.toFixed(2)}`;
            document.getElementById('total-amount').textContent = `${symbol}${total.toFixed(2)}`;
            
            // Update current quote
            currentQuote.subtotal = subtotal;
            currentQuote.discountAmount = discountAmount;
            currentQuote.discountType = discountType;
            currentQuote.discountInput = discountInput;
            currentQuote.tax = taxPercent;
            currentQuote.taxAmount = taxAmount;
            currentQuote.shipping = shippingAmount;
            currentQuote.total = total;
        }

        // Utility functions
        function enableSelector(selectorId) {
            document.getElementById(selectorId).disabled = false;
        }

        function clearCascadeSelectors(selectorIds) {
            selectorIds.forEach(id => {
                const selector = document.getElementById(id);
                selector.innerHTML = '<option value="">Select ' + id.replace('-selector', '').replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) + '</option>';
                selector.disabled = true;
            });
            
            // Clear pricing
            document.getElementById('unit-price-input').value = '';
            
            const priceDisplay = document.getElementById('price-display');
            if (priceDisplay) {
                priceDisplay.classList.add('hidden');
            }
            
            const addBtn = document.getElementById('add-item-btn');
            if (addBtn) {
                addBtn.disabled = true;
            }
        }

        function updateConnectionStatus(connected) {
            const indicator = document.querySelector('.status-indicator');
            if (!indicator) {
                // Status indicator element doesn't exist, just log the status
                console.log(`Connection status: ${connected ? 'Connected' : 'Disconnected'}`);
                return;
            }
            
            if (connected) {
                // Green Firebase logo for connected state
                indicator.innerHTML = `
                    <svg class="w-9 h-9 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M5.803 21.803l5.678-10.44L9.189 6.81l-3.386 14.993zm7.078-11.013L11.189 8.8l1.292-2.49L10.189 3.81l2.692 6.98zm3.908 8.15L14.481 8.8l2.308 10.14z"/>
                        <path d="M18.75 18.94L12 22.5l-6.75-3.56L12 2.5l6.75 16.44z" fill-opacity="0.3"/>
                    </svg>
                `;
                indicator.title = "Firebase Connected";
            } else {
                // Red Firebase logo for disconnected state
                indicator.innerHTML = `
                    <svg class="w-9 h-9 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M5.803 21.803l5.678-10.44L9.189 6.81l-3.386 14.993zm7.078-11.013L11.189 8.8l1.292-2.49L10.189 3.81l2.692 6.98zm3.908 8.15L14.481 8.8l2.308 10.14z"/>
                        <path d="M18.75 18.94L12 22.5l-6.75-3.56L12 2.5l6.75 16.44z" fill-opacity="0.3"/>
                    </svg>
                `;
                indicator.title = "Firebase Disconnected";
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay) {
                console.log('ℹ️ Loading overlay element not found');
                return;
            }
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function showError(message) {
            alert(message); // Simple alert for now, can be enhanced with a proper modal
        }

        function showSuccess(message) {
            alert(message); // Simple alert for now, can be enhanced with a proper modal
        }

        // Initialize quote
        function initializeQuote() {
            // Generate quote number
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            currentQuote.number = `INH-${dateStr}-${randomNum}`;
            
            // Set current date
            currentQuote.date = today.toISOString().split('T')[0];
            
            // Update form
            document.getElementById('quote-number').value = currentQuote.number;
            document.getElementById('quote-date').value = currentQuote.date;
            
            // Initialize shipping currency symbol
            const defaultCurrency = currentQuote.currency || 'INR';
            const shippingSymbol = document.getElementById('shipping-currency-symbol');
            if (shippingSymbol) {
                shippingSymbol.textContent = currencySymbols[defaultCurrency] || defaultCurrency + ' ';
            }
            
            // Initialize shipping input placeholder
            const shippingInput = document.getElementById('shipping-input');
            if (shippingInput) {
                shippingInput.placeholder = `Enter shipping amount in ${defaultCurrency}`;
            }
        }

        // Modal functions
        function openAddClientModal() {
            const modal = document.getElementById('add-client-modal');
            if (!modal) {
                console.log('ℹ️ Add client modal element not found');
                return;
            }
            modal.classList.remove('hidden');
            setTimeout(() => {
                const clientNameInput = document.getElementById('client-name');
                if (clientNameInput) {
                    clientNameInput.focus();
                }
            }, 100);
        }

        function closeAddClientModal() {
            const modal = document.getElementById('add-client-modal');
            const form = document.getElementById('add-client-form');
            if (!modal) {
                console.log('ℹ️ Add client modal element not found');
                return;
            }
            modal.classList.add('hidden');
            if (form) {
                form.reset();
            }
        }

        // Add new client
        async function addNewClient(event) {
            event.preventDefault();
            
            const clientName = document.getElementById('client-name').value.trim();
            const companyName = document.getElementById('company-name').value.trim();
            const email = document.getElementById('client-email').value.trim();
            const phone = document.getElementById('client-phone').value.trim();
            const address = document.getElementById('client-address').value.trim();
            
            if (!clientName) {
                showError('Client name is required');
                return;
            }
            
            try {
                showLoading(true);
                
                const newClient = {
                    clientName,
                    companyName,
                    email,
                    phone,
                    address,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    const savedClient = await window.firebaseDB.saveClient(newClient);
                    clientData.push(savedClient);
                    
                    // Add to dropdown
                    const selector = document.getElementById('client-selector');
                    const option = document.createElement('option');
                    option.value = savedClient.id;
                    option.textContent = `${clientName} (${companyName || 'No Company'})`;
                    
                    // Insert before "Add New Client" option
                    const addNewOption = selector.querySelector('option[value="add-new"]');
                    selector.insertBefore(option, addNewOption);
                    
                    // Select the new client
                    selector.value = savedClient.id;
                    currentQuote.client = savedClient;
                    
                    showSuccess('Client added successfully!');
                } else {
                    showError('Cannot add client: Firebase not available');
                }
                
                closeAddClientModal();
                
            } catch (error) {
                console.error('Error adding client:', error);
                showError('Failed to add client. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Save quote
        async function saveQuote() {
            if (currentQuote.items.length === 0) {
                showError('Cannot save empty quote. Please add at least one item.');
                return;
            }
            
            try {
                showLoading(true);
                
                // Update quote data from form
                const quoteData = {
                    ...currentQuote,
                    number: document.getElementById('quote-number').value || generateQuoteNumber(),
                    date: document.getElementById('quote-date').value || new Date().toISOString().split('T')[0],
                    salesperson: document.getElementById('salesperson-selector').value,
                    discount: parseFloat(document.getElementById('discount-input').value) || 0,
                    tax: parseFloat(document.getElementById('tax-input').value) || 18,
                    shipping: parseFloat(document.getElementById('shipping-input').value) || 0,
                    subtotal: calculateSubtotal(),
                    total: calculateTotal(),
                    status: 'draft',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    // Create a clean version for Firebase (without large base64 images)
                    const firebaseQuoteData = {
                        ...quoteData,
                        items: quoteData.items.map(item => ({
                            ...item,
                            // Remove large base64 images to prevent Firebase document size limit errors
                            colorImage: item.colorImage ? 'IMAGE_DATA_REMOVED' : null,
                            styleImage: item.styleImage ? 'IMAGE_DATA_REMOVED' : null
                        }))
                    };
                    
                    // Save to Firebase quotes collection
                    const savedQuote = await window.firebaseDB.saveQuote(firebaseQuoteData);
                    showSuccess('Quote saved successfully to Firebase!');
                    
                    // Update current quote with saved data
                    currentQuote = { ...quoteData, id: savedQuote.id };
                    
                    // Refresh saved quotes list
                    await loadSavedQuotes();
                } else {
                    // Save to localStorage as fallback
                    const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                    quoteData.id = Date.now().toString();
                    savedQuotes.push(quoteData);
                    localStorage.setItem('savedQuotes', JSON.stringify(savedQuotes));
                    showSuccess('Quote saved locally!');
                    
                    // Update current quote
                    currentQuote = quoteData;
                    
                    // Refresh saved quotes list
                    loadSavedQuotesFromLocal();
                }
                
            } catch (error) {
                console.error('Error saving quote:', error);
                showError('Failed to save quote. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Load saved quotes from Firebase
        async function loadSavedQuotes() {
            try {
                console.log('🔄 Loading saved quotes...');
                const container = document.getElementById('saved-quotes-container');
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    console.log('📊 Using Firebase for quotes');
                    const quotes = await window.firebaseDB.getQuotes();
                    console.log('📋 Retrieved quotes from Firebase:', quotes);
                    displaySavedQuotes(quotes);
                } else {
                    console.log('💾 Using localStorage for quotes');
                    loadSavedQuotesFromLocal();
                }
                
            } catch (error) {
                console.error('Error loading saved quotes:', error);
                const container = document.getElementById('saved-quotes-container');
                container.innerHTML = '<div class="text-center text-red-500 py-4"><p class="text-sm">Error loading quotes</p></div>';
            }
        }

        // Load saved quotes from localStorage
        function loadSavedQuotesFromLocal() {
            try {
                const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                displaySavedQuotes(savedQuotes);
            } catch (error) {
                console.error('Error loading local quotes:', error);
                const container = document.getElementById('saved-quotes-container');
                container.innerHTML = '<div class="text-center text-red-500 py-4"><p class="text-sm">Error loading local quotes</p></div>';
            }
        }

        // Display saved quotes in the UI
        function displaySavedQuotes(quotes) {
            const container = document.getElementById('saved-quotes-container');
            
            if (!quotes || quotes.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4"><p class="text-sm">No saved quotes yet</p></div>';
                return;
            }
            
            // Sort quotes by creation date (newest first)
            const sortedQuotes = quotes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            container.innerHTML = sortedQuotes.slice(0, 5).map(quote => {
                // Calculate total amount with currency symbol
                const total = quote.total || 0;
                const currency = quote.currency || 'INR';
                const symbol = currencySymbols[currency] || currency + ' ';
                const totalDisplay = `${symbol}${total.toFixed(2)}`;
                
                return `
                <div class="quote-item border rounded-lg p-1 mb-1 hover:bg-gray-50">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="text-xs text-gray-700">
                                <span class="font-semibold">${quote.number || 'No Number'}</span>
                                <span class="mx-1">-</span>
                                <span>${quote.client ? quote.client.clientName : 'No Client'}</span>
                                <span class="mx-1">-</span>
                                <span>${quote.items ? quote.items.length : 0} items</span>
                                <span class="mx-1">-</span>
                                <span class="font-semibold text-green-600">${totalDisplay}</span>
                                <span class="mx-1">-</span>
                                <span class="text-gray-500">${formatDate(quote.createdAt)}</span>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex items-center space-x-1">
                            <button onclick="recallQuote('${quote.id}')" class="action-btn-compact action-btn-recall" title="Recall for editing">
                                <span class="text-xs">📝</span>
                            </button>
                            <button onclick="previewQuote('${quote.id}')" class="action-btn-compact action-btn-preview" title="Generate proforma invoice">
                                <span class="text-xs">👁️</span>
                            </button>
                            <button onclick="deleteQuote('${quote.id}')" class="action-btn-compact action-btn-delete" title="Delete quote">
                                <span class="text-xs">🗑️</span>
                            </button>
                            <button onclick="convertToOrder('${quote.id}')" class="action-btn-compact action-btn-convert" title="Convert to order">
                                <span class="text-xs">📦</span>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Load quote data into the form
        async function loadQuoteData(quoteId) {
            try {
                showLoading(true);
                
                let quote = null;
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    const quotes = await window.firebaseDB.getQuotes();
                    quote = quotes.find(q => q.id === quoteId);
                } else {
                    const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                    quote = savedQuotes.find(q => q.id === quoteId);
                }
                
                if (quote) {
                    // Load quote data into form
                    currentQuote = { ...quote };
                    
                    // Set currency selector and apply conversion if needed
                    const quoteCurrency = quote.currency || 'INR';
                    const currentCurrency = document.getElementById('currency-selector').value;
                    document.getElementById('currency-selector').value = quoteCurrency;
                    
                    // Apply currency conversion to all quote items if currency has changed
                    if (quoteCurrency !== currentCurrency && currentQuote.items) {
                        console.log('💱 Converting loaded quote from', quoteCurrency, 'to', currentCurrency);
                        currentQuote.items.forEach(item => {
                            if (item.unitPrice) {
                                item.unitPrice = convertCurrency(item.unitPrice, quoteCurrency, currentCurrency);
                                item.totalPrice = item.unitPrice * item.quantity;
                            }
                        });
                        
                        // Convert summary amounts
                        if (currentQuote.subtotal) {
                            currentQuote.subtotal = convertCurrency(currentQuote.subtotal, quoteCurrency, currentCurrency);
                        }
                        if (currentQuote.discountAmount) {
                            currentQuote.discountAmount = convertCurrency(currentQuote.discountAmount, quoteCurrency, currentCurrency);
                        }
                        if (currentQuote.taxAmount) {
                            currentQuote.taxAmount = convertCurrency(currentQuote.taxAmount, quoteCurrency, currentCurrency);
                        }
                        if (currentQuote.shipping) {
                            currentQuote.shipping = convertCurrency(currentQuote.shipping, quoteCurrency, currentCurrency);
                        }
                        if (currentQuote.total) {
                            currentQuote.total = convertCurrency(currentQuote.total, quoteCurrency, currentCurrency);
                        }
                        
                        // Update currency in quote
                        currentQuote.currency = currentCurrency;
                    }
                    
                    // Update form fields
                    document.getElementById('quote-number').value = quote.number || '';
                    document.getElementById('quote-date').value = quote.date || '';
                    document.getElementById('salesperson-selector').value = quote.salesperson || '';
                    document.getElementById('discount-input').value = quote.discount || 0;
                    document.getElementById('tax-input').value = quote.tax || 18;
                    document.getElementById('shipping-input').value = quote.shipping || 0;
                    
                    // Set client if available
                    if (quote.client) {
                        document.getElementById('client-selector').value = quote.client.id || '';
                    }
                    
                    // Update displays
                    updateQuoteItemsDisplay();
                    updateQuoteSummary();
                    
                    showSuccess('Quote loaded successfully!');
                } else {
                    showError('Quote not found.');
                }
                
            } catch (error) {
                console.error('Error loading quote:', error);
                showError('Failed to load quote.');
            } finally {
                showLoading(false);
            }
        }

        // Helper function to calculate subtotal
        function calculateSubtotal() {
            return currentQuote.items.reduce((sum, item) => sum + item.totalPrice, 0);
        }

        // Helper function to calculate total
        function calculateTotal() {
            const subtotal = calculateSubtotal();
            const discount = parseFloat(document.getElementById('discount-input').value) || 0;
            const tax = parseFloat(document.getElementById('tax-input').value) || 0;
            const shipping = parseFloat(document.getElementById('shipping-input').value) || 0;
            
            const discountAmount = subtotal * (discount / 100);
            const taxableAmount = subtotal - discountAmount;
            const taxAmount = taxableAmount * (tax / 100);
            
            return taxableAmount + taxAmount + shipping;
        }

        // Helper function to format currency
        function formatCurrency(amount, currency) {
            // Use centralized language utilities if available
            if (window.LanguageUtils) {
                return window.LanguageUtils.formatCurrency(amount, currency);
            }
            // Fallback to basic formatting
            const symbol = currencySymbols[currency] || currency + ' ';
            return `${symbol}${amount.toFixed(2)}`;
        }

        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            // Use centralized language utilities if available
            if (window.LanguageUtils) {
                return window.LanguageUtils.formatDate(date, 'datetime');
            }
            // Fallback to English locale
            return date.toLocaleDateString('en-US') + ' ' + date.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'});
        }

        // Generate quote number
        function generateQuoteNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const time = String(date.getHours()).padStart(2, '0') + String(date.getMinutes()).padStart(2, '0');
            return `INH-${year}${month}${day}-${time}`;
        }



        // Clear quote
        function clearQuote() {
            if (confirm('Are you sure you want to clear the current quote? This action cannot be undone.')) {
                currentQuote.items = [];
                currentQuote.client = null;
                
                // Reset form
                document.getElementById('client-selector').value = '';
                document.getElementById('salesperson-selector').value = '';
                document.getElementById('price-list-selector').value = '';
                document.getElementById('discount-input').value = '0';
                document.getElementById('tax-input').value = '18';
                document.getElementById('shipping-input').value = '0';
                
                clearProductForm();
                updateQuoteItemsDisplay();
                updateQuoteSummary();
                
                showSuccess('Quote cleared successfully!');
            }
        }

        // Duplicate quote (placeholder)
        function duplicateQuote() {
            showError('Duplicate functionality will be implemented soon.');
        }

        // Load quote (placeholder)
        function loadQuote() {
            showError('Load quote functionality will be implemented soon.');
        }

        // Quote Management Actions

        // Recall quote for editing
        async function recallQuote(quoteId) {
            try {
                showLoading(true);
                
                let quote = null;
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    const quotes = await window.firebaseDB.getQuotes();
                    quote = quotes.find(q => q.id === quoteId);
                } else {
                    const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                    quote = savedQuotes.find(q => q.id === quoteId);
                }
                
                if (quote) {
                    // Load quote data into form
                    currentQuote = { ...quote };
                    
                    // Update form fields
                    document.getElementById('quote-number').value = quote.number || '';
                    document.getElementById('quote-date').value = quote.date || '';
                    document.getElementById('salesperson-selector').value = quote.salesperson || '';
                    document.getElementById('discount-input').value = quote.discount || 0;
                    document.getElementById('tax-input').value = quote.tax || 18;
                    document.getElementById('shipping-input').value = quote.shipping || 0;
                    
                    // Set client if available
                    if (quote.client) {
                        document.getElementById('client-selector').value = quote.client.id || '';
                    }
                    
                    // Update displays
                    updateQuoteItemsDisplay();
                    updateQuoteSummary();
                    
                    showSuccess('Quote recalled for editing!');
                    
                    // Scroll to top for better UX
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    showError('Quote not found.');
                }
                
            } catch (error) {
                console.error('Error recalling quote:', error);
                showError('Failed to recall quote.');
            } finally {
                showLoading(false);
            }
        }

        // Preview quote (generate proforma invoice)
        async function previewQuote(quoteId) {
            try {
                showLoading(true);
                
                let quote = null;
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    const quotes = await window.firebaseDB.getQuotes();
                    quote = quotes.find(q => q.id === quoteId);
                } else {
                    const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                    quote = savedQuotes.find(q => q.id === quoteId);
                }
                
                if (quote) {
                    // Generate proforma invoice preview (thermal printer format)
                    const proformaHTML = generateProformaHTML(quote);
                    
                    // Create a new document in the same window
                    document.open();
                    document.write(proformaHTML);
                    document.close();
                } else {
                    showError('Quote not found.');
                }
                
            } catch (error) {
                console.error('Error generating preview:', error);
                showError('Failed to generate preview.');
            } finally {
                showLoading(false);
            }
        }

        // Delete quote (update status to 'hold')
        async function deleteQuote(quoteId) {
            if (!confirm('Are you sure you want to delete this quote? It will be marked as "hold" status.')) {
                return;
            }
            
            try {
                showLoading(true);
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    // Update quote status to 'hold' in Firebase
                    await window.firebaseDB.updateAllData('quotes', quoteId, { status: 'hold', updatedAt: new Date().toISOString() });
                    showSuccess('Quote moved to hold status!');
                    
                    // Refresh saved quotes list
                    await loadSavedQuotes();
                } else {
                    // Update in localStorage
                    const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                    const quoteIndex = savedQuotes.findIndex(q => q.id === quoteId);
                    
                    if (quoteIndex !== -1) {
                        savedQuotes[quoteIndex].status = 'hold';
                        savedQuotes[quoteIndex].updatedAt = new Date().toISOString();
                        localStorage.setItem('savedQuotes', JSON.stringify(savedQuotes));
                        showSuccess('Quote moved to hold status!');
                        
                        // Refresh saved quotes list
                        loadSavedQuotesFromLocal();
                    } else {
                        showError('Quote not found.');
                    }
                }
                
            } catch (error) {
                console.error('Error deleting quote:', error);
                showError('Failed to delete quote.');
            } finally {
                showLoading(false);
            }
        }

        // Convert quote to order
        async function convertToOrder(quoteId) {
            if (!confirm('Are you sure you want to convert this quote to an order? This action cannot be undone.')) {
                return;
            }
            
            try {
                showLoading(true);
                
                let quote = null;
                
                if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                    const quotes = await window.firebaseDB.getQuotes();
                    quote = quotes.find(q => q.id === quoteId);
                } else {
                    const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                    quote = savedQuotes.find(q => q.id === quoteId);
                }
                
                if (quote) {
                    // Create order data from quote
                    const orderData = {
                        ...quote,
                        id: undefined, // Remove quote ID
                        orderId: generateOrderNumber(),
                        quoteId: quote.id,
                        status: 'pending',
                        orderDate: new Date().toISOString(),
                        type: 'order'
                    };
                    
                    if (window.firebaseDB && window.firebaseDB.isAvailable()) {
                        // Save to orders collection
                        await window.firebaseDB.saveOrder(orderData);
                        
                        // Update quote status to 'converted'
                        await window.firebaseDB.updateAllData('quotes', quoteId, { status: 'converted', updatedAt: new Date().toISOString() });
                        
                        showSuccess(`Quote converted to order ${orderData.orderId}!`);
                        
                        // Refresh saved quotes list
                        await loadSavedQuotes();
                    } else {
                        // Save to localStorage orders
                        const savedOrders = JSON.parse(localStorage.getItem('savedOrders') || '[]');
                        savedOrders.push(orderData);
                        localStorage.setItem('savedOrders', JSON.stringify(savedOrders));
                        
                        // Update quote status
                        const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
                        const quoteIndex = savedQuotes.findIndex(q => q.id === quoteId);
                        if (quoteIndex !== -1) {
                            savedQuotes[quoteIndex].status = 'converted';
                            savedQuotes[quoteIndex].updatedAt = new Date().toISOString();
                            localStorage.setItem('savedQuotes', JSON.stringify(savedQuotes));
                        }
                        
                        showSuccess(`Quote converted to order ${orderData.orderId}!`);
                        
                        // Refresh saved quotes list
                        loadSavedQuotesFromLocal();
                    }
                } else {
                    showError('Quote not found.');
                }
                
            } catch (error) {
                console.error('Error converting to order:', error);
                showError('Failed to convert quote to order.');
            } finally {
                showLoading(false);
            }
        }

        // Generate proforma invoice HTML
        function generateProformaHTML(quote) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Proforma Invoice - ${quote.number}</title>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        /* Thermal Printer Optimized Styles */
                        * { box-sizing: border-box; }
                        body { 
                            font-family: 'Courier New', monospace; 
                            margin: 0; 
                            padding: 8px; 
                            max-width: 380px; 
                            width: 100%; 
                            font-size: 11px; 
                            line-height: 1.2; 
                            color: #000; 
                            background: #fff;
                        }
                        
                        .header { 
                            text-align: center; 
                            margin-bottom: 15px; 
                            border-bottom: 1px solid #000;
                            padding-bottom: 8px;
                        }
                        .header h1 { 
                            font-size: 14px; 
                            margin: 0 0 4px 0; 
                            font-weight: bold; 
                        }
                        .header h2 { 
                            font-size: 12px; 
                            margin: 0; 
                            font-weight: normal; 
                        }
                        
                        .quote-info { 
                            margin-bottom: 15px; 
                            font-size: 10px;
                        }
                        .quote-info p { 
                            margin: 2px 0; 
                            word-wrap: break-word;
                        }
                        
                        /* Thermal printer friendly item list */
                        .items-section {
                            margin-bottom: 15px;
                            border-top: 1px solid #000;
                            border-bottom: 1px solid #000;
                            padding: 8px 0;
                        }
                        .items-header {
                            font-weight: bold;
                            font-size: 11px;
                            margin-bottom: 8px;
                            text-align: center;
                        }
                        .item {
                            margin-bottom: 8px;
                            padding-bottom: 6px;
                            border-bottom: 1px dashed #000;
                            display: flex;
                            align-items: flex-start;
                            gap: 8px;
                        }
                        .item:last-child {
                            border-bottom: none;
                            margin-bottom: 0;
                        }
                        .item-image {
                            width: 40px;
                            height: 40px;
                            object-fit: contain;
                            border: 1px solid #000;
                            flex-shrink: 0;
                        }
                        .item-content {
                            flex: 1;
                            min-width: 0;
                        }
                        .item-line {
                            margin: 1px 0;
                            font-size: 10px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        .item-details {
                            flex: 1;
                            margin-right: 10px;
                        }
                        .item-calculation {
                            text-align: right;
                            font-weight: bold;
                            white-space: nowrap;
                        }
                        .item-price {
                            text-align: right;
                            font-weight: bold;
                        }
                        
                        .totals { 
                            font-size: 10px;
                            border-top: 2px solid #000;
                            padding-top: 8px;
                        }
                        .totals p { 
                            margin: 2px 0; 
                            display: flex; 
                            justify-content: space-between;
                        }
                        .total-row { 
                            font-weight: bold; 
                            font-size: 12px; 
                            border-top: 1px solid #000;
                            padding-top: 4px;
                            margin-top: 4px;
                        }
                        
                        /* Print optimizations */
                        @media print {
                            body { margin: 0; padding: 4px; }
                            .header { page-break-inside: avoid; }
                            .item { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>PROFORMA INVOICE</h1>
                        <h2>Indian Natural Hair</h2>
                    </div>
                    
                    <div class="quote-info">
                        <p><strong>Quote #:</strong> ${quote.number || 'N/A'}</p>
                        <p><strong>Date:</strong> ${quote.date || 'N/A'}</p>
                        <p><strong>Client:</strong> ${quote.client ? quote.client.clientName : 'N/A'}</p>
                        <p><strong>Salesperson:</strong> ${quote.salesperson || 'N/A'}</p>
                    </div>
                    
                    <div class="items-section">
                        <div class="items-header">ITEMS</div>
                        ${quote.items ? quote.items.map((item, index) => {
                            const imagePath = getProductImagePath(item.product || '');
                            return '<div class="item">' +
                                '<img src="' + imagePath + '" alt="' + (item.product || 'Product') + '" class="item-image" onerror="this.src=\'images/Products/Genius.png\'">' +
                                '<div class="item-content">' +
                                    '<div class="item-line">' +
                                        '<span class="item-details">' +
                                            '<strong>' + (item.product || 'N/A') + '</strong> | ' +
                                            (item.category || 'N/A') + ' | ' +
                                            (item.density || 'N/A') + ' | ' +
                                            (item.length || 'N/A') + ' | ' +
                                            (item.color || 'N/A') + ' | ' +
                                            (item.style || 'N/A') +
                                        '</span>' +
                                        '<span class="item-calculation">' +
                                            'Qty: ' + (item.quantity || 0) + ' x ' + formatCurrency(item.unitPrice || 0, quote.currency || 'INR') + ' = ' +
                                            formatCurrency(item.totalPrice || 0, quote.currency || 'INR') +
                                        '</span>' +
                                    '</div>' +
                                '</div>' +
                            '</div>';
                        }).join('') : '<div class="item">No items</div>'}
                    </div>
                    
                    <div class="totals">
                        <p><span>Subtotal:</span><span>${formatCurrency(quote.subtotal || 0, quote.currency || 'INR')}</span></p>
                        <p><span>Discount:</span><span>${formatCurrency(quote.discountAmount || 0, quote.currency || 'INR')}</span></p>
                        <p><span>Tax (${quote.tax || 0}%):</span><span>${formatCurrency(quote.taxAmount || 0, quote.currency || 'INR')}</span></p>
                        <p><span>Shipping:</span><span>${formatCurrency(quote.shipping || 0, quote.currency || 'INR')}</span></p>
                        <p class="total-row"><span>TOTAL:</span><span>${formatCurrency(quote.total || 0, quote.currency || 'INR')}</span></p>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center; border-top: 1px solid #000; padding-top: 15px;">
                        <button id="smartDownloadBtn" onclick="smartDownload()" style="background-color: #081249; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 12px; cursor: pointer; margin-right: 10px;">
                            📄 Smart Download
                        </button>
                        <button onclick="window.print()" style="background-color: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 12px; cursor: pointer;">
                            🖨️ Print
                        </button>
                        <div id="downloadInfo" style="margin-top: 10px; font-size: 10px; color: #666; font-style: italic;">
                            Analyzing content size...
                        </div>
                    </div>
                    
                    <script>
                        // Include jsPDF in the preview window
                        const jsPDFScript = document.createElement('script');
                        jsPDFScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                        document.head.appendChild(jsPDFScript);
                        
                        // Include HTML2Canvas in the preview window
                        const html2canvasScript = document.createElement('script');
                        html2canvasScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                        document.head.appendChild(html2canvasScript);
                        
                        // Quote data will be received via postMessage
                        let quoteData = null;
                        
                        // Listen for quote data from parent window
                        window.addEventListener('message', function(event) {
                            if (event.data.type === 'QUOTE_DATA') {
                                quoteData = event.data.quote;
                            }
                        });
                        
                        // Format currency function
                        function formatCurrency(amount, currency = 'INR') {
                            // Use centralized language utilities if available
                            if (window.LanguageUtils) {
                                return window.LanguageUtils.formatCurrency(amount, currency);
                            }
                            // Fallback to basic formatting
                            const symbols = {
                                'INR': '₹',
                                'USD': '$',
                                'EUR': '€',
                                'GBP': '£'
                            };
                            const symbol = symbols[currency] || currency;
                            return symbol + ' ' + parseFloat(amount || 0).toFixed(2);
                        }
                        
                        // Get product image path function
                        function getProductImagePath(productName) {
                            if (!productName) return 'images/Products/Genius.png';
                            
                            // Clean the product name and create filename
                            const cleanName = productName.trim();
                            const filename = cleanName + '.png';
                            
                            return 'images/Products/' + filename;
                        }
                        
                        // Content measurement and smart download functionality
                        function measureContent() {
                            const content = document.body;
                            const rect = content.getBoundingClientRect();
                            
                            // A4 dimensions in pixels (at 96 DPI)
                            const A4_WIDTH_PX = 794;  // 210mm at 96 DPI
                            const A4_HEIGHT_PX = 1123; // 297mm at 96 DPI
                            
                            // Account for margins (20mm on each side)
                            const USABLE_WIDTH = A4_WIDTH_PX - 152; // ~20mm margins
                            const USABLE_HEIGHT = A4_HEIGHT_PX - 152; // ~20mm margins
                            
                            const contentWidth = rect.width;
                            const contentHeight = rect.height;
                            
                            // Determine if content fits in single A4 page
                            const fitsInA4 = contentWidth <= USABLE_WIDTH && contentHeight <= USABLE_HEIGHT;
                            
                            // Calculate number of items for complexity assessment
                            const itemCount = quoteData && quoteData.items ? quoteData.items.length : 0;
                            
                            return {
                                width: contentWidth,
                                height: contentHeight,
                                fitsInA4: fitsInA4,
                                itemCount: itemCount,
                                recommendedFormat: fitsInA4 && itemCount <= 5 ? 'image' : 'pdf'
                            };
                        }
                        
                        // Update download info display
                        function updateDownloadInfo() {
                            const measurement = measureContent();
                            const infoElement = document.getElementById('downloadInfo');
                            const btnElement = document.getElementById('smartDownloadBtn');
                            
                            if (measurement.recommendedFormat === 'image') {
                                infoElement.textContent = 'Will download as IMAGE (' + Math.round(measurement.width) + '×' + Math.round(measurement.height) + 'px, fits A4)';
                                btnElement.innerHTML = '🖼️ Download Image';
                                btnElement.style.backgroundColor = '#2563eb';
                            } else {
                                infoElement.textContent = 'Will download as PDF (' + measurement.itemCount + ' items, multi-page content)';
                                btnElement.innerHTML = '📄 Download PDF';
                                btnElement.style.backgroundColor = '#dc2626';
                            }
                        }
                        
                        // Smart download function
                        async function smartDownload() {
                            try {
                                const measurement = measureContent();
                                
                                if (measurement.recommendedFormat === 'image') {
                                    await downloadAsImage();
                                } else {
                                    await downloadAsPDF();
                                }
                            } catch (error) {
                                console.error('Error in smart download:', error);
                                alert('Error generating download. Please try again.');
                            }
                        }
                        
                        // Download as optimized image
                        async function downloadAsImage() {
                            if (!window.html2canvas) {
                                alert('Image library is loading, please try again in a moment.');
                                return;
                            }
                            
                            // Hide the download buttons temporarily for clean capture
                            const buttonsDiv = document.querySelector('div[style*="border-top: 1px solid #000"]');
                            const originalDisplay = buttonsDiv.style.display;
                            buttonsDiv.style.display = 'none';
                            
                            try {
                                const canvas = await html2canvas(document.body, {
                                    scale: 2, // High quality
                                    useCORS: true,
                                    allowTaint: true,
                                    backgroundColor: '#ffffff',
                                    width: 794, // A4 width in pixels
                                    height: null // Auto height
                                });
                                
                                // Create download link
                                const link = document.createElement('a');
                                link.download = 'Proforma_Invoice_' + (quoteData.number || 'Quote') + '.png';
                                link.href = canvas.toDataURL('image/png', 0.95);
                                link.click();
                                
                            } finally {
                                // Restore buttons
                                buttonsDiv.style.display = originalDisplay;
                            }
                        }
                        
                    }

                </body>
                </html>
            `;
        }

        // Get product image path
        function getProductImagePath(product, category, density, length, colorType, color) {
            console.log('getProductImagePath called with:', { product, category, density, length, colorType, color });
            
            // Product image mapping based on actual files in images/Products/
            const productImageMap = {
                'BUN': 'BUN.png',
                'Bangs': 'Bangs.png',
                'Bulk': 'Bulk.png',
                'ClipOn': 'ClipOn.png',
                'Closure': 'Closure.png',
                'ClutchBun': 'ClutchBun.png',
                'CoverPatch': 'CoverPatch.png',
                'CurlyBun': 'CurlyBun.png',
                'FLATCLIPPONYTAIL': 'FLATCLIPPONYTAIL.png',
                'FlatTips': 'FlatTips.png',
                'Frontal': 'Frontal.png',
                'Frontline': 'Frontline.png',
                'Genius': 'Genius.png',
                'Halo': 'Halo.png',
                'Highlights': 'Highlights.png',
                'ITIPS': 'ITIPS.png',
                'Nano': 'Nano.png',
                'PonyTail': 'PonyTail.png',
                'SILKTOPPER': 'SILKTOPPER.png',
                'Tapes': 'Tapes.png',
                'UTIPS': 'UTIPS.png',
                'WIGCLOSURE': 'WIGCLOSURE.png',
                'WIGFRONTAL': 'WIGFRONTAL.png',
                'Weaves-DD': 'Weaves-DD.png',
                'Weaves-SD': 'Weaves-SD.png',
                'Weaves-SDD': 'Weaves-SDD.png',
                'YTIPS': 'YTIPS.png'
            };

            // Try to find image by product name first (exact match)
            if (product && productImageMap[product]) {
                const path = `images/Products/${productImageMap[product]}`;
                console.log('Exact match found:', path);
                return path;
            }

            // Try partial matches for common variations
            const productLower = product ? product.toLowerCase() : '';
            for (const [key, value] of Object.entries(productImageMap)) {
                if (key.toLowerCase().includes(productLower) || productLower.includes(key.toLowerCase())) {
                    const path = `images/Products/${value}`;
                    console.log('Partial match found:', path);
                    return path;
                }
            }

            // Fallback to a default image (use one of the existing images)
            const fallbackPath = 'images/Products/Genius.png';
            console.log('Using fallback image:', fallbackPath);
            return fallbackPath;
        }

        // Generate order number
        function generateOrderNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const time = String(date.getHours()).padStart(2, '0') + String(date.getMinutes()).padStart(2, '0');
            return `ORD-${year}${month}${day}-${time}`;
        }

        // Test function for debugging image upload functionality
        function testImageUploadFunctionality() {
            console.log('🧪 Starting image upload functionality test...');
            
            // Test 1: Check if image display elements exist
            const colorImageDisplay = document.getElementById('color-image-display');
            const styleImageDisplay = document.getElementById('style-image-display');
            
            console.log('🔍 Image display elements check:', {
                colorImageDisplay: !!colorImageDisplay,
                styleImageDisplay: !!styleImageDisplay,
                colorImageDisplaySrc: colorImageDisplay ? colorImageDisplay.src : 'N/A',
                styleImageDisplaySrc: styleImageDisplay ? styleImageDisplay.src : 'N/A'
            });
            
            // Test 2: Simulate adding an item and check if elements still exist
            console.log('🧪 Simulating form clear...');
            clearProductForm();
            
            const colorImageDisplayAfter = document.getElementById('color-image-display');
            const styleImageDisplayAfter = document.getElementById('style-image-display');
            
            console.log('🔍 Image display elements after clear:', {
                colorImageDisplay: !!colorImageDisplayAfter,
                styleImageDisplay: !!styleImageDisplayAfter,
                colorImageDisplaySrc: colorImageDisplayAfter ? colorImageDisplayAfter.src : 'N/A',
                styleImageDisplaySrc: styleImageDisplayAfter ? styleImageDisplayAfter.src : 'N/A'
            });
            
            if (colorImageDisplayAfter && styleImageDisplayAfter) {
                console.log('✅ Image display elements preserved after form clear - fix successful!');
            } else {
                console.log('❌ Image display elements missing after form clear - fix failed!');
            }
            
            return {
                beforeClear: { colorImageDisplay: !!colorImageDisplay, styleImageDisplay: !!styleImageDisplay },
                afterClear: { colorImageDisplay: !!colorImageDisplayAfter, styleImageDisplay: !!styleImageDisplayAfter }
            };
        }

        // Test function to diagnose second quote line rendering
        function testSecondQuoteLineRendering() {
            console.log('🧪 Testing second quote line rendering...');
            
            // Clear existing items
            currentQuote.items = [];
            
            // Add two test items
            const testItem1 = {
                id: 'test-1',
                product: 'Genius',
                category: 'Genius',
                density: '150',
                length: '12',
                colorType: 'Natural',
                color: 'Black',
                style: 'Straight',
                quantity: 1,
                unitPrice: 100,
                totalPrice: 100,
                customColor: false,
                customStyle: false,
                colorImage: null,
                styleImage: null
            };
            
            const testItem2 = {
                id: 'test-2',
                product: 'Tapes',
                category: 'Tapes',
                density: '180',
                length: '14',
                colorType: 'Colored',
                color: 'Brown',
                style: 'Wavy',
                quantity: 2,
                unitPrice: 150,
                totalPrice: 300,
                customColor: false,
                customStyle: false,
                colorImage: null,
                styleImage: null
            };
            
            console.log('➕ Adding first test item:', testItem1);
            currentQuote.items.push(testItem1);
            updateQuoteItemsDisplay();
            
            setTimeout(() => {
                console.log('➕ Adding second test item:', testItem2);
                currentQuote.items.push(testItem2);
                updateQuoteItemsDisplay();
                
                console.log('✅ Test completed. Check the quote items display for any issues.');
            }, 1000);
        }

        // Add test button functionality (for debugging purposes)
        window.testSecondQuoteLineRendering = testSecondQuoteLineRendering;
        window.testImageUploadFunctionality = testImageUploadFunctionality;
        
        // Mobile menu functionality
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                });
            }
        });
    </script>
</body>
</html>
