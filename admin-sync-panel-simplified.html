<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Sync Panel - Simplified</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Local scripts -->
    <script src="/firebase-config.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Admin Sync Panel - Simplified</h1>
                        <p class="text-gray-600 mt-2">Firebase-only operations (Google Sheets bypassed)</p>
                    </div>
                    <div class="text-right">
                        <div id="connectionStatus" class="text-sm">
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center">
                                    <div id="firebaseIndicator" class="w-3 h-3 rounded-full bg-gray-400 mr-2"></div>
                                    <span>Firebase: <span id="firebaseStatus">Checking...</span></span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-yellow-400 mr-2"></div>
                                    <span>Google Sheets: Bypassed</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Panel -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">System Status</h2>
                <div id="statusMessage" class="p-4 rounded-lg bg-blue-50 text-blue-800">
                    Initializing Firebase connection...
                </div>
            </div>

            <!-- Firebase Operations -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Firebase Operations</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <button id="testFirebase" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                        <i class="fas fa-database mr-2"></i>
                        Test Firebase Connection
                    </button>
                    <button id="viewCollections" class="bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">
                        <i class="fas fa-list mr-2"></i>
                        View Collections
                    </button>
                    <button id="backupData" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg">
                        <i class="fas fa-download mr-2"></i>
                        Backup Data
                    </button>
                    <button id="clearCache" class="bg-orange-500 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg">
                        <i class="fas fa-trash mr-2"></i>
                        Clear Cache
                    </button>
                    <button id="syncLocalStorage" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">
                        <i class="fas fa-sync mr-2"></i>
                        Sync Local Storage
                    </button>
                    <button id="generateReport" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">
                        <i class="fas fa-chart-bar mr-2"></i>
                        Generate Report
                    </button>
                </div>
            </div>

            <!-- Data Overview -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Data Overview</h2>
                <div id="dataOverview" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Activity Log -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Activity Log</h2>
                <div id="activityLog" class="bg-gray-50 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm">
                    <!-- Activity log will appear here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let db = null;
        
        function log(message) {
            const logDiv = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, className = 'p-4 rounded-lg bg-blue-50 text-blue-800') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = className;
        }
        
        function updateFirebaseStatus(status, color) {
            document.getElementById('firebaseStatus').textContent = status;
            document.getElementById('firebaseIndicator').className = `w-3 h-3 rounded-full ${color} mr-2`;
        }
        
        async function initializeSystem() {
            log('Starting simplified admin panel...');
            updateStatus('Initializing Firebase...');
            
            try {
                // Initialize Firebase
                if (typeof initializeFirebaseApp === 'function') {
                    initializeFirebaseApp();
                    db = firebase.firestore();
                    
                    // Test Firebase connection
                    await db.collection('test').limit(1).get();
                    
                    updateFirebaseStatus('Connected', 'bg-green-500');
                    updateStatus('✅ Firebase connected successfully! Ready for operations.', 'p-4 rounded-lg bg-green-50 text-green-800');
                    log('✓ Firebase initialized and connected');
                    
                    // Load data overview
                    await loadDataOverview();
                    
                } else {
                    throw new Error('Firebase initialization function not found');
                }
                
            } catch (error) {
                updateFirebaseStatus('Error', 'bg-red-500');
                updateStatus('❌ Firebase connection failed: ' + error.message, 'p-4 rounded-lg bg-red-50 text-red-800');
                log('❌ Firebase error: ' + error.message);
            }
        }
        
        async function loadDataOverview() {
            const collections = ['products', 'clients', 'salesmen', 'styles', 'colors', 'pricelists'];
            const overviewDiv = document.getElementById('dataOverview');
            overviewDiv.innerHTML = '';
            
            for (const collection of collections) {
                try {
                    const snapshot = await db.collection(collection).limit(1000).get();
                    const count = snapshot.size;
                    
                    const div = document.createElement('div');
                    div.className = 'text-center p-4 bg-gray-50 rounded-lg';
                    div.innerHTML = `
                        <div class="text-2xl font-bold text-blue-600">${count}</div>
                        <div class="text-sm text-gray-600 capitalize">${collection}</div>
                    `;
                    overviewDiv.appendChild(div);
                    
                } catch (error) {
                    const div = document.createElement('div');
                    div.className = 'text-center p-4 bg-red-50 rounded-lg';
                    div.innerHTML = `
                        <div class="text-2xl font-bold text-red-600">Error</div>
                        <div class="text-sm text-gray-600 capitalize">${collection}</div>
                    `;
                    overviewDiv.appendChild(div);
                }
            }
        }
        
        // Event listeners
        document.getElementById('testFirebase').addEventListener('click', async () => {
            log('Testing Firebase connection...');
            try {
                const testDoc = await db.collection('test').add({
                    timestamp: new Date(),
                    test: 'connection'
                });
                log('✓ Firebase write test successful: ' + testDoc.id);
                updateStatus('✅ Firebase test successful!', 'p-4 rounded-lg bg-green-50 text-green-800');
            } catch (error) {
                log('❌ Firebase test failed: ' + error.message);
                updateStatus('❌ Firebase test failed: ' + error.message, 'p-4 rounded-lg bg-red-50 text-red-800');
            }
        });
        
        document.getElementById('viewCollections').addEventListener('click', async () => {
            log('Loading collection data...');
            await loadDataOverview();
            log('✓ Collection data refreshed');
        });
        
        document.getElementById('backupData').addEventListener('click', async () => {
            log('Starting data backup...');
            const collections = ['products', 'clients', 'salesmen', 'styles', 'colors', 'pricelists'];
            const backup = {};
            
            try {
                for (const collection of collections) {
                    const snapshot = await db.collection(collection).get();
                    backup[collection] = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                }
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `firebase_backup_${Date.now()}.json`;
                link.click();
                
                log('✓ Data backup completed');
                updateStatus('✅ Data backup downloaded successfully!', 'p-4 rounded-lg bg-green-50 text-green-800');
                
            } catch (error) {
                log('❌ Backup failed: ' + error.message);
                updateStatus('❌ Backup failed: ' + error.message, 'p-4 rounded-lg bg-red-50 text-red-800');
            }
        });
        
        document.getElementById('clearCache').addEventListener('click', () => {
            localStorage.clear();
            sessionStorage.clear();
            log('✓ Cache cleared');
            updateStatus('✅ Cache cleared successfully!', 'p-4 rounded-lg bg-green-50 text-green-800');
        });
        
        document.getElementById('syncLocalStorage').addEventListener('click', async () => {
            log('Syncing Firebase to Local Storage...');
            const collections = ['products', 'clients', 'salesmen', 'styles', 'colors', 'pricelists'];
            
            try {
                for (const collection of collections) {
                    const snapshot = await db.collection(collection).get();
                    const data = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    localStorage.setItem(collection, JSON.stringify(data));
                    log(`✓ Synced ${data.length} ${collection} records to localStorage`);
                }
                
                updateStatus('✅ Local storage sync completed!', 'p-4 rounded-lg bg-green-50 text-green-800');
                
            } catch (error) {
                log('❌ Local storage sync failed: ' + error.message);
                updateStatus('❌ Sync failed: ' + error.message, 'p-4 rounded-lg bg-red-50 text-red-800');
            }
        });
        
        document.getElementById('generateReport').addEventListener('click', async () => {
            log('Generating system report...');
            const report = {
                timestamp: new Date().toISOString(),
                firebase: {
                    connected: db !== null,
                    collections: {}
                },
                localStorage: {},
                browser: {
                    userAgent: navigator.userAgent,
                    localStorage: typeof Storage !== 'undefined'
                }
            };
            
            // Check Firebase collections
            const collections = ['products', 'clients', 'salesmen', 'styles', 'colors', 'pricelists'];
            for (const collection of collections) {
                try {
                    const snapshot = await db.collection(collection).get();
                    report.firebase.collections[collection] = snapshot.size;
                } catch (error) {
                    report.firebase.collections[collection] = 'Error: ' + error.message;
                }
            }
            
            // Check localStorage
            for (const collection of collections) {
                const data = localStorage.getItem(collection);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        report.localStorage[collection] = Array.isArray(parsed) ? parsed.length : 1;
                    } catch {
                        report.localStorage[collection] = 'Invalid JSON';
                    }
                } else {
                    report.localStorage[collection] = 0;
                }
            }
            
            const reportStr = JSON.stringify(report, null, 2);
            const reportBlob = new Blob([reportStr], {type: 'application/json'});
            const url = URL.createObjectURL(reportBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `system_report_${Date.now()}.json`;
            link.click();
            
            log('✓ System report generated and downloaded');
            updateStatus('✅ System report generated!', 'p-4 rounded-lg bg-green-50 text-green-800');
        });
        
        // Initialize on page load
        window.addEventListener('load', initializeSystem);
    </script>
</body>
</html>