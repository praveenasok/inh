<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets Accessibility Diagnostic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="max-w-6xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">üîç Google Sheets Accessibility Diagnostic</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h2 class="text-lg font-semibold text-blue-800 mb-2">Configuration</h2>
                    <div id="configInfo" class="text-sm text-blue-700">
                        Loading configuration...
                    </div>
                </div>
                
                <div class="bg-green-50 p-4 rounded-lg">
                    <h2 class="text-lg font-semibold text-green-800 mb-2">Status</h2>
                    <div id="statusInfo" class="text-sm text-green-700">
                        Ready to diagnose
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex flex-wrap gap-2">
                    <button id="testApiKey" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Test API Key
                    </button>
                    <button id="testConfiguredSheet" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                        Test Configured Sheet
                    </button>
                    <button id="testPublicSheet" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                        Test Public Sheet
                    </button>
                    <button id="testPermissions" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded">
                        Test Permissions
                    </button>
                    <button id="runFullDiagnostic" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        Full Diagnostic
                    </button>
                    <button id="clearResults" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                        Clear
                    </button>
                </div>
            </div>

            <div id="results" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_KEY = '35bbf27b0bf3abb0a9fec63e815006a5785ec7bb';
        const CONFIGURED_SHEET_ID = '1hlfrnZnNQ0u8idg5KDmkSY4zFhLyvjLqUwAZn6HmW3s';
        const PUBLIC_SHEET_ID = '1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms'; // Google's sample sheet
        
        let diagnosticResults = [];

        function updateConfigInfo() {
            const configDiv = document.getElementById('configInfo');
            configDiv.innerHTML = `
                <strong>API Key:</strong> ${API_KEY.substring(0, 8)}...${API_KEY.substring(API_KEY.length - 4)}<br>
                <strong>Configured Sheet:</strong> ${CONFIGURED_SHEET_ID.substring(0, 15)}...<br>
                <strong>Public Test Sheet:</strong> ${PUBLIC_SHEET_ID.substring(0, 15)}...<br>
                <strong>GAPI Status:</strong> ${typeof gapi !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Not Loaded'}
            `;
        }

        function updateStatus(status, color = 'green') {
            const statusDiv = document.getElementById('statusInfo');
            statusDiv.innerHTML = `<span class="text-${color}-700">${status}</span>`;
        }

        function addResult(test, status, message, details = '', recommendation = '') {
            const result = { test, status, message, details, recommendation, timestamp: new Date().toLocaleTimeString() };
            diagnosticResults.push(result);
            displayResult(result);
        }

        function displayResult(result) {
            const resultsDiv = document.getElementById('results');
            const statusColors = {
                'success': 'bg-green-100 border-green-500 text-green-700',
                'error': 'bg-red-100 border-red-500 text-red-700',
                'warning': 'bg-yellow-100 border-yellow-500 text-yellow-700',
                'info': 'bg-blue-100 border-blue-500 text-blue-700'
            };

            const statusIcons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };

            const resultDiv = document.createElement('div');
            resultDiv.className = `border-l-4 p-4 ${statusColors[result.status]}`;
            resultDiv.innerHTML = `
                <div class="flex items-start">
                    <span class="text-lg mr-3 mt-1">${statusIcons[result.status]}</span>
                    <div class="flex-1">
                        <h3 class="font-semibold">${result.test}</h3>
                        <p class="mt-1">${result.message}</p>
                        ${result.details ? `<div class="mt-2 text-sm opacity-75 whitespace-pre-line">${result.details}</div>` : ''}
                        ${result.recommendation ? `<div class="mt-2 text-sm font-medium">üí° Recommendation: ${result.recommendation}</div>` : ''}
                        <div class="text-xs opacity-50 mt-2">${result.timestamp}</div>
                    </div>
                </div>
            `;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function testApiKey() {
            updateStatus('Testing API Key...', 'blue');
            addResult('API Key Test', 'info', 'Testing API key validity...');
            
            try {
                // Test with a simple API call
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${PUBLIC_SHEET_ID}?key=${API_KEY}`);
                
                if (response.ok) {
                    const data = await response.json();
                    addResult('API Key Test', 'success', 'API key is valid and working!', 
                        `Successfully accessed public sheet: "${data.properties.title}"`);
                    updateStatus('API Key: ‚úÖ Valid', 'green');
                    return true;
                } else {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { message: errorText };
                    }
                    
                    let recommendation = '';
                    if (response.status === 400) {
                        recommendation = 'Check if the API key format is correct and not corrupted.';
                    } else if (response.status === 403) {
                        recommendation = 'Enable Google Sheets API in Google Cloud Console and check API key restrictions.';
                    } else if (response.status === 429) {
                        recommendation = 'API quota exceeded. Wait a moment and try again, or check quota limits.';
                    }
                    
                    addResult('API Key Test', 'error', `API key validation failed: HTTP ${response.status}`, 
                        `Error: ${JSON.stringify(errorData, null, 2)}`, recommendation);
                    updateStatus('API Key: ‚ùå Invalid', 'red');
                    return false;
                }
            } catch (error) {
                addResult('API Key Test', 'error', 'Network error during API key test', 
                    error.message, 'Check internet connection and try again.');
                updateStatus('API Key: ‚ùå Network Error', 'red');
                return false;
            }
        }

        async function testConfiguredSheet() {
            updateStatus('Testing Configured Sheet...', 'blue');
            addResult('Configured Sheet Test', 'info', 'Testing access to configured spreadsheet...');
            
            try {
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${CONFIGURED_SHEET_ID}?key=${API_KEY}`);
                
                if (response.ok) {
                    const data = await response.json();
                    addResult('Configured Sheet Test', 'success', 'Successfully accessed configured spreadsheet!', 
                        `Title: "${data.properties.title}"\nSheets: ${data.sheets.map(s => s.properties.title).join(', ')}\nOwner: ${data.properties.locale || 'Unknown'}`);
                    updateStatus('Configured Sheet: ‚úÖ Accessible', 'green');
                    return true;
                } else {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { message: errorText };
                    }
                    
                    let recommendation = '';
                    if (response.status === 403) {
                        recommendation = 'Make the spreadsheet public or share it with the service account email.';
                    } else if (response.status === 404) {
                        recommendation = 'Check if the spreadsheet ID is correct and the sheet exists.';
                    }
                    
                    addResult('Configured Sheet Test', 'error', `Cannot access configured spreadsheet: HTTP ${response.status}`, 
                        `Error: ${JSON.stringify(errorData, null, 2)}`, recommendation);
                    updateStatus('Configured Sheet: ‚ùå Not Accessible', 'red');
                    return false;
                }
            } catch (error) {
                addResult('Configured Sheet Test', 'error', 'Network error accessing configured spreadsheet', 
                    error.message, 'Check internet connection and spreadsheet ID.');
                updateStatus('Configured Sheet: ‚ùå Network Error', 'red');
                return false;
            }
        }

        async function testPublicSheet() {
            updateStatus('Testing Public Sheet...', 'blue');
            addResult('Public Sheet Test', 'info', 'Testing access to known public spreadsheet...');
            
            try {
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${PUBLIC_SHEET_ID}?key=${API_KEY}`);
                
                if (response.ok) {
                    const data = await response.json();
                    addResult('Public Sheet Test', 'success', 'Successfully accessed public spreadsheet!', 
                        `This confirms the API key works with public sheets.\nTitle: "${data.properties.title}"`);
                    updateStatus('Public Sheet: ‚úÖ Accessible', 'green');
                    return true;
                } else {
                    addResult('Public Sheet Test', 'error', `Cannot access public spreadsheet: HTTP ${response.status}`, 
                        'This indicates an issue with the API key or Google Sheets API access.');
                    updateStatus('Public Sheet: ‚ùå Not Accessible', 'red');
                    return false;
                }
            } catch (error) {
                addResult('Public Sheet Test', 'error', 'Network error accessing public spreadsheet', error.message);
                updateStatus('Public Sheet: ‚ùå Network Error', 'red');
                return false;
            }
        }

        async function testPermissions() {
            updateStatus('Testing Permissions...', 'blue');
            addResult('Permissions Test', 'info', 'Testing various permission levels...');
            
            try {
                // Test read access to configured sheet values
                const valuesResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${CONFIGURED_SHEET_ID}/values/A1:Z10?key=${API_KEY}`);
                
                if (valuesResponse.ok) {
                    const valuesData = await valuesResponse.json();
                    addResult('Read Permissions', 'success', 'Can read spreadsheet values', 
                        `Retrieved ${valuesData.values ? valuesData.values.length : 0} rows of data`);
                } else {
                    const errorData = await valuesResponse.json().catch(() => ({}));
                    addResult('Read Permissions', 'error', `Cannot read spreadsheet values: HTTP ${valuesResponse.status}`, 
                        JSON.stringify(errorData, null, 2));
                }

                // Test if we can get spreadsheet metadata
                const metadataResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${CONFIGURED_SHEET_ID}?fields=properties,sheets.properties&key=${API_KEY}`);
                
                if (metadataResponse.ok) {
                    const metadataData = await metadataResponse.json();
                    addResult('Metadata Permissions', 'success', 'Can read spreadsheet metadata', 
                        `Sheets: ${metadataData.sheets ? metadataData.sheets.length : 0}`);
                } else {
                    addResult('Metadata Permissions', 'error', `Cannot read spreadsheet metadata: HTTP ${metadataResponse.status}`);
                }

                updateStatus('Permissions: Tested', 'blue');
                return true;
            } catch (error) {
                addResult('Permissions Test', 'error', 'Error testing permissions', error.message);
                updateStatus('Permissions: ‚ùå Error', 'red');
                return false;
            }
        }

        async function runFullDiagnostic() {
            updateStatus('Running Full Diagnostic...', 'blue');
            addResult('Full Diagnostic', 'info', 'Starting comprehensive diagnostic...');
            
            const results = {
                apiKey: await testApiKey(),
                publicSheet: await testPublicSheet(),
                configuredSheet: await testConfiguredSheet(),
                permissions: await testPermissions()
            };
            
            // Summary
            const successCount = Object.values(results).filter(Boolean).length;
            const totalTests = Object.keys(results).length;
            
            let summary = '';
            let recommendations = [];
            
            if (!results.apiKey) {
                summary += '‚ùå API Key is invalid or not working\n';
                recommendations.push('Get a new API key from Google Cloud Console');
                recommendations.push('Ensure Google Sheets API is enabled');
            } else {
                summary += '‚úÖ API Key is valid\n';
            }
            
            if (!results.publicSheet && results.apiKey) {
                summary += '‚ùå Cannot access public sheets (API issue)\n';
                recommendations.push('Check API key restrictions in Google Cloud Console');
            } else if (results.publicSheet) {
                summary += '‚úÖ Can access public sheets\n';
            }
            
            if (!results.configuredSheet && results.apiKey) {
                summary += '‚ùå Cannot access configured spreadsheet\n';
                recommendations.push('Make the spreadsheet public or share it properly');
                recommendations.push('Verify the spreadsheet ID is correct');
            } else if (results.configuredSheet) {
                summary += '‚úÖ Can access configured spreadsheet\n';
            }
            
            if (successCount === totalTests) {
                addResult('Full Diagnostic', 'success', 'All tests passed! Google Sheets is fully accessible.', summary);
                updateStatus('Diagnostic: ‚úÖ All Good!', 'green');
            } else if (successCount > 0) {
                addResult('Full Diagnostic', 'warning', `${successCount}/${totalTests} tests passed. Issues detected.`, 
                    summary, recommendations.join('\n‚Ä¢ '));
                updateStatus(`Diagnostic: ‚ö†Ô∏è ${successCount}/${totalTests} Working`, 'yellow');
            } else {
                addResult('Full Diagnostic', 'error', 'All tests failed. Google Sheets is not accessible.', 
                    summary, recommendations.join('\n‚Ä¢ '));
                updateStatus('Diagnostic: ‚ùå Not Working', 'red');
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            diagnosticResults = [];
            updateStatus('Ready to diagnose', 'green');
        }

        // Event listeners
        document.getElementById('testApiKey').addEventListener('click', testApiKey);
        document.getElementById('testConfiguredSheet').addEventListener('click', testConfiguredSheet);
        document.getElementById('testPublicSheet').addEventListener('click', testPublicSheet);
        document.getElementById('testPermissions').addEventListener('click', testPermissions);
        document.getElementById('runFullDiagnostic').addEventListener('click', runFullDiagnostic);
        document.getElementById('clearResults').addEventListener('click', clearResults);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateConfigInfo();
            addResult('System Ready', 'info', 'Google Sheets Accessibility Diagnostic loaded', 
                'Click "Full Diagnostic" to run all tests, or test individual components.');
        });
    </script>
</body>
</html>