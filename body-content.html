<body class="bg-slate-100 min-h-screen text-slate-800">

  <!-- Top Menu Bar -->
  <header class="bg-white shadow-soft mb-4">
    <div class="max-w-4xl mx-auto px-3 sm:px-6">
      <!-- Header with InstaQuote flush left and logo flush right -->
      <div class="flex items-center justify-between py-3">
        <!-- InstaQuote heading flush left -->
        <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold" style="line-height: 0.7;">
          <span style="color: #081249;">Insta</span><span style="color: #9b7952;">Q</span><span style="color: #081249;">uote</span>
        </h1>
        
        <!-- Logo flush right -->
        <div class="flex-shrink-0">
          <img src="images/logo.png" alt="Company Logo" class="h-12 sm:h-16 w-auto opacity-75 hover:opacity-100 transition-opacity duration-200">
        </div>
      </div>
      
      <!-- Navigation Menu below header -->
      <div class="pb-3">
        <nav class="hidden md:flex gap-2 justify-center">
          <button id="nav-price-calculator" class="nav-btn nav-btn-active btn-primary px-4 py-2 rounded-lg font-medium hover:bg-emerald-700 transition-all duration-200 flex items-center gap-2">
            <span>ðŸ“Š</span>
            <span>PriceLists</span>
          </button>
          <button id="nav-quote-maker" class="nav-btn px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2">
            <span class="text-lg">ðŸ“‹</span>
            <span>Quote Maker</span>
          </button>
          <button id="nav-product-catalog" class="nav-btn px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2">
            <span class="text-lg">ðŸ“¦</span>
            <span>Product Catalog</span>
          </button>
          <button id="nav-admin-panel" class="nav-btn px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2">
            <span class="text-lg">âš™ï¸</span>
            <span>Admin Panel</span>
          </button>
        </nav>
      </div>
      
      <!-- Mobile Navigation Menu -->
      <nav class="md:hidden pb-3">
        <div class="flex flex-wrap justify-center gap-2">
          <button id="nav-price-calculator-mobile" class="nav-btn nav-btn-active btn-primary px-3 py-2 rounded-lg font-medium hover:bg-emerald-700 transition-all duration-200 flex items-center gap-1 text-sm">
            <span>ðŸ“Š</span>
            <span>PriceLists</span>
          </button>
          <button id="nav-quote-maker-mobile" class="nav-btn px-3 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-1 text-sm">
            <span>ðŸ“‹</span>
            <span>Quote</span>
          </button>
          <button id="nav-product-catalog-mobile" class="nav-btn px-3 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-1 text-sm">
            <span>ðŸ“¦</span>
            <span>Catalog</span>
          </button>
          <button id="nav-admin-panel-mobile" class="nav-btn px-3 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-1 text-sm">
            <span>âš™ï¸</span>
            <span>Admin</span>
          </button>
        </div>
      </nav>
    </div>
  </header>

  <div class="max-w-4xl mx-auto p-3 sm:p-6 container">

    <!-- Module Content Container -->
    <div id="module-container">
      
      <!-- Price List Calculator Module -->
      <div id="price-calculator-module" class="module-content">
        <!-- Controls Section -->
        <div class="card-responsive section-spacing">
          <!-- First Row: Price List, Currency, Factor, Salesman -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <!-- Price List Selector -->
            <div>
              <select id="priceListSelector" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                <option value="">Select Price List</option>
              </select>
            </div>
            
            <!-- Currency Selector -->
            <div>
              <select id="currency" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                <option value="INR">â‚¹ INR - Indian Rupee</option>
                <option value="USD">$ USD - US Dollar</option>
                <option value="EUR">â‚¬ EUR - Euro</option>
                <option value="GBP">Â£ GBP - British Pound</option>
                <option value="AUD">A$ AUD - Australian Dollar</option>
                <option value="SAR">SAR - Saudi Riyal</option>
                <option value="NGN">â‚¦ NGN - Nigerian Naira</option>
                <option value="AED">Ø¯.Ø¥ AED - UAE Dirham</option>
                <option value="JPY">Â¥ JPY - Japanese Yen</option>
              </select>
            </div>
            
            <!-- Factor Input -->
            <div>
              <input type="number" id="priceFactor" value="" min="-100" max="1000" step="0.1" 
                     class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" 
                     placeholder="Price Factor (%)"
                     title="Price adjustment percentage: empty = no change, 10 = 10% increase, -10 = 10% decrease">
            </div>
            
            <!-- Salesman Selector -->
            <div>
              <select id="price-calculator-salesman" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                <option value="">Select Salesman</option>
              </select>
            </div>
          </div>
          
          <!-- Second Row: Category and Related Controls -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Category Selector -->
            <div>
              <select id="category" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                <option value="">Select Category</option>
              </select>
            </div>
            
            <!-- Control Options -->
            <div>
              <div class="flex flex-wrap gap-4">
                <!-- Checkbox elements removed -->
              </div>
            </div>
          </div>
      
      <!-- Products, Densities, and Colors -->
      <div class="grid grid-cols-3 gap-1 mt-1">
        <!-- Products -->
        <div>
          <div class="custom-dropdown" id="productDropdown">
            <button class="dropdown-btn w-full border rounded-lg px-2 py-1 text-left bg-white disabled:opacity-60 text-sm" disabled>
              <span class="dropdown-text">Select products...</span>
            </button>
            <div class="dropdown-list hidden absolute z-10 w-full bg-white border rounded-lg shadow-lg max-h-32 overflow-y-auto">
              <!-- Options will be populated here -->
            </div>
          </div>
        </div>

        <!-- Densities -->
        <div>
          <div class="custom-dropdown" id="densityDropdown">
            <button class="dropdown-btn w-full border rounded-lg px-2 py-1 text-left bg-white disabled:opacity-60 text-sm" disabled>
              <span class="dropdown-text">Select densities...</span>
            </button>
            <div class="dropdown-list hidden absolute z-10 w-full bg-white border rounded-lg shadow-lg max-h-32 overflow-y-auto">
              <!-- Options will be populated here -->
            </div>
          </div>
        </div>

        <!-- Colors -->
        <div>
          <div class="custom-dropdown" id="colorDropdown">
            <button class="dropdown-btn w-full border rounded-lg px-2 py-1 text-left bg-white disabled:opacity-60 text-sm" disabled>
              <span class="dropdown-text">Select colors...</span>
            </button>
            <div class="dropdown-list hidden absolute z-10 w-full bg-white border rounded-lg shadow-lg max-h-32 overflow-y-auto">
              <!-- Options will be populated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Second Row -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-1 mt-1">

        <!-- Actions -->
        <div class="relative" style="margin-top: 20px;">
          <div class="flex flex-col sm:flex-row gap-1 mobile-button-stack" id="actionButtonsContainer">
            <button id="clearSegments" class="btn-secondary px-2 py-0 rounded-lg text-sm font-medium hover:bg-slate-300 transition-all duration-200 flex items-center justify-center gap-1 mobile-full" aria-label="Clear all selections" title="Clear all selections">
              <span class="text-base" aria-hidden="true">ðŸ—‘ï¸</span>
              <span>Clear</span>
            </button>
            <button id="previewBtn" class="btn-primary px-4 py-1 rounded-lg text-sm font-medium hover:bg-emerald-700 transition-all duration-200 flex items-center justify-center gap-1 mobile-full" aria-label="Generate preview" title="Generate preview">
              <span class="text-base" aria-hidden="true">ðŸ‘ï¸</span>
              <span>Preview</span>
            </button>
            <button id="shareBtn" class="btn-primary px-4 py-1 rounded-lg text-sm font-medium hover:bg-emerald-700 transition-all duration-200 flex items-center justify-center gap-1 mobile-full" aria-label="Share Quote" title="Share quote as image to clipboard">
              <span class="text-base" aria-hidden="true">ðŸ“¤</span>
              <span>Share</span>
            </button>
          </div>
           
           <!-- Enhanced Share Popup for Mobile -->
           <div id="sharePopup" class="hidden absolute z-50 mt-2 w-full sm:w-64 bg-white border-2 rounded-xl shadow-xl p-3" style="top: 100%; left: 0; display: none;">
             <div class="space-y-2">


               <!-- Share Price Lists with Dropdown -->
               <div class="relative">
                 <button id="sharePNGBtn" class="w-full text-left px-4 py-3 text-base font-medium hover:bg-slate-100 rounded-lg flex items-center gap-3 transition-all duration-200 touch-action-manipulation">
                   <span class="text-lg">ðŸ“¤</span> 
                   <span>Share Price Lists</span>
                 </button>
                 <div id="pngSelectionDropdown" class="hidden">
                   <div id="pngFilesList"></div>
                   <button id="shareSelectedPNGs" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-medium transition-colors duration-200 mt-3 flex items-center justify-center gap-2" disabled>
                     <span class="text-lg">ðŸ“¤</span>
                     Share Selected File
                   </button>
                 </div>
               </div>

             </div>
           </div>
         </div>

        <!-- Segments (Hidden) -->
        <div>
          <div id="segmentsList" class="flex flex-wrap gap-2" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Preview Section -->
    <div class="bg-white rounded-xl shadow-soft p-4 sm:p-6 mobile-padding preview-container">
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2 form-row">
        <h3 class="text-lg sm:text-xl font-semibold mobile-text-adjust">Preview</h3>
        <div id="pageInfo" class="text-center text-sm text-slate-500 min-w-[120px] bg-slate-50 px-3 py-1 rounded-full mobile-text-adjust" role="status" aria-live="polite"></div>
      </div>
      <div class="w-full overflow-auto border-2 border-slate-200 rounded-lg">
        <div id="htmlPreview" class="w-full bg-white min-h-[200px] p-2 sm:p-4 flex justify-center">
          <div class="w-full max-w-[515px] mx-auto" style="min-width: 320px;">
            <!-- HTML preview content will be generated here -->
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center text-xs text-slate-500 mt-6 mobile-hide">
      Assets in <code>/images</code>: <code>logo.png</code>, <code>geniusstamps.png</code>, <code>lacestamps.png</code>, <code>tapesstamps.png</code>, <code>tipsstamps.png</code>, <code>generalstamps.png</code>.
    </footer>
  </div>


  <script>
    // Removed orphaned constants ADDRESS_LINES, CATEGORY_STAMPS, and LOGO_PATH (not used consistently)

    const FX_APIS = [
      (base) => `https://api.exchangerate-api.com/v4/latest/${base}`,
      (base) => `https://api.fixer.io/latest?base=${base}`,
      (base) => `https://open.er-api.com/v6/latest/${base}`
    ];
    const SUPPORTED = ['INR','USD','EUR','GBP','AUD','SAR','NGN','AED','JPY'];
    const SYMBOL = { INR:'â‚¹', USD:'$', EUR:'â‚¬', GBP:'Â£', AUD:'A$', SAR:'SAR ', NGN:'â‚¦', AED:'Ø¯.Ø¥ ', JPY:'Â¥' };
    const DEFAULT_RATES = { base:'INR',
      rates:{ INR:1, USD:0.0120, EUR:0.0110, GBP:0.0095, AUD:0.0180, SAR:0.0450, NGN:5.5000, AED:0.0440, JPY:1.8000 },
      updatedAt: null, mode:'auto'
    };

    let productData = [];
    let state = {
      currency:'INR', rates: { ...DEFAULT_RATES },
      category:'', selectAll:false, kg:false,
      selProducts:[], selDensities:[], selColors:[],
      segments: [], // each: { title, category, selectAll, kg, product, density, color }
      allProducts: [], // Store all products for filtering
      filteredProducts: [] // Store filtered products based on price list selection
    };

    // Exchange Rate Functions
    async function loadRates() {
      const stored = localStorage.getItem('fx_rates_v1');
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          if (parsed.updatedAt && Date.now() - parsed.updatedAt < 3600000) { // 1 hour cache
            state.rates = parsed;
            return;
          }
        } catch (e) {}
      }
      await refreshRates(true);
    }

    async function refreshRates(silent = false) {
      if (!silent) console.log('Refreshing exchange rates...');
      
      for (const apiUrl of FX_APIS) {
        try {
          const response = await fetch(apiUrl(state.currency)); // Use selected currency as base
          const data = await response.json();
          
          if (data.rates) {
            const newRates = { base: state.currency, rates: {}, updatedAt: Date.now(), mode: 'auto' };
            
            // Filter only supported currencies
            for (const currency of SUPPORTED) {
              newRates.rates[currency] = data.rates[currency] || DEFAULT_RATES.rates[currency] || 1;
            }
            
            state.rates = newRates;
            localStorage.setItem('fx_rates_v1', JSON.stringify(newRates));
            
            if (!silent) {
              console.log('Exchange rates updated successfully');
              updateAllPrices(); // Update all displayed prices
            }
            return;
          }
        } catch (error) {
          console.warn('Failed to fetch from API:', error);
        }
      }
      
      // Fallback to default rates if all APIs fail
      if (!silent) console.warn('All exchange rate APIs failed, using default rates');
      state.rates = { ...DEFAULT_RATES, base: state.currency, updatedAt: Date.now(), mode: 'fallback' };
      localStorage.setItem('fx_rates_v1', JSON.stringify(state.rates));
    }

    function updateAllPrices() {
      // Update price list generator
      renderAllPagesToHTML();
      
      // Update quote calculations
      if (typeof updateQuoteCalculations === 'function') updateQuoteCalculations();
      
      // Sync with quotemaker iframe if available
      const quotemakerFrame = document.querySelector('iframe[src*="quotemaker"]');
      if (quotemakerFrame && quotemakerFrame.contentWindow) {
        try {
          // Update quotemaker's FX rates
          if (typeof quotemakerFrame.contentWindow.setFX === 'function' && state.rates.rates) {
            quotemakerFrame.contentWindow.setFX(state.rates.rates);
          }
          
          // Currency selectors are now independent - no synchronization
          
          // Trigger quotemaker's re-rendering
          if (typeof quotemakerFrame.contentWindow.renderItems === 'function') {
            quotemakerFrame.contentWindow.renderItems();
          }
          if (typeof quotemakerFrame.contentWindow.renderTotals === 'function') {
            quotemakerFrame.contentWindow.renderTotals();
          }
        } catch (e) {
          console.log('Could not sync with quotemaker iframe:', e.message);
        }
      }
      
      // Update any other price displays
      const event = new CustomEvent('exchangeRatesUpdated', { detail: state.rates });
      document.dispatchEvent(event);
    }

    // Currency conversion function for compatibility with quotemaker
    function fx(cur) {
      const rates = state.rates.rates || {};
      return rates[cur] || 1;
    }

    function convertINRto(curr, amt) {
      const r = (state.rates.rates && state.rates.rates[curr]) || 0;
      return amt * (r || 0);
    }

    /* DOM */
    const $ = (id) => document.getElementById(id);
    const elCurrency = $('currency');
    const elCategory = $('category'); 
    const elProductDropdown = $('productDropdown'); const elDensityDropdown = $('densityDropdown'); const elColorDropdown = $('colorDropdown');
    // Checkbox element declarations removed
    const elClearSegments = $('clearSegments'); const elSegmentsList = $('segmentsList');
    const elDownloadPDF = $('downloadPDF'); const elPageInfo = $('pageInfo');

    /* Basics */
    function uniqSorted(arr) { return [...new Set(arr)].sort(); }
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function lockDropdown(dropdown, locked) { 
      const btn = dropdown.querySelector('.dropdown-btn');
      btn.disabled = locked; 
    }
    
    function getDropdownValues(dropdown) {
      // Checkbox functionality removed - returning empty array
      return [];
    }

    function setAllDropdownSelected(dropdown) {
      // Checkbox functionality removed
      updateDropdownText(dropdown);
    }
    
    function fillDropdown(dropdown, arr, placeholder) {
      const list = dropdown.querySelector('.dropdown-list');
      const btn = dropdown.querySelector('.dropdown-btn');
      
      // Add "Select All" option at the top if there are items
      const selectAllOption = arr.length > 0 ? `
        <div class="dropdown-option border-b border-gray-200 pb-1 mb-1">
          <button class="select-all-btn w-full text-left px-2 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded" data-dropdown-id="${dropdown.id}">
            âš¡ Select All
          </button>
        </div>
      ` : '';
      
      list.innerHTML = selectAllOption + arr.map(v => `
        <div class="dropdown-option">
          <label>${escapeHTML(v)}</label>
        </div>
      `).join('');
      
      btn.disabled = arr.length === 0;
      
      // Add event listener for "Select All" button
      const selectAllBtn = list.querySelector('.select-all-btn');
      if (selectAllBtn) {
        selectAllBtn.addEventListener('click', (e) => {
          e.preventDefault();
          setAllDropdownSelected(dropdown);
          if (dropdown === elProductDropdown) onProductChange();
          else if (dropdown === elDensityDropdown) onDensityChange();
          else if (dropdown === elColorDropdown) onColorChange();
        });
      }
      
      // Checkbox event listeners removed
      
      updateDropdownText(dropdown, placeholder);
    }
    
    function fillDropdownWithPriceList(dropdown, productArray, placeholder) {
      const list = dropdown.querySelector('.dropdown-list');
      const btn = dropdown.querySelector('.dropdown-btn');
      
      // Add "Select All" option at the top if there are items
      const selectAllOption = productArray.length > 0 ? `
        <div class="dropdown-option border-b border-gray-200 pb-1 mb-1">
          <button class="select-all-btn w-full text-left px-2 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded" data-dropdown-id="${dropdown.id}">
            âš¡ Select All
          </button>
        </div>
      ` : '';
      
      list.innerHTML = selectAllOption + productArray.map(product => `
        <div class="dropdown-option">
          <label class="flex justify-between items-center">
            <span>${escapeHTML(product.name)}</span>
            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">[${escapeHTML(product.priceList)}]</span>
          </label>
        </div>
      `).join('');
      
      btn.disabled = productArray.length === 0;
      
      // Add event listener for "Select All" button
      const selectAllBtn = list.querySelector('.select-all-btn');
      if (selectAllBtn) {
        selectAllBtn.addEventListener('click', (e) => {
          e.preventDefault();
          setAllDropdownSelected(dropdown);
          if (dropdown === elProductDropdown) onProductChange();
          else if (dropdown === elDensityDropdown) onDensityChange();
          else if (dropdown === elColorDropdown) onColorChange();
        });
      }
      
      // Add event listeners for checkboxes
      list.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', () => updateDropdownText(dropdown));
      });
      
      updateDropdownText(dropdown, placeholder);
    }
    
    function updateDropdownText(dropdown, placeholder = 'Select...') {
      const selected = getDropdownValues(dropdown);
      const textSpan = dropdown.querySelector('.dropdown-text');
      
      if (selected.length === 0) {
        textSpan.textContent = placeholder;
      } else if (selected.length === 1) {
        textSpan.textContent = selected[0];
      } else {
        textSpan.textContent = `${selected.length} selected`;
      }
    }

    /* Data */
    function populateCategories() {
      // Only use filtered products (based on selected price list)
      const dataSource = state.filteredProducts;
      const categories = uniqSorted(dataSource.map(i => i.Category).filter(c => c));
      elCategory.innerHTML = '<option value="">Select Category</option>' + 
        categories.map(c => `<option value="${escapeHTML(c)}">${escapeHTML(c)}</option>`).join('');
      lockDropdown(elProductDropdown,true); lockDropdown(elDensityDropdown,true); lockDropdown(elColorDropdown,true);
      
      // Clear category selection if no categories available
      if (categories.length === 0) {
        state.category = '';
        elCategory.value = '';
      }
    }

    /* Category to image mapping */
    function getCategoryImage(category) {
      const categoryImageMap = {
        'Tips': 'images/tipsstamps.png',
        'Tapes': 'images/tapesstamps.png',
        'Genius Weaves': 'images/geniusstamps.png',
        'Closures': 'images/lacestamps.png',
        'Wigs': 'images/generalstamps.png',
        'Weaves': 'images/generalstamps.png',
        'Bulk': 'images/generalstamps.png',
        'ClipOn': 'images/generalstamps.png',
        'DIY': 'images/generalstamps.png',
        'Toppers': 'images/generalstamps.png'
      };
      return categoryImageMap[category] || 'images/generalstamps.png';
    }

    /* Category to feature images mapping */
    function getCategoryFeatureImages(category) {
      const categoryFeatureMap = {
        'Bulk': ['cuticle.png', 'color.png', 'measure.png', 'durable.png', 'noshedding.png', 'cut.png'],
        'Weaves': ['cuticle.png', 'color.png', 'measure.png', 'durable.png', 'noshedding.png', 'stitch.png'],
        'Wigs': ['transparentlace.png', 'plucked.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png'],
        'Toppers': ['plucked.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png', 'cut.png'],
        'Closures': ['transparentlace.png', 'plucked.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png'],
        'Tapes': ['tapes.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png', 'cut.png'],
        'Tips': ['tips.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png', 'cut.png'],
        'Genius': ['genius.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png', 'cut.png'],
        'Genius Weaves': ['genius.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png', 'cut.png'],
        'DIY': ['diy.png', 'cuticle.png', 'color.png', 'measure.png', 'durable.png', 'cut.png'],
        'ClipOn': ['cuticle.png', 'color.png', 'measure.png', 'durable.png', 'noshedding.png', 'stitch.png']
      };
      const images = categoryFeatureMap[category] || [];
      return images.map(img => {
        // For genius.png, use the Products directory path
        if (img === 'genius.png') {
          return `images/Products/Genius.png`;
        }
        return `images/category-images/${category}/${img}`;
      });
    }



    /* Flow */
    function onCategoryChange(){
      // Auto-clear previous selections when category changes
      if (state.category !== elCategory.value && state.category !== '') {
        clearAllSelections();
      }
      
      state.category = elCategory.value;
      state.selProducts=[]; state.selDensities=[]; state.selColors=[];
      // Only use filtered products (based on selected price list)
      const dataSource = state.filteredProducts;
      const hasKg = dataSource.some(i => i.Category===state.category && /y/i.test(i['Can Be Sold in KG?']||''));
      // Removed elKgWrap and elKg references - checkboxes no longer exist
      // Removed elSelectAllWrap and elSelectAll references - checkboxes no longer exist

      // Check if price list is selected
      if (state.filteredProducts.length === 0) {
        fillDropdownWithPriceList(elProductDropdown, [], 'Please select a price list first');
      } else {
        // Get unique products with their price list information
        const productMap = new Map();
        dataSource.filter(i => i.Category===state.category).forEach(item => {
          const key = item.Product;
          if (!productMap.has(key)) {
            productMap.set(key, { name: item.Product, priceList: item.PriceList });
          }
        });
        const products = Array.from(productMap.values()).sort((a, b) => a.name.localeCompare(b.name));
        fillDropdownWithPriceList(elProductDropdown, products, 'Select Products');
      }
      fillDropdown(elDensityDropdown, [], 'Select Densities');
      fillDropdown(elColorDropdown, [], 'Select Colors');
      lockDropdown(elProductDropdown, !state.category); lockDropdown(elDensityDropdown, true); lockDropdown(elColorDropdown, true);
  
      
      
      
      // Initial render removed - HTML preview generates on demand
    }
    function onProductChange(){
      const selP = getDropdownValues(elProductDropdown);
      state.selProducts = selP;
      const dataSource = state.filteredProducts;
      const densPool = uniqSorted(dataSource.filter(i => i.Category===state.category && (selP.length===0 || selP.includes(i.Product))).map(i => i.Density));
      fillDropdown(elDensityDropdown, densPool, 'Select Densities'); lockDropdown(elDensityDropdown,false);
      const selD = getDropdownValues(elDensityDropdown); state.selDensities = selD;
      const colorPool = uniqSorted(dataSource.filter(i => i.Category===state.category && (selP.length===0 || selP.includes(i.Product)) && (selD.length===0 || selD.includes(i.Density))).map(i => i.Colors));
      fillDropdown(elColorDropdown, colorPool, 'Select Colors'); lockDropdown(elColorDropdown,false);
      state.selColors = getDropdownValues(elColorDropdown);
      renderAllPagesToHTML();
    }
    function onDensityChange(){
      const selD = getDropdownValues(elDensityDropdown);
      state.selDensities = selD;
      const selP = state.selProducts;
      const dataSource = state.filteredProducts;
      const colorPool = uniqSorted(dataSource.filter(i => i.Category===state.category && (selP.length===0 || selP.includes(i.Product)) && (selD.length===0 || selD.includes(i.Density))).map(i => i.Colors));
      fillDropdown(elColorDropdown, colorPool, 'Select Colors'); lockDropdown(elColorDropdown,false);
      state.selColors = getDropdownValues(elColorDropdown);
      renderAllPagesToHTML();
    }
    function onColorChange(){
      state.selColors = getDropdownValues(elColorDropdown);
      renderAllPagesToHTML();
    }
    function onSelectAllToggle(){
      state.selectAll = elSelectAll.checked;
      [elProductDropdown, elDensityDropdown, elColorDropdown].forEach(dropdown => { lockDropdown(dropdown, state.selectAll); });
      renderAllPagesToHTML();
    }


    /* Segments (explode combinations) */
    function explodeCombosToSegments(){
      if (!state.category) return;
      const dataSource = state.filteredProducts;
      const pool = dataSource.filter(i => i.Category===state.category);
      let P = state.selectAll ? uniqSorted(pool.map(x=>x.Product)) : (state.selProducts.length? state.selProducts : uniqSorted(pool.map(x=>x.Product)));
      let D = state.selectAll ? uniqSorted(pool.map(x=>x.Density)) : (state.selDensities.length? state.selDensities : uniqSorted(pool.map(x=>x.Density)));
      let C = state.selectAll ? uniqSorted(pool.map(x=>x.Colors)) : (state.selColors.length? state.selColors : uniqSorted(pool.map(x=>x.Colors)));
      const set = new Set(); // avoid duplicates when data has repeated rows
      const next = [];
      P.forEach(p => D.forEach(d => C.forEach(c => {
        const key = `${p}::${d}::${c}`;
        const matches = pool.filter(i => i.Product===p && i.Density===d && i.Colors===c);
        if (matches.length && !set.has(key)) {
          set.add(key);
          next.push({ title: `${p} - ${d} - ${c}`, category: state.category, product:p, density:d, color:c, kg: false });
        }
      })));
      // append
      state.segments.push(...next);
      renderSegmentsList();
      renderAllPagesToHTML();
    }

    function removeSegment(idx){ state.segments.splice(idx,1); renderSegmentsList(); renderAllPagesToHTML(); }
    function renderSegmentsList(){
      elSegmentsList.innerHTML = state.segments.map((s,idx)=>`
        <span class="chip"><span class="font-semibold">${escapeHTML(s.title)}</span>
          <button class="text-red-600" onclick="__remove(${idx})">âœ•</button>
        </span>`).join('');
    }
    window.__remove = removeSegment;

    /* Pricing rows per segment */
    function rowsForSegment(seg){
      const rows = productData.filter(i => i.Category===seg.category && i.Product===seg.product && i.Density===seg.density && i.Colors===seg.color)
        .map(i => ({
          length: (i.Length||'').toString(),
          priceINR: parseFloat(i.Rate||'0') * (seg.kg && /y/i.test(i['Can Be Sold in KG?']||'') ? 10 : 1),
          meta: i
        }))
        .sort((a,b)=>parseFloat(a.length)-parseFloat(b.length));
      return rows;
    }

    /* FX (automatic) */
    async function fetchLiveFX(){
      let ok = false;
      for (const builder of FX_APIS) {
        try {
          const url = builder('INR');
          const res = await fetch(url, { cache:'no-store' });
          if (!res.ok) continue;
          const data = await res.json();
          const ratesRaw = data.rates || (data.result==='success' && data.rates) || data;
          if (!ratesRaw) continue;
          const next = { base:'INR', rates:{}, updatedAt: Date.now(), mode:'auto' };
          SUPPORTED.forEach(k => { const v = ratesRaw[k]; if (v && typeof v === 'number') next.rates[k] = v; });
          if (Object.keys(next.rates).length >= 3) {
            state.rates = next;
            localStorage.setItem('INH_FX', JSON.stringify(next));
            ok = true;
            break;
          }
        } catch(e) { console.warn('FX API failed:', e); }
      }
      renderAllPagesToHTML();
    }

    function convertINRto(curr, amt){ const r = (state.rates.rates && state.rates.rates[curr]) || 0; return amt * (r||0); }

    /* HTML Preview Functions */
    function getProductImagePath(category, product, density) {
      const categoryLower = (category || '').toLowerCase();
      const productLower = (product || '').toLowerCase();
      const densityLower = (density || '').toLowerCase();
      
      // Product image mapping based on your specifications
      const imageMap = {
        // Weaves category
        'weaves': {
          'weaves': {
            'single drawn': 'images/Products/Weaves-SD.png',
            'double drawn': 'images/Products/Weaves-DD.png',
            'super double drawn': 'images/Products/Weaves-SDD.png'
          }
        },
        // Genius Weaves
        'genius weaves': {
          'genius weaves': 'images/Products/Genius.png'
        },
        // DIY category
        'diy': {
          'bangs': 'images/Products/Bangs.png',
          'curtain bangs': 'images/Products/Bangs.png',
          'curly faux buns': 'images/Products/CurlyBun.png',
          'bun20': 'images/Products/BUN.png',
          'bun30': 'images/Products/BUN.png',
          'flatclip ponytail': 'images/Products/FLATCLIPPONYTAIL.png',
          'highlights': 'images/Products/Highlights.png',
          'frontline-13x1': 'images/Products/Frontline.png',
          'frontline-2x1': 'images/Products/Frontline.png',
          'frontline-5x1': 'images/Products/Frontline.png',
          'single clip cover patch': 'images/Products/CoverPatch.png',
          'clutch bun': 'images/Products/ClutchBun.png'
        },
        // Closures
        'closures': {
          'closure': 'images/Products/Closure.png',
          'frontal': 'images/Products/Frontal.png',
          'frontal-13x4': 'images/Products/Frontal.png',
          'frontal-13x6': 'images/Products/Frontal.png',
          'closure-5x3': 'images/Products/Closure.png',
          'closure-4x4': 'images/Products/Closure.png',
          'closure-5x5': 'images/Products/Closure.png',
          'closure-6x6': 'images/Products/Closure.png',
          'closure-6x2': 'images/Products/Closure.png'
        },
        // Wigs
        'wigs': {
          'wig-closure5x5': 'images/Products/WIGCLOSURE.png',
          'wig-closure6x2': 'images/Products/WIGCLOSURE.png',
          'wig-dd-closure6x2': 'images/Products/WIGCLOSURE.png',
          'wig-dd-closure5x5': 'images/Products/WIGCLOSURE.png',
          'wig-silktopper': 'images/Products/SILKTOPPER.png',
          'wig-dd-frontal13x4': 'images/Products/WIGFRONTAL.png',
          'wig-dd-frontal13x6': 'images/Products/WIGFRONTAL.png',
          'wig-frontal13x6': 'images/Products/WIGFRONTAL.png',
          'wig-frontal13x4': 'images/Products/WIGFRONTAL.png'
        },
        // Bulk
        'bulk': {
          'bulk': 'images/Products/Bulk.png'
        },
        // Tapes
        'tapes': {
          'tape extension': 'images/Products/Tapes.png'
        },
        // Tips
        'tips': {
          'tips': 'images/Products/ITIPS.png',
          'tipsnano': 'images/Products/Nano.png',
          'tipsy': 'images/Products/YTIPS.png',
          'flat tips': 'images/Products/FlatTips.png',
          'u tips': 'images/Products/UTIPS.png'
        },
        // ClipOn
        'clipon': {
          'clipon classic': 'images/Products/ClipOn.png',
          'clipon seamless': 'images/Products/ClipOn.png',
          'clutch ponytail': 'images/Products/PonyTail.png',
          'halo extensions': 'images/Products/Halo.png',
          'wrap around ponytail': 'images/Products/PonyTail.png'
        },
        // Toppers
        'toppers': {
          'topper': 'images/Products/SILKTOPPER.png'
        }
      };
      
      // First try to find by category and product
      if (imageMap[categoryLower] && imageMap[categoryLower][productLower]) {
        const productMapping = imageMap[categoryLower][productLower];
        // If it's an object (like Weaves with density), check for density
        if (typeof productMapping === 'object') {
          return productMapping[densityLower] || Object.values(productMapping)[0] || '';
        }
        // If it's a direct string path
        return productMapping;
      }
      
      // Fallback: try to find by density for Weaves category
      if (categoryLower === 'weaves' && densityLower) {
        if (densityLower.includes('single drawn')) return 'images/Products/Weaves-SD.png';
        if (densityLower.includes('double drawn')) return 'images/Products/Weaves-DD.png';
        if (densityLower.includes('super double drawn')) return 'images/Products/Weaves-SDD.png';
      }
      
      return ''; // No image found
    }

    /**
     * Calculate price factor from percentage input
     * @param {number} percentage - Percentage value (e.g., 10 for 10% increase, -10 for 10% decrease)
     * @returns {number} - Factor value (e.g., 1.10 for 10% increase, 0.90 for 10% decrease)
     */
    function calculatePriceFactor(percentage) {
      // Handle edge cases
      if (typeof percentage !== 'number' || isNaN(percentage)) {
        return 1.0; // No change for invalid input
      }
      
      // Calculate factor: 1 + (percentage / 100)
      // Examples: 10 -> 1.10, -10 -> 0.90, 0 -> 1.00
      const factor = 1 + (percentage / 100);
      
      // Ensure precision and prevent negative factors
      return Math.max(0, Number(factor.toFixed(6)));
    }
    
    /**
     * Get current price factor from UI input
     * @returns {number} - Current factor value
     */
    function getCurrentPriceFactor() {
      const inputElement = document.getElementById('priceFactor');
      const inputValue = inputElement.value.trim();
      
      // If empty, return 1.0 (no price adjustment)
      if (inputValue === '' || inputValue === null || inputValue === undefined) {
        return 1.0;
      }
      
      // Parse the percentage value directly
      const percentage = parseFloat(inputValue);
      if (isNaN(percentage)) {
        return 1.0; // Default to no change for invalid input
      }
      
      return calculatePriceFactor(percentage);
    }

    function createPageHTML(segment, pageIndex) {
      const rows = rowsForSegment(segment);
      const factor = getCurrentPriceFactor();
      const unit = segment.kg ? 'Per Kg' : 'Per Piece';
      const titleText = `${segment.product.toUpperCase()} | ${segment.density.toUpperCase()} | ${segment.color.toUpperCase()} | ${state.currency} | ${unit.toUpperCase()}`;
      
      // Calculate optimal height based on content including footer space
      const baseHeight = 500; // Reduced base height for compactness
      const rowHeight = 28; // Reduced row height to match smaller cells
      const footerHeight = 120; // Minimized footer space for compact layout
      const headerSpace = 180; // Reduced header space
      const contentHeight = Math.max(baseHeight, headerSpace + 260 + (rows.length * rowHeight) + footerHeight);
      
      return `
        <div class="page-container bg-white border rounded-lg shadow-lg mx-auto" style="width: 515px; height: ${contentHeight}px; page-break-after: always; margin: 0 auto; transform-origin: center top; transform: scale(min(1, calc(100vw - 40px) / 515px));">
          <!-- Header Section -->
          <div class="header-section p-2 border-b" style="background-color: #e6eaeb;">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <img src="images/logo.png" alt="Company Logo" class="h-16 w-16 object-contain" onerror="this.style.display='none'">
                <div>
                  <h1 class="text-lg font-bold text-gray-800">${document.getElementById('priceListSelector').value === 'USA25' ? 'Indian Natural Hair, LLC' : 'Indian Natural Hair'}</h1>
                  <p class="text-gray-600 text-xs">Premium Quality Hair Products</p>
                  <p class="text-black text-xs font-medium">www.indiannaturalhair.com</p>
                </div>
              </div>
              

              
              <div>
                <img src="images/madewithbadge.png" alt="Made with Badge" class="h-12 object-contain" onerror="this.style.display='none'">
              </div>
            </div>
          </div>
          
          <!-- Category Feature Images Section Below Header -->
          ${segment.category ? `<div class="category-section border-b bg-gray-100 mobile-feature-section" style="margin: 0;">
            <div class="flex items-center justify-center p-2">
               <div class="flex items-center justify-center gap-1 flex-nowrap mobile-feature-images" style="width: 458px; min-height: 91px; padding: 8px; overflow-x: auto;">
                 ${getCategoryFeatureImages(segment.category).map(imagePath => 
                   `<img src="${imagePath}" alt="Feature" class="object-contain mobile-feature-img" style="height: 65px; width: auto; max-width: 75px; flex-shrink: 0;" onerror="this.style.display='none'">` 
                 ).join('')}
               </div>
            </div>
          </div>` : ''}
          
          <!-- Product Title with Responsive Dynamic Sizing -->
          <div class="text-center py-2 px-1">
            <h3 class="font-bold text-gray-800" 
                style="font-size: ${titleText.length > 60 ? 'clamp(0.625rem, 2vw, 0.75rem)' : titleText.length > 40 ? 'clamp(0.75rem, 2.5vw, 0.875rem)' : 'clamp(0.875rem, 3vw, 1rem)'}; line-height: 1.2; word-wrap: break-word;">${titleText}</h3>
          </div>
          
          <!-- Product Table with Optimized Layout -->
          <div class="product-table mx-1 bg-white border rounded-lg overflow-hidden">
            <!-- Single Header Row -->
            <div class="table-header bg-gray-100 p-1 border-b">
              <div class="grid grid-cols-2 gap-4 items-center">
                <div class="grid grid-cols-2 gap-2">
                  <div class="text-left font-semibold text-gray-700" style="font-size: clamp(0.75rem, 2.5vw, 0.875rem);">Length</div>
                  <div class="text-right font-semibold text-gray-700" style="font-size: clamp(0.75rem, 2.5vw, 0.875rem);">Price (${state.currency})</div>
                </div>
                <div class="text-center font-semibold text-gray-700" style="font-size: clamp(0.75rem, 2.5vw, 0.875rem);">Product</div>
              </div>
            </div>
            
            <!-- Table Content -->
            <div class="table-content p-2">
              <div class="grid grid-cols-2 gap-4 items-start">
                <!-- Left Side: Length and Price Columns -->
                <div class="grid grid-cols-2 gap-2">
                  <!-- Length Column -->
                  <div class="lengths-column space-y-1">
                    ${rows.map(row => `<div class="text-left text-gray-900 font-medium py-1 px-2 bg-gray-100 rounded border min-h-[24px] flex items-center" style="font-size: clamp(0.75rem, 2.2vw, 0.875rem);">${row.length}"</div>`).join('')}
                  </div>
                  
                  <!-- Price Column -->
                  <div class="prices-column space-y-1">
                    ${rows.map(row => {
                      const converted = state.currency === 'INR' ? row.priceINR : convertINRto(state.currency, row.priceINR);
                      const adjustedPrice = (converted || 0) * factor;
                      return `<div class="text-right text-gray-900 font-semibold py-1 px-2 bg-gray-100 rounded border min-h-[24px] flex items-center justify-end" style="font-size: clamp(0.75rem, 2.2vw, 0.875rem);">${(SYMBOL[state.currency] || '')}${adjustedPrice.toFixed(2)}</div>`;
                    }).join('')}
                  </div>
                </div>
                
                <!-- Right Side: Product Image -->
                <div class="product-image-column flex justify-center items-center bg-white border rounded-lg shadow-sm" style="height: ${Math.max(150, rows.length * 28)}px;">
                  <img src="${getProductImagePath(segment.category, segment.product, segment.density)}" alt="${segment.product}" 
                       class="max-w-full max-h-full object-contain" 
                       style="width: auto; height: 90%;" 
                       onerror="this.style.display='none'">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Footer integrated within main content -->
          <div class="border-t-2 border-gray-300 rounded-lg" style="background-color: #e6eaeb;">
            <div class="text-center px-1 py-2">
              <!-- Contact Information Section -->
              <div class="grid grid-cols-3 items-start mb-2" style="font-size: clamp(0.75rem, 2vw, 0.875rem);">
                ${document.getElementById('priceListSelector').value === 'USA25' ? `
                <div class="text-left text-gray-700">
                  <div class="font-medium text-xs">8 SUMMIT CT, HACKENSACK NJ 07601, USA</div>
                  <div class="font-medium text-xs">us@indiannaturalhair.com</div>
                  <div class="font-medium text-xs">+1 (646) 919-2921</div>
                </div>
                <div class="flex-1"></div>
                <div class="text-right flex justify-end items-center">
                  <span class="font-bold text-4xl" style="color: #a37e55;">${SYMBOL[state.currency] || state.currency}</span>
                </div>
                ` : `
                <div class="text-left text-gray-700">
                  <div class="font-medium text-xs">WZ 81/1A, Guru Nanak Nagar, New Delhi 110018, India</div>
                  <div class="font-medium text-xs">info@indiannaturalhair.com</div>
                </div>
                <div class="flex-1"></div>
                <div class="text-right flex justify-end items-center">
                  <span class="font-bold text-4xl" style="color: #a37e55;">${SYMBOL[state.currency] || state.currency}</span>
                </div>
                `}
              </div>
                
              <!-- Shipping Partners & Payment Methods Section -->
              <div class="border-t border-gray-400 pt-1 pb-1">
                <div class="flex items-center justify-center gap-3 flex-wrap">
                  <!-- Shipping Partners -->
                  <img src="images/dhl-logo-official.svg" alt="DHL" class="h-5 w-auto object-contain" onerror="this.style.display='none'">
                  <img src="images/aramex-logo-official.svg" alt="Aramex" class="h-5 w-auto object-contain" onerror="this.style.display='none'">
                  <img src="images/fedex-logo-official.svg" alt="FedEx" class="h-5 w-auto object-contain" onerror="this.style.display='none'">
                  
                  <!-- Separator -->
                  <div class="h-4 w-px bg-gray-300 mx-2"></div>
                  
                  <!-- Payment Methods -->
                  <img src="images/visa-logo.svg" alt="Visa" class="h-4 w-auto object-contain" onerror="this.style.display='none'">
                  <img src="images/mastercard-logo.svg" alt="Mastercard" class="h-4 w-auto object-contain" onerror="this.style.display='none'">
                  <img src="images/amex-logo.svg" alt="American Express" class="h-4 w-auto object-contain" onerror="this.style.display='none'">
                  
                  <!-- INR-specific payment methods -->
                  ${state.currency === 'INR' ? `
                    <img src="images/paytm-logo.svg" alt="PayTM" class="h-4 w-auto object-contain" onerror="this.style.display='none'">
                    <img src="images/googlepay-logo.svg" alt="Google Pay" class="h-4 w-auto object-contain" onerror="this.style.display='none'">
                  ` : ''}
                </div>
              </div>
                
              <!-- Enhanced Metadata Section -->
              <div class="border-t border-gray-400 pt-1 pb-1">
                <div class="text-center">
                  <p class="text-gray-600 font-medium" style="font-size: clamp(0.625rem, 1.8vw, 0.75rem);">
                    <strong>Generated:</strong> ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })} | 
                    <span class="text-red-600 font-semibold"><strong>Valid until:</strong> ${(() => {
                      const validDays = parseInt(document.getElementById('valid-days')?.value || '14');
                      return new Date(Date.now() + validDays * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    })()}</span>
                  </p>
                </div>
              </div>
              
              <!-- Sales Representative and Device Info Section -->
              <div class="border-t border-gray-400 pt-1 pb-1">
                <div class="text-center">
                  <p class="text-gray-600 font-medium" style="font-size: clamp(0.625rem, 1.8vw, 0.75rem);">
                    <strong>Sales Representative:</strong> ${(() => {
                      // Check which module is active and use the appropriate salesman dropdown
                      const activeModule = document.querySelector('.module-content.active');
                      if (activeModule && activeModule.id === 'price-calculator-module') {
                        return document.getElementById('price-calculator-salesman')?.value || 'Not Specified';
                      } else {
                        return document.getElementById('salesman-name')?.value || 'Not Specified';
                      }
                    })()} | 
                    <strong>Device ID:</strong> ${getDeviceIdentifier()}
                  </p>
                </div>
              </div>
                
              <!-- Standard Weight Section -->
              ${(() => {
                const rows = rowsForSegment(segment);
                if (rows.length > 0) {
                  const firstRow = rows[0];
                  const baseWeight = parseFloat(firstRow.meta['Standard Weight']) || 0;
                  // Only multiply by 10 if kg mode is enabled AND prices are displayed per kg (not per piece)
                  const pricesArePerKg = segment.kg && /y/i.test(firstRow.meta['Can Be Sold in KG?'] || '');
                  const displayWeight = pricesArePerKg ? baseWeight * 10 : baseWeight;
                  const weightText = displayWeight ? `${displayWeight}g` : 'N/A';
                  return `<div class="border-t border-gray-400 pt-1 pb-1">
                    <div class="text-center">
                      <p class="text-gray-600 font-medium" style="font-size: clamp(0.625rem, 1.8vw, 0.75rem);">Standard Weight: <span class="font-semibold">${weightText}</span></p>
                    </div>
                  </div>`;
                }
                return '';
              })()} 
              
              <!-- Brand Tagline Section -->
              <div class="border-t border-gray-400 pt-1">
                <p class="text-gray-700 italic font-semibold" style="font-size: clamp(0.75rem, 2vw, 0.875rem);">Premium Quality Hair Products â€¢ Trusted Worldwide â€¢ ${getCurrentPriceFactor().toFixed(2)}x</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function drawHeader(W, category){
      // Ensure context is properly set before drawing
      if (!ctx) {
        console.error('Canvas context not available for header drawing');
        return;
      }
      
      // Draw main header background - increased height for larger elements
      ctx.fillStyle='#e6eaeb'; 
      roundRect(ctx, 10, 10, W-20, 140, 15, true, false);
      
      // Company logo right-aligned - 120x120 pixels (increased from 80x80)
      const logoSize = 120;
      const logoX = W - logoSize - 15; // 15px margin from right edge
      const logoY = 10; // Top aligned within header
      try{ 
        await drawImage('images/logo.png', logoX, logoY, logoSize, logoSize);
      }catch(e){
        console.warn('Logo not found:', e);
        // Draw placeholder rectangle for logo
        ctx.fillStyle='#cccccc';
        ctx.fillRect(logoX, logoY, logoSize, logoSize);
      }
      
      // "Made with" badge left-aligned - 240x75 pixels (increased from 180x55)
      const badgeWidth = 240;
      const badgeHeight = 75;
      const badgeX = 25; // 25px margin from left edge
      const badgeY = 15; // Centered vertically within header
      try{ 
        await drawImage('images/madewithbadge.png', badgeX, badgeY, badgeWidth, badgeHeight);
      }catch(e){
        console.warn('Made with badge not found:', e);
        // Draw placeholder rectangle for badge
        ctx.fillStyle='#cccccc';
        ctx.fillRect(badgeX, badgeY, badgeWidth, badgeHeight);
      }
      
      // USA Company Information - display when USA25 price list is selected

      
      // Category feature images section below main header
      if (category) {
        ctx.fillStyle='#dddfe0'; 
        roundRect(ctx, 10, 149, W-20, 101, 15, true, false);
        
        // Draw multiple feature images in a row
        const featureImages = getCategoryFeatureImages(category);
        const imageHeight = 70;
        const imageSpacing = 4;
        const imageWidth = 85;
        const totalImagesWidth = featureImages.length * imageWidth + (featureImages.length - 1) * imageSpacing;
        const startX = (W - totalImagesWidth) / 2;
        const imageY = 159 + (91 - imageHeight) / 2;
        
        for (let i = 0; i < featureImages.length; i++) {
          const imagePath = featureImages[i];
          const imageX = startX + i * (imageWidth + imageSpacing);
          
          try {
            await drawImage(imagePath, imageX, imageY, imageWidth, imageHeight);
          } catch(e) {
            console.warn('Feature image not found:', imagePath, e);
            // Draw placeholder rectangle for missing image
            ctx.fillStyle='#cccccc';
            ctx.fillRect(imageX, imageY, imageWidth, imageHeight);
          }
        }
        
        // Add subtle border
        ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(0, 250); ctx.lineTo(W, 250); ctx.stroke();
      }
    }
    async function drawFooter(W,H,segment){
      // Footer background with proper margins - matching header color - increased height for new content
      ctx.fillStyle='#e6eaeb'; 
      roundRect(ctx, 10, H-150, W-20, 140, 15, true, false);
      
      // Footer text styling and positioning
      ctx.fillStyle='#475569'; 
      ctx.font='500 11px system-ui, -apple-system, Segoe UI, Roboto';
      
      // Address (left aligned, two rows) and email (right aligned, top row)
      const leftMargin = 25;
      const rightMargin = W - 5;
      const selectedPriceList = document.getElementById('priceListSelector').value;
      
      if (selectedPriceList === 'USA25') {
        // USA company information
        ctx.textAlign='right';
        ctx.fillText('us@indiannaturalhair.com', rightMargin, H-125);
        ctx.fillText('+1 (646) 919-2921', rightMargin, H-110);
        
        // Address on left (two lines)
        ctx.textAlign='left';
        ctx.font='500 9px system-ui, -apple-system, Segoe UI, Roboto'; // Slightly smaller font to fit
        ctx.fillText('8 SUMMIT CT', leftMargin, H-125);
        ctx.fillText('HACKENSACK NJ 07601, USA', leftMargin, H-110);
        ctx.font='500 10px system-ui, -apple-system, Segoe UI, Roboto'; // Reset font size
      } else {
        // Default Indian company information
        ctx.textAlign='right';
        ctx.fillText('info@indiannaturalhair.com', rightMargin - 10, H-125); // Add 10px right space
        
        // Address on left (two lines)
        ctx.textAlign='left';
        ctx.font='500 8px system-ui, -apple-system, Segoe UI, Roboto'; // Smaller font to fit in one row
        ctx.fillText('WZ 81/1A, Guru Nanak Nagar', leftMargin, H-125);
        ctx.fillText('New Delhi 110018, India', leftMargin, H-110);
        ctx.font='500 10px system-ui, -apple-system, Segoe UI, Roboto'; // Reset font size
      }
      
      // Generated date and Valid until date in a single row (center)
      ctx.textAlign='center';
      ctx.fillStyle='#374151';
      ctx.font='600 10px system-ui, -apple-system, Segoe UI, Roboto';
      const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      const validUntilDate = new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      ctx.fillText(`Generated: ${currentDate} | Valid until: ${validUntilDate}`, W/2, H-95);
      
      // Standard Weight section
      if (segment) {
        const rows = rowsForSegment(segment);
        if (rows.length > 0) {
          const firstRow = rows[0];
          const baseWeight = parseFloat(firstRow.meta['Standard Weight']) || 0;
          // Only multiply by 10 if kg mode is enabled AND prices are displayed per kg (not per piece)
          const pricesArePerKg = segment.kg && /y/i.test(firstRow.meta['Can Be Sold in KG?'] || '');
          const displayWeight = pricesArePerKg ? baseWeight * 10 : baseWeight;
          const weightText = displayWeight ? `${displayWeight}g` : 'N/A';
          
          ctx.fillStyle='#475569';
          ctx.font='500 11px system-ui, -apple-system, Segoe UI, Roboto';
          ctx.fillText(`Standard Weight: ${weightText}`, W/2, H-80);
        }
      }
      
      // Combined shipping and payment partners label
      ctx.fillStyle='#374151';
      ctx.font='600 10px system-ui, -apple-system, Segoe UI, Roboto';
      ctx.fillText('SHIPPING PARTNERS & PAYMENT METHODS', W/2, H-65);
      
      // Combined logos row
      const logoY = H-50;
      const shippingLogoWidth = 45;
      const shippingLogoHeight = 15;
      const paymentLogoWidth = 30;
      const paymentLogoHeight = 15;
      
      // Determine payment logos based on currency
      const isINR = state.currency === 'INR';
      const paymentLogos = [
        'images/visa-logo.svg',
        'images/mastercard-logo.svg', 
        'images/amex-logo.svg'
      ];
      
      if (isINR) {
        paymentLogos.push('images/paytm-logo.svg', 'images/googlepay-logo.svg');
      }
      
      // Calculate total width for centering
      const shippingWidth = shippingLogoWidth * 3 + 20; // 3 shipping logos + gaps
      const separatorWidth = 20; // Space for separator
      const paymentWidth = paymentLogoWidth * paymentLogos.length + 8 * (paymentLogos.length - 1);
      const totalWidth = shippingWidth + separatorWidth + paymentWidth;
      const startX = (W - totalWidth) / 2;
      
      try {
        // Draw shipping logos
        await drawImage('images/dhl-logo-official.svg', startX, logoY, shippingLogoWidth, shippingLogoHeight);
        await drawImage('images/aramex-logo-official.svg', startX + shippingLogoWidth + 10, logoY, shippingLogoWidth, shippingLogoHeight);
        await drawImage('images/fedex-logo-official.svg', startX + (shippingLogoWidth + 10) * 2, logoY, shippingLogoWidth, shippingLogoHeight);
        
        // Draw separator line
        const separatorX = startX + shippingWidth + 10;
        ctx.fillStyle='#d1d5db';
        ctx.fillRect(separatorX, logoY, 1, 15);
        
        // Draw payment logos
        const paymentStartX = separatorX + 10;
        for (let i = 0; i < paymentLogos.length; i++) {
          const x = paymentStartX + i * (paymentLogoWidth + 8);
          await drawImage(paymentLogos[i], x, logoY, paymentLogoWidth, paymentLogoHeight);
        }
      } catch (e) {
        console.warn('Logos not found:', e);
        // Fallback text if logos fail to load
        ctx.fillStyle='#6b7280';
        ctx.font='500 8px system-ui, -apple-system, Segoe UI, Roboto';
        const fallbackText = isINR ? 'DHL â€¢ ARAMEX â€¢ FEDEX | VISA â€¢ MASTERCARD â€¢ AMEX â€¢ PAYTM â€¢ GOOGLE PAY' : 'DHL â€¢ ARAMEX â€¢ FEDEX | VISA â€¢ MASTERCARD â€¢ AMEX';
        ctx.fillText(fallbackText, W/2, logoY + 10);
      }
    }
    
    function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
      if (typeof stroke === 'undefined') stroke = true;
      if (typeof radius === 'undefined') radius = 5;
      if (typeof radius === 'number') {
        radius = {tl: radius, tr: radius, br: radius, bl: radius};
      } else {
        var defaultRadius = {tl: 0, tr: 0, br: 0, bl: 0};
        for (var side in defaultRadius) {
          radius[side] = radius[side] || defaultRadius[side];
        }
      }
      ctx.beginPath();
      ctx.moveTo(x + radius.tl, y);
      ctx.lineTo(x + width - radius.tr, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
      ctx.lineTo(x + width, y + height - radius.br);
      ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
      ctx.lineTo(x + radius.bl, y + height);
      ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
      ctx.lineTo(x, y + radius.tl);
      ctx.quadraticCurveTo(x, y, x + radius.tl, y);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }
    function tableHead(W, y, xPad){
      const lengthPriceColWidth = 180;
      const imageWidth = 250;
      
      ctx.fillStyle='#e6eaeb'; roundRect(ctx, xPad, y, W-2*xPad, 36, 10, true);
      ctx.fillStyle='#081249'; ctx.font='600 14px system-ui, -apple-system, Segoe UI, Roboto';
      
      // Length header (left side) - left aligned
      ctx.textAlign='left';
      ctx.fillText('Length', xPad + 10, y+23);
      
      // Price header (left side, next to length) - left aligned
      ctx.fillText(`Price (${SYMBOL[state.currency]||''}${state.currency})`, xPad + 90, y+23);
      
      // Product image header (right side) - center aligned
      ctx.textAlign='center';
      ctx.fillText('Product', xPad + lengthPriceColWidth + imageWidth/2, y+23);
    }

    function segmentBlockHeight(rows){ 
      const titleHeight = 24;
      const tableHeaderHeight = 36;
      const minImageHeight = 200; // Minimum height for product image
      const rowHeight = 40; // Height per data row
      const bottomMargin = 40;
      
      // Calculate dynamic table height based on number of rows
      const dynamicImageHeight = Math.max(minImageHeight, rows.length * rowHeight + 60); // 60px for padding
      
      return titleHeight + tableHeaderHeight + dynamicImageHeight + bottomMargin;
    }
    
    function calculateOptimalPageHeight(segments, W) {
      if (segments.length === 0) return 600;
      
      const seg = segments[0]; // Only calculate for first segment since we render one per page
      const baseHeaderHeight = 100;
      const categoryHeaderHeight = seg.category ? 120 : 0;
      const headerHeight = baseHeaderHeight + categoryHeaderHeight;
      const footerHeight = 80; // Minimized footer background height for compact layout
      const minContentHeight = 200;
      const contentMargin = 80; // Increased spacing between content and footer
      
      const rows = rowsForSegment(seg);
      const contentHeight = segmentBlockHeight(rows);
      
      // Ensure adequate spacing: header + content + margin + footer
      return Math.max(
        headerHeight + contentHeight + contentMargin + footerHeight,
        headerHeight + minContentHeight + contentMargin + footerHeight
      );
    }

    async function renderPage(segments, W, H){
      // Render only one segment per page with header and footer
      if (segments.length === 0) return 0;
      
      const seg = segments[0];
      const cat = seg.category;
      
      // Always draw header for this segment - ensure it's rendered
      try {
        await drawHeader(W, cat);
      } catch (e) {
        console.error('Error drawing header:', e);
        // Draw a basic header fallback
        ctx.fillStyle='#e6eaeb'; 
        roundRect(ctx, 10, 10, W-20, 80, 15, true, false);
      }
      
      let y = cat ? 269 : 160; // Start lower if category header is present - adjusted for new header height
      let xPad = 20;
      
      const rows = rowsForSegment(seg);
      
      // Title
      ctx.fillStyle='#081249'; ctx.font='700 18px system-ui, -apple-system, Segoe UI, Roboto'; ctx.textAlign='center';
      const unit = state.kg ? 'Per Kg' : 'Per Piece';
      const titleText = `${seg.product.toUpperCase()} | ${seg.density.toUpperCase()} | ${seg.color.toUpperCase()} | ${state.currency} | ${unit.toUpperCase()}`;
      ctx.fillText(titleText, W/2, y+20); y += 24;

      // Table with rounded corners and better margins - dynamic height based on data
       const tableMargin = 30;
       const tableWidth = W - 2 * tableMargin;
       
       // Calculate dynamic table dimensions based on row count
       const minImageHeight = 200;
       const rowHeight = 40;
       const dynamicImageHeight = Math.max(minImageHeight, rows.length * rowHeight + 60);
       const tableContentHeight = 36 + dynamicImageHeight; // header + content
       
       // Draw table background with rounded corners
       ctx.fillStyle='#ffffff';
       roundRect(ctx, tableMargin, y, tableWidth, tableContentHeight, 12, true);
       
       // Add subtle shadow effect
       ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
       ctx.shadowBlur = 8;
       ctx.shadowOffsetY = 4;
       
       tableHead(W, y, tableMargin); y += 36;
       
       ctx.shadowColor = 'transparent'; // Reset shadow
       ctx.shadowBlur = 0;
       ctx.shadowOffsetY = 0;
       
       // Calculate layout for 3-column table: Length+Price, Product Image
       const lengthPriceColWidth = 180;
       const imageWidth = 250;
       const imageHeight = dynamicImageHeight;
       
       // Draw product image in right column
       let imagePath = getProductImagePath(seg.category, seg.product, seg.density);
       
       const imageX = tableMargin + lengthPriceColWidth;
       const imageY = y;
       
       if (imagePath) {
         try {
           await drawImage(imagePath, imageX, imageY, imageWidth, imageHeight);
         } catch(e) {
           console.warn('Product image not found:', imagePath);
           // Draw placeholder text if image fails
           ctx.fillStyle='#64748b';
           ctx.font='500 14px system-ui, -apple-system, Segoe UI, Roboto';
           ctx.textAlign='center';
           ctx.fillText('Image not found', imageX + imageWidth/2, imageY + imageHeight/2);
         }
       }
       
       // Draw length and price data with proper spacing
       ctx.font='500 13px system-ui, -apple-system, Segoe UI, Roboto';
       const dataRowHeight = 40; // Consistent row height
       const startPadding = 30; // Top padding within table content area
       
       for (let idx = 0; idx < rows.length; idx++) {
         const row = rows[idx];
         const dataY = y + startPadding + (idx * dataRowHeight);
         
         // Length column (left side) - left aligned
         ctx.fillStyle='#444662';
         ctx.textAlign='left';
         ctx.fillText(`${row.length}"`, tableMargin + 10, dataY);
         
         // Price column (left side, next to length) - left aligned
         const converted = state.currency==='INR' ? row.priceINR : convertINRto(state.currency, row.priceINR);
         const factor = getCurrentPriceFactor();
        const adjustedPrice = (converted || 0) * factor;
         ctx.fillText(`${(SYMBOL[state.currency]||'')}${adjustedPrice.toFixed(2)}`, tableMargin + 90, dataY);
       }
       
       y += dynamicImageHeight + 20;
      
      // Draw footer for this segment
      await drawFooter(W,H,segment);
      
      return 1; // Always consume exactly one segment
    }

    function renderAllPagesToHTML(){
      const htmlPreview = document.getElementById('htmlPreview');
      const previewContainer = htmlPreview.querySelector('div');
      
      // Clear existing content
      previewContainer.innerHTML = '';
      
      if (state.segments.length === 0) {
        previewContainer.innerHTML = '<div class="text-center text-gray-500 p-8">No segments to display. Please select products and generate preview.</div>';
        document.getElementById('pageInfo').textContent = 'No pages to display';
        

        
        return;
      }
      
      // Generate HTML for each segment with 200px spacing
      const pagesHTML = state.segments.map((segment, index) => {
        return `<div class="page-wrapper mx-auto" style="margin-bottom: 60px;">${createPageHTML(segment, index)}</div>`;
      }).join('');
      
      previewContainer.innerHTML = pagesHTML;
      
      // Update page info
      const pageCount = state.segments.length;
      document.getElementById('pageInfo').textContent = pageCount > 1 ? `Showing all ${pageCount} pages` : 'Single page preview';
      
      // Show PNG download button for all page counts since we support multiple PNG generation
      const pngButton = document.getElementById('downloadPNG');
      if (pngButton) {
        pngButton.style.display = 'flex';
        pngButton.disabled = false;
      }
      
      return { pageCount };
    }
    
    // Canvas functions removed - now using HTML preview
    


    async function downloadPDF(){
      console.log('downloadPDF called');
      
      if (state.segments.length === 0) {
        alert('Please generate a preview first. Select a category, products, densities, and colors, then click "Generate Preview".');
        return;
      }
      
      // Show loading state with mobile-friendly feedback
      const downloadBtn = $('shareDownloadPDF');
      const originalText = downloadBtn.innerHTML;
      downloadBtn.innerHTML = '<span>â³</span> <span class="hidden sm:inline">Generating PDF...</span><span class="sm:hidden">Generating...</span>';
      downloadBtn.disabled = true;
      
      // Add mobile-specific loading indicator
      const loadingOverlay = document.createElement('div');
      loadingOverlay.id = 'pdfLoadingOverlay';
      loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      loadingOverlay.innerHTML = `
        <div class="bg-white rounded-lg p-6 text-center max-w-xs mx-4">
          <div class="text-2xl mb-2">â³</div>
          <div class="font-medium">Generating PDF...</div>
          <div class="text-sm text-gray-600 mt-1">Please wait</div>
        </div>
      `;
      document.body.appendChild(loadingOverlay);
      
      try {
        // Create a temporary container to measure content dimensions
        const measureContainer = document.createElement('div');
        measureContainer.style.position = 'absolute';
        measureContainer.style.left = '-9999px';
        measureContainer.style.top = '0';
        measureContainer.style.width = 'auto';
        measureContainer.style.height = 'auto';
        measureContainer.style.backgroundColor = '#ffffff';
        measureContainer.innerHTML = createPageHTML(state.segments[0], 0);
        document.body.appendChild(measureContainer);
        
        // Measure content dimensions
        const contentWidth = measureContainer.scrollWidth;
        const contentHeight = measureContainer.scrollHeight;
        document.body.removeChild(measureContainer);
        
        // Convert 20px margins to mm (1px â‰ˆ 0.264583mm)
        const marginMM = 20 * 0.264583;
        
        // Calculate page dimensions with 20px margins on all sides
        const pageWidthMM = (contentWidth * 0.264583) + (marginMM * 2);
        const pageHeightMM = (contentHeight * 0.264583) + (marginMM * 2);
        
        // Log dimensions for debugging
        console.log('ðŸ“ Content Dimensions:');
        console.log(`  Content Width: ${contentWidth}px`);
        console.log(`  Content Height: ${contentHeight}px`);
        console.log('ðŸ“„ PDF Page Dimensions:');
        console.log(`  Page Width: ${pageWidthMM.toFixed(2)}mm (${(pageWidthMM / 0.264583).toFixed(0)}px equivalent)`);
        console.log(`  Page Height: ${pageHeightMM.toFixed(2)}mm (${(pageHeightMM / 0.264583).toFixed(0)}px equivalent)`);
        console.log(`  Margin: ${marginMM.toFixed(2)}mm (20px)`);
        
        // Process each segment as a separate PNG image
        const generatedImages = [];
        
        for (let i = 0; i < state.segments.length; i++) {
          const segment = state.segments[i];
          
          // Create a temporary container for this segment only
          const tempContainer = document.createElement('div');
          tempContainer.style.position = 'absolute';
          tempContainer.style.left = '-9999px';
          tempContainer.style.top = '0';
          tempContainer.style.width = 'auto';
          tempContainer.style.minWidth = '800px';
          tempContainer.style.backgroundColor = '#ffffff';
          tempContainer.style.padding = '20px';
          tempContainer.innerHTML = createPageHTML(segment, i);
          
          document.body.appendChild(tempContainer);
          
          try {
            // Render this segment to canvas with high quality settings
            const canvas = await html2canvas(tempContainer, {
              scale: 3, // Higher quality for PNG
              useCORS: true,
              allowTaint: true,
              backgroundColor: '#ffffff',
              width: tempContainer.scrollWidth,
              height: tempContainer.scrollHeight,
              logging: false,
              removeContainer: false
            });
            
            // Convert canvas to PNG blob
            const pngBlob = await new Promise(resolve => {
              canvas.toBlob(resolve, 'image/png', 1.0);
            });
            
            // Generate filename for this segment
            const category = segment.category || 'General';
            const currency = state.currency || 'INR';
            const hasKgMode = segment.kg;
            const unit = hasKgMode ? 'Per Kg' : 'Per Piece';
            
            // Format category name with proper capitalization
            const formattedCategory = category.split(' ').map(word => 
              word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
            
            const filename = state.segments.length > 1 
              ? `${formattedCategory} - ${currency} - ${unit} - Page ${i + 1}.png`
              : `${formattedCategory} - ${currency} - ${unit}.png`;
            
            // Store the generated image
            generatedImages.push({
              blob: pngBlob,
              filename: filename,
              canvas: canvas
            });
            
            console.log(`Generated PNG image ${i + 1}/${state.segments.length}: ${filename}`);
            
          } finally {
            // Clean up temporary container
            document.body.removeChild(tempContainer);
          }
        }
        
        // Download all generated PNG images
        for (const imageData of generatedImages) {
          const url = URL.createObjectURL(imageData.blob);
          const downloadLink = document.createElement('a');
          downloadLink.href = url;
          downloadLink.download = imageData.filename;
          downloadLink.style.display = 'none';
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
          URL.revokeObjectURL(url);
        }
        
        console.log(`Generated ${generatedImages.length} PNG images successfully`);
        
        // Store the generated images for sharing
        state.lastGeneratedImages = {
          images: generatedImages,
          timestamp: Date.now()
        };
        
        // Reset button state
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
        
        // Remove mobile loading overlay
        const overlay = document.getElementById('pdfLoadingOverlay');
        if (overlay) overlay.remove();
        
        // Hide share popup
        $('sharePopup').classList.add('hidden');
        
        // Show enhanced success message with file opening option
        const successModal = document.createElement('div');
        successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        successModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-auto">
            <div class="text-center mb-4">
              <div class="text-3xl mb-2">âœ…</div>
              <h3 class="font-semibold text-lg">PDF Downloaded Successfully!</h3>
              <p class="text-gray-600 text-sm mt-1">Your file has been saved to your device</p>
            </div>
            <div class="space-y-3">
              <div class="bg-gray-50 rounded-lg p-3">
                <div class="text-sm font-medium text-gray-700">File:</div>
                <div class="text-sm text-gray-600 truncate">${filename}</div>
              </div>
              <button onclick="openDownloadedFile('${filename}', 'pdf')" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors touch-action-manipulation">
                ðŸ“„ Open PDF File
              </button>
              <button onclick="this.parentElement.parentElement.parentElement.remove()" class="w-full px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors touch-action-manipulation">
                Close
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(successModal);
        
        // Auto-close after 10 seconds
        setTimeout(() => {
          if (successModal.parentElement) {
            successModal.remove();
          }
        }, 10000);
        
      } catch (error) {
        console.error('Error generating PDF:', error);
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
        
        // Remove mobile loading overlay
        const overlay = document.getElementById('pdfLoadingOverlay');
        if (overlay) overlay.remove();
        
        // Mobile-friendly error message
        if (window.innerWidth <= 768) {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'fixed top-4 left-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50';
          errorMsg.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="text-lg">âŒ</span>
              <div>
                <div class="font-medium">PDF Generation Failed</div>
                <div class="text-sm">Please try again</div>
              </div>
            </div>
          `;
          document.body.appendChild(errorMsg);
          setTimeout(() => errorMsg.remove(), 4000);
        } else {
          alert('Error generating PDF: ' + error.message);
        }
      }
    }

    // Function to open downloaded files
    function openDownloadedFile(filename, fileType) {
      try {
        // For modern browsers, try to use the File System Access API or fallback methods
        if ('showOpenFilePicker' in window) {
          // Modern browsers with File System Access API
          const instructions = document.createElement('div');
          instructions.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
          instructions.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-auto">
              <div class="text-center mb-4">
                <div class="text-2xl mb-2">ðŸ“</div>
                <h3 class="font-semibold text-lg">Open Downloaded File</h3>
              </div>
              <div class="space-y-3 text-sm">
                <p class="text-gray-600">To open your downloaded ${fileType.toUpperCase()} file:</p>
                <div class="bg-gray-50 rounded-lg p-3">
                  <div class="space-y-2">
                    <div class="flex items-start gap-2">
                      <span class="font-medium text-blue-600">1.</span>
                      <span>Check your Downloads folder</span>
                    </div>
                    <div class="flex items-start gap-2">
                      <span class="font-medium text-blue-600">2.</span>
                      <span>Look for: <strong>${filename}</strong></span>
                    </div>
                    <div class="flex items-start gap-2">
                      <span class="font-medium text-blue-600">3.</span>
                      <span>Double-click to open</span>
                    </div>
                  </div>
                </div>
                <div class="text-xs text-gray-500">
                  ðŸ’¡ Tip: Press Ctrl+J (Windows) or Cmd+Shift+J (Mac) in your browser to see recent downloads
                </div>
              </div>
              <button onclick="this.parentElement.parentElement.remove()" class="w-full mt-4 px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors touch-action-manipulation">
                Got it!
              </button>
            </div>
          `;
          document.body.appendChild(instructions);
        } else {
          // Fallback for older browsers
          const message = `Your ${fileType.toUpperCase()} file "${filename}" has been downloaded.\n\nTo open it:\n1. Check your Downloads folder\n2. Look for: ${filename}\n3. Double-click to open\n\nTip: Press Ctrl+J (Windows) or Cmd+Shift+J (Mac) to see recent downloads.`;
          alert(message);
        }
      } catch (error) {
        console.error('Error opening file:', error);
        const fallbackMessage = `File downloaded: ${filename}\n\nPlease check your Downloads folder to open the file.`;
        alert(fallbackMessage);
      }
    }

    /* Init */
    async function init(){
      console.log('Starting init function...');
      try {
        // Try to load data from embedded script first
        const embeddedElement = document.getElementById('EMBEDDED_DATA');
        if (embeddedElement && embeddedElement.textContent.trim()) {
          console.log('Loading data from embedded script...');
          productData = JSON.parse(embeddedElement.textContent);
          console.log('Loaded', productData.length, 'products from embedded data');
        } else {
          // Try to load from localStorage as fallback
          const storedData = localStorage.getItem('productData');
          if (storedData) {
            console.log('Loading data from localStorage...');
            productData = JSON.parse(storedData);
            console.log('Loaded', productData.length, 'products from localStorage');
          } else {
            // Initialize with empty data - users can upload their own Excel files
            console.log('No existing data found, initializing with empty data...');
            productData = [];
            console.log('Initialized with empty data - ready for Excel upload');
          }
        }
      } catch(e){ 
        console.error('Error during initialization:', e);
        productData=[]; 
      }
      
      // Initialize product arrays for filtering
      state.allProducts = [...productData];
      state.filteredProducts = []; // Start empty - will be populated when price list is selected
      console.log('State initialized with', state.allProducts.length, 'products');
      
      // Price list dropdown will be initialized in DOMContentLoaded event
      
      // restore FX if saved, otherwise fetch live rates
      const cached = JSON.parse(localStorage.getItem('INH_FX')||'null');
      if (cached && cached.base==='INR' && cached.rates && cached.mode==='auto'){
        state.rates = cached;
        // Auto-refresh if rates are older than 1 hour
        const hourAgo = Date.now() - (60 * 60 * 1000);
        if (!cached.updatedAt || cached.updatedAt < hourAgo) {
          fetchLiveFX();
        }
      } else {
        fetchLiveFX();
      }

      // events
      elCurrency.addEventListener('change', async ()=>{ 
        state.currency=elCurrency.value; 
        await refreshRates(false); // Update exchange rates when currency changes
        renderAllPagesToHTML(); 
      });


      elCategory.addEventListener('change', onCategoryChange);
      
      // Dropdown toggle functionality
      [elProductDropdown, elDensityDropdown, elColorDropdown].forEach(dropdown => {
        const btn = dropdown.querySelector('.dropdown-btn');
        const list = dropdown.querySelector('.dropdown-list');
        
        btn.addEventListener('click', (e) => {
          if (btn.disabled) return;
          e.stopPropagation();
          
          // Close other dropdowns
          [elProductDropdown, elDensityDropdown, elColorDropdown].forEach(other => {
            if (other !== dropdown) {
              other.querySelector('.dropdown-list').classList.add('hidden');
            }
          });
          
          list.classList.toggle('hidden');
        });
        

        
        // Handle checkbox changes
        list.addEventListener('change', () => {
          if (dropdown === elProductDropdown) onProductChange();
          else if (dropdown === elDensityDropdown) onDensityChange();
          else if (dropdown === elColorDropdown) onColorChange();
        });
      });
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', () => {
        [elProductDropdown, elDensityDropdown, elColorDropdown].forEach(dropdown => {
          dropdown.querySelector('.dropdown-list').classList.add('hidden');
        });
      });

      // Checkbox event listeners removed

  
      elClearSegments.addEventListener('click', clearAllOptions);
      $('previewBtn').addEventListener('click', generatePreview);



      
      // Direct PNG sharing functionality
      $('sharePNGBtn').addEventListener('click', togglePNGSelectionDropdown);
    $('shareSelectedPNGs').addEventListener('click', shareSelectedPNGFiles);

      
      // Page navigation event listeners removed - now using HTML preview
      
      // Price factor event listener
      $('priceFactor').addEventListener('input', () => {
        if (state.segments.length > 0) {
          renderAllPagesToHTML();
        }
      });




      // Close share popup when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#sharePopup')) {
          $('sharePopup').classList.add('hidden');
        }
        
        // Close PNG dropdown when clicking outside
        if (!e.target.closest('#pngSelectionDropdown') && !e.target.closest('#sharePNGBtn')) {
          const dropdown = document.getElementById('pngSelectionDropdown');
          if (dropdown && !dropdown.classList.contains('hidden')) {
            dropdown.classList.add('hidden');
          }
        }
      });

      renderAllPagesToHTML();
    }

    // Generate Preview functionality
    function generatePreview() {
      // Validate that a category is selected
      if (!state.category) {
        alert('Please select a category first before generating a preview.');
        return;
      }
      
      // Clear existing preview content immediately to ensure fresh output
      const htmlPreview = document.getElementById('htmlPreview');
      const previewContainer = htmlPreview.querySelector('div');
      previewContainer.innerHTML = '<div class="text-center text-gray-500 p-8">Generating preview...</div>';
      document.getElementById('pageInfo').textContent = 'Generating...';
      
      // Show loading state
      const previewBtn = $('previewBtn');
      const originalText = previewBtn.innerHTML;
      previewBtn.innerHTML = '<span>â³</span> <span class="hidden sm:inline">Generating...</span><span class="sm:hidden">Loading...</span>';
      previewBtn.disabled = true;
      
      // Share PDF button removed - no longer needed
      
      // Use setTimeout to allow UI to update
      setTimeout(() => {
        try {
          // First, add the combinations to segments
          explodeCombosToSegments();
          
          // Then generate the preview
          renderAllPagesToHTML();
          
          // Reset button state
          previewBtn.innerHTML = originalText;
          previewBtn.disabled = false;
          
          // Share PDF button removed - no longer needed
          
          // Ensure all buttons have equal flex properties with improved styling
          const container = document.getElementById('actionButtonsContainer');
          const buttons = container.querySelectorAll('button');
          buttons.forEach(button => {
            button.style.flex = '1';
            // Mobile-friendly minimum width
            button.style.minWidth = window.innerWidth <= 640 ? '80px' : '120px';
            button.style.height = '52px';
            button.style.fontSize = '14px';
            button.style.fontWeight = '600';
            button.style.padding = '12px 16px';
            button.style.borderRadius = '12px';
            button.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
            button.style.whiteSpace = 'nowrap';
            button.style.overflow = 'hidden';
            button.style.textOverflow = 'ellipsis';
            button.style.transition = 'all 0.2s ease';
          });
          
          // Show success feedback
          const successMsg = document.createElement('div');
          successMsg.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50 flex items-center gap-2';
          successMsg.innerHTML = '<span class="text-lg">âœ…</span><span class="font-medium">Preview generated successfully!</span>';
          document.body.appendChild(successMsg);
          setTimeout(() => successMsg.remove(), 3000);
          
        } catch (error) {
          console.error('Error generating preview:', error);
          previewBtn.innerHTML = originalText;
          previewBtn.disabled = false;
          alert('Error generating preview: ' + error.message + '. Please ensure you have selected a category and try again.');
        }
      }, 100);
    }
    
    // Clear selections but keep category
    function clearAllSelections() {
      state.selProducts = [];
      state.selDensities = [];
      state.selColors = [];
      state.segments = [];
      state.selectAll = false;
      
      // Reset form elements but keep category
      // Removed elSelectAll and elKg references - checkboxes no longer exist
      
      // Clear segments list and preview
      renderSegmentsList();
      renderAllPagesToHTML();
    }
    
    // Page navigation functions removed - now using HTML preview

    // Clear all options and reset to default state
    function clearAllOptions() {
      // Reset state
      state.category = '';
      state.selProducts = [];
      state.selDensities = [];
      state.selColors = [];
      state.segments = [];
      state.selectAll = false;
      
      // Reset form elements
      elCategory.value = '';
      // Removed elKg and elSelectAll references - checkboxes no longer exist
      
      // Clear price factor input
      document.getElementById('priceFactor').value = '';
      
      // Clear and disable dropdowns
      fillDropdown(elProductDropdown, [], 'Select products...');
      fillDropdown(elDensityDropdown, [], 'Select densities...');
      fillDropdown(elColorDropdown, [], 'Select colors...');
      lockDropdown(elProductDropdown, true);
      lockDropdown(elDensityDropdown, true);
      lockDropdown(elColorDropdown, true);
      
      // Hide elements and reset layout
      // Removed elSelectAllWrap and elKgWrap references - elements no longer exist
      // sharePdfBtn removed - no longer needed
      
      // Reset button styling to original state
      const container = document.getElementById('actionButtonsContainer');
      const buttons = container.querySelectorAll('button');
      buttons.forEach(button => {
        button.style.flex = '';
        button.style.minWidth = '';
        button.style.height = '';
        button.style.fontSize = '';
        button.style.fontWeight = '';
        button.style.padding = '';
        button.style.borderRadius = '';
        button.style.boxShadow = '';
        button.style.whiteSpace = '';
        button.style.overflow = '';
        button.style.textOverflow = '';
        button.style.transition = '';
      });
      
      // Close share popup if open
      const sharePopup = $('sharePopup');
      sharePopup.classList.add('hidden');
      
      // Clear segments list and preview
      renderSegmentsList();
      renderAllPagesToHTML();
    }

    // Share functionality
    async function shareNatively() {
      console.log('shareNatively called, segments:', state.segments.length, 'PNGs:', state.lastGeneratedPNGs?.length || 0);
      
      // Check if we have segments to share
      if (state.segments.length === 0) {
        // For Price List Calculator Module, try to generate preview automatically
        if (state.category) {
          console.log('No segments found, but category exists. Generating preview first...');
          generatePreview();
          // Wait a moment for preview generation to complete
          setTimeout(() => {
            if (state.segments.length > 0) {
              shareNatively(); // Retry sharing
            } else {
              alert('Unable to generate preview. Please ensure you have selected products and try the Preview button first.');
            }
          }, 1000);
          return;
        } else {
          alert('Please select a category and generate a preview first before sharing.');
          return;
        }
      }
      
      // Check if we have generated PNG images to share
      if (!state.lastGeneratedPNGs || state.lastGeneratedPNGs.length === 0) {
        // Show popup directly for user to choose sharing options
        toggleSharePopup();
        return;
      }
      
      // Check if Web Share API is supported and can share files
      if (navigator.share && navigator.canShare) {
        const files = state.lastGeneratedPNGs.map(png => 
          new File([png.blob], png.filename, {
            type: 'image/png'
          })
        );
        
        const shareData = {
          title: 'Price List Images',
          text: 'Check out these price lists',
          files: files
        };
        
        // Check if the device can share this data
        if (navigator.canShare(shareData)) {
          try {
            await navigator.share(shareData);
            return; // Successfully shared
          } catch (error) {
            console.log('Native sharing cancelled or failed:', error);
            // Fall through to popup fallback
          }
        }
      }
      
      // Fallback to popup if Web Share API is not supported or sharing failed
      toggleSharePopup();
    }
    
    function toggleSharePopup() {
      console.log('toggleSharePopup called');
      const popup = $('sharePopup');
      console.log('popup element:', popup);
      
      if (popup.style.display === 'none' || popup.classList.contains('hidden')) {
        popup.style.display = 'block';
        popup.classList.remove('hidden');
        console.log('Popup shown');
      } else {
        popup.style.display = 'none';
        popup.classList.add('hidden');
        console.log('Popup hidden');
      }
      console.log('popup classes after toggle:', popup.className);
      console.log('popup display style:', popup.style.display);
    }

    async function downloadPNG() {
      // Validate that segments exist
      if (state.segments.length === 0) {
        if (window.innerWidth <= 768) {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'fixed top-4 left-4 right-4 bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg z-50';
          errorMsg.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="text-lg">âš ï¸</span>
              <span class="font-medium">Please generate a preview first</span>
            </div>
          `;
          document.body.appendChild(errorMsg);
          setTimeout(() => errorMsg.remove(), 3000);
        } else {
          alert('Please generate a preview first before downloading as PNG.');
        }
        return;
      }
      
      try {
        // Show loading state with mobile-friendly feedback
        const downloadBtn = $('downloadPNG');
        const originalText = downloadBtn.innerHTML;
        downloadBtn.innerHTML = '<span>â³</span> <span class="hidden sm:inline">Generating PNG...</span><span class="sm:hidden">Generating...</span>';
        downloadBtn.disabled = true;
        
        // Add mobile-specific loading indicator
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'pngLoadingOverlay';
        loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        loadingOverlay.innerHTML = `
          <div class="bg-white rounded-lg p-6 text-center max-w-xs mx-4">
            <div class="text-2xl mb-2">ðŸ–¼ï¸</div>
            <div class="font-medium">Generating PNG Images...</div>
            <div class="text-sm text-gray-600 mt-1">Processing ${state.segments.length} price list${state.segments.length > 1 ? 's' : ''}</div>
          </div>
        `;
        document.body.appendChild(loadingOverlay);
        
        const generatedImages = [];
        
        // Process each segment as a separate PNG
        for (let i = 0; i < state.segments.length; i++) {
          const segment = state.segments[i];
          
          // Create a temporary container for this segment only
          const tempContainer = document.createElement('div');
          tempContainer.style.position = 'absolute';
          tempContainer.style.left = '-9999px';
          tempContainer.style.top = '0';
          tempContainer.style.width = '615px';
          tempContainer.style.backgroundColor = '#ffffff';
          tempContainer.style.padding = '20px';
          tempContainer.style.fontFamily = 'Arial, sans-serif';
          
          // Generate HTML for this specific segment
          tempContainer.innerHTML = createPageHTML(segment, i);
          document.body.appendChild(tempContainer);
          
          // Convert this segment to canvas
          const canvas = await html2canvas(tempContainer, {
            scale: 2, // Higher quality
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff',
            width: 615,
            height: tempContainer.scrollHeight
          });
          
          // Convert canvas to blob
          const blob = await new Promise(resolve => {
            canvas.toBlob(resolve, 'image/png');
          });
          
          // Generate filename for this segment
          const categoryName = segment.category.split(' ').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
          ).join(' ');
          const currency = state.currency || 'INR';
          const unit = state.kg ? 'Per Kg' : 'Per Piece';
          const segmentSuffix = state.segments.length > 1 ? ` - Page ${i + 1}` : '';
          const filename = `${categoryName} - ${currency} - ${unit}${segmentSuffix}.png`;
          
          generatedImages.push({
            blob: blob,
            filename: filename,
            segment: segment
          });
          
          // Clean up temporary container
          document.body.removeChild(tempContainer);
        }
        
        // Try to use Web Share API first, fallback to download
        const shareFiles = generatedImages.map(imageData => 
          new File([imageData.blob], imageData.filename, { type: 'image/png' })
        );
        
        // Check if Web Share API is supported and can share files
        if (navigator.share && navigator.canShare) {
          const shareData = {
            title: 'Price List Images',
            text: `Sharing ${shareFiles.length} price list image${shareFiles.length > 1 ? 's' : ''}`,
            files: shareFiles
          };
          
          if (navigator.canShare(shareData)) {
            try {
              await navigator.share(shareData);
              console.log('Images shared successfully via Web Share API');
              
              // Reset button state
              downloadBtn.innerHTML = originalText;
              downloadBtn.disabled = false;
              
              // Remove mobile loading overlay
              const overlay = document.getElementById('pngLoadingOverlay');
              if (overlay) overlay.remove();
              
              // Hide share popup
              $('sharePopup').classList.add('hidden');
              
              // Show success message for sharing
              const successModal = document.createElement('div');
              successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
              successModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-auto">
                  <div class="text-center">
                    <div class="text-3xl mb-2">ðŸ“¤</div>
                    <h3 class="font-semibold text-lg">Images Shared Successfully!</h3>
                    <p class="text-gray-600 text-sm mt-1">${shareFiles.length} price list image${shareFiles.length > 1 ? 's' : ''} shared via device</p>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" class="mt-4 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors touch-action-manipulation">
                      Close
                    </button>
                  </div>
                </div>
              `;
              document.body.appendChild(successModal);
              
              // Auto-close after 5 seconds
              setTimeout(() => {
                if (successModal.parentElement) {
                  successModal.remove();
                }
              }, 5000);
              
              return; // Exit early if sharing was successful
            } catch (error) {
              console.log('Web Share API cancelled or failed, falling back to download:', error);
            }
          }
        }
        
        // Fallback: Download all generated images
        for (const imageData of generatedImages) {
          const url = URL.createObjectURL(imageData.blob);
          const downloadLink = document.createElement('a');
          downloadLink.href = url;
          downloadLink.download = imageData.filename;
          downloadLink.style.display = 'none';
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
          URL.revokeObjectURL(url);
        }
        
        console.log(`Generated ${generatedImages.length} PNG images successfully`);
        
        // Store the generated images for sharing
        state.lastGeneratedPNGs = generatedImages;
        
        // Reset button state
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
        
        // Remove mobile loading overlay
        const overlay = document.getElementById('pngLoadingOverlay');
        if (overlay) overlay.remove();
        
        // Hide share popup
        $('sharePopup').classList.add('hidden');
        
        // Show enhanced success message
        const successModal = document.createElement('div');
        successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        const fileList = generatedImages.map(img => `<div class="text-sm text-gray-600 truncate">â€¢ ${img.filename}</div>`).join('');
        successModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-auto">
            <div class="text-center mb-4">
              <div class="text-3xl mb-2">âœ…</div>
              <h3 class="font-semibold text-lg">PNG Images Downloaded Successfully!</h3>
              <p class="text-gray-600 text-sm mt-1">${generatedImages.length} image${generatedImages.length > 1 ? 's' : ''} saved to your device</p>
            </div>
            <div class="space-y-3">
              <div class="bg-gray-50 rounded-lg p-3 max-h-32 overflow-y-auto">
                <div class="text-sm font-medium text-gray-700 mb-2">Files:</div>
                ${fileList}
              </div>
              <button onclick="this.parentElement.parentElement.parentElement.remove()" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors touch-action-manipulation">
                Close
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(successModal);
        
        // Auto-close after 10 seconds
        setTimeout(() => {
          if (successModal.parentElement) {
            successModal.remove();
          }
        }, 10000);
        
      } catch (error) {
        console.error('Error generating PNG:', error);
        
        // Reset button state
        const downloadBtn = $('downloadPNG');
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
        
        // Remove mobile loading overlay
        const overlay = document.getElementById('pngLoadingOverlay');
        if (overlay) overlay.remove();
        
        // Mobile-friendly error message
        if (window.innerWidth <= 768) {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'fixed top-4 left-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50';
          errorMsg.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="text-lg">âŒ</span>
              <div>
                <div class="font-medium">PNG Generation Failed</div>
                <div class="text-sm">Please try again</div>
              </div>
            </div>
          `;
          document.body.appendChild(errorMsg);
          setTimeout(() => errorMsg.remove(), 4000);
        } else {
          alert('Error generating PNG: ' + error.message);
        }
      }
    }

    // PNG Selection and Sharing Functions
    let isAutoCollapsing = false;
    
    async function togglePNGSelectionDropdown() {
      const dropdown = document.getElementById('pngSelectionDropdown');
      const isHidden = dropdown.classList.contains('hidden');
      
      // Prevent reopening immediately after auto-collapse
      if (isAutoCollapsing) {
        return;
      }
      
      if (isHidden) {
        // Check if PNG files exist, if not generate them first
        if (!state.lastGeneratedPNGs || state.lastGeneratedPNGs.length === 0) {
          await generateAllPNGFiles();
        }
        // Populate the dropdown with available PNG files
        populatePNGFilesList();
        dropdown.classList.remove('hidden');
      } else {
        dropdown.classList.add('hidden');
      }
    }

    function populatePNGFilesList() {
      const filesList = document.getElementById('pngFilesList');
      const shareBtn = document.getElementById('shareSelectedPNGs');
      
      // Clear existing content
      filesList.innerHTML = '';
      
      // Check if we have generated PNG files
      if (!state.lastGeneratedPNGs || state.lastGeneratedPNGs.length === 0) {
        filesList.innerHTML = '<div class="text-sm text-gray-500 text-center py-2">No PNG files available. Generate PNGs first.</div>';
        shareBtn.disabled = true;
        return;
      }
      
      // Create radio buttons for each PNG file
      state.lastGeneratedPNGs.forEach((pngData, index) => {
        const radioContainer = document.createElement('div');
        radioContainer.className = 'flex items-center gap-2';
        
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'png-file-selection';
        radio.id = `png-file-${index}`;
        radio.className = 'png-file-radio w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500 focus:ring-2';
        radio.addEventListener('change', () => {
          updateShareButtonState();
          // Auto-collapse after selection for cleaner UX
          isAutoCollapsing = true;
          setTimeout(() => {
            document.getElementById('pngSelectionDropdown').classList.add('hidden');
            document.getElementById('sharePopup').classList.add('hidden');
            // Reset flag after collapse to allow normal toggle behavior
            setTimeout(() => {
              isAutoCollapsing = false;
            }, 500); // Brief delay to prevent immediate reopening
          }, 1500); // 1.5 second delay to allow user to see selection
        });
        
        const label = document.createElement('label');
        label.htmlFor = `png-file-${index}`;
        label.className = 'text-sm text-gray-700 cursor-pointer flex-1 truncate';
        label.textContent = pngData.filename;
        label.title = pngData.filename; // Show full filename on hover
        
        radioContainer.appendChild(radio);
        radioContainer.appendChild(label);
        filesList.appendChild(radioContainer);
      });
      
      updateShareButtonState();
    }

    // Removed toggleSelectAllPNGs function since we're using radio buttons

    function updateShareButtonState() {
      const radios = document.querySelectorAll('.png-file-radio');
      const shareBtn = document.getElementById('shareSelectedPNGs');
      
      const selectedRadio = Array.from(radios).find(radio => radio.checked);
      
      // Update share button
      shareBtn.disabled = !selectedRadio;
      shareBtn.textContent = selectedRadio ? 'Share Selected File' : 'Share Selected File';
    }

    async function shareSelectedPNGFiles() {
      const selectedRadio = document.querySelector('.png-file-radio:checked');
      
      if (!selectedRadio) {
        alert('Please select a PNG file to share.');
        return;
      }
      
      const index = parseInt(selectedRadio.id.split('-')[2]);
      const pngData = state.lastGeneratedPNGs[index];
      
      if (!pngData) {
        alert('Selected PNG file not found.');
        return;
      }
      
      const selectedFiles = [new File([pngData.blob], pngData.filename, { type: 'image/png' })];
      
      // Check if Web Share API is supported and can share files
      if (navigator.share && navigator.canShare) {
        const shareData = {
          title: 'PNG Price List',
          text: `Sharing price list image: ${pngData.filename}`,
          files: selectedFiles
        };
        
        if (navigator.canShare(shareData)) {
          try {
            await navigator.share(shareData);
            // Hide the dropdown and share popup on successful share
            isAutoCollapsing = true;
            document.getElementById('pngSelectionDropdown').classList.add('hidden');
            document.getElementById('sharePopup').classList.add('hidden');
            setTimeout(() => {
              isAutoCollapsing = false;
            }, 500);
            return;
          } catch (error) {
            console.log('Native sharing cancelled or failed:', error);
          }
        }
      }
      
      // Fallback: Download selected files
      selectedFiles.forEach(file => {
        const url = URL.createObjectURL(file);
        const downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = file.name;
        downloadLink.style.display = 'none';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        URL.revokeObjectURL(url);
      });
      
      // Show success message
      const successMsg = document.createElement('div');
      successMsg.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50 flex items-center gap-2';
      successMsg.innerHTML = `
        <span class="text-lg">âœ…</span>
        <span>Downloaded PNG file: ${pngData.filename}</span>
      `;
      document.body.appendChild(successMsg);
      setTimeout(() => successMsg.remove(), 3000);
      
      // Hide the dropdown and share popup
      isAutoCollapsing = true;
      document.getElementById('pngSelectionDropdown').classList.add('hidden');
      document.getElementById('sharePopup').classList.add('hidden');
      setTimeout(() => {
        isAutoCollapsing = false;
      }, 500);
    }

    // Share Invoice Image functionality
    async function shareInvoiceImage() {
      try {
        // Show loading state
        const shareBtn = $('shareInvoiceImage');
        const originalText = shareBtn.innerHTML;
        shareBtn.innerHTML = '<span>â³</span> <span>Generating...</span>';
        shareBtn.disabled = true;
        
        // Create invoice-style layout
        const invoiceHTML = createInvoiceLayout();
        
        // Create a temporary container for rendering
        const tempContainer = document.createElement('div');
        tempContainer.style.position = 'absolute';
        tempContainer.style.left = '-9999px';
        tempContainer.style.top = '-9999px';
        tempContainer.style.width = '800px';
        tempContainer.innerHTML = invoiceHTML;
        document.body.appendChild(tempContainer);
        
        // Convert to canvas using html2canvas
        const canvas = await html2canvas(tempContainer, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          width: 800,
          height: tempContainer.scrollHeight
        });
        
        // Remove temporary container
        document.body.removeChild(tempContainer);
        
        // Convert canvas to blob
        const blob = await new Promise(resolve => {
          canvas.toBlob(resolve, 'image/png', 1.0);
        });
        
        // Copy to clipboard
        if (navigator.clipboard && window.ClipboardItem) {
          await navigator.clipboard.write([
            new ClipboardItem({
              'image/png': blob
            })
          ]);
          
          // Show success message
          showSuccessMessage('Invoice image copied to clipboard! ðŸ“‹âœ¨');
        } else {
          // Fallback: download the image
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Invoice-${new Date().toISOString().slice(0,10)}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          showSuccessMessage('Invoice image downloaded! (Clipboard not supported)');
        }
        
        // Reset button state
        shareBtn.innerHTML = originalText;
        shareBtn.disabled = false;
        
        // Close the share popup
        $('sharePopup').classList.add('hidden');
        
      } catch (error) {
        console.error('Error generating invoice image:', error);
        
        // Show error message
        showErrorMessage('Failed to generate invoice image. Please try again.');
        
        // Reset button state
        const shareBtn = $('shareInvoiceImage');
        shareBtn.innerHTML = '<span>ðŸ“‹</span> <span>Share Invoice Image</span>';
        shareBtn.disabled = false;
      }
    }
    
    // Create invoice-style layout
    function createInvoiceLayout() {
      const category = state.segments.length > 0 ? state.segments[0].category : 'General';
      const currency = state.currency || 'INR';
      const currencySymbol = getCurrencySymbol(currency);
      const unit = state.kg ? 'Per Kg' : 'Per Piece';
      const currentDate = new Date().toLocaleDateString();
      
      // Get current quote items
      const items = state.segments.flatMap(segment => 
        segment.items.map(item => ({
          name: item.name,
          length: item.length,
          price: item.price,
          unit: unit
        }))
      );
      
      // Calculate totals
      const subtotal = items.reduce((sum, item) => sum + item.price, 0);
      const tax = subtotal * 0.18; // 18% GST
      const total = subtotal + tax;
      
      return `
        <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; background: white; color: #333;">
          <!-- Header -->
          <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #081249; padding-bottom: 20px;">
            <h1 style="color: #081249; font-size: 32px; margin: 0; font-weight: bold;">INVOICE</h1>
            <p style="color: #9b7952; font-size: 18px; margin: 5px 0;">Indian Natural Hair Pvt Ltd</p>
            <p style="color: #666; font-size: 14px; margin: 0;">Premium Hair Extensions & Wigs</p>
          </div>
          
          <!-- Invoice Details -->
          <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
            <div>
              <h3 style="color: #081249; margin: 0 0 10px 0;">Invoice Details</h3>
              <p style="margin: 5px 0;"><strong>Date:</strong> ${currentDate}</p>
              <p style="margin: 5px 0;"><strong>Category:</strong> ${category}</p>
              <p style="margin: 5px 0;"><strong>Currency:</strong> ${currency}</p>
              <p style="margin: 5px 0;"><strong>Unit:</strong> ${unit}</p>
            </div>
            <div style="text-align: right;">
              <h3 style="color: #081249; margin: 0 0 10px 0;">Company Info</h3>
              <p style="margin: 5px 0;">Indian Natural Hair Pvt Ltd</p>
              <p style="margin: 5px 0;">Premium Hair Solutions</p>
              <p style="margin: 5px 0;">www.indiannaturalhair.com</p>
            </div>
          </div>
          
          <!-- Items Table -->
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
            <thead>
              <tr style="background: #f8f9fa; border-bottom: 2px solid #081249;">
                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Product</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Length</th>
                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Price (${currencySymbol})</th>
              </tr>
            </thead>
            <tbody>
              ${items.map(item => `
                <tr style="border-bottom: 1px solid #eee;">
                  <td style="padding: 10px; border: 1px solid #ddd;">${item.name}</td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${item.length}"</td>
                  <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${currencySymbol}${item.price.toFixed(2)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          
          <!-- Totals -->
          <div style="margin-left: auto; width: 300px;">
            <div style="border: 2px solid #081249; padding: 20px; background: #f8f9fa;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Subtotal:</span>
                <span>${currencySymbol}${subtotal.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Tax (18%):</span>
                <span>${currencySymbol}${tax.toFixed(2)}</span>
              </div>
              <hr style="margin: 15px 0; border: 1px solid #081249;">
              <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; color: #081249;">
                <span>Total:</span>
                <span>${currencySymbol}${total.toFixed(2)}</span>
              </div>
            </div>
          </div>
          
          <!-- Footer -->
          <div style="margin-top: 40px; text-align: center; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px;">
            <p>Thank you for choosing Indian Natural Hair Pvt Ltd</p>
            <p>For inquiries, please contact us at info@indiannaturalhair.com</p>
          </div>
        </div>
      `;
    }
    
    // Helper function to get currency symbol
    function getCurrencySymbol(currency) {
      const symbols = {
        'INR': 'â‚¹',
        'USD': '$',
        'EUR': 'â‚¬',
        'GBP': 'Â£',
        'AUD': 'A$',
        'SAR': 'SAR ',
        'NGN': 'â‚¦',
        'AED': 'Ø¯.Ø¥ ',
        'JPY': 'Â¥'
      };
      return symbols[currency] || currency;
    }
    
    // Helper function to show success message
    function showSuccessMessage(message) {
      const successMsg = document.createElement('div');
      successMsg.className = 'fixed top-4 left-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50';
      successMsg.innerHTML = `
        <div class="flex items-center gap-2">
          <span class="text-lg">âœ…</span>
          <span class="font-medium">${message}</span>
        </div>
      `;
      document.body.appendChild(successMsg);
      setTimeout(() => successMsg.remove(), 4000);
    }
    
    // Helper function to show error message
    function showErrorMessage(message) {
      const errorMsg = document.createElement('div');
      errorMsg.className = 'fixed top-4 left-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50';
      errorMsg.innerHTML = `
        <div class="flex items-center gap-2">
          <span class="text-lg">âŒ</span>
          <span class="font-medium">${message}</span>
        </div>
      `;
      document.body.appendChild(errorMsg);
      setTimeout(() => errorMsg.remove(), 4000);
    }

    // PNG Selection Dropdown Functions
    function togglePNGSelectionDropdown() {
      const dropdown = document.getElementById('pngSelectionDropdown');
      const isHidden = dropdown.classList.contains('hidden');
      
      if (isHidden) {
        // Auto-generate PNGs when dropdown is opened
        generateAllPNGFiles();
      }
      
      dropdown.classList.toggle('hidden');
    }
    
    function toggleSelectAllPNGs() {
      const checkboxes = document.querySelectorAll('#pngFilesList input[type="checkbox"]');
      const selectAllBtn = document.getElementById('selectAllPNGs');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      
      checkboxes.forEach(cb => {
        cb.checked = !allChecked;
      });
      
      selectAllBtn.textContent = allChecked ? 'Select All' : 'Deselect All';
      updateShareButton();
    }
    
    function shareSelectedPNGFiles() {
      const selectedCheckboxes = document.querySelectorAll('#pngFilesList input[type="checkbox"]:checked');
      
      if (selectedCheckboxes.length === 0) {
        alert('Please select at least one PNG file to share.');
        return;
      }
      
      // Get the selected PNG data
      const selectedPNGs = Array.from(selectedCheckboxes).map(cb => {
        const filename = cb.getAttribute('data-filename');
        const blob = cb.getAttribute('data-blob');
        return { filename, blob };
      });
      
      // For now, download each selected PNG
      selectedPNGs.forEach(png => {
        const url = png.blob;
        const a = document.createElement('a');
        a.href = url;
        a.download = png.filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
      
      // Close dropdown and show success message
      document.getElementById('pngSelectionDropdown').classList.add('hidden');
      
      const successMsg = document.createElement('div');
      successMsg.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50';
      successMsg.innerHTML = `
        <div class="flex items-center gap-2">
          <span class="text-lg">âœ…</span>
          <span class="font-medium">${selectedPNGs.length} PNG file(s) downloaded successfully!</span>
        </div>
      `;
      document.body.appendChild(successMsg);
      setTimeout(() => successMsg.remove(), 3000);
    }
    
    async function generateAllPNGFiles() {
      // Show loading indicator
      const pngFilesList = document.getElementById('pngFilesList');
      pngFilesList.innerHTML = '<div class="text-center py-4"><span class="text-lg">â³</span> Generating PNG files...</div>';
      
      if (state.segments.length === 0) {
        pngFilesList.innerHTML = '<div class="text-center py-4 text-gray-500">No segments available. Please generate a preview first.</div>';
        return;
      }
      
      const htmlPreview = document.getElementById('htmlPreview');
      const generatedPNGs = [];
      
      try {
        // Generate PNG for each segment
        for (let i = 0; i < state.segments.length; i++) {
          const segment = state.segments[i];
          
          // Create a temporary container for this segment
          const tempContainer = document.createElement('div');
          tempContainer.innerHTML = createPageHTML(segment, i);
          tempContainer.style.position = 'absolute';
          tempContainer.style.left = '-9999px';
          tempContainer.style.top = '0';
          tempContainer.style.width = '800px';
          document.body.appendChild(tempContainer);
          
          // Generate PNG using html2canvas
          const canvas = await html2canvas(tempContainer, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
          });
          
          // Convert to blob
          const blob = await new Promise(resolve => {
            canvas.toBlob(resolve, 'image/png');
          });
          
          const url = URL.createObjectURL(blob);
          const filename = `${segment.category} - ${segment.product} - ${segment.density} - ${segment.color} - ${state.currency} - ${state.kg ? 'Per Kg' : 'Per Piece'}.png`;
          
          generatedPNGs.push({ filename, url, blob });
          
          // Clean up temporary container
          document.body.removeChild(tempContainer);
        }
        
        // Store the generated PNGs in state for sharing functionality
        state.lastGeneratedPNGs = generatedPNGs;
        
        // Populate the PNG files list
        populatePNGFilesList(generatedPNGs);
        
      } catch (error) {
        console.error('Error generating PNG files:', error);
        pngFilesList.innerHTML = '<div class="text-center py-4 text-red-500">Error generating PNG files. Please try again.</div>';
      }
    }

    // Direct share all prices functionality for Share Prices button
    async function shareAllPricesDirectly() {
      if (state.segments.length === 0) {
        alert('No segments available. Please generate a preview first.');
        return;
      }

      // Show loading state on button
      const shareBtn = document.getElementById('sharePricesBtn');
      const originalHTML = shareBtn.innerHTML;
      shareBtn.innerHTML = '<span>â³</span> <span>Generating...</span>';
      shareBtn.disabled = true;

      try {
        const generatedFiles = [];
        
        // Generate PNG for each segment
        for (let i = 0; i < state.segments.length; i++) {
          const segment = state.segments[i];
          
          // Create a temporary container for this segment
          const tempContainer = document.createElement('div');
          tempContainer.innerHTML = createPageHTML(segment, i);
          tempContainer.style.position = 'absolute';
          tempContainer.style.left = '-9999px';
          tempContainer.style.top = '0';
          tempContainer.style.width = '800px';
          document.body.appendChild(tempContainer);
          
          // Generate PNG using html2canvas
          const canvas = await html2canvas(tempContainer, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
          });
          
          // Convert to blob
          const blob = await new Promise(resolve => {
            canvas.toBlob(resolve, 'image/png');
          });
          
          const filename = `${segment.category} - ${segment.product} - ${segment.density} - ${segment.color} - ${state.currency} - ${state.kg ? 'Per Kg' : 'Per Piece'}.png`;
          generatedFiles.push(new File([blob], filename, { type: 'image/png' }));
          
          // Clean up temporary container
          document.body.removeChild(tempContainer);
        }
        
        // Try Web Share API first
        if (navigator.share && navigator.canShare) {
          const shareData = {
            title: 'PNG Price Lists',
            text: `Sharing ${generatedFiles.length} price list image${generatedFiles.length > 1 ? 's' : ''}`,
            files: generatedFiles
          };
          
          if (navigator.canShare(shareData)) {
            try {
              await navigator.share(shareData);
              // Show success message
              const successMsg = document.createElement('div');
              successMsg.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50 flex items-center gap-2';
              successMsg.innerHTML = `
                <span class="text-lg">âœ…</span>
                <span>Shared ${generatedFiles.length} PNG file${generatedFiles.length > 1 ? 's' : ''} successfully!</span>
              `;
              document.body.appendChild(successMsg);
              setTimeout(() => successMsg.remove(), 3000);
              return;
            } catch (error) {
              console.log('Native sharing cancelled or failed:', error);
            }
          }
        }
        
        // Fallback: Download all files
        generatedFiles.forEach(file => {
          const url = URL.createObjectURL(file);
          const downloadLink = document.createElement('a');
          downloadLink.href = url;
          downloadLink.download = file.name;
          downloadLink.style.display = 'none';
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
          URL.revokeObjectURL(url);
        });
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50 flex items-center gap-2';
        successMsg.innerHTML = `
          <span class="text-lg">âœ…</span>
          <span>Downloaded ${generatedFiles.length} PNG file${generatedFiles.length > 1 ? 's' : ''} successfully!</span>
        `;
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
        
      } catch (error) {
        console.error('Error generating/sharing PNG files:', error);
        
        // Show error message
        const errorMsg = document.createElement('div');
        errorMsg.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50 flex items-center gap-2';
        errorMsg.innerHTML = `
          <span class="text-lg">âŒ</span>
          <span>Error generating PNG files. Please try again.</span>
        `;
        document.body.appendChild(errorMsg);
        setTimeout(() => errorMsg.remove(), 4000);
      } finally {
        // Restore button state
        shareBtn.innerHTML = originalHTML;
        shareBtn.disabled = false;
      }
    }
    
    function populatePNGFilesList(pngFiles) {
      const pngFilesList = document.getElementById('pngFilesList');
      
      if (pngFiles.length === 0) {
        pngFilesList.innerHTML = '<div class="text-center py-4 text-gray-500">No PNG files generated.</div>';
        return;
      }
      
      const checkboxesHTML = pngFiles.map((png, index) => `
        <label class="flex items-start gap-3 p-3 hover:bg-blue-50 rounded-lg cursor-pointer border border-transparent hover:border-blue-200 transition-all duration-200 ${index > 0 ? 'border-t border-gray-100' : ''}">
          <input type="checkbox" 
                 id="png-checkbox-${index}"
                 data-filename="${png.filename}" 
                 data-blob="${png.url}"
                 class="png-file-checkbox w-5 h-5 text-blue-600 border-2 border-gray-300 rounded focus:ring-blue-500 focus:ring-2 mt-1 flex-shrink-0"
                 onchange="updateShareButtonState()">
          <div class="flex-1 min-w-0">
            <div class="flex items-start gap-3">
              <div class="w-16 h-12 bg-gray-100 rounded border overflow-hidden flex-shrink-0">
                <img src="${png.url}" alt="Preview" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                <div class="w-full h-full bg-gray-200 flex items-center justify-center text-gray-500 text-xs" style="display: none;">ðŸ“„</div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-sm font-medium text-gray-900 mb-1 leading-tight">
                  ${png.filename.split(' - ').slice(0, 2).join(' - ')}
                </div>
                <div class="text-xs text-gray-500 truncate" title="${png.filename}">
                  ${png.filename.split(' - ').slice(2).join(' - ')}
                </div>
              </div>
            </div>
          </div>
          <div class="flex-shrink-0 mt-1">
            <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center transition-all duration-200 radio-indicator">
              <div class="w-3 h-3 bg-blue-500 rounded-full opacity-0 scale-0 transition-all duration-200 radio-dot"></div>
            </div>
          </div>
        </label>
      `).join('');
      
      pngFilesList.innerHTML = checkboxesHTML;
      
      // Add CSS for enhanced checkbox styling
      const style = document.createElement('style');
      style.textContent = `
        .png-file-radio:checked + div .radio-indicator {
          border-color: #3b82f6;
          background-color: #3b82f6;
        }
        .png-file-radio:checked + div .radio-indicator .radio-dot {
          opacity: 1;
          scale: 1;
          background-color: white;
        }
        .png-file-radio:checked + div + div .radio-indicator {
          border-color: #3b82f6;
          background-color: #3b82f6;
        }
        .png-file-radio:checked + div + div .radio-indicator .radio-dot {
          opacity: 1;
          scale: 1;
          background-color: white;
        }
        label:has(.png-file-radio:checked) {
          background-color: #eff6ff !important;
          border-color: #3b82f6 !important;
        }
      `;
      document.head.appendChild(style);
      
      updateShareButtonState();
    }
    
    function updateShareButton() {
      const selectedCount = document.querySelectorAll('#pngFilesList input[type="checkbox"]:checked').length;
      const shareBtn = document.getElementById('shareSelectedPNGs');
      const selectAllBtn = document.getElementById('selectAllPNGs');
      
      shareBtn.disabled = selectedCount === 0;
      shareBtn.textContent = selectedCount > 0 ? `Share ${selectedCount} File${selectedCount > 1 ? 's' : ''}` : 'Share Selected';
      
      const totalCheckboxes = document.querySelectorAll('#pngFilesList input[type="checkbox"]').length;
      const allChecked = selectedCount === totalCheckboxes && totalCheckboxes > 0;
      selectAllBtn.textContent = allChecked ? 'Deselect All' : 'Select All';
    }

    // WhatsApp PDF sharing functionality

    




    </script>
      
      </div> <!-- End Price List Calculator Module -->
      
      <!-- Quote Maker Module -->
      <div id="quote-maker-module" class="module-content">
        <!-- Quote Details -->
        <section class="bg-white rounded-xl shadow-soft p-4 sm:p-6 mb-4 mobile-padding" style="background: #eef2ff;">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold text-gray-800">Quote Details</h2>
            <span class="chip no-print" id="quote-chip">Draft</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div>
              <input type="text" id="quote-number" placeholder="Quote # (INH-#####-DDMMYY-###)" class="w-full border-2 border-gray-200 rounded-lg px-3 py-1 bg-gray-50 text-gray-700" />
            </div>
            <div>
              <input type="date" id="quote-date" placeholder="Date" class="w-full border-2 border-gray-300 rounded-lg px-3 py-1 focus:border-blue-500 focus:outline-none" />
            </div>
            <div>
              <input type="text" id="client-name" placeholder="Client Name" class="w-full border-2 border-gray-300 rounded-lg px-3 py-1 focus:border-blue-500 focus:outline-none" />
            </div>
            <div>
              <input type="text" id="client-contact" placeholder="Client Contact" class="w-full border-2 border-gray-300 rounded-lg px-3 py-1 focus:border-blue-500 focus:outline-none" />
            </div>
            <div>
              <select id="salesman-name" class="w-full border-2 border-gray-300 rounded-lg px-3 py-1 focus:border-blue-500 focus:outline-none bg-white">
                <option value="">Select Sales Representative</option>
              </select>
            </div>
            <div>
              <input type="number" id="valid-days" value="14" placeholder="Valid for (days)" class="w-full border-2 border-gray-300 rounded-lg px-3 py-1 focus:border-blue-500 focus:outline-none" />
            </div>
            <div class="md:col-span-2">
              <textarea id="brief-preview" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" rows="2" placeholder="Brief Preview (e.g., Clip-on set, 18â€“22 inch mix, 200g total)"></textarea>
            </div>
          </div>
        </section>

        <!-- Currency and Price List Controls -->
        <section class="bg-white rounded-xl shadow-soft p-4 sm:p-6 mb-4 mobile-padding" style="background: #f8fafc;">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <select id="quote-currency" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                <option value="INR" selected>INR (â‚¹) - Indian Rupee</option>
                <option value="USD">USD ($) - US Dollar</option>
                <option value="EUR">EUR (â‚¬) - Euro</option>
                <option value="GBP">GBP (Â£) - British Pound</option>
                <option value="AUD">AUD (A$) - Australian Dollar</option>
                <option value="SAR">SAR - Saudi Riyal</option>
                <option value="NGN">NGN (â‚¦) - Nigerian Naira</option>
                <option value="AED">AED (Ø¯.Ø¥) - UAE Dirham</option>
                <option value="JPY">JPY (Â¥) - Japanese Yen</option>
              </select>
            </div>
            <div>
              <select id="quote-price-list-selector" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
              </select>
            </div>
          </div>
        </section>

        <!-- Catalog -->
        <section class="bg-white rounded-xl shadow-soft p-4 sm:p-6 mb-4 mobile-padding" style="background: #ecfeff;">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <div>
              <select id="new-item-category" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                <option value="">Select Category</option>
              </select>
            </div>
            <div>
              <select id="new-item-product" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" disabled>
                <option value="">Select Product</option>
              </select>
            </div>
            <div>
              <select id="new-item-density" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" disabled>
                <option value="">Select Density</option>
              </select>
            </div>
            <div>
              <select id="new-item-length" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                <option value="">Select Length</option>
              </select>
            </div>
            <div>
              <select id="new-item-color" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                <option value="">Select Color</option>
              </select>
            </div>
            <div>
              <input type="text" id="new-item-color-detail" placeholder="Color Detail" class="w-full border-2 border-gray-300 rounded-lg px-3 py-1 focus:border-blue-500 focus:outline-none" />
            </div>
            <div>
              <input type="text" id="new-item-styles" placeholder="Styles" class="w-full border-2 border-gray-300 rounded-lg px-3 py-1 focus:border-blue-500 focus:outline-none" />
            </div>
            <div>
              <input type="number" id="new-item-quantity" value="1" min="0.01" step="0.01" placeholder="Quantity" class="w-full border-2 border-gray-300 rounded-lg px-3 py-1 focus:border-blue-500 focus:outline-none" />
            </div>
            <div>
              <input type="number" id="new-item-override-price" placeholder="Override Unit Price (Optional)" class="w-full border-2 border-gray-300 rounded-lg px-3 py-1 focus:border-blue-500 focus:outline-none" />
            </div>
          </div>
          
          <!-- Dynamic Rate Display -->
          <div id="dynamic-rate-display" class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-4 mt-3 mb-3 hidden">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-2">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                </svg>
                <span class="text-sm font-medium text-blue-800">Calculated Rate:</span>
              </div>
              <div class="text-right">
                <div id="rate-amount" class="text-lg font-bold text-blue-900">â‚¹0.00</div>
                <div id="rate-details" class="text-xs text-blue-600">per unit</div>
              </div>
            </div>
            <div id="rate-breakdown" class="mt-2 text-xs text-blue-700 hidden">
              <div class="grid grid-cols-2 gap-2">
                <span>Base Rate:</span><span id="base-rate-value">â‚¹0.00</span>
                <span>Currency:</span><span id="currency-rate-value">INR</span>
              </div>
            </div>
          </div>
          
          <div class="flex items-center gap-2 mt-2">
            <button id="add-item-btn" class="btn-primary px-3 py-1 rounded-lg">Add Item</button>
            <span class="text-xs text-gray-600">Override converts back to INR using current FX.</span>
          </div>
        </section>

        <!-- Financial Controls -->
        <section class="bg-white rounded-xl shadow-soft p-2 mb-2 mobile-padding" style="background: #f0f9ff;">
          
          <!-- Discount Controls -->
          <div class="grid grid-cols-1 gap-2 mb-2">
            <div>
              <input type="text" id="discount-input" placeholder="Discount (e.g., 10% or 50)" class="w-full border-2 border-gray-300 rounded-lg px-2 py-1 focus:border-blue-500 focus:outline-none" />
            </div>
          </div>
          
          <!-- Tax Controls -->
          <div class="grid grid-cols-1 gap-2 mb-2">
            <div>
              <input type="text" id="tax-input" placeholder="Tax (e.g., 10%)" class="w-full border-2 border-gray-300 rounded-lg px-2 py-1 focus:border-blue-500 focus:outline-none" />
            </div>
          </div>
          
          <!-- Shipping Controls -->
          <div class="grid grid-cols-1 gap-2">
            <div>
              <input type="text" id="shipping-input" placeholder="Shipping (e.g., 25 or 0 for free)" class="w-full border-2 border-gray-300 rounded-lg px-2 py-1 focus:border-blue-500 focus:outline-none" />
            </div>
          </div>
        </section>

        <!-- Items Table -->
        <section class="bg-white rounded-xl shadow-soft p-2 mb-2 mobile-padding">
          <h2 class="text-lg font-semibold text-gray-800 mb-3">Items</h2>
          <div class="table-container table-responsive overflow-x-auto bg-white rounded-lg border border-gray-200">
            <table id="items-table" class="w-full border-collapse min-w-full">
              <thead>
                <tr class="bg-gradient-to-r from-gray-50 via-gray-100 to-gray-150 border-b-2 border-gray-300">
                  <th class="px-4 py-2 text-center text-xs font-bold text-gray-800 uppercase tracking-wider border-r border-gray-300">
                    <div class="flex items-center justify-center">
                      <span class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 font-bold text-xs">#</span>
                    </div>
                  </th>
                  <th class="px-4 py-2 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-r border-gray-300 bg-gray-100">
                    <div class="flex items-center space-x-2">
                      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                      </svg>
                      <span>Product Details</span>
                    </div>
                  </th>
                  <th class="px-4 py-2 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-r border-gray-300">
                    <div class="flex items-center space-x-1">
                      <span>Variant</span>
                      <span class="sort-indicator ml-1 text-gray-500 cursor-pointer hover:text-gray-700">â†•</span>
                    </div>
                  </th>
                  <th class="px-4 py-2 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-r border-gray-300">
                    <div class="flex items-center space-x-1">
                      <span>Length</span>
                      <span class="sort-indicator ml-1 text-gray-500 cursor-pointer hover:text-gray-700">â†•</span>
                    </div>
                  </th>
                  <th class="px-4 py-2 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-r border-gray-300">
                    <span>Color</span>
                  </th>
                  <th class="px-4 py-2 text-left text-xs font-bold text-gray-800 uppercase tracking-wider border-r border-gray-300">
                    <span>Styles</span>
                  </th>
                  <th class="px-4 py-2 text-center text-xs font-bold text-gray-800 uppercase tracking-wider border-r border-gray-300 bg-gray-100">
                    <div class="flex items-center justify-center space-x-1">
                      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                      </svg>
                      <span>Qty</span>
                    </div>
                  </th>
                  <th class="px-4 py-2 text-right text-xs font-bold text-gray-800 uppercase tracking-wider border-r border-gray-300 bg-gray-100">
                    <div class="flex items-center justify-end space-x-1">
                      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                      </svg>
                      <span>Unit Price</span>
                    </div>
                  </th>
                  <th class="px-4 py-2 text-right text-xs font-bold text-gray-800 uppercase tracking-wider border-r border-gray-300 bg-gray-100">
                    <div class="flex items-center justify-end space-x-1">
                      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                      </svg>
                      <span>Line Total</span>
                    </div>
                  </th>
                  <th class="px-4 py-2 text-center text-xs font-bold text-gray-800 uppercase tracking-wider no-print">
                    <div class="flex items-center justify-center">
                      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200"></tbody>
              <tfoot class="bg-gradient-to-r from-gray-50 to-gray-100 border-t-2 border-gray-300">
                <tr class="border-b border-gray-200 bg-gradient-to-r from-gray-100 to-gray-150 hover:from-gray-150 hover:to-gray-200 transition-all duration-200">
                  <td colspan="8" class="font-semibold px-4 py-3 text-sm text-gray-800">
                    <div class="flex items-center space-x-2">
                      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16l3-1m-3 1l-3-1"></path>
                      </svg>
                      <span>Total Weight</span>
                    </div>
                  </td>
                  <td id="grand-weight" class="px-4 py-3 text-sm font-bold text-gray-900 text-right bg-gray-200 rounded-l-lg">â€”</td>
                  <td class="no-print"></td>
                </tr>
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-all duration-200">
                  <td colspan="8" class="font-semibold px-4 py-3 text-sm text-gray-800">
                    <div class="flex items-center space-x-2">
                      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                      </svg>
                      <span>Subtotal</span>
                    </div>
                  </td>
                  <td id="subtotal" class="px-4 py-3 text-sm font-medium text-gray-900 text-right">â€”</td>
                  <td class="no-print"></td>
                </tr>
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-all duration-200">
                  <td colspan="8" class="font-semibold px-4 py-3 text-sm text-gray-800">
                    <div class="flex items-center space-x-2">
                      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                      </svg>
                      <span>Discount</span>
                    </div>
                  </td>
                  <td id="discount" class="px-4 py-3 text-sm font-medium text-gray-900 text-right">â€”</td>
                  <td class="no-print"></td>
                </tr>
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-all duration-200">
                  <td colspan="8" class="font-semibold px-4 py-3 text-sm text-gray-800">
                    <div class="flex items-center space-x-2">
                      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                      </svg>
                      <span>Tax</span>
                    </div>
                  </td>
                  <td id="tax" class="px-4 py-3 text-sm font-medium text-gray-900 text-right">â€”</td>
                  <td class="no-print"></td>
                </tr>
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-all duration-200">
                  <td colspan="8" class="font-semibold px-4 py-3 text-sm text-gray-800">
                    <div class="flex items-center space-x-2">
                      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                      </svg>
                      <span>Shipping</span>
                    </div>
                  </td>
                  <td id="shipping-total" class="px-4 py-3 text-sm font-medium text-gray-900 text-right">â€”</td>
                  <td class="no-print"></td>
                </tr>
                <tr class="border-t-2 border-gray-400 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 transition-all duration-200">
                  <td colspan="8" class="font-bold px-4 py-4 text-base text-gray-900">
                    <div class="flex items-center space-x-2">
                      <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                      </svg>
                      <span>Grand Total</span>
                    </div>
                  </td>
                  <td id="grand-total-table" class="px-4 py-4 text-base font-bold text-gray-900 text-right bg-gray-300 rounded-l-lg border-l-4 border-gray-600">â€”</td>
                  <td class="no-print"></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <textarea id="notes-terms" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" rows="3" placeholder="Notes / Terms (Payment terms, lead time, shipping details, etc.)"></textarea>
          
          <!-- Quote Actions positioned at bottom-left -->
          <div class="flex gap-2 flex-wrap mt-3">
            <div class="relative">
              <button onclick="toggleSaveQuoteMenu()" class="btn-primary px-4 py-1 rounded-lg flex items-center gap-2">
                Save Quote
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <!-- Floating Save Quote Menu -->
              <div id="saveQuoteMenu" class="absolute bottom-full left-0 mb-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden">
                <div class="py-2">
                  <button onclick="saveQuote()" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2">
                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Save Quote
                  </button>
                  <button onclick="deleteQuote()" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-red-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Delete
                  </button>
                  <button onclick="convertToOrder()" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-blue-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Convert to Order
                  </button>
                  <button onclick="shareQuote()" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-purple-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                    </svg>
                    Share
                  </button>
                </div>
              </div>
            </div>
            <button id="clear-quote-btn" class="btn-secondary px-4 py-1 rounded-lg">Clear</button>
          </div>
        </section>



        <!-- Saved Quotes List -->
        <section class="bg-white rounded-lg shadow-soft p-2 sm:p-3 mb-3 mobile-padding">
          <h2 class="text-sm font-semibold text-gray-800 mb-2">Saved Quotes</h2>
          <div id="saved-quotes-container" class="saved-quotes-container">
            <div id="no-quotes-message" class="no-quotes-message">
              No saved quotes yet. Save a quote to see it here.
            </div>
          </div>
        </section>


      </div>
      
      <!-- Product Catalog Module -->
      <div id="product-catalog-module" class="module-content">
        <!-- Enhanced Catalog Header -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 mb-6 text-white">
          <p class="text-blue-100">Discover our premium hair extension collection</p>
        </div>
        
        <!-- Modern Catalog Filters -->
        <section class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 mb-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
              <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
              </svg>
              Filters
            </h3>
            <div class="text-sm text-gray-500">
              <span id="catalog-results-count">Loading products...</span>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- Category Filter -->
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700 flex items-center">
                <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                Category
              </label>
              <select id="catalog-category" class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition-all duration-200 bg-gray-50 hover:bg-white">
                <option value="">All Categories</option>
              </select>
            </div>
            
            <!-- Search Filter -->
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700 flex items-center">
                <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Search
              </label>
              <div class="relative">
                <input type="text" id="catalog-search" placeholder="Search products by name..." class="w-full border-2 border-gray-200 rounded-lg px-4 py-1 pl-10 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition-all duration-200 bg-gray-50 hover:bg-white" />
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </div>
            </div>
          </div>
          
          <div class="flex flex-wrap gap-3">
            <button id="catalog-filter-btn" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium px-6 py-3 rounded-lg transition-all duration-200 flex items-center shadow-md hover:shadow-lg">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
              </svg>
              Apply Filters
            </button>
            <button id="catalog-clear-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium px-6 py-3 rounded-lg transition-all duration-200 flex items-center border border-gray-300">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              Clear All
            </button>
          </div>
        </section>

        <!-- Enhanced Product Grid -->
        <section class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
              <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
              </svg>
              Our Products
            </h3>
            <div class="flex items-center space-x-4">
              <div class="text-sm text-gray-500 bg-gray-50 px-3 py-1 rounded-full">
                <span id="catalog-results-count-display">Loading...</span>
              </div>
              <div class="flex items-center space-x-2">
                <button id="grid-view-btn" class="p-2 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200 transition-colors" title="Grid View">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                  </svg>
                </button>
                <button id="list-view-btn" class="p-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors" title="List View">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Loading State -->
          <div id="catalog-loading" class="hidden flex items-center justify-center py-12">
            <div class="text-center">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p class="text-gray-600">Loading products...</p>
            </div>
          </div>
          
          <!-- Empty State -->
          <div id="catalog-empty" class="hidden text-center py-12">
            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
            <p class="text-gray-500 mb-4">Try adjusting your search criteria or browse all categories.</p>
            <button onclick="clearCatalogFilters()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
              View All Products
            </button>
          </div>
          
          <!-- Product Cards Container -->
          <div id="catalog-products-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4 sm:gap-6">
            <!-- Products will be dynamically loaded here -->
          </div>
          
          <!-- Pagination -->
          <div id="catalog-pagination" class="flex justify-center mt-6">
            <!-- Pagination controls will be added here -->
          </div>
        </section>
      </div>
      
      <!-- Admin Panel Module -->
      <div id="admin-panel-module" class="module-content">
        <div class="bg-white rounded-xl shadow-soft p-4 sm:p-6 mobile-padding">
          <h2 class="text-xl font-semibold mb-4 text-gray-800">Admin Panel</h2>
          
          <!-- Admin Functions Grid -->
          <div class="grid grid-cols-1 gap-4 mb-6">
            <!-- Excel Data Management -->
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-4 hover:shadow-md transition-all duration-200">
              <div class="text-3xl mb-3">ðŸ“Š</div>
              <h3 class="text-lg font-semibold text-gray-800 mb-2">Data Management</h3>
              <p class="text-sm text-gray-600 mb-4">Load and manage Excel data, update product catalogs</p>
              <button onclick="openAdminPanel()" class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all duration-200 hover:transform hover:scale-105">
                Open Data Manager
              </button>
            </div>
            

          </div>
          

        </div>
      </div>
      
    </div> <!-- End Module Container -->

  <!-- Admin Panel Modal -->
  <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300">
    <div class="bg-white rounded-lg p-4 sm:p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95 opacity-0">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Admin Panel</h3>
        <button id="closeAdmin" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 p-1 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="space-y-4">
        <div class="border rounded-lg p-4">
          <h4 class="font-medium text-gray-700 mb-2">Excel Data Loader</h4>
          <p class="text-sm text-gray-600 mb-3">Load and embed Excel data directly into the application</p>
          <button id="convertExcel" class="w-full px-4 py-3 sm:py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all duration-200 hover:transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-300 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed min-h-[44px] touch-manipulation">
            <span class="convert-text">ðŸ“ Load Excel Data</span>
            <span class="convert-loading hidden">â³ Loading...</span>
          </button>
        </div>
        

        
        <div class="border rounded-lg p-4">
          <h4 class="font-medium text-gray-700 mb-2">Database Status</h4>
          <div id="dbStatus" class="text-sm text-gray-600">
            <div>Current records: <span id="recordCount">Loading...</span></div>
            <div>Sales representatives: <span id="salesRepCount">Loading...</span></div>
            <div>Last updated: <span id="lastUpdated">Loading...</span></div>
          </div>
        </div>
        
        <div id="adminMessages" class="hidden">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <div id="adminMessageText" class="text-sm text-blue-800"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Admin Panel Functionality
    let availablePriceLists = new Set();
    
    // Initialize admin panel
    function initAdminPanel() {
      const adminModal = document.getElementById('adminModal');
      const closeAdmin = document.getElementById('closeAdmin');
      const convertExcel = document.getElementById('convertExcel');
      
      // Function to open admin panel with animation
      window.openAdminPanel = async () => {
        adminModal.classList.remove('hidden');
        // Trigger animation
        setTimeout(() => {
          const modalContent = adminModal.querySelector('div > div');
          modalContent.classList.remove('scale-95', 'opacity-0');
          modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        await updateAdminStatus();
      };
      
      // Close admin panel with animation
      closeAdmin.addEventListener('click', () => {
        const modalContent = adminModal.querySelector('div > div');
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
          adminModal.classList.add('hidden');
        }, 300);
      });
      
      // Close on backdrop click with animation
      adminModal.addEventListener('click', (e) => {
        if (e.target === adminModal) {
          const modalContent = adminModal.querySelector('div > div');
          modalContent.classList.remove('scale-100', 'opacity-100');
          modalContent.classList.add('scale-95', 'opacity-0');
          setTimeout(() => {
            adminModal.classList.add('hidden');
          }, 300);
        }
      });
      
      // Convert Excel functionality
      convertExcel.addEventListener('click', handleExcelConversion);
      
      // Remove INR25 functionality

    }
    
    // Update admin status display with validation
    async function updateAdminStatus() {
      const recordCount = document.getElementById('recordCount');
      const salesRepCount = document.getElementById('salesRepCount');
      const lastUpdated = document.getElementById('lastUpdated');
      
      // Validate current data
      const validation = validateProductData(state.allProducts);
      
      recordCount.innerHTML = `
        <div>${validation.stats.totalProducts} total</div>
        <div class="text-xs ${validation.isValid ? 'text-green-600' : 'text-red-600'}">
          ${validation.stats.validProducts} valid
          ${validation.errors.length > 0 ? ` â€¢ ${validation.errors.length} errors` : ''}
          ${validation.warnings.length > 0 ? ` â€¢ ${validation.warnings.length} warnings` : ''}
        </div>
        <div class="text-xs text-gray-500">
          ${validation.stats.categories.size} categories â€¢ ${validation.stats.priceLists.size} price lists
        </div>
      `;
      
      // Get sales representatives count
      try {
        const response = await fetch('/data.json');
        const data = await response.json();
        const salesmenCount = data.salesmen ? data.salesmen.length : 0;
        salesRepCount.innerHTML = `
          <div>${salesmenCount} active</div>
          <div class="text-xs text-gray-500">personnel</div>
        `;
      } catch (error) {
        console.error('Error fetching salesmen data:', error);
        salesRepCount.innerHTML = `
          <div>0 active</div>
          <div class="text-xs text-red-500">error loading</div>
        `;
      }
      
      lastUpdated.textContent = new Date().toLocaleString();
      
      // Show validation summary if there are issues
      if (!validation.isValid || validation.warnings.length > 0) {
        const issues = [...validation.errors, ...validation.warnings.slice(0, 3)];
        if (validation.warnings.length > 3) {
          issues.push(`... and ${validation.warnings.length - 3} more warnings`);
        }
        showAdminMessage(`Data validation: ${issues.join('; ')}`, validation.isValid ? 'warning' : 'error');
      }
    }
    
    // Enhanced Excel to JSON conversion with better error handling
    async function handleExcelConversion() {
      const convertBtn = document.getElementById('convertExcel');
      const originalText = convertBtn.innerHTML;
      
      try {
        // Validate button exists
        if (!convertBtn) {
          throw new Error('Convert button not found');
        }
        
        convertBtn.innerHTML = 'â³ Converting...';
        convertBtn.disabled = true;
        
        showAdminMessage('Starting Excel conversion process...', 'info');
        
        // Create file input for Excel file selection
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.xlsx,.xls';
        fileInput.multiple = true;
        
        // Promise to handle file selection
        const fileSelectionPromise = new Promise((resolve, reject) => {
          fileInput.onchange = (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) {
              reject(new Error('No files selected'));
              return;
            }
            resolve(files);
          };
          
          fileInput.oncancel = () => {
            reject(new Error('File selection cancelled'));
          };
        });
        
        // Trigger file selection
        fileInput.click();
        
        // Wait for file selection
        const selectedFiles = await fileSelectionPromise;
        
        showAdminMessage(`Processing ${selectedFiles.length} Excel file(s)...`, 'info');
        
        let allProcessedData = [];
        let processedPriceLists = new Set();
        
        // Process each selected Excel file with enhanced validation
        for (const file of selectedFiles) {
          try {
            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
              throw new Error(`File too large: ${(file.size / 1024 / 1024).toFixed(1)}MB (max 10MB)`);
            }
            
            // Validate file type
            const validTypes = ['.xlsx', '.xls'];
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            if (!validTypes.includes(fileExtension)) {
              throw new Error(`Invalid file type: ${fileExtension}. Only .xlsx and .xls files are supported.`);
            }
            
            showAdminMessage(`Processing ${file.name} (${(file.size / 1024).toFixed(1)}KB)...`, 'info');
            
            const data = await parseExcelFile(file);
            
            // Validate parsed data
            if (!data || !data.products || !Array.isArray(data.products)) {
              throw new Error('Invalid data structure returned from Excel parser');
            }
            
            if (data.products.length === 0) {
              showAdminMessage(`âš ï¸ No valid products found in ${file.name}`, 'warning');
              continue;
            }
            
            // Validate each product before adding
            const validProducts = data.products.filter(product => {
              return product && typeof product === 'object' && 
                     product.Category && product.Product && product.Rate;
            });
            
            if (validProducts.length !== data.products.length) {
              showAdminMessage(`âš ï¸ ${file.name}: ${data.products.length - validProducts.length} invalid products filtered out`, 'warning');
            }
            
            allProcessedData = allProcessedData.concat(validProducts);
            
            // Extract price list names from the PriceList field in products
            validProducts.forEach(product => {
              if (product.PriceList && product.PriceList.trim()) {
                processedPriceLists.add(product.PriceList.trim());
              }
            });
            
            showAdminMessage(`âœ… Processed ${file.name}: ${validProducts.length} valid products`, 'info');
            
          } catch (fileError) {
            console.error(`Error processing ${file.name}:`, fileError);
            showAdminMessage(`âŒ Error processing ${file.name}: ${fileError.message}`, 'error');
            // Continue processing other files even if one fails
          }
        }
        
        if (allProcessedData.length > 0) {
          // Validate processed data before proceeding
          const validation = validateProductData(allProcessedData);
          
          if (!validation.isValid) {
            showAdminMessage(`âŒ Data validation failed: ${validation.errors.slice(0, 3).join('; ')}`, 'error');
            if (validation.errors.length > 3) {
              console.error('Additional validation errors:', validation.errors.slice(3));
            }
            return;
          }
          
          if (validation.warnings.length > 0) {
            showAdminMessage(`âš ï¸ Data warnings: ${validation.warnings.slice(0, 2).join('; ')}`, 'warning');
            if (validation.warnings.length > 2) {
              console.warn('Additional validation warnings:', validation.warnings.slice(2));
            }
          }
          
          // Generate and save JSON with duplicate removal
          const cleanedData = await generateAndSaveJSON(allProcessedData, Array.from(processedPriceLists));
          
          // Validate cleaned data
          if (!cleanedData || cleanedData.length === 0) {
            throw new Error('No data remained after cleaning and validation');
          }
          
          // Update the application data with cleaned data
          state.allProducts = cleanedData;
          state.filteredProducts = [...cleanedData];
          productData = cleanedData;
          
          // Update embedded data in HTML with cleaned data
          updateEmbeddedData(cleanedData);
          
          // Update price lists
          processedPriceLists.forEach(pl => availablePriceLists.add(pl));
          updatePriceListDropdown();
          
          // Refresh the UI
          populateCategories();
          
          const successMessage = `âœ… Conversion completed! Processed ${cleanedData.length} unique records from ${selectedFiles.length} file(s). Added ${processedPriceLists.size} new price list(s). JSON generated and embedded in HTML.`;
          showAdminMessage(successMessage, 'success');
          await updateAdminStatus();
          
        } else {
          showAdminMessage('âŒ No valid data found in the selected files. Please check file format and content.', 'error');
        }
        
      } catch (error) {
        console.error('Excel conversion error:', error);
        
        // Categorize different types of errors
        if (error.message === 'File selection cancelled' || error.message === 'No files selected') {
          showAdminMessage('File selection cancelled.', 'info');
        } else if (error.name === 'TypeError' || error.message.includes('Cannot read property')) {
          showAdminMessage(`âŒ Data structure error: ${error.message}. Please check file format.`, 'error');
        } else if (error.message.includes('File too large') || error.message.includes('Invalid file type')) {
          showAdminMessage(`âŒ File validation error: ${error.message}`, 'error');
        } else if (error.message.includes('Failed to parse')) {
          showAdminMessage(`âŒ Excel parsing error: ${error.message}. Please ensure the file is not corrupted.`, 'error');
        } else {
          showAdminMessage(`âŒ Unexpected error during conversion: ${error.message}`, 'error');
        }
        
        // Log full error details for debugging
        console.error('Full error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        
      } finally {
        // Ensure button is always restored
        try {
          if (convertBtn) {
            convertBtn.innerHTML = originalText;
            convertBtn.disabled = false;
          }
        } catch (restoreError) {
          console.error('Error restoring button state:', restoreError);
        }
      }
    }
    
    // Parse Excel file using SheetJS
    async function parseExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // Get the first worksheet
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // Convert to JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (jsonData.length < 2) {
              reject(new Error('Excel file must contain at least a header row and one data row'));
              return;
            }
            
            // Parse the data
            const headers = jsonData[0];
            const products = [];
            
            // Map common header variations to standard field names
            const headerMap = {
              'category': ['category', 'catagory', 'cat', 'type'],
              'product': ['product', 'prod', 'name', 'product name'],
              'density': ['density', 'dens', 'thickness'],
              'colors': ['colors', 'color', 'colour', 'colours'],
              'length': ['length', 'len', 'size'],
              'rate': ['rate', 'price', 'cost', 'amount'],
              'canBeSoldInKG': ['can be sold in kg?', 'kg', 'kilogram', 'can be sold in kg'],
              'standardWeight': ['standard weight', 'weight', 'std weight', 'wt'],
              'priceListName': ['price list name', 'pricelist name', 'pricelistname', 'price list', 'pricelist']
            };
            
            // Find column indices for each field
            const columnIndices = {};
            Object.keys(headerMap).forEach(field => {
              const variations = headerMap[field];
              for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || '').toString().toLowerCase().trim();
                if (variations.includes(header)) {
                  columnIndices[field] = i;
                  break;
                }
              }
            });
            
            // Process data rows
            for (let i = 1; i < jsonData.length; i++) {
              const row = jsonData[i];
              if (!row || row.length === 0) continue;
              
              const product = {
                Category: row[columnIndices.category] || '',
                Product: row[columnIndices.product] || '',
                Density: row[columnIndices.density] || '',
                Colors: row[columnIndices.colors] || '',
                Length: row[columnIndices.length] || '',
                Rate: row[columnIndices.rate] || '',
                'Can Be Sold in KG?': row[columnIndices.canBeSoldInKG] || '',
                'Standard Weight': row[columnIndices.standardWeight] || '',
                PriceList: row[columnIndices.priceListName] || ''
              };
              
              // Only add products with required fields
              if (product.Category && product.Product && product.Rate) {
                products.push(product);
              }
            }
            
            resolve({
              products: products,
              totalRows: jsonData.length - 1,
              headers: headers
            });
            
          } catch (parseError) {
            reject(new Error(`Failed to parse Excel file: ${parseError.message}`));
          }
        };
        
        reader.onerror = () => {
          reject(new Error('Failed to read the Excel file'));
        };
        
        reader.readAsArrayBuffer(file);
      });
    }
    
    // Enhanced admin message system with error logging
    function showAdminMessage(message, type = 'info', persistent = false) {
      try {
        const messagesDiv = document.getElementById('adminMessages');
        const messageText = document.getElementById('adminMessageText');
        
        if (!messagesDiv || !messageText) {
          console.error('Admin message elements not found');
          // Fallback to console and alert
          console.log(`[${type.toUpperCase()}] ${message}`);
          if (type === 'error') {
            alert(`Error: ${message}`);
          }
          return;
        }
        
        messagesDiv.classList.remove('hidden');
        messageText.textContent = message;
        
        // Log to console for debugging
        console.log(`[ADMIN ${type.toUpperCase()}] ${message}`);
        
        // Update styling based on type
        messagesDiv.className = 'border rounded-lg p-3';
        if (type === 'success') {
          messagesDiv.className += ' bg-green-50 border-green-200';
          messageText.className = 'text-sm text-green-800';
        } else if (type === 'error') {
          messagesDiv.className += ' bg-red-50 border-red-200';
          messageText.className = 'text-sm text-red-800';
          // Log errors to console for debugging
          console.error('Admin Error:', message);
        } else if (type === 'warning') {
          messagesDiv.className += ' bg-yellow-50 border-yellow-200';
          messageText.className = 'text-sm text-yellow-800';
          console.warn('Admin Warning:', message);
        } else {
          messagesDiv.className += ' bg-blue-50 border-blue-200';
          messageText.className = 'text-sm text-blue-800';
        }
        
        // Clear any existing timeout
        if (window.adminMessageTimeout) {
          clearTimeout(window.adminMessageTimeout);
        }
        
        // Auto-hide after specified time (longer for errors, persistent for critical messages)
        if (!persistent) {
          const hideDelay = type === 'error' ? 8000 : type === 'warning' ? 6000 : 5000;
          window.adminMessageTimeout = setTimeout(() => {
            if (messagesDiv) {
              messagesDiv.classList.add('hidden');
            }
          }, hideDelay);
        }
        
      } catch (error) {
        console.error('Error showing admin message:', error);
        // Ultimate fallback
        alert(`${type.toUpperCase()}: ${message}`);
      }
    }
    
    // Enhanced INR25 product removal with validation and loading states

    
    // Enhanced data integrity validation
    function validateProductData(products) {
      const validationResults = {
        isValid: true,
        errors: [],
        warnings: [],
        stats: {
          totalProducts: products.length,
          validProducts: 0,
          categories: new Set(),
          priceLists: new Set()
        }
      };
      
      if (!Array.isArray(products)) {
        validationResults.errors.push('Product data is not an array');
        validationResults.isValid = false;
        return validationResults;
      }
      
      if (products.length === 0) {
        validationResults.warnings.push('No products found in dataset');
        return validationResults;
      }
      
      const requiredFields = ['Category', 'Product', 'Rate'];
      const numericFields = ['Rate', 'Length'];
      const validCategories = new Set();
      const validPriceLists = new Set();
      
      products.forEach((product, index) => {
        let isProductValid = true;
        
        // Check if product is an object
        if (!product || typeof product !== 'object') {
          validationResults.errors.push(`Row ${index + 1}: Invalid product data structure`);
          return;
        }
        
        // Check required fields
        requiredFields.forEach(field => {
          if (!product[field] || product[field].toString().trim() === '') {
            validationResults.errors.push(`Row ${index + 1}: Missing required field '${field}'`);
            isProductValid = false;
          }
        });
        
        // Validate numeric fields
        numericFields.forEach(field => {
          if (product[field] && product[field] !== '') {
            const numValue = parseFloat(product[field]);
            if (isNaN(numValue)) {
              validationResults.warnings.push(`Row ${index + 1}: Field '${field}' value '${product[field]}' is not a valid number`);
            } else if (field === 'Rate' && numValue <= 0) {
              validationResults.warnings.push(`Row ${index + 1}: Rate must be greater than 0, found: ${numValue}`);
            } else if (field === 'Length' && numValue <= 0) {
              validationResults.warnings.push(`Row ${index + 1}: Length must be greater than 0, found: ${numValue}`);
            }
          }
        });
        
        // Validate category format
        if (product.Category) {
          const category = product.Category.toString().trim();
          if (category.length > 50) {
            validationResults.warnings.push(`Row ${index + 1}: Category name too long (${category.length} chars)`);
          }
          validCategories.add(category);
          validationResults.stats.categories.add(category);
        }
        
        // Validate product name
        if (product.Product) {
          const productName = product.Product.toString().trim();
          if (productName.length > 100) {
            validationResults.warnings.push(`Row ${index + 1}: Product name too long (${productName.length} chars)`);
          }
        }
        
        // Validate price list
        if (product.PriceList) {
          const priceList = product.PriceList.toString().trim();
          if (priceList.length > 20) {
            validationResults.warnings.push(`Row ${index + 1}: Price list name too long (${priceList.length} chars)`);
          }
          validPriceLists.add(priceList);
          validationResults.stats.priceLists.add(priceList);
        }
        
        // Validate KG field
        if (product['Can Be Sold in KG?']) {
          const kgValue = product['Can Be Sold in KG?'].toString().toLowerCase();
          if (!['y', 'n', 'yes', 'no', 'true', 'false'].includes(kgValue)) {
            validationResults.warnings.push(`Row ${index + 1}: Invalid 'Can Be Sold in KG?' value: ${product['Can Be Sold in KG?']}`);
          }
        }
        
        if (isProductValid) {
          validationResults.stats.validProducts++;
        }
      });
      
      // Check for duplicate products with enhanced key
      const productKeys = new Set();
      const duplicateGroups = new Map();
      
      products.forEach((product, index) => {
        const key = `${product.Category || ''}-${product.Product || ''}-${product.Density || ''}-${product.Colors || ''}-${product.Length || ''}-${product.PriceList || ''}`;
        
        if (productKeys.has(key)) {
          if (!duplicateGroups.has(key)) {
            duplicateGroups.set(key, []);
          }
          duplicateGroups.get(key).push(index + 1);
        }
        productKeys.add(key);
      });
      
      // Report duplicates
      duplicateGroups.forEach((rows, key) => {
        validationResults.warnings.push(`Duplicate products found in rows: ${rows.join(', ')} (${key.split('-').slice(0, 3).join(' - ')})`);
      });
      
      // Additional validation checks
      if (validCategories.size === 0) {
        validationResults.errors.push('No valid categories found');
      }
      
      if (validCategories.size > 50) {
        validationResults.warnings.push(`Large number of categories detected: ${validCategories.size}`);
      }
      
      if (validPriceLists.size > 20) {
        validationResults.warnings.push(`Large number of price lists detected: ${validPriceLists.size}`);
      }
      
      validationResults.isValid = validationResults.errors.length === 0;
      return validationResults;
    }
    
    // Initialize price list dropdown
    function initPriceListDropdown() {
      console.log('Initializing price list dropdown...');
      console.log('state.allProducts length:', state.allProducts.length);
      
      // Clear existing price lists to ensure fresh data
      availablePriceLists.clear();
      
      // Extract unique price lists from existing data
      state.allProducts.forEach(product => {
        if (product.PriceList) {
          availablePriceLists.add(product.PriceList);
        }
      });
      
      console.log('Available price lists:', Array.from(availablePriceLists));
      
      updatePriceListDropdown();
      
      // Do not show products until a price list is selected
      if (state.filteredProducts.length === 0 && state.allProducts.length > 0) {
        console.log('No price list selected - products will be empty until price list is chosen');
      }
      
      // Add event listener for price list selection
      const priceListSelector = document.getElementById('priceListSelector');
      if (priceListSelector) {
        priceListSelector.addEventListener('change', handlePriceListChange);
      } else {
        console.error('Price list selector element not found!');
      }
    }
    
    // Initialize price calculator salesman dropdown
    function initPriceCalculatorSalesmanDropdown() {
      console.log('Initializing price calculator salesman dropdown...');
      
      const salesmanSelector = document.getElementById('price-calculator-salesman');
      if (!salesmanSelector) {
        console.error('Price calculator salesman selector not found!');
        return;
      }
      
      console.log('Found salesman selector:', salesmanSelector);
      console.log('Salesman selector parent:', salesmanSelector.parentElement);
      console.log('Salesman selector visible:', window.getComputedStyle(salesmanSelector).display);
      console.log('Salesman selector offsetParent:', salesmanSelector.offsetParent);
      
      // Debug logging for dropdown visibility
      console.log('Dropdown found:', salesmanSelector ? 'YES' : 'NO', 'Visible:', window.getComputedStyle(salesmanSelector).display);
      
      // Clear existing options
      salesmanSelector.innerHTML = '<option value="">Select Salesman</option>';
      
      // Load salesmen data from server API
      fetch('/api/get-data')
        .then(response => {
          console.log('API response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('API response data:', data);
          if (!data.success || !data.salesmen) {
            throw new Error('No salesmen data found in API response');
          }
          
          const salesmenData = data.salesmen;
          console.log('Salesmen data:', salesmenData);
          
          // Populate dropdown with salesmen
          salesmenData.forEach(salesman => {
            const option = document.createElement('option');
            // Handle both string format and object format
            const salesmanName = typeof salesman === 'string' ? salesman : salesman.name;
            option.value = salesmanName;
            option.textContent = salesmanName;
            salesmanSelector.appendChild(option);
            console.log('Added salesman option:', salesmanName);
          });
          
          console.log('Final dropdown options count:', salesmanSelector.options.length);
          
          // Restore previously selected salesman from localStorage
          const savedSalesman = localStorage.getItem('priceCalculatorSelectedSalesman');
          if (savedSalesman && salesmanSelector.querySelector(`option[value="${savedSalesman}"]`)) {
            salesmanSelector.value = savedSalesman;
          }
          
          console.log('Price calculator salesman dropdown initialized with', salesmenData.length, 'salesmen');
        })
        .catch(error => {
          console.error('Error loading salesmen data:', error);
          
          // Add fallback salesmen
          const fallbackSalesmen = [
            'John Smith',
            'Sarah Johnson',
            'Mike Wilson'
          ];
          
          fallbackSalesmen.forEach(salesman => {
            const option = document.createElement('option');
            option.value = salesman;
            option.textContent = salesman;
            salesmanSelector.appendChild(option);
          });
          
          console.log('Using fallback salesmen data');
        });
      
      // Add event listener to save selection
      salesmanSelector.addEventListener('change', function() {
        localStorage.setItem('priceCalculatorSelectedSalesman', this.value);
        console.log('Saved selected salesman:', this.value);
      });
    }
    
    // Update price list dropdown options
    function updatePriceListDropdown() {
      const priceListSelector = document.getElementById('priceListSelector');
      
      // Clear existing options
      priceListSelector.innerHTML = '';
      
      // Add price list options
      const sortedPriceLists = Array.from(availablePriceLists).sort();
      sortedPriceLists.forEach(priceList => {
        const option = document.createElement('option');
        option.value = priceList;
        option.textContent = priceList;
        priceListSelector.appendChild(option);
      });
      
      // Auto-select the first price list if available
      if (sortedPriceLists.length > 0) {
        priceListSelector.value = sortedPriceLists[0];
        // Trigger the change event to filter products
        handlePriceListChange();
      }
    }
    
    // Clear product selections
    function clearProducts() {
      const productSelect = document.getElementById('new-item-product');
      if (productSelect) {
        productSelect.innerHTML = '<option value="">Select Product</option>';
        productSelect.disabled = true;
      }
      
      // Clear any product-related state
      state.selectedProduct = '';
    }
    
    // Handle price list selection change
    function handlePriceListChange() {
      const selectedPriceList = document.getElementById('priceListSelector').value;
      
      if (selectedPriceList) {
        // Filter products by selected price list
        state.filteredProducts = state.allProducts.filter(product => 
          product.PriceList === selectedPriceList
        );
        showAdminMessage(`Filtered to ${state.filteredProducts.length} products from price list: ${selectedPriceList}`, 'info');
        
        // Auto-select USD currency for USA25 price list
        if (selectedPriceList === 'USA25') {
          const currencySelect = document.getElementById('currency');
          currencySelect.value = 'USD';
          state.currency = 'USD';
          renderAllPagesToHTML(); // Update preview to reflect currency change
        }
      } else {
        // No price list selected - keep products empty
        state.filteredProducts = [];
      }
      
      // Update categories and products based on filtered data
      populateCategories();
      
      // Update catalog filters to reflect filtered products
      populateCatalogFilters();
      
      // Clear current selections
      state.category = '';
      $('category').value = '';
      clearProducts();
      renderAllPagesToHTML();
      
      // Notify other modules about price list change
      notifyPriceListChange();
    }
    
    // --------- Real-time Synchronization Functions ---------
    
    // Notify other modules when price lists are updated
    async function notifyPriceListChange() {
      try {
        const currentPriceLists = Array.from(availablePriceLists);
        const response = await fetch('/api/sync-price-lists', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'price_list_updated',
            priceLists: currentPriceLists,
            sourceModule: 'priceListGenerator'
          })
        });
        
        if (response.ok) {
          console.log('Price list change notification sent successfully');
        }
      } catch (error) {
        console.error('Failed to notify price list change:', error);
      }
    }
    
    // Check for updates from other modules
    async function checkForSyncUpdates() {
      try {
        const response = await fetch('/api/sync-status');
        const data = await response.json();
        
        if (data.success && data.syncData) {
          const lastUpdate = localStorage.getItem('priceListGenerator_lastSync') || '0';
          
          if (data.syncData.timestamp > parseInt(lastUpdate)) {
            // Update available price lists from sync data
            const syncedPriceLists = data.syncData.priceLists || [];
            
            // Check if price lists have changed
            const currentPriceLists = Array.from(availablePriceLists).sort();
            const newPriceLists = syncedPriceLists.sort();
            
            if (JSON.stringify(currentPriceLists) !== JSON.stringify(newPriceLists)) {
              console.log('Price lists updated from other modules:', newPriceLists);
              
              // Update local price lists
              availablePriceLists.clear();
              newPriceLists.forEach(pl => availablePriceLists.add(pl));
              
              // Update dropdown
              updatePriceListDropdown();
              
              showAdminMessage('Price lists synchronized from other modules', 'info');
            }
            
            // Update last sync timestamp
            localStorage.setItem('priceListGenerator_lastSync', data.syncData.timestamp.toString());
          }
        }
      } catch (error) {
        console.error('Failed to check for sync updates:', error);
      }
    }
    
    // Initialize real-time synchronization
    function initializeRealTimeSync() {
      // Check for updates every 5 seconds
      setInterval(checkForSyncUpdates, 5000);
      
      // Initial check
      checkForSyncUpdates();
      
      console.log('Real-time synchronization initialized for Price List Generator');
    }
    

    
    // Generate and save JSON file
    async function generateAndSaveJSON(productData, priceLists) {
      try {
        // Remove duplicates based on a combination of key fields
        const uniqueProducts = [];
        const seen = new Set();
        
        productData.forEach(product => {
          // Create a unique key based on important fields
          const key = `${product.Category || ''}_${product.Product || ''}_${product.Density || ''}_${product.Length || ''}_${product.Colors || ''}_${product.PriceList || ''}`;
          
          if (!seen.has(key)) {
            seen.add(key);
            uniqueProducts.push(product);
          }
        });
        
        // Use unique products for further processing
        const finalProductData = uniqueProducts.length > 0 ? uniqueProducts : productData;
        
        const jsonData = {
          metadata: {
            generatedAt: new Date().toISOString(),
            totalRecords: finalProductData.length,
            uniqueRecords: uniqueProducts.length,
            duplicatesRemoved: productData.length - uniqueProducts.length,
            priceLists: priceLists,
            version: '1.0'
          },
          products: finalProductData
        };
        
        // Log the data processing results
        console.log('Data processed:', {
          totalRecords: finalProductData.length,
          uniqueRecords: uniqueProducts.length,
          duplicatesRemoved: productData.length - uniqueProducts.length,
          priceLists: priceLists
        });
        
        showAdminMessage(`âœ… Data processed: ${finalProductData.length} unique records (${productData.length - uniqueProducts.length} duplicates removed)`, 'success');
        
        return finalProductData; // Return the cleaned data
        
      } catch (error) {
        console.error('Error generating JSON:', error);
        showAdminMessage(`âŒ Error generating JSON: ${error.message}`, 'error');
        throw error;
      }
    }
    
    // Update embedded data in HTML and permanently save to file
    async function updateEmbeddedData(newProductData) {
      try {
        // Clear existing application state
        state.allProducts = [];
        state.filteredProducts = [];
        state.category = '';
        state.selProducts = [];
        state.selDensities = [];
        state.selColors = [];
        
        // Clear localStorage
        localStorage.removeItem('productData');
        localStorage.removeItem('productDataTimestamp');
        
        // Update the global productData variable
        window.productData = newProductData;
        
        // Find the EMBEDDED_DATA script element
        let embeddedElement = document.getElementById('EMBEDDED_DATA');
        
        if (embeddedElement) {
          // Remove existing embedded data
          embeddedElement.remove();
        }
        
        // Create new script element with updated data
        const newScript = document.createElement('script');
        newScript.id = 'EMBEDDED_DATA';
        newScript.type = 'application/json';
        newScript.textContent = JSON.stringify(newProductData);
        
        // Insert the new script element before the main script tag
        const mainScript = document.querySelector('script:not([id="EMBEDDED_DATA"])');
        if (mainScript) {
          mainScript.parentNode.insertBefore(newScript, mainScript);
        } else {
          // Fallback: append to head
          document.head.appendChild(newScript);
        }
        
        // Note: JSON data is now embedded in the page and stored in localStorage
        console.log('Product data successfully embedded and ready for use');
        
        // Update application state with new data
        state.allProducts = [...newProductData];
        state.filteredProducts = [...newProductData];
        
        // Store in localStorage for persistence
        localStorage.setItem('productData', JSON.stringify(newProductData));
        localStorage.setItem('productDataTimestamp', new Date().toISOString());
        
        // Refresh UI components
        initPriceListDropdown();
        populateCategories();
        clearProducts();
        renderAllPagesToHTML();
        
        showAdminMessage(`âœ… Data successfully embedded and saved to HTML file! Loaded ${newProductData.length} products with fresh state.`, 'success');
        
      } catch (error) {
        console.error('Error updating embedded data:', error);
        showAdminMessage(`âŒ Error updating embedded data: ${error.message}`, 'error');
      }
    }
    
    
    // Load data from localStorage on page load
    function loadStoredData() {
      try {
        const storedData = localStorage.getItem('productData');
        const timestamp = localStorage.getItem('productDataTimestamp');
        
        if (storedData && timestamp) {
          const parsedData = JSON.parse(storedData);
          if (parsedData && parsedData.length > 0) {
            // Update application data
            state.allProducts = parsedData;
            state.filteredProducts = [...parsedData];
            window.productData = parsedData;
            
            console.log(`Loaded ${parsedData.length} products from localStorage (updated: ${timestamp})`);
            
            // Debug: Check first product structure
            if (parsedData[0]) {
              console.log('First product structure:', Object.keys(parsedData[0]));
              console.log('First product PriceList field:', parsedData[0].PriceList);
              console.log('First product Price List field:', parsedData[0]['Price List']);
            }
            
            return true;
          }
        }
      } catch (error) {
        console.error('Error loading stored data:', error);
      }
      return false;
    }
    
    // Initialize admin functionality when page loads
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM Content Loaded - starting initialization...');
      initAdminPanel();
      
      // Load data from embedded script or localStorage
      await init();
      
      console.log('Final state.allProducts length:', state.allProducts.length);
      initPriceListDropdown();
      await updateAdminStatus();
      
      // Initialize navigation
      console.log('About to initialize navigation...');
      initNavigation();
      console.log('Navigation initialization completed.');
      
      // Test navigation after a short delay
      setTimeout(() => {
        const testBtn = document.getElementById('nav-quote-maker');
        if (testBtn) {
          console.log('Test button found:', testBtn.id);
          const navStatus = document.getElementById('nav-status');
          if (navStatus) navStatus.textContent += ' - Ready for testing';
        } else {
          console.error('Test button not found!');
        }
      }, 1000);
      
      // Initialize real-time synchronization
      initializeRealTimeSync();
      
      // Initialize share button event listener
      const shareBtn = document.getElementById('shareBtn');
      if (shareBtn) {
        shareBtn.addEventListener('click', function(e) {
          console.log('Share button clicked!');
          console.log('Current state.segments:', state.segments);
          console.log('Generated PNGs:', state.generatedPNGs);
          toggleSharePopup();
        });
        console.log('Share button event listener attached');
      } else {
        console.error('Share button not found during initialization');
      }
    });
    
    // Navigation functionality
    function initNavigation() {
      console.log('Initializing navigation...');
      

      
      // Set Price List Calculator as default active
      const defaultModule = document.getElementById('price-calculator-module');
      if (defaultModule) {
        defaultModule.classList.add('active');
        console.log('Default module activated:', defaultModule.id);
      } else {
        console.error('Default module not found!');
      }
      
      // Add click handlers for navigation buttons
      const navButtons = document.querySelectorAll('.nav-btn');
      

      console.log('Found navigation buttons:', navButtons.length);
      
      navButtons.forEach(btn => {
        console.log('Adding click handler to button:', btn.id);
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Navigation button clicked:', this.id);
          

          
          // Handle both desktop and mobile button IDs
          let moduleId = this.id.replace('nav-', '').replace('-mobile', '') + '-module';
          console.log('Target module ID:', moduleId);
          switchModule(moduleId, this);
        });
      });
    }
    
    function switchModule(moduleId, activeBtn) {
      console.log('Switching to module:', moduleId);
      
      // Hide all modules
      const allModules = document.querySelectorAll('.module-content');
      console.log('Found modules to hide:', allModules.length);
      allModules.forEach(module => {
        module.classList.remove('active');
        console.log('Hiding module:', module.id);
      });
      
      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('nav-btn-active');
      });
      
      // Show selected module
      const targetModule = document.getElementById(moduleId);
      if (targetModule) {
        targetModule.classList.add('active');
        console.log('Showing module:', targetModule.id);
      } else {
        console.error('Target module not found:', moduleId);
      }
      
      // Add active class to both desktop and mobile buttons for the same module
      const baseId = activeBtn.id.replace('nav-', '').replace('-mobile', '');
      const desktopBtn = document.getElementById('nav-' + baseId);
      const mobileBtn = document.getElementById('nav-' + baseId + '-mobile');
      
      if (desktopBtn) desktopBtn.classList.add('nav-btn-active');
      if (mobileBtn) mobileBtn.classList.add('nav-btn-active');
      
      // Initialize Quote Maker if switching to it
      if (moduleId === 'quote-maker-module') {
        // Ensure exchange rates are available before initializing quote maker
         if (!state.rates || !state.rates.rates || Object.keys(state.rates.rates).length === 0) {
           fetchLiveFX().then(() => {
             initQuoteMaker();
           });
         } else {
           initQuoteMaker();
         }
      }
      
      // Initialize Product Catalog if switching to it
      if (moduleId === 'product-catalog-module') {
        initProductCatalog();
      }
    }
    
    // Function to show a specific module (used by addToQuote)
    function showModule(moduleId) {
      console.log('Showing module:', moduleId);
      
      // Hide all modules
      const allModules = document.querySelectorAll('.module-content');
      allModules.forEach(module => {
        module.classList.remove('active');
      });
      
      // Show selected module
      const targetModule = document.getElementById(moduleId);
      if (targetModule) {
        targetModule.classList.add('active');
        console.log('Module shown:', targetModule.id);
      } else {
        console.error('Target module not found:', moduleId);
      }
      
      // Update navigation buttons to reflect active module
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('nav-btn-active');
      });
      
      // Activate corresponding nav button
      const baseId = moduleId.replace('-module', '');
      const desktopBtn = document.getElementById('nav-' + baseId);
      const mobileBtn = document.getElementById('nav-' + baseId + '-mobile');
      
      if (desktopBtn) desktopBtn.classList.add('nav-btn-active');
      if (mobileBtn) mobileBtn.classList.add('nav-btn-active');
      
      // Initialize Quote Maker if switching to it
      if (moduleId === 'quote-maker-module') {
        if (!state.rates || !state.rates.rates || Object.keys(state.rates.rates).length === 0) {
          fetchLiveFX().then(() => {
            initQuoteMaker();
          });
        } else {
          initQuoteMaker();
        }
      }
      
      // Initialize Price Calculator if switching to it
      if (moduleId === 'price-calculator-module') {
        initPriceCalculatorSalesmanDropdown();
      }
      
      // Initialize Product Catalog if switching to it
      if (moduleId === 'product-catalog-module') {
        initProductCatalog();
      }
    }
    
    // Quote Maker Functionality
    let quoteItems = [];
    let quoteCounter = 1;
    let quoteMakerInitialized = false;

    function initQuoteMaker() {
      if (quoteMakerInitialized) return;
      
      // Set default date
      const today = new Date().toISOString().split('T')[0];
      const quoteDateInput = document.getElementById('quote-date');
      if (quoteDateInput) {
        quoteDateInput.value = today;
      }

      // Generate quote number
      generateQuoteNumber();

      // Initialize Quote Maker price list selector
      initQuoteMakerPriceListSelector();

      // Initialize dropdowns with product data
      populateQuoteDropdowns();

      // Add event listeners
      const addItemBtn = document.getElementById('add-item-btn');
      if (addItemBtn) {
        addItemBtn.addEventListener('click', addQuoteItem);
      }

      const saveQuoteBtn = document.getElementById('save-quote-btn');
      if (saveQuoteBtn) {
        saveQuoteBtn.addEventListener('click', saveQuote);
      }

      const clearQuoteBtn = document.getElementById('clear-quote-btn');
      if (clearQuoteBtn) {
        clearQuoteBtn.addEventListener('click', clearAllQuoteData);
      }

      // shareBtn event listener moved to main DOMContentLoaded block

      // Add currency change event listener for quote maker
      const quoteCurrencySelector = document.getElementById('quote-currency');
      if (quoteCurrencySelector) {
        quoteCurrencySelector.addEventListener('change', function() {
          // Update state currency
          state.currency = this.value;
          // Re-render quote items with new currency
          renderQuoteItems();
          // Update totals with new currency
          updateQuoteTotals();
        });
      }
      
      quoteMakerInitialized = true;
    }

    function getDeviceIdentifier() {
      // Try to get a stored device identifier first
      let deviceId = localStorage.getItem('deviceIdentifier');
      
      if (!deviceId) {
        // Generate a unique device identifier based on various factors
        const userAgent = navigator.userAgent;
        const screen = `${window.screen.width}x${window.screen.height}`;
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const language = navigator.language;
        const platform = navigator.platform;
        
        // Create a hash-like identifier from device characteristics
        const deviceString = `${userAgent}-${screen}-${timezone}-${language}-${platform}`;
        let hash = 0;
        for (let i = 0; i < deviceString.length; i++) {
          const char = deviceString.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // Convert to 32-bit integer
        }
        
        // Convert to positive number and limit to 5 digits
        deviceId = Math.abs(hash).toString().slice(0, 5).padStart(5, '0');
        
        // Store for future use
        localStorage.setItem('deviceIdentifier', deviceId);
      }
      
      return deviceId;
    }

    function generateQuoteNumber() {
      const today = new Date();
      const dateStr = today.getDate().toString().padStart(2, '0') + 
                     (today.getMonth() + 1).toString().padStart(2, '0') + 
                     today.getFullYear().toString().slice(-2);
      
      const deviceId = getDeviceIdentifier();
      
      // Get the next sequential number for today with device identifier
      const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
      const todayQuotes = savedQuotes.filter(q => q.quoteId && q.quoteId.includes(`INH-${deviceId}-${dateStr}`));
      const nextNumber = todayQuotes.length + 1;
      
      const quoteNumber = `INH-${deviceId}-${dateStr}-${nextNumber.toString().padStart(3, '0')}`;
      
      const quoteNumberInput = document.getElementById('quote-number');
      if (quoteNumberInput) {
        quoteNumberInput.value = quoteNumber;
      }
    }

    function populateQuoteDropdowns() {
      // Populate categories from existing product data filtered by selected price list
      const categorySelect = document.getElementById('new-item-category');
      if (categorySelect && state.filteredProducts && state.filteredProducts.length > 0) {
        // Use already filtered products from price list selection
        const productsToFilter = state.filteredProducts;
        
        const categories = [...new Set(productsToFilter.map(p => p.Category).filter(c => c))];
        categorySelect.innerHTML = '<option value="">Select Category</option>';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });
        
        // Add category change listener
        categorySelect.addEventListener('change', updateQuoteProductOptions);
      }
      
      // Add event listeners for product dropdown
      const productSelect = document.getElementById('new-item-product');
      if (productSelect) {
        productSelect.addEventListener('change', updateQuoteDensityOptions);
      }
      
      // Populate colors dropdown
      populateColorsDropdown();
    }
    
    function populateColorsDropdown() {
      const colorSelect = document.getElementById('new-item-color');
      if (colorSelect && state.filteredProducts && state.filteredProducts.length > 0) {
        // Use already filtered products from price list selection
        const productsToFilter = state.filteredProducts;
        
        const colors = [...new Set(productsToFilter.map(p => p.Colors).filter(c => c && c.trim() !== ''))];
        colorSelect.innerHTML = '<option value="">Select Color</option>';
        colors.sort().forEach(color => {
          const option = document.createElement('option');
          option.value = color;
          option.textContent = color;
          colorSelect.appendChild(option);
        });
      }
    }

    function updateQuoteDensityOptions() {
      const category = document.getElementById('new-item-category').value;
      const product = document.getElementById('new-item-product').value;
      const densitySelect = document.getElementById('new-item-density');
      
      // Clear and disable dependent dropdowns
      densitySelect.innerHTML = '<option value="">Select Density</option>';
      const lengthSelect = document.getElementById('new-item-length');
      if (lengthSelect) {
        lengthSelect.innerHTML = '<option value="">Select Length</option>';
      }
      densitySelect.disabled = !product;

      if (category && product && state.filteredProducts && state.filteredProducts.length > 0) {
        // Use already filtered products from price list selection
        const productsToFilter = state.filteredProducts;
        
        const densities = [...new Set(productsToFilter
          .filter(p => p.Category === category && p.Product === product)
          .map(p => p.Density))]
          .filter(d => d);
        
        densities.forEach(density => {
          const option = document.createElement('option');
          option.value = density;
          option.textContent = density;
          densitySelect.appendChild(option);
        });

        densitySelect.addEventListener('change', updateQuoteLengthOptions);
      }
    }

    function updateQuoteProductOptions() {
      const category = document.getElementById('new-item-category').value;
      const productSelect = document.getElementById('new-item-product');
      const densitySelect = document.getElementById('new-item-density');
      
      // Clear and disable dependent dropdowns
      productSelect.innerHTML = '<option value="">Select Product</option>';
      densitySelect.innerHTML = '<option value="">Select Density</option>';
      const lengthSelect = document.getElementById('new-item-length');
      if (lengthSelect) {
        lengthSelect.innerHTML = '<option value="">Select Length</option>';
      }
      productSelect.disabled = !category;
      densitySelect.disabled = true;

      if (category && state.filteredProducts && state.filteredProducts.length > 0) {
        // Use already filtered products from price list selection
        const productsToFilter = state.filteredProducts;
        
        const products = productsToFilter.filter(p => 
          p.Category === category
        );
        
        // Get unique product names to avoid duplicates in dropdown
        const uniqueProducts = new Map();
        products.forEach(product => {
          if (!uniqueProducts.has(product.Product)) {
            uniqueProducts.set(product.Product, product);
          }
        });
        
        // Sort unique products alphabetically and add to dropdown
         Array.from(uniqueProducts.values())
           .sort((a, b) => a.Product.localeCompare(b.Product))
           .forEach(product => {
             const option = document.createElement('option');
             option.value = product.Product;
             // Display product name with price list source for clear differentiation
             option.textContent = `${product.Product} [${product.PriceList}]`;
             option.dataset.price = product.Rate || 0;
             option.dataset.weight = product['Standard Weight'] || 0;
             option.dataset.priceList = product.PriceList;
             productSelect.appendChild(option);
           });
      }
    }

    function updateQuoteLengthOptions() {
      const category = document.getElementById('new-item-category').value;
      const product = document.getElementById('new-item-product').value;
      const density = document.getElementById('new-item-density').value;
      const lengthSelect = document.getElementById('new-item-length');
      
      if (!lengthSelect) return;
      
      lengthSelect.innerHTML = '<option value="">Select Length</option>';
      
      if (category && product && density && state.filteredProducts && state.filteredProducts.length > 0) {
        // Use already filtered products from price list selection
        const productsToFilter = state.filteredProducts;
        
        const lengths = [...new Set(productsToFilter
          .filter(p => p.Category === category && p.Product === product && p.Density === density)
          .map(p => Number(p.Length))
          .filter(l => !isNaN(l)))]
          .sort((a, b) => a - b);
        
        lengths.forEach(length => {
          const option = document.createElement('option');
          option.value = length;
          option.textContent = length;
          lengthSelect.appendChild(option);
        });
      }
    }

    function addQuoteItem() {
      const category = document.getElementById('new-item-category').value;
      const density = document.getElementById('new-item-density').value;
      const productName = document.getElementById('new-item-product').value;
      const length = document.getElementById('new-item-length').value;
      const quantity = parseFloat(document.getElementById('new-item-quantity').value) || 1;
      const overridePrice = parseFloat(document.getElementById('new-item-override-price').value);
      const color = document.getElementById('new-item-color').value;
      const colorDetail = document.getElementById('new-item-color-detail').value;
      const styles = document.getElementById('new-item-styles').value;

      if (!category || !productName) {
        alert('Please select category and product');
        return;
      }

      // Use already filtered products from price list selection
      const productsToFilter = state.filteredProducts || [];
      
      // Find the exact product match with all factors for accurate pricing
      let matchingProduct = null;
      
      // First try to match with all factors including color and length
      if (length && color) {
        matchingProduct = productsToFilter.find(p => 
          p.Category === category && 
          p.Density === density && 
          p.Product === productName && 
          Number(p.Length) === Number(length) &&
          p.Colors === color
        );
      }
      
      // If no exact match with color, try without color but with length
      if (!matchingProduct && length) {
        matchingProduct = productsToFilter.find(p => 
          p.Category === category && 
          p.Density === density && 
          p.Product === productName && 
          Number(p.Length) === Number(length)
        );
      }
      
      // If still no match, try with color but without length
      if (!matchingProduct && color) {
        matchingProduct = productsToFilter.find(p => 
          p.Category === category && 
          p.Density === density && 
          p.Product === productName && 
          p.Colors === color
        );
      }
      
      // Final fallback to any product match
      if (!matchingProduct) {
        matchingProduct = productsToFilter.find(p => 
          p.Category === category && 
          p.Density === density && 
          p.Product === productName
        );
      }
      
      const basePrice = matchingProduct ? parseFloat(matchingProduct.Rate) || 0 : 0;
      const weight = matchingProduct ? parseFloat(matchingProduct['Standard Weight']) || 0 : 0;
      
      // Store prices in INR (base currency) for consistency
      // Override price should be converted back to INR if provided in different currency
      const selectedCurrency = document.getElementById('quote-currency')?.value || state.currency || 'INR';
      let unitPriceInINR = basePrice;
      
      if (overridePrice) {
        // If override price is provided, convert it back to INR for storage
        if (selectedCurrency !== 'INR') {
          const exchangeRates = state.rates?.rates || {};
          const rate = exchangeRates[selectedCurrency] || 1;
          unitPriceInINR = overridePrice / rate; // Convert back to INR
        } else {
          unitPriceInINR = overridePrice;
        }
      }
      
      const unitPrice = unitPriceInINR;

      const item = {
        id: Date.now(),
        category,
        density,
        product: productName,
        length: length || 'Standard',
        weight,
        quantity,
        unitPrice,
        lineTotal: unitPrice * quantity,
        color: color || '',
        colorDetail: colorDetail || '',
        styles: styles || ''
      };

      quoteItems.push(item);
      renderQuoteItems();
      clearQuoteForm();
      saveQuoteToStorage(); // Auto-save when item is added
    }

    // Helper function to get color codes for visualization
    function getColorCode(colorName) {
      const colorMap = {
        'Black': '#000000',
        'Brown': '#6B7280',
        'Dark Brown': '#4B5563',
        'Light Brown': '#9CA3AF',
        'Blonde': '#D1D5DB',
        'Light Blonde': '#F3F4F6',
        'Platinum': '#E5E7EB',
        'Red': '#4B5563',
        'Auburn': '#6B7280',
        'Gray': '#808080',
        'Grey': '#808080',
        'Silver': '#C0C0C0',
        'White': '#FFFFFF',
        'Natural': '#9CA3AF',
        'Jet Black': '#111827',
        'Off Black': '#374151',
        'Dark Auburn': '#4B5563',
        'Medium Brown': '#6B7280',
        'Light Auburn': '#9CA3AF',
        'Dark Blonde': '#9CA3AF',
        'Medium Blonde': '#D1D5DB',
        'Light Golden Blonde': '#F3F4F6',
        'Strawberry Blonde': '#E5E7EB',
        'Ash Blonde': '#D1D5DB',
        'Honey Blonde': '#E5E7EB',
        'Caramel': '#9CA3AF',
        'Chestnut': '#6B7280',
        'Mahogany': '#4B5563',
        'Copper': '#9CA3AF',
        'Golden Brown': '#6B7280',
        'Chocolate': '#4B5563'
      };
      
      if (!colorName || colorName === 'â€”') return '#E5E7EB'; // Default gray
      
      // Try exact match first
      if (colorMap[colorName]) return colorMap[colorName];
      
      // Try case-insensitive match
      const lowerColorName = colorName.toLowerCase();
      for (const [key, value] of Object.entries(colorMap)) {
        if (key.toLowerCase() === lowerColorName) {
          return value;
        }
      }
      
      // Try partial match
      for (const [key, value] of Object.entries(colorMap)) {
        if (key.toLowerCase().includes(lowerColorName) || lowerColorName.includes(key.toLowerCase())) {
          return value;
        }
      }
      
      // Default to a neutral color if no match found
      return '#9CA3AF';
    }

    function renderQuoteItems() {
      const tbody = document.querySelector('#items-table tbody');
      if (!tbody) return;

      tbody.innerHTML = '';
      let totalWeight = 0;
      let subtotal = 0;

      // Get current selected currency
      const selectedCurrency = document.getElementById('quote-currency')?.value || state.currency || 'INR';
      const exchangeRates = state.rates?.rates || {};

      quoteItems.forEach((item, index) => {
        // Items are stored in their original currency, so we need to convert for display
        // Assume items are stored in INR base price, convert to selected currency
        let displayUnitPrice = item.unitPrice;
        
        // If current currency is different from INR, convert the price
        if (selectedCurrency !== 'INR') {
          const rate = exchangeRates[selectedCurrency] || 1;
          // Convert from INR to selected currency
          displayUnitPrice = item.unitPrice * rate;
        }
        
        const displayLineTotal = displayUnitPrice * item.quantity;
        // Calculate subtotal using base INR price (not converted price)
        const baseLineTotal = item.unitPrice * item.quantity;
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 hover:bg-gradient-to-r hover:from-blue-25 hover:to-indigo-25 transition-all duration-200 group';
        
        const itemWeight = item.weight * item.quantity;
        totalWeight += itemWeight;
        subtotal += baseLineTotal;

        row.innerHTML = `
          <td class="px-4 py-2 text-center border-r border-gray-100">
            <div class="w-6 h-6 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center text-gray-700 font-bold text-xs shadow-sm">
              ${index + 1}
            </div>
          </td>
          <td class="px-4 py-2 border-r border-gray-100">
            <span class="text-sm font-semibold text-gray-900">${item.product}</span>
          </td>
          <td class="px-4 py-2 text-sm text-gray-700 border-r border-gray-100">
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
              ${item.density || 'â€”'}
            </span>
          </td>
          <td class="px-4 py-2 text-sm text-gray-700 border-r border-gray-100">
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
              ${item.length}
            </span>
          </td>
          <td class="px-4 py-2 border-r border-gray-100">
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 rounded-full border-2 border-gray-300 shadow-sm" style="background-color: ${getColorCode(item.color)}"></div>
              <span class="text-sm font-medium text-gray-900">${item.color || 'â€”'}</span>
              <span class="text-xs text-gray-500 ml-2">${item.colorDetail || ''}</span>
            </div>
          </td>
          <td class="px-4 py-2 text-xs text-gray-600 border-r border-gray-100">
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
              ${item.styles || 'â€”'}
            </span>
          </td>
          <td class="px-4 py-2 text-center border-r border-gray-100">
            <div class="flex items-center justify-center">
              <div class="relative">
                <input type="number" value="${item.quantity}" min="0.01" step="0.01" 
                       class="w-16 px-2 py-1 border-2 border-gray-200 rounded-lg text-center font-semibold text-gray-900 focus:border-gray-500 focus:ring-2 focus:ring-gray-200 transition-all duration-200 group-hover:border-gray-300 bg-white text-xs"
                       onchange="updateQuantity(${index}, this.value)" 
                       onblur="this.classList.remove('focus:bg-white')" />
                <div class="absolute inset-y-0 right-0 flex flex-col">
                  <button type="button" class="px-1 py-0.5 text-xs text-gray-400 hover:text-gray-600 transition-colors" onclick="updateQuantity(${index}, ${item.quantity + 1})">
                    <svg class="w-2 h-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                    </svg>
                  </button>
                  <button type="button" class="px-1 py-0.5 text-xs text-gray-400 hover:text-gray-600 transition-colors" onclick="updateQuantity(${index}, Math.max(0.01, ${item.quantity - 1}))">
                    <svg class="w-2 h-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </td>
          <td class="px-4 py-2 text-right border-r border-gray-100">
            <div class="flex flex-col items-end">
              <span class="text-sm font-semibold text-gray-900">${formatQuoteCurrency(displayUnitPrice)}</span>
              <span class="text-xs text-gray-500">per unit</span>
            </div>
          </td>
          <td class="px-4 py-2 text-right border-r border-gray-100">
            <div class="flex flex-col items-end">
              <span class="text-base font-bold text-gray-700">${formatQuoteCurrency(displayLineTotal)}</span>
              <span class="text-xs text-gray-500">${item.quantity} Ã— ${formatQuoteCurrency(displayUnitPrice)}</span>
            </div>
          </td>
          <td class="px-4 py-2 text-center no-print">
            <button onclick="removeQuoteItem(${index})" 
                    class="group relative p-1 text-red-500 hover:text-white hover:bg-red-500 rounded-full transition-all duration-200 transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-red-300">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
              <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 text-xs text-white bg-gray-800 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
                Remove Item
              </div>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Calculate financial totals using the new function
      const financials = calculateFinancialTotals(subtotal);

      // Update totals with proper formatting
      document.getElementById('grand-weight').textContent = `${totalWeight.toFixed(2)}g`;
      document.getElementById('subtotal').textContent = formatQuoteCurrency(financials.subtotal);
      
      // Update discount display
      const discountElement = document.getElementById('discount');
      if (financials.discountAmount > 0) {
        discountElement.textContent = `-${formatQuoteCurrency(financials.discountAmount)}`;
        discountElement.className = 'text-green-600 font-medium';
      } else {
        discountElement.textContent = 'â€”';
        discountElement.className = '';
      }
      
      // Update tax display
      const taxElement = document.getElementById('tax');
      if (financials.taxAmount > 0) {
        taxElement.textContent = formatQuoteCurrency(financials.taxAmount);
      } else {
        taxElement.textContent = 'Tax Free';
        taxElement.className = 'text-blue-600 font-medium';
      }
      
      // Update shipping display
      const shippingElement = document.getElementById('shipping-total');
      if (financials.shippingAmount > 0) {
        shippingElement.textContent = formatQuoteCurrency(financials.shippingAmount);
      } else {
        shippingElement.textContent = 'Free Shipping';
        shippingElement.className = 'text-green-600 font-medium';
      }
      
      // Update grand total
      document.getElementById('grand-total-table').textContent = formatQuoteCurrency(financials.grandTotal);
      
      // Update preview displays in financial controls
      updateFinancialPreviews(financials);
    }

    function removeQuoteItem(index) {
      quoteItems.splice(index, 1);
      renderQuoteItems();
      saveQuoteToStorage(); // Auto-save when item is removed
    }

    function updateQuantity(index, newQuantity) {
      let quantity = parseFloat(newQuantity) || 0.01;
      if (quantity < 0.01) {
        quantity = 0.01;
      }
      
      quoteItems[index].quantity = quantity;
      quoteItems[index].lineTotal = quoteItems[index].unitPrice * quantity;
      
      renderQuoteItems();
      saveQuoteToStorage(); // Auto-save when quantity is updated
    }

    function clearQuoteForm() {
      document.getElementById('new-item-category').value = '';
      document.getElementById('new-item-density').value = '';
      document.getElementById('new-item-product').value = '';
      document.getElementById('new-item-length').value = '';
      document.getElementById('new-item-quantity').value = '1';
      document.getElementById('new-item-override-price').value = '';
      document.getElementById('new-item-color').value = '';
      document.getElementById('new-item-color-detail').value = '';
      document.getElementById('new-item-styles').value = '';
      
      // Reset dependent dropdowns
      document.getElementById('new-item-density').disabled = true;
      document.getElementById('new-item-product').disabled = true;
    }

    function clearAllQuoteData() {
      // Clear line items array
      quoteItems = [];
      
      // Clear quote details form
      document.getElementById('client-name').value = '';
      document.getElementById('client-contact').value = '';
      document.getElementById('salesman-name').value = '';
      document.getElementById('valid-days').value = '14';
      document.getElementById('brief-preview').value = '';
      
      // Clear new item form
      clearQuoteForm();
      
      // Clear notes and terms
      const notesField = document.getElementById('notes-terms');
      if (notesField) {
        notesField.value = '';
      }
      
      // Reset financial controls to defaults
      const discountInput = document.getElementById('discount-input');
      const taxInput = document.getElementById('tax-input');
      const shippingInput = document.getElementById('shipping-input');
      
      if (discountInput) {
        discountInput.value = '';
      }
      
      if (taxInput) {
        taxInput.value = '';
      }
      
      if (shippingInput) {
        shippingInput.value = '';
      }
      
      // Generate new quote number
      generateQuoteNumber();
      
      // Set current date
      const today = new Date().toISOString().split('T')[0];
      const quoteDateInput = document.getElementById('quote-date');
      if (quoteDateInput) {
        quoteDateInput.value = today;
      }
      
      // Re-render items and totals
      renderQuoteItems();
      const subtotal = quoteItems.reduce((sum, item) => sum + (item.lineTotal || 0), 0);
      calculateFinancialTotals(subtotal);
    }

    function saveQuote() {
      if (quoteItems.length === 0) {
        alert('Please add items to the quote before saving.');
        return;
      }

      const now = new Date();
      const dateStr = now.getFullYear().toString() + 
                     (now.getMonth() + 1).toString().padStart(2, '0') + 
                     now.getDate().toString().padStart(2, '0');
      
      const deviceId = getDeviceIdentifier();
      
      // Get existing quotes to determine auto number
      const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
      const todayQuotes = savedQuotes.filter(q => q.quoteId && q.quoteId.includes(`INH-${deviceId}-${dateStr}`));
      const autoNumber = (todayQuotes.length + 1).toString().padStart(3, '0');
      
      const quoteId = `INH-${deviceId}-${dateStr}-${autoNumber}`;
      
      const quoteData = {
        quoteId: quoteId,
        quoteNumber: document.getElementById('quote-number').value,
        date: document.getElementById('quote-date').value,
        clientName: document.getElementById('client-name').value,
        clientContact: document.getElementById('client-contact').value,
        salesman: document.getElementById('salesman-name').value,
        validDays: document.getElementById('valid-days').value,
        briefPreview: document.getElementById('brief-preview').value,
        items: [...quoteItems],
        notes: document.getElementById('notes-terms').value,
        discount: {
          type: (() => {
            const discountInput = document.getElementById('discount-input');
            if (discountInput && discountInput.value.trim()) {
              return discountInput.value.includes('%') ? 'percentage' : 'fixed';
            }
            return 'none';
          })(),
          value: (() => {
            const discountInput = document.getElementById('discount-input');
            if (discountInput && discountInput.value.trim()) {
              return discountInput.value.replace('%', '');
            }
            return '0';
          })()
        },
        shipping: {
          type: (() => {
            const shippingInput = document.getElementById('shipping-input');
            if (shippingInput && shippingInput.value.trim() && parseFloat(shippingInput.value.trim()) > 0) {
              return 'paid';
            }
            return 'free';
          })(),
          cost: document.getElementById('shipping-input')?.value || '0'
        },
        tax: {
          type: (() => {
            const taxInput = document.getElementById('tax-input');
            if (taxInput && taxInput.value.trim()) {
              return 'taxable';
            }
            return 'tax-free';
          })(),
          rate: (() => {
            const taxInput = document.getElementById('tax-input');
            if (taxInput && taxInput.value.trim()) {
              return taxInput.value.replace('%', '');
            }
            return '0';
          })()
        },
        savedAt: now.toISOString()
      };

      savedQuotes.push(quoteData);
      localStorage.setItem('savedQuotes', JSON.stringify(savedQuotes));
      
      alert(`Quote saved successfully as ${quoteId}!`);
      renderSavedQuotesList();
    }

    function renderSavedQuotesList() {
      const container = document.getElementById('saved-quotes-container');
      const noQuotesMessage = document.getElementById('no-quotes-message');
      const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
      
      if (savedQuotes.length === 0) {
        noQuotesMessage.style.display = 'block';
        return;
      }
      
      noQuotesMessage.style.display = 'none';
      
      // Create array with original indices before sorting
      const quotesWithOriginalIndex = savedQuotes.map((quote, originalIndex) => ({
        ...quote,
        originalIndex
      }));
      
      // Sort quotes by date (newest first)
      quotesWithOriginalIndex.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
      
      // Clear existing quotes except the no-quotes message
      const existingQuotes = container.querySelectorAll('.quote-item');
      existingQuotes.forEach(item => item.remove());
      
      quotesWithOriginalIndex.forEach((quote, displayIndex) => {
        const quoteItem = document.createElement('div');
        quoteItem.className = 'quote-item bg-gray-50 border border-gray-200 rounded p-2 hover:bg-gray-100 transition-colors relative';
        quoteItem.innerHTML = `
          <div class="flex items-center space-x-3 text-sm">
            <span class="font-medium text-gray-900">${quote.quoteId}</span>
            <span class="text-gray-600">${quote.clientName || 'No client name'}</span>
            <span class="text-gray-500">${new Date(quote.savedAt).toLocaleDateString()}</span>
            <span class="text-xs text-gray-400">(${quote.items.length} items)</span>
          </div>
        `;
        
        // Checkbox functionality removed
        
        container.appendChild(quoteItem);
      });
    }

    function showQuoteContextMenu(checkboxElement, quoteIndex) {
      // Remove any existing context menu
      hideQuoteContextMenu();
      
      const contextMenu = document.createElement('div');
      contextMenu.className = 'quote-context-menu fixed bg-white border border-gray-200 rounded-lg shadow-lg z-50 py-1 min-w-48';
      contextMenu.id = 'quote-context-menu';
      
      // Position the menu with viewport boundary checking
      const rect = checkboxElement.getBoundingClientRect();
      const menuWidth = 192; // min-w-48 = 12rem = 192px
      const menuHeight = 120; // Approximate height for 3 buttons
      
      let left = rect.right + 10;
      let top = rect.top;
      
      // Check right boundary - if menu would go off screen, position to the left
      if (left + menuWidth > window.innerWidth) {
        left = rect.left - menuWidth - 10;
      }
      
      // Check bottom boundary - if menu would go off screen, position above
      if (top + menuHeight > window.innerHeight) {
        top = rect.bottom - menuHeight;
      }
      
      // Ensure menu doesn't go above viewport
      if (top < 0) {
        top = 10;
      }
      
      // Ensure menu doesn't go left of viewport
      if (left < 0) {
        left = 10;
      }
      
      contextMenu.style.left = left + 'px';
      contextMenu.style.top = top + 'px';
      
      contextMenu.innerHTML = `
        <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center" onclick="recallQuote(${quoteIndex}); hideQuoteContextMenu();">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
          </svg>
          Recall Quote
        </button>
        <button class="w-full text-left px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 flex items-center" onclick="shareQuoteFromContext(${quoteIndex}); hideQuoteContextMenu();">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
          </svg>
          Share Quote
        </button>
        <button class="w-full text-left px-4 py-2 text-sm text-green-600 hover:bg-green-50 flex items-center" onclick="convertQuoteToOrder(${quoteIndex}); hideQuoteContextMenu();">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Convert to Order
        </button>
        <button class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center" onclick="deleteQuote(${quoteIndex}); hideQuoteContextMenu();">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
          Delete Quote
        </button>
      `;
      
      document.body.appendChild(contextMenu);
      
      // Store the current quote index for reference
      contextMenu.dataset.quoteIndex = quoteIndex;
      
      // Set up click-outside behavior
      setTimeout(() => {
        document.addEventListener('click', handleContextMenuClickOutside);
      }, 0);
    }
    
    function hideQuoteContextMenu() {
      const existingMenu = document.getElementById('quote-context-menu');
      if (existingMenu) {
        existingMenu.remove();
        document.removeEventListener('click', handleContextMenuClickOutside);
      }
      
      // Uncheck all checkboxes
      const checkboxes = document.querySelectorAll('.quote-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
    }
    
    function handleContextMenuClickOutside(e) {
      const contextMenu = document.getElementById('quote-context-menu');
      const checkboxes = document.querySelectorAll('.quote-checkbox');
      
      // Check if click is outside the context menu and not on any checkbox
      let clickedOnCheckbox = false;
      checkboxes.forEach(checkbox => {
        if (checkbox.contains(e.target) || checkbox === e.target) {
          clickedOnCheckbox = true;
        }
      });
      
      if (contextMenu && !contextMenu.contains(e.target) && !clickedOnCheckbox) {
        hideQuoteContextMenu();
      }
    }

     function recallQuote(quoteIndex) {
       const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
       const quote = savedQuotes[quoteIndex];
       
       if (!quote) {
         alert('Quote not found!');
         return;
       }
       
       // Load quote data into the form
       document.getElementById('quote-number').value = quote.quoteNumber || '';
       document.getElementById('quote-date').value = quote.date || '';
       document.getElementById('client-name').value = quote.clientName || '';
       document.getElementById('client-contact').value = quote.clientContact || '';
       document.getElementById('salesman-name').value = quote.salesman || '';
       document.getElementById('valid-days').value = quote.validDays || '';
       document.getElementById('brief-preview').value = quote.briefPreview || '';
       document.getElementById('notes-terms').value = quote.notes || '';
       
       // Load financial controls
       // Restore discount
       const discountInput = document.getElementById('discount-input');
       if (discountInput) {
         if (quote.discount && quote.discount.value && quote.discount.value !== '0') {
           if (quote.discount.type === 'percentage') {
             discountInput.value = quote.discount.value + '%';
           } else {
             discountInput.value = quote.discount.value;
           }
         } else {
           discountInput.value = '';
         }
       }
       
       // Restore tax
       const taxInput = document.getElementById('tax-input');
       if (taxInput) {
         if (quote.tax && quote.tax.rate && quote.tax.rate !== '0') {
           taxInput.value = quote.tax.rate + '%';
         } else {
           taxInput.value = '';
         }
       }
       
       // Restore shipping
       const shippingInput = document.getElementById('shipping-input');
       if (shippingInput) {
         if (quote.shipping && quote.shipping.cost && quote.shipping.cost !== '0' && quote.shipping.type === 'paid') {
           shippingInput.value = quote.shipping.cost;
         } else {
           shippingInput.value = '';
         }
       }
       
       // Load quote items
       quoteItems.length = 0; // Clear existing items
       quote.items.forEach(item => {
         quoteItems.push({...item}); // Create a copy of each item
       });
       
       renderQuoteItems();
       
       // Remove any existing dropdown
       const existingDropdown = document.querySelector('.quote-actions-dropdown');
       if (existingDropdown) {
         existingDropdown.remove();
       }
       
       alert(`Quote ${quote.quoteId} recalled successfully!`);
     }

     async function shareQuoteAsImage(quoteIndex) {
       const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
       const quote = savedQuotes[quoteIndex];
       
       if (!quote) {
         alert('Quote not found!');
         return;
       }
       
       // First recall the quote to load its data
       recallQuote(quoteIndex);
       
       // Wait a moment for the data to load, then share
       setTimeout(() => {
         shareQuoteAsImageFromMain();
       }, 500);
     }

     async function shareQuoteFromContext(quoteIndex) {
       const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
       const quote = savedQuotes[quoteIndex];
       
       if (!quote) {
         alert('Quote not found!');
         return;
       }
       
       try {
         // Show loading message
         const loadingMsg = document.createElement('div');
         loadingMsg.className = 'fixed top-4 left-4 right-4 bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg z-50';
         loadingMsg.innerHTML = `
           <div class="flex items-center gap-2">
             <span class="text-lg">â³</span>
             <span class="font-medium">Generating quote image for ${quote.quoteId}...</span>
           </div>
         `;
         document.body.appendChild(loadingMsg);
         
         // Create quote details layout for image generation
         const quoteHTML = createQuoteDetailsLayout(quote);
         
         // Create a temporary container for rendering
         const tempContainer = document.createElement('div');
         tempContainer.style.position = 'absolute';
         tempContainer.style.left = '-9999px';
         tempContainer.style.top = '-9999px';
         tempContainer.style.width = '800px';
         tempContainer.innerHTML = quoteHTML;
         document.body.appendChild(tempContainer);
         
         // Convert to canvas using html2canvas
         const canvas = await html2canvas(tempContainer, {
           scale: 2,
           useCORS: true,
           allowTaint: true,
           backgroundColor: '#ffffff',
           width: 400,
           height: 400
         });
         
         // Remove temporary container
         document.body.removeChild(tempContainer);
         
         // Convert canvas to blob
         const blob = await new Promise(resolve => {
           canvas.toBlob(resolve, 'image/png', 1.0);
         });
         
         // Share using Web Share API
         if (navigator.share) {
           // Create a file from the blob
           const file = new File([blob], `Quote-${quote.quoteId}-${new Date().toISOString().slice(0,10)}.png`, {
             type: 'image/png'
           });
           
           try {
             await navigator.share({
               title: `Quote ${quote.quoteId} - Indian Natural Hair`,
               text: `Quote details for ${quote.quoteId}`,
               files: [file]
             });
             
             // Remove loading message
             loadingMsg.remove();
             
             // Show success message
             showSuccessMessage(`Quote ${quote.quoteId} shared successfully! ðŸ“¤âœ¨`);
           } catch (shareError) {
             console.log('Share cancelled or failed:', shareError);
             
             // Remove loading message
             loadingMsg.remove();
             
             // Fallback to clipboard if share is cancelled
             if (navigator.clipboard && window.ClipboardItem) {
               await navigator.clipboard.write([
                 new ClipboardItem({
                   'image/png': blob
                 })
               ]);
               showSuccessMessage(`Quote ${quote.quoteId} image copied to clipboard! ðŸ“‹âœ¨`);
             } else {
               // Final fallback: download the image
               const url = URL.createObjectURL(blob);
               const a = document.createElement('a');
               a.href = url;
               a.download = `Quote-${quote.quoteId}-${new Date().toISOString().slice(0,10)}.png`;
               document.body.appendChild(a);
               a.click();
               document.body.removeChild(a);
               URL.revokeObjectURL(url);
               showSuccessMessage(`Quote ${quote.quoteId} image downloaded! ðŸ’¾`);
             }
           }
         } else {
           // Fallback for browsers without Web Share API
           if (navigator.clipboard && window.ClipboardItem) {
             await navigator.clipboard.write([
               new ClipboardItem({
                 'image/png': blob
               })
             ]);
             
             // Remove loading message
             loadingMsg.remove();
             
             // Show success message
             showSuccessMessage(`Quote ${quote.quoteId} image copied to clipboard! ðŸ“‹âœ¨`);
           } else {
             // Final fallback: download the image
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = `Quote-${quote.quoteId}-${new Date().toISOString().slice(0,10)}.png`;
             document.body.appendChild(a);
             a.click();
             document.body.removeChild(a);
             URL.revokeObjectURL(url);
              
              // Remove loading message
              loadingMsg.remove();
              
              showSuccessMessage(`Quote ${quote.quoteId} image downloaded! ðŸ’¾`);
            }
          }
         
       } catch (error) {
         console.error('Error generating quote image:', error);
         
         // Remove any existing loading message
         const existingMsg = document.querySelector('.fixed.top-4');
         if (existingMsg) existingMsg.remove();
         
         // Show error message
         showErrorMessage(`Failed to generate image for quote ${quote.quoteId}. Please try again.`);
       }
     }
     
     // Create quote details layout for image generation
     function createQuoteDetailsLayout(quote) {
       const currentDate = new Date().toLocaleDateString();
       
       // Calculate totals with safety checks
        const subtotal = quote.items.reduce((sum, item) => {
          const price = parseFloat(item.unitPrice || item.price) || 0;
          const quantity = parseInt(item.quantity) || 1;
          return sum + (price * quantity);
        }, 0);
        
        // Calculate discount
        let discountAmount = 0;
        if (quote.discount && quote.discount.value && parseFloat(quote.discount.value) > 0) {
          const discountValue = parseFloat(quote.discount.value);
          if (quote.discount.type === 'percentage') {
            discountAmount = (subtotal * discountValue) / 100;
          } else {
            discountAmount = discountValue;
          }
        } else {
          // If no discount data in quote object, check current form input
          const discountInput = document.getElementById('discount-input');
          if (discountInput && discountInput.value.trim()) {
            const discountValue = discountInput.value.trim();
            if (discountValue.includes('%')) {
              const percentage = parseFloat(discountValue.replace('%', '')) || 0;
              discountAmount = (subtotal * percentage) / 100;
            } else {
              discountAmount = parseFloat(discountValue) || 0;
            }
          }
        }
        
        // Calculate tax on discounted amount
        const taxableAmount = subtotal - discountAmount;
        let taxAmount = 0;
        if (quote.tax && quote.tax.type === 'percentage' && quote.tax.rate) {
          const taxRate = parseFloat(quote.tax.rate) || 0;
          taxAmount = (taxableAmount * taxRate) / 100;
        } else {
          // If no tax data in quote object, check current form input
          const taxInput = document.getElementById('tax-input');
          if (taxInput && taxInput.value.trim()) {
            const taxValue = taxInput.value.trim();
            const taxRate = parseFloat(taxValue.replace('%', '')) || 0;
            taxAmount = (taxableAmount * taxRate) / 100;
          }
        }
        
        // Calculate shipping
        let shippingAmount = 0;
        if (quote.shipping && quote.shipping.type === 'paid' && quote.shipping.cost) {
          shippingAmount = parseFloat(quote.shipping.cost) || 0;
        } else {
          // If no shipping data in quote object, check current form input
          const shippingInput = document.getElementById('shipping-input');
          if (shippingInput && shippingInput.value.trim()) {
            shippingAmount = parseFloat(shippingInput.value.trim()) || 0;
          }
        }
        
        const total = taxableAmount + taxAmount + shippingAmount;
       
       return `
         <div style="font-family: 'Courier New', monospace; width: 400px; margin: 0; padding: 12px; background: white; color: #000; line-height: 1.1; box-sizing: border-box;">
           <!-- Header -->
           <div style="text-align: center; margin-bottom: 8px; border-bottom: 2px solid #000; padding-bottom: 6px;">
             <h1 style="font-size: 18px; margin: 0; font-weight: bold; letter-spacing: 1px;">QUOTE</h1>
             <p style="font-size: 12px; margin: 2px 0; font-weight: bold;">Indian Natural Hair</p>
             <p style="font-size: 10px; margin: 0;">Hair Extensions</p>
           </div>
           
           <!-- Quote Details Table -->
           <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; font-size: 10px;">
             <div><strong>ID:</strong> ${quote.quoteId}</div>
             <div><strong>Date:</strong> ${quote.date || currentDate}</div>
             <div><strong>Client:</strong> ${quote.clientName || 'N/A'}</div>
             <div><strong>Contact:</strong> ${quote.clientContact || 'N/A'}</div>
             <div><strong>Sales:</strong> ${quote.salesman || 'N/A'}</div>
             <div><strong>Valid:</strong> ${quote.validDays || 'N/A'} days</div>
           </div>
           
           <!-- Brief Preview -->
           ${quote.briefPreview ? `
             <div style="margin-bottom: 8px; padding: 4px; background: #f9f9f9; border: 1px solid #ddd; font-size: 9px;">
               <strong>Info:</strong> ${quote.briefPreview}
             </div>
           ` : ''}
           
           <!-- Items Section -->
           <div style="border: 1px solid #000; margin-bottom: 8px;">
             <div style="background: #f0f0f0; padding: 4px; font-weight: bold; font-size: 11px; border-bottom: 1px solid #000;">
               <span>ITEMS</span>
               <span style="float: right;">TOTAL</span>
             </div>
             <div style="padding: 4px;">
               ${quote.items.map((item, index) => {
                 const unitPrice = parseFloat(item.unitPrice || item.price) || 0;
                 const quantity = parseInt(item.quantity) || 1;
                 const lineTotal = unitPrice * quantity;
                 return `
                 <div style="display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 9px; border-bottom: 1px dotted #ccc; padding-bottom: 2px;">
                   <div style="flex: 1;">
                     <strong>${index + 1}. ${item.product || item.name || 'N/A'}</strong>${item.category ? ` (${item.category})` : ''}${item.density ? ` ${item.density}` : ''}<br/>
                     Length: ${item.length || 'N/A'} | Qty: ${quantity} | Unit: ${formatQuoteCurrency(unitPrice)}
                   </div>
                   <div style="font-weight: bold; margin-left: 8px;">${formatQuoteCurrency(lineTotal)}</div>
                 </div>
                 `;
               }).join('')}
             </div>
           </div>
           
           <!-- Totals Section -->
           <div style="border: 1px solid #000; margin-bottom: 8px; background: #f9f9f9;">
             <div style="padding: 6px; font-size: 10px;">
               <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                 <span>Subtotal:</span><span>${formatQuoteCurrency(subtotal)}</span>
               </div>
               ${discountAmount > 0 ? `
                 <div style="display: flex; justify-content: space-between; margin-bottom: 2px; color: #d63384;">
                   <span>Discount ${quote.discount.type === 'percentage' ? `(${quote.discount.value}%)` : ''}:</span><span>-${formatQuoteCurrency(discountAmount)}</span>
                 </div>
               ` : ''}
               ${taxAmount > 0 ? `
                 <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                   <span>Tax (${quote.tax.rate}%):</span><span>${formatQuoteCurrency(taxAmount)}</span>
                 </div>
               ` : ''}
               ${shippingAmount > 0 ? `
                 <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                   <span>Shipping:</span><span>${formatQuoteCurrency(shippingAmount)}</span>
                 </div>
               ` : quote.shipping && quote.shipping.type === 'free' ? `
                 <div style="display: flex; justify-content: space-between; margin-bottom: 2px; color: #198754;">
                   <span>Shipping:</span><span>FREE</span>
                 </div>
               ` : ''}
               <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 12px; border-top: 1px solid #000; padding-top: 4px;">
                 <span>TOTAL:</span><span>${formatQuoteCurrency(total)}</span>
               </div>
             </div>
           </div>
           
           <!-- Notes -->
           ${quote.notes ? `
             <div style="margin-top: 4px;">
               <p style="font-size: 9px; margin: 0; font-weight: bold;">Notes: ${quote.notes}</p>
             </div>
           ` : ''}
           
           <!-- Footer -->
           <div style="text-align: center; font-size: 9px; border-top: 1px solid #000; padding-top: 6px;">
             <p style="margin: 0; font-weight: bold;">Indian Natural Hair</p>
             <p style="margin: 0;">info@indiannaturalhair.com</p>
           </div>
         </div>
       `;
     }

     function deleteQuote(quoteIndex) {
       const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
       const quote = savedQuotes[quoteIndex];
       
       if (!quote) {
         alert('Quote not found!');
         return;
       }
       
       const confirmed = confirm(`Are you sure you want to delete quote ${quote.quoteId}? This action cannot be undone.`);
       if (confirmed) {
         savedQuotes.splice(quoteIndex, 1);
         localStorage.setItem('savedQuotes', JSON.stringify(savedQuotes));
         
         // Remove any existing dropdown
         const existingDropdown = document.querySelector('.quote-actions-dropdown');
         if (existingDropdown) {
           existingDropdown.remove();
         }
         
         renderSavedQuotesList();
         alert(`Quote ${quote.quoteId} deleted successfully!`);
       }
     }

     function convertQuoteToOrder(quoteIndex) {
       const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
       const quote = savedQuotes[quoteIndex];
       
       if (!quote) {
         alert('Quote not found!');
         return;
       }
       
       const confirmed = confirm(`Convert quote ${quote.quoteId} to order? This will recall the quote and mark it as an order.`);
       if (confirmed) {
         // First recall the quote to load its data
         recallQuote(quoteIndex);
         
         // Wait a moment for the data to load, then process as order
         setTimeout(() => {
           // Check if there are items in the quote
           if (quoteItems.length === 0) {
             alert('Cannot convert to order: No items in quote!');
             return;
           }
           
           // Save the current quote state as an order
           saveQuote();
           
           alert(`Quote ${quote.quoteId} has been successfully converted to an order!`);
         }, 500);
       }
     }

     // Share current quote as image
     async function shareQuoteAsImageFromMain() {
       try {
         if (quoteItems.length === 0) {
           alert('Please add items to the quote first');
           return;
         }
         
         // Generate preview first
         await generatePreview();
         
         // Get the preview element
         const previewElement = document.getElementById('preview');
         if (!previewElement) {
           alert('Please generate a preview first');
           return;
         }
         
         // Use html2canvas to capture the preview as image
         const canvas = await html2canvas(previewElement, {
           backgroundColor: '#ffffff',
           scale: 2,
           useCORS: true
         });
         
         // Convert canvas to blob
         canvas.toBlob(async (blob) => {
           try {
             // Copy to clipboard
             await navigator.clipboard.write([
               new ClipboardItem({ 'image/png': blob })
             ]);
             alert('Quote image copied to clipboard!');
           } catch (err) {
             console.error('Failed to copy to clipboard:', err);
             // Fallback: download the image
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = 'quote-image.png';
             a.click();
             URL.revokeObjectURL(url);
             alert('Quote image downloaded!');
           }
         }, 'image/png');
         
       } catch (error) {
         console.error('Error sharing quote as image:', error);
         alert('Failed to share quote as image');
       }
     }

    function formatQuoteCurrency(amount) {
      // Get current currency from quote-currency selector or state
      const currency = document.getElementById('quote-currency')?.value || state.currency || 'INR';
      const symbols = {
        'INR': 'â‚¹',
        'USD': '$',
        'EUR': 'â‚¬',
        'GBP': 'Â£',
        'AUD': 'A$',
        'SAR': 'SAR ',
        'NGN': 'â‚¦',
        'AED': 'Ø¯.Ø¥ ',
        'JPY': 'Â¥'
      };
      
      // Convert amount if currency is not INR (assuming amount is in the selected currency already)
      // Since we're now storing prices in the selected currency, just format with the right symbol
      return `${symbols[currency] || 'â‚¹'}${amount.toFixed(2)}`;
    }

    // Quote Maker Price List Selector Functions
    function initQuoteMakerPriceListSelector() {
      console.log('Initializing Quote Maker price list selector...');
      
      // Clear existing price lists to ensure fresh data
      const quotePriceListSelector = document.getElementById('quote-price-list-selector');
      if (!quotePriceListSelector) {
        console.error('Quote price list selector element not found!');
        return;
      }
      
      // Extract unique price lists from existing data
      const quotePriceLists = new Set();
      state.allProducts.forEach(product => {
        if (product.PriceList) {
          quotePriceLists.add(product.PriceList);
        }
      });
      
      console.log('Available price lists for Quote Maker:', Array.from(quotePriceLists));
      
      // Update dropdown options
      quotePriceListSelector.innerHTML = '';
      const sortedQuotePriceLists = Array.from(quotePriceLists).sort();
      sortedQuotePriceLists.forEach(priceList => {
        const option = document.createElement('option');
        option.value = priceList;
        option.textContent = priceList;
        quotePriceListSelector.appendChild(option);
      });
      
      // Auto-select the first price list if available
      if (sortedQuotePriceLists.length > 0) {
        quotePriceListSelector.value = sortedQuotePriceLists[0];
        // Trigger the change event to filter products
        const event = new Event('change');
        quotePriceListSelector.dispatchEvent(event);
      }
      
      // Add event listener for price list selection
      quotePriceListSelector.addEventListener('change', handleQuoteMakerPriceListChange);
    }
    
    function handleQuoteMakerPriceListChange() {
      const selectedPriceList = document.getElementById('quote-price-list-selector').value;
      
      if (selectedPriceList) {
        // Filter products based on selected price list to prevent cross-contamination
        state.filteredProducts = state.allProducts.filter(product =>
          product.PriceList === selectedPriceList
        );
        
        console.log(`Quote Maker filtered to ${state.filteredProducts.length} products from price list: ${selectedPriceList}`);
        
        // Update categories dropdown to show only categories from selected price list
        populateQuoteDropdowns();
        
        // Update Quote Maker dropdowns with filtered data
        updateQuoteDropdownsWithFilteredData(state.filteredProducts);
        
        // Update color dropdown to show only colors from selected price list
        populateColorsDropdown();
        
        // Update catalog filters to reflect filtered products
        populateCatalogFilters();
        
        // Auto-select USD currency for USA25 price list
        if (selectedPriceList === 'USA25') {
          const currencySelect = document.getElementById('currency');
          if (currencySelect) {
            currencySelect.value = 'USD';
            state.currency = 'USD';
          }
        }
      } else {
        // Clear filtered products if no price list is selected
        state.filteredProducts = [];
      }
    }
    
    function updateQuoteDropdownsWithFilteredData(products) {
      // Update category dropdown with filtered data
      const categorySelect = document.getElementById('new-item-category');
      if (categorySelect) {
        const categories = [...new Set(products.map(p => p.Category))].filter(c => c).sort();
        categorySelect.innerHTML = '<option value="">Select Category</option>';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });
        
        // Reset dependent dropdowns
        const densitySelect = document.getElementById('new-item-density');
        const productSelect = document.getElementById('new-item-product');
        if (densitySelect) {
          densitySelect.innerHTML = '<option value="">Select Density</option>';
          densitySelect.disabled = true;
        }
        if (productSelect) {
          productSelect.innerHTML = '<option value="">Select Product</option>';
          productSelect.disabled = true;
        }
        
        // Update color dropdown with filtered data
        populateColorsDropdown();
      }
    }

    // Product Catalog Functions
    function initProductCatalog() {
      loadProductCatalog();
      setupCatalogEventListeners();
    }

    // Define comprehensive product catalog with proper image mapping
    // Helper functions for dynamic catalog generation
    function getProductImage(category) {
      const imageMap = {
        'Bulk': 'Bulk.png',
        'Weaves': 'Weaves-SD.png',
        'Weaves DD': 'Weaves-DD.png', 
        'Weaves SDD': 'Weaves-SDD.png',
        'Tapes': 'Tapes.png',
        'ClipOn': 'ClipOn.png',
        'Closures': 'Closure.png',
        'Frontals': 'Frontal.png',
        'Frontline': 'Frontline.png',
        'I Tips': 'ITIPS.png',
        'U Tips': 'UTIPS.png',
        'Y Tips': 'YTIPS.png',
        'Flat Tips': 'FlatTips.png',
        'Nano': 'Nano.png',
        'PonyTail': 'PonyTail.png',
        'BUN': 'BUN.png',
        'Curly Bun': 'CurlyBun.png',
        'Clutch Bun': 'ClutchBun.png',
        'Bangs': 'Bangs.png',
        'Halo': 'Halo.png',
        'Highlights': 'Highlights.png',
        'Cover Patch': 'CoverPatch.png',
        'Genius': 'Genius.png',
        'Wigs': 'WIGFRONTAL.png',
        'Wig Closure': 'WIGCLOSURE.png',
        'Wig Frontal': 'WIGFRONTAL.png',
        'Silk Topper': 'SILKTOPPER.png',
        'Flat Clip Ponytail': 'FLATCLIPPONYTAIL.png'
      };
      return imageMap[category] || 'template.png';
    }
    
    function getProductDescription(category) {
      const descriptionMap = {
        'Bulk': 'Premium bulk hair for various styling needs',
        'Weaves': 'High-quality weave extensions',
        'Weaves DD': 'Double drawn weave extensions for fuller look',
        'Weaves SDD': 'Super double drawn premium weaves',
        'Tapes': 'Seamless tape-in hair extensions',
        'ClipOn': 'Easy-to-use clip-in extensions',
        'Closures': 'Natural-looking lace closures',
        'Frontals': 'Full frontal lace pieces',
        'Frontline': 'Frontline hair systems',
        'I Tips': 'I-tip micro link extensions',
        'U Tips': 'U-tip keratin bond extensions',
        'Y Tips': 'Y-tip flat bond extensions',
        'Flat Tips': 'Flat tip keratin extensions',
        'Nano': 'Ultra-fine nano ring extensions',
        'PonyTail': 'Ready-to-wear ponytail pieces',
        'BUN': 'Instant bun hair pieces',
        'Curly Bun': 'Textured curly bun pieces',
        'Clutch Bun': 'Secure clutch bun accessories',
        'Bangs': 'Clip-in fringe pieces',
        'Halo': 'Invisible wire halo extensions',
        'Highlights': 'Color highlight pieces',
        'Cover Patch': 'Coverage patches for thinning areas',
        'Genius': 'Genius weft extensions',
        'Wigs': 'Full lace and synthetic wigs',
        'Wig Closure': 'Wig pieces with closure',
        'Wig Frontal': 'Wig pieces with frontal',
        'Silk Topper': 'Silk base hair toppers',
        'Flat Clip Ponytail': 'Flat clip ponytail extensions'
      };
      return descriptionMap[category] || 'Premium hair extension products';
    }

    // Product catalog is now generated dynamically from state.filteredProducts
    // No static catalog needed - prevents cross-contamination between price lists

    function populateCatalogFilters() {
      const categorySelect = document.getElementById('catalog-category');
      
      // Clear existing options
      categorySelect.innerHTML = '<option value="">All Categories</option>';
      
      // Add categories from filtered products (based on selected price list)
      if (state.filteredProducts && state.filteredProducts.length > 0) {
        const categories = [...new Set(state.filteredProducts.map(p => p.Category).filter(c => c))];
        categories.sort().forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });
      }
    }

    function loadProductCatalog(filters = {}) {
      populateCatalogFilters();
      
      // Get UI elements
      const productsGrid = document.getElementById('catalog-products-grid');
      const resultsCount = document.getElementById('catalog-results-count');
      const resultsCountDisplay = document.getElementById('catalog-results-count-display');
      const loadingElement = document.getElementById('catalog-loading');
      const emptyElement = document.getElementById('catalog-empty');
      
      // Show loading state
      if (loadingElement) {
        loadingElement.classList.remove('hidden');
        productsGrid.classList.add('hidden');
        if (emptyElement) emptyElement.classList.add('hidden');
      }
      
      // Simulate loading delay for better UX
      setTimeout(() => {
        // Generate dynamic catalog from filtered products
        let catalogData = {};
        if (state.filteredProducts && state.filteredProducts.length > 0) {
          state.filteredProducts.forEach(product => {
            if (product.Category && !catalogData[product.Category]) {
              catalogData[product.Category] = {
                image: getProductImage(product.Category),
                description: getProductDescription(product.Category),
                variants: []
              };
            }
            if (product.Category && product.Product && !catalogData[product.Category].variants.includes(product.Product)) {
              catalogData[product.Category].variants.push(product.Product);
            }
          });
        }
        
        let products = Object.entries(catalogData);
        
        // Apply filters
        if (filters.category) {
          products = products.filter(([category]) => category === filters.category);
        }
        
        if (filters.search) {
          const searchTerm = filters.search.toLowerCase();
          products = products.filter(([category, data]) => 
            category.toLowerCase().includes(searchTerm) ||
            data.description.toLowerCase().includes(searchTerm)
          );
        }
        
        // Update results count
        const countText = `${products.length} product${products.length !== 1 ? 's' : ''} found`;
        if (resultsCount) resultsCount.textContent = countText;
        if (resultsCountDisplay) resultsCountDisplay.textContent = countText;
        
        // Hide loading state
        if (loadingElement) loadingElement.classList.add('hidden');
        
        // Handle empty results
        if (products.length === 0) {
          if (emptyElement) {
            emptyElement.classList.remove('hidden');
            productsGrid.classList.add('hidden');
          } else {
            productsGrid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No products match your filters.</div>';
            productsGrid.classList.remove('hidden');
          }
          return;
        }
        
        // Show products grid
         productsGrid.classList.remove('hidden');
         if (emptyElement) emptyElement.classList.add('hidden');
       
         productsGrid.innerHTML = products.map(([category, data]) => {
        const imagePath = `images/Products/${data.image}`;
        
        return `
          <div class="bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-all duration-300 overflow-hidden group cursor-pointer" 
               onclick="showProductDetails('${category}')">
            <!-- Product Image -->
            <div class="aspect-square bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center overflow-hidden relative">
              <img src="${imagePath}" 
                   alt="${category}" 
                   class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                   onerror="this.src='/images/template.png'; this.onerror=null;"
                   loading="lazy">
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all duration-300"></div>
            </div>
            
            <!-- Product Details -->
            <div class="p-4">
              <h4 class="font-bold text-gray-800 mb-2 text-base leading-tight group-hover:text-blue-600 transition-colors duration-200">${category}</h4>
              <p class="text-sm text-gray-600 mb-3 line-clamp-2">${data.description}</p>
              
              <!-- Variants Preview -->
              <div class="mb-3">
                <div class="text-xs font-medium text-gray-500 mb-1">Available Options:</div>
                <div class="flex flex-wrap gap-1">
                  ${data.variants.slice(0, 3).map(variant => 
                    `<span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-full">${variant}</span>`
                  ).join('')}
                  ${data.variants.length > 3 ? `<span class="text-xs text-gray-500">+${data.variants.length - 3} more</span>` : ''}
                </div>
              </div>
              
              <!-- Action Button -->
              <button class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-all duration-200 transform group-hover:scale-105">
                View Details
              </button>
            </div>
          </div>
        `;
        }).join('');
      }, 300); // Close setTimeout
    }

    function setupCatalogEventListeners() {
      const filterBtn = document.getElementById('catalog-filter-btn');
      const clearBtn = document.getElementById('catalog-clear-btn');
      const searchInput = document.getElementById('catalog-search');
      const gridViewBtn = document.getElementById('catalog-grid-view');
      const listViewBtn = document.getElementById('catalog-list-view');

      filterBtn.addEventListener('click', applyCatalogFilters);
      clearBtn.addEventListener('click', clearCatalogFilters);
      
      // Grid/List view toggle
      if (gridViewBtn) {
        gridViewBtn.addEventListener('click', () => {
          const productsGrid = document.getElementById('catalog-products-grid');
          productsGrid.className = productsGrid.className.replace(/grid-cols-\d+/, 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4');
          gridViewBtn.classList.add('bg-blue-500', 'text-white');
          gridViewBtn.classList.remove('bg-gray-100', 'text-gray-600');
          if (listViewBtn) {
            listViewBtn.classList.remove('bg-blue-500', 'text-white');
            listViewBtn.classList.add('bg-gray-100', 'text-gray-600');
          }
        });
      }
      
      if (listViewBtn) {
        listViewBtn.addEventListener('click', () => {
          const productsGrid = document.getElementById('catalog-products-grid');
          productsGrid.className = productsGrid.className.replace(/grid-cols-\d+/, 'grid-cols-1');
          listViewBtn.classList.add('bg-blue-500', 'text-white');
          listViewBtn.classList.remove('bg-gray-100', 'text-gray-600');
          if (gridViewBtn) {
            gridViewBtn.classList.remove('bg-blue-500', 'text-white');
            gridViewBtn.classList.add('bg-gray-100', 'text-gray-600');
          }
        });
      }
      
      // Search on Enter key and real-time search
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          applyCatalogFilters();
        }
      });
      
      // Real-time search with debounce
      let searchTimeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          applyCatalogFilters();
        }, 300);
      });
      
      // Category filter change
      document.getElementById('catalog-category').addEventListener('change', applyCatalogFilters);
      
      // Event delegation for View Details buttons
      document.addEventListener('click', (e) => {
        if (e.target.textContent === 'View Details' && e.target.closest('.group')) {
          const productCard = e.target.closest('.group');
          const categoryElement = productCard.querySelector('h3');
          if (categoryElement) {
            const category = categoryElement.textContent.trim();
            showProductDetails(category);
          }
        }
      });
    }

    function applyCatalogFilters() {
      const filters = {
        category: document.getElementById('catalog-category').value,
        search: document.getElementById('catalog-search').value
      };
      loadProductCatalog(filters);
    }

    function clearCatalogFilters() {
      document.getElementById('catalog-category').value = '';
      document.getElementById('catalog-search').value = '';
      loadProductCatalog();
    }
    
    function showProductDetails(category) {
      // Generate product data dynamically from filtered products
      const categoryProducts = state.filteredProducts.filter(p => p.Category === category);
      if (categoryProducts.length === 0) return;
      
      const product = {
        image: getProductImage(category),
        description: getProductDescription(category),
        variants: [...new Set(categoryProducts.map(p => p.Product))].filter(p => p)
      };
      
      // Create modal for product details
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center">
            <h2 class="text-2xl font-bold text-gray-800">${category}</h2>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
          
          <div class="p-6">
            <div class="grid md:grid-cols-2 gap-6">
              <!-- Product Image -->
              <div class="aspect-square bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg overflow-hidden">
                <img src="/images/Products/${product.image}" 
                     alt="${category}" 
                     class="w-full h-full object-cover"
                     onerror="this.src='/images/template.png'; this.onerror=null;">
              </div>
              
              <!-- Product Info -->
              <div>
                <h3 class="text-xl font-semibold text-gray-800 mb-4">${category}</h3>
                <p class="text-gray-600 mb-6">${product.description}</p>
                
                <div class="mb-6">
                  <h4 class="font-semibold text-gray-800 mb-3">Available Options:</h4>
                  <div class="grid grid-cols-2 gap-2">
                    ${product.variants.map(variant => 
                      `<div class="bg-blue-50 text-blue-700 px-3 py-2 rounded-lg text-sm font-medium text-center">${variant}</div>`
                    ).join('')}
                  </div>
                </div>
                
                <div class="space-y-3">
                  <button onclick="addToQuote('${category}')" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200">
                    Add to Quote
                  </button>
                  <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all duration-200">
                    Close
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close modal on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }
    
    function addToQuote(category) {
      // Switch to quote maker module
      showModule('quote-maker-module');
      
      // Set the category in the quote maker
      const categorySelect = document.getElementById('new-item-category');
      if (categorySelect) {
        // Add option if it doesn't exist
        let optionExists = false;
        for (let option of categorySelect.options) {
          if (option.value === category) {
            optionExists = true;
            break;
          }
        }
        
        if (!optionExists) {
          const newOption = document.createElement('option');
          newOption.value = category;
          newOption.textContent = category;
          categorySelect.appendChild(newOption);
        }
        
        categorySelect.value = category;
        
        // Trigger change event to update dependent fields
        categorySelect.dispatchEvent(new Event('change'));
      }
      
      // Close the modal
      const modal = document.querySelector('.fixed.inset-0');
      if (modal) modal.remove();
      
      // Show success message
      const message = document.createElement('div');
      message.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
      message.textContent = `${category} added to quote maker`;
      document.body.appendChild(message);
      
      setTimeout(() => {
        message.remove();
      }, 3000);
    }

    // Financial Controls Functions
    function initFinancialControls() {
      // Initialize currency selector
      const currencySelect = document.getElementById('currency-selector');
      if (currencySelect) {
        currencySelect.addEventListener('change', handleCurrencyChange);
      }

      // Initialize discount controls
      const discountInput = document.getElementById('discount-input');
      if (discountInput) {
        discountInput.addEventListener('input', updateQuoteCalculations);
      }

      // Initialize tax controls
      const taxInput = document.getElementById('tax-input');
      if (taxInput) {
        taxInput.addEventListener('input', updateQuoteCalculations);
      }

      // Initialize shipping controls
      const shippingInput = document.getElementById('shipping-input');
      if (shippingInput) {
        shippingInput.addEventListener('input', updateQuoteCalculations);
      }

      // Initialize price list selector
      const priceListSelector = document.getElementById('quote-price-list-selector');
      if (priceListSelector) {
        priceListSelector.addEventListener('change', handleQuotePriceListChange);
        initPriceListOptions();
      }
    }

    async function handleCurrencyChange() {
      const currencySelect = document.getElementById('currency-selector');
      const selectedCurrency = currencySelect.value;
      
      // Update global currency state
      state.currency = selectedCurrency;
      
      // Fetch fresh exchange rates when currency changes
      await refreshRates(false);
      
      // Update currency preview with complete symbol set
      const currencyPreview = document.getElementById('currency-preview');
      if (currencyPreview) {
        const symbols = { 
          'INR': 'â‚¹', 'USD': '$', 'EUR': 'â‚¬', 'GBP': 'Â£', 
          'AUD': 'A$', 'SAR': 'SR', 'NGN': 'â‚¦', 'AED': 'Ø¯.Ø¥', 'JPY': 'Â¥' 
        };
        currencyPreview.textContent = `${symbols[selectedCurrency] || 'â‚¹'} ${selectedCurrency}`;
      }
      
      // Sync with price list if needed
      const priceListSelector = document.getElementById('quote-price-list-selector');
      if (selectedCurrency === 'USD' && priceListSelector) {
        priceListSelector.value = 'USA25';
        handlePriceListChange();
      }
      
      // Update all calculations and displays with fresh rates
      updateQuoteCalculations();
      updateAllPrices();
    }

    function handleDiscountToggle() {
      const discountToggle = document.getElementById('discount-toggle');
      const discountPercentage = document.getElementById('discount-percentage');
      const discountFixed = document.getElementById('discount-fixed');
      const discountPreview = document.getElementById('discount-preview');
      
      if (discountToggle.checked) {
        // Percentage mode
        discountPercentage.style.display = 'block';
        discountFixed.style.display = 'none';
        discountFixed.value = '';
        if (discountPreview) {
          const value = parseFloat(discountPercentage.value) || 0;
          discountPreview.textContent = `${value}%`;
        }
      } else {
        // Fixed amount mode
        discountPercentage.style.display = 'none';
        discountFixed.style.display = 'block';
        discountPercentage.value = '';
        if (discountPreview) {
          const value = parseFloat(discountFixed.value) || 0;
          const currency = state.currency || 'INR';
          const symbols = { 'INR': 'â‚¹', 'USD': '$', 'EUR': 'â‚¬', 'GBP': 'Â£', 'AUD': 'A$', 'SAR': 'SAR ', 'NGN': 'â‚¦', 'AED': 'Ø¯.Ø¥ ', 'JPY': 'Â¥' };
          discountPreview.textContent = `${symbols[currency]}${value.toFixed(2)}`;
        }
      }
      updateQuoteCalculations();
    }

    // handleTaxToggle function removed - replaced by handleTaxTypeChange

    // handleShippingToggle function removed - replaced by handleShippingTypeChange

    function handleQuotePriceListChange() {
      const priceListSelector = document.getElementById('quote-price-list-selector');
      if (!priceListSelector) {
        console.error('Price list selector not found');
        return;
      }
      const selectedPriceList = priceListSelector.value;
      
      if (selectedPriceList) {
        // Use already filtered products from price list selection
        // Update dropdowns with filtered data
        updateQuoteDropdownsWithFilteredData(state.filteredProducts);
        
        // Auto-select currency for specific price lists
        if (selectedPriceList === 'USA25') {
          const currencySelect = document.getElementById('currency-selector');
          if (currencySelect) {
            currencySelect.value = 'USD';
            handleCurrencyChange();
          }
        }
      } else {
        // Show all products
        updateQuoteDropdownsWithFilteredData(state.filteredProducts);
      }
    }

    function initPriceListOptions() {
      const priceListSelector = document.getElementById('quote-price-list-selector');
      if (!priceListSelector) return;
      
      // Extract unique price lists
      const priceLists = new Set();
      state.allProducts.forEach(product => {
        if (product.PriceList) {
          priceLists.add(product.PriceList);
        }
      });
      
      // Update dropdown options
      priceListSelector.innerHTML = '';
      const sortedPriceLists = Array.from(priceLists).sort();
      sortedPriceLists.forEach(priceList => {
        const option = document.createElement('option');
        option.value = priceList;
        option.textContent = priceList;
        priceListSelector.appendChild(option);
      });
      
      // Auto-select the first price list if available
      if (sortedPriceLists.length > 0) {
        priceListSelector.value = sortedPriceLists[0];
      }
    }

    // New dropdown handler functions
    function handleDiscountTypeChange(type) {
      const discountValue = document.getElementById('discount-value');
      const discountPreview = document.getElementById('discount-preview');
      
      if (type === 'percentage') {
        discountValue.placeholder = '0';
        discountValue.max = '100';
      } else {
        discountValue.placeholder = '0';
        discountValue.removeAttribute('max');
      }
      updateQuoteCalculations();
    }

    function handleTaxTypeChange(type) {
      const taxRate = document.getElementById('tax-rate');
      const taxPreview = document.getElementById('tax-preview');
      
      if (type === 'tax-free') {
        taxRate.disabled = true;
        taxRate.value = '';
        if (taxPreview) {
          taxPreview.textContent = 'Tax: â‚¹0.00';
        }
      } else {
        taxRate.disabled = false;
      }
      updateQuoteCalculations();
    }

    function handleShippingTypeChange(type) {
      const shippingCost = document.getElementById('shipping-cost');
      const shippingPreview = document.getElementById('shipping-preview');
      
      if (type === 'free') {
        shippingCost.disabled = true;
        shippingCost.value = '';
        if (shippingPreview) {
          shippingPreview.textContent = 'Shipping: â‚¹0.00';
        }
      } else {
        shippingCost.disabled = false;
      }
      updateQuoteCalculations();
    }

    function updateQuoteCalculations() {
      // Recalculate and re-render the quote items table
      renderQuoteItems();
    }

    function calculateFinancialTotals(subtotal) {
      const currency = state.currency || 'INR';
      
      // Use dynamic exchange rates from state
      const exchangeRates = state.rates.rates || DEFAULT_RATES.rates;
      
      // Convert subtotal from INR to selected currency
      let convertedSubtotal = subtotal;
      if (currency !== 'INR') {
        const rate = exchangeRates[currency] || 1;
        convertedSubtotal = subtotal * rate;
      }
      
      // Calculate discount
      let discountAmount = 0;
      const discountInput = document.getElementById('discount-input');
      
      if (discountInput && discountInput.value.trim()) {
        const discountValue = discountInput.value.trim();
        if (discountValue.includes('%')) {
          // Percentage discount
          const percentage = parseFloat(discountValue.replace('%', '')) || 0;
          discountAmount = (convertedSubtotal * percentage) / 100;
        } else {
          // Fixed discount - already in selected currency
          discountAmount = parseFloat(discountValue) || 0;
        }
      }
      
      const afterDiscount = convertedSubtotal - discountAmount;
      
      // Calculate tax
      let taxAmount = 0;
      const taxInput = document.getElementById('tax-input');
      
      if (taxInput && taxInput.value.trim()) {
        const taxValue = taxInput.value.trim();
        // Parse percentage (remove % if present)
        const taxPercent = parseFloat(taxValue.replace('%', '')) || 0;
        taxAmount = (afterDiscount * taxPercent) / 100;
      }
      
      const afterTax = afterDiscount + taxAmount;
      
      // Calculate shipping
      let shippingAmount = 0;
      const shippingInput = document.getElementById('shipping-input');
      
      if (shippingInput && shippingInput.value.trim()) {
        // Convert shipping cost from INR to selected currency
        const baseShippingAmount = parseFloat(shippingInput.value.trim()) || 0;
        if (currency !== 'INR') {
          const rate = exchangeRates[currency] || 1;
          shippingAmount = baseShippingAmount * rate;
        } else {
          shippingAmount = baseShippingAmount;
        }
      }
      
      const grandTotal = afterTax + shippingAmount;
      
      return {
         subtotal: convertedSubtotal,
         discountAmount,
         afterDiscount,
         taxAmount,
         afterTax,
         shippingAmount,
         grandTotal
       };
     }

     function updateFinancialPreviews(financials) {
       // Update discount preview
       const discountPreview = document.getElementById('discount-preview');
       const discountInput = document.getElementById('discount-input');
       
       if (discountPreview && discountInput && discountInput.value.trim()) {
         const discountValue = discountInput.value.trim();
         if (discountValue.includes('%')) {
           discountPreview.textContent = discountValue;
         } else {
           const currency = state.currency || 'INR';
           const symbols = { 'INR': 'â‚¹', 'USD': '$', 'EUR': 'â‚¬', 'GBP': 'Â£', 'AUD': 'A$', 'SAR': 'SAR ', 'NGN': 'â‚¦', 'AED': 'Ø¯.Ø¥ ', 'JPY': 'Â¥' };
           const value = parseFloat(discountValue) || 0;
           discountPreview.textContent = `${symbols[currency]}${value.toFixed(2)}`;
         }
       } else if (discountPreview) {
         discountPreview.textContent = 'No Discount';
       }
       
       // Update tax preview
       const taxPreview = document.getElementById('tax-preview');
       const taxInput = document.getElementById('tax-input');
       
       if (taxPreview) {
         if (taxInput && taxInput.value.trim()) {
           const taxValue = taxInput.value.trim();
           const percentage = parseFloat(taxValue.replace('%', '')) || 0;
           taxPreview.textContent = `${percentage}%`;
         } else {
           taxPreview.textContent = 'Tax Free';
         }
       }
       
       // Update shipping preview
       const shippingPreview = document.getElementById('shipping-preview');
       const shippingInput = document.getElementById('shipping-input');
       
       if (shippingPreview) {
         if (shippingInput && shippingInput.value.trim()) {
           const value = parseFloat(shippingInput.value.trim()) || 0;
           if (value === 0) {
             shippingPreview.textContent = 'Free Shipping';
           } else {
             const currency = state.currency || 'INR';
             const symbols = { 'INR': 'â‚¹', 'USD': '$', 'EUR': 'â‚¬', 'GBP': 'Â£', 'AUD': 'A$', 'SAR': 'SAR ', 'NGN': 'â‚¦', 'AED': 'Ø¯.Ø¥ ', 'JPY': 'Â¥' };
             shippingPreview.textContent = `${symbols[currency]}${value.toFixed(2)}`;
           }
         } else {
           shippingPreview.textContent = 'Free Shipping';
         }
       }
     }

     // Validation functions for financial inputs
     function validatePercentage(input) {
       const value = parseFloat(input.value);
       if (isNaN(value) || value < 0 || value > 100) {
         input.setCustomValidity('Please enter a percentage between 0 and 100');
         input.classList.add('border-red-500');
         return false;
       } else {
         input.setCustomValidity('');
         input.classList.remove('border-red-500');
         return true;
       }
     }

     function validateCurrency(input) {
       const value = parseFloat(input.value);
       if (isNaN(value) || value < 0) {
         input.setCustomValidity('Please enter a valid positive amount');
         input.classList.add('border-red-500');
         return false;
       } else {
         input.setCustomValidity('');
         input.classList.remove('border-red-500');
         return true;
       }
     }

     function addInputValidation() {
       // Add validation to discount and tax value inputs
       const discountValue = document.getElementById('discount-value');
       const taxRate = document.getElementById('tax-rate');
       const shippingCost = document.getElementById('shipping-cost');
       
       if (discountValue) {
         discountValue.addEventListener('blur', () => validateCurrency(discountValue));
         discountValue.addEventListener('input', () => {
           if (discountValue.value) validateCurrency(discountValue);
         });
       }
       
       if (taxRate) {
         taxRate.addEventListener('blur', () => validatePercentage(taxRate));
         taxRate.addEventListener('input', () => {
           if (taxRate.value) validatePercentage(taxRate);
         });
       }
       
       if (shippingCost) {
         shippingCost.addEventListener('blur', () => validateCurrency(shippingCost));
         shippingCost.addEventListener('input', () => {
           if (shippingCost.value) validateCurrency(shippingCost);
         });
       }
     }

     // Table sorting functionality
     let currentSort = { column: null, direction: 'asc' };
     
     function initTableSorting() {
       const sortableHeaders = document.querySelectorAll('.sortable');
       sortableHeaders.forEach(header => {
         header.addEventListener('click', () => {
           const sortColumn = header.getAttribute('data-sort');
           sortTable(sortColumn);
         });
       });
     }
     
     function sortTable(column) {
       const tbody = document.querySelector('#items-table tbody');
       const rows = Array.from(tbody.querySelectorAll('tr'));
       
       // Determine sort direction
       if (currentSort.column === column) {
         currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
       } else {
         currentSort.direction = 'asc';
       }
       currentSort.column = column;
       
       // Update sort indicators
       updateSortIndicators(column, currentSort.direction);
       
       // Sort rows
       rows.sort((a, b) => {
         let aValue = getCellValue(a, column);
         let bValue = getCellValue(b, column);
         
         // Handle numeric sorting
         if (column === 'qty' || column === 'price' || column === 'total' || column === 'weight') {
           aValue = parseFloat(aValue) || 0;
           bValue = parseFloat(bValue) || 0;
         }
         
         if (aValue < bValue) return currentSort.direction === 'asc' ? -1 : 1;
         if (aValue > bValue) return currentSort.direction === 'asc' ? 1 : -1;
         return 0;
       });
       
       // Re-append sorted rows
       rows.forEach(row => tbody.appendChild(row));
     }
     
     function getCellValue(row, column) {
       const columnMap = {
         'product': 1,
         'variant': 2,
         'length': 3,
         'weight': 4,
         'qty': 5,
         'price': 6,
         'total': 7
       };
       
       const cell = row.cells[columnMap[column]];
       return cell ? cell.textContent.trim().replace(/[^\d.-]/g, '') : '';
     }
     
     function updateSortIndicators(activeColumn, direction) {
       // Reset all indicators
       document.querySelectorAll('.sort-indicator').forEach(indicator => {
         indicator.textContent = 'â†•';
       });
       
       // Set active indicator
       const activeHeader = document.querySelector(`[data-sort="${activeColumn}"] .sort-indicator`);
       if (activeHeader) {
         activeHeader.textContent = direction === 'asc' ? 'â†‘' : 'â†“';
       }
     }

     // Local storage functionality
     function saveQuoteToStorage() {
       const quoteData = {
         items: quoteItems,
         currency: document.getElementById('currency-selector')?.value || 'INR',
         priceList: document.getElementById('quote-price-list-selector')?.value || '',
         discount: {
           type: (() => {
             const discountInput = document.getElementById('discount-input');
             if (discountInput && discountInput.value.trim()) {
               return discountInput.value.includes('%') ? 'percentage' : 'fixed';
             }
             return 'none';
           })(),
           value: (() => {
             const discountInput = document.getElementById('discount-input');
             if (discountInput && discountInput.value.trim()) {
               return discountInput.value.replace('%', '');
             }
             return '0';
           })()
         },
         tax: {
           type: (() => {
             const taxInput = document.getElementById('tax-input');
             if (taxInput && taxInput.value.trim()) {
               return 'taxable';
             }
             return 'tax-free';
           })(),
           rate: (() => {
             const taxInput = document.getElementById('tax-input');
             if (taxInput && taxInput.value.trim()) {
               return taxInput.value.replace('%', '');
             }
             return '0';
           })()
         },
         shipping: {
           type: (() => {
             const shippingInput = document.getElementById('shipping-input');
             if (shippingInput && shippingInput.value.trim() && parseFloat(shippingInput.value.trim()) > 0) {
               return 'paid';
             }
             return 'free';
           })(),
           cost: document.getElementById('shipping-input')?.value || '0'
         },
         notes: document.getElementById('notes-terms')?.value || '',
         timestamp: new Date().toISOString()
       };
       
       localStorage.setItem('currentQuote', JSON.stringify(quoteData));
     }
     
     function loadQuoteFromStorage() {
       try {
         const savedQuote = localStorage.getItem('currentQuote');
         if (savedQuote) {
           const quoteData = JSON.parse(savedQuote);
           
           // Restore items
           if (quoteData.items && Array.isArray(quoteData.items)) {
             quoteItems = quoteData.items;
             renderQuoteItems();
           }
           
           // Restore currency
           const currencySelect = document.getElementById('currency-selector');
           if (currencySelect && quoteData.currency) {
             currencySelect.value = quoteData.currency;
           }
           
           // Restore price list
           const priceListSelect = document.getElementById('quote-price-list-selector');
           if (priceListSelect && quoteData.priceList) {
             priceListSelect.value = quoteData.priceList;
           }
           
           // Restore discount
           if (quoteData.discount) {
             const discountInput = document.getElementById('discount-input');
             if (discountInput && quoteData.discount.value && quoteData.discount.value !== '0') {
               if (quoteData.discount.type === 'percentage') {
                 discountInput.value = quoteData.discount.value + '%';
               } else {
                 discountInput.value = quoteData.discount.value;
               }
             }
           }
           
           // Restore tax
           if (quoteData.tax) {
             const taxInput = document.getElementById('tax-input');
             if (taxInput && quoteData.tax.rate && quoteData.tax.rate !== '0') {
               taxInput.value = quoteData.tax.rate + '%';
             }
           }
           
           // Restore shipping
           if (quoteData.shipping) {
             const shippingInput = document.getElementById('shipping-input');
             if (shippingInput && quoteData.shipping.cost && quoteData.shipping.cost !== '0') {
               shippingInput.value = quoteData.shipping.cost;
             }
           }
           
           // Restore notes
           const notesField = document.getElementById('notes-terms');
           if (notesField && quoteData.notes) {
             notesField.value = quoteData.notes;
           }
         }
       } catch (error) {
         console.warn('Failed to load quote from storage:', error);
       }
     }
     
     function clearQuoteStorage() {
       localStorage.removeItem('currentQuote');
     }

     // Add visual indicators for editable fields
     function addVisualIndicators() {
       // Add focus and blur effects to all input fields
       const inputs = document.querySelectorAll('input[type="number"], input[type="text"], select, textarea');
       inputs.forEach(input => {
         input.addEventListener('focus', function() {
           this.classList.add('ring-2', 'ring-blue-300', 'border-blue-500');
         });
         
         input.addEventListener('blur', function() {
           this.classList.remove('ring-2', 'ring-blue-300');
           if (!this.classList.contains('border-red-500')) {
             this.classList.remove('border-blue-500');
             this.classList.add('border-gray-300');
           }
         });
       });
       
       // Add hover effects to buttons
       const buttons = document.querySelectorAll('button');
       buttons.forEach(button => {
         if (!button.classList.contains('hover:bg-gray-200')) {
           button.classList.add('hover:opacity-90', 'transition-opacity');
         }
       });
       
       // Auto-save functionality
       const autoSaveElements = document.querySelectorAll('#discount-input, #tax-input, #shipping-input, #notes-terms, #quote-currency, #quote-price-list-selector');
       autoSaveElements.forEach(element => {
         element.addEventListener('input', () => {
           clearTimeout(window.autoSaveTimeout);
           window.autoSaveTimeout = setTimeout(saveQuoteToStorage, 1000); // Save after 1 second of inactivity
         });
       });
       
       autoSaveElements.forEach(element => {
         element.addEventListener('change', () => {
           clearTimeout(window.autoSaveTimeout);
           window.autoSaveTimeout = setTimeout(saveQuoteToStorage, 1000); // Save after 1 second of inactivity
         });
       });
     }

     // Function to populate salesman dropdown
     async function populateSalesmanDropdown() {
       console.log('populateSalesmanDropdown called');
       try {
         const response = await fetch('/api/get-data');
         const result = await response.json();
         console.log('API response:', result);
         
         if (result.success && result.salesmen) {
           const salesmenData = result.salesmen;
           
           const salesmanSelect = document.getElementById('salesman-name');
           if (salesmanSelect && salesmenData.length > 0) {
             // Clear existing options except the first one
             salesmanSelect.innerHTML = '<option value="">Select Sales Representative</option>';
             
             // Add salesmen options
             salesmenData.forEach(salesman => {
               const option = document.createElement('option');
               option.value = salesman;
               option.textContent = salesman;
               salesmanSelect.appendChild(option);
             });
             
             // Try to restore previously selected salesman from localStorage
              const savedSalesman = localStorage.getItem('selectedSalesman');
              if (savedSalesman && salesmanSelect.querySelector(`option[value="${savedSalesman}"]`)) {
                salesmanSelect.value = savedSalesman;
              }
           }
         }
       } catch (error) {
         console.error('Error loading salesmen data:', error);
         // Fallback: add enhanced default salesmen if API fails
         console.log('Using fallback salesmen data');
         const salesmanSelect = document.getElementById('salesman-name');
         console.log('Salesman select element:', salesmanSelect);
         if (salesmanSelect) {
           const defaultSalesmen = [
             'John Smith - Senior Sales Manager',
             'Sarah Johnson - Regional Sales Director', 
             'Michael Brown - Account Executive',
             'Emily Davis - Sales Representative',
             'David Wilson - Business Development Manager',
             'Lisa Chen - Key Account Manager',
             'Robert Taylor - Sales Consultant',
             'Jennifer Martinez - Territory Manager'
           ];
           salesmanSelect.innerHTML = '<option value="">Select Sales Representative</option>';
           defaultSalesmen.forEach(salesman => {
             const option = document.createElement('option');
             option.value = salesman;
             option.textContent = salesman;
             salesmanSelect.appendChild(option);
           });
           
           // Try to restore previously selected salesman from localStorage
           const savedSalesman = localStorage.getItem('selectedSalesman');
           if (savedSalesman && salesmanSelect.querySelector(`option[value="${savedSalesman}"]`)) {
             salesmanSelect.value = savedSalesman;
           }
         }
       }
     }

     // Add event listener to save selected salesman to localStorage
     document.addEventListener('DOMContentLoaded', function() {
       const salesmanSelect = document.getElementById('salesman-name');
       if (salesmanSelect) {
         salesmanSelect.addEventListener('change', function() {
           if (this.value) {
             localStorage.setItem('selectedSalesman', this.value);
           } else {
             localStorage.removeItem('selectedSalesman');
           }
         });
       }
     });

     // Dynamic Rate Calculation Function
     function calculateAndDisplayRate() {
       const category = document.getElementById('new-item-category')?.value;
       const density = document.getElementById('new-item-density')?.value;
       const product = document.getElementById('new-item-product')?.value;
       const length = document.getElementById('new-item-length')?.value;
       const color = document.getElementById('new-item-color')?.value;
       const quantity = parseFloat(document.getElementById('new-item-quantity')?.value) || 1;
       const overridePrice = parseFloat(document.getElementById('new-item-override-price')?.value);
       
       const rateDisplay = document.getElementById('dynamic-rate-display');
       const rateAmount = document.getElementById('rate-amount');
       const rateDetails = document.getElementById('rate-details');
       const baseRateValue = document.getElementById('base-rate-value');
       const currencyRateValue = document.getElementById('currency-rate-value');
       const rateBreakdown = document.getElementById('rate-breakdown');
       
       if (!category || !product || !state.filteredProducts || state.filteredProducts.length === 0) {
         rateDisplay.classList.add('hidden');
         return;
       }
       
       // Use already filtered products from price list selection
       const productsToFilter = state.filteredProducts;
       
       // Find matching product with all available criteria
       let matchingProduct = null;
       
       // Try to match with all criteria
       if (length && color) {
         matchingProduct = productsToFilter.find(p => 
           p.Category === category && 
           p.Density === density && 
           p.Product === product && 
           Number(p.Length) === Number(length) &&
           p.Colors === color
         );
       }
       
       // Fallback matches
       if (!matchingProduct && length) {
         matchingProduct = productsToFilter.find(p => 
           p.Category === category && 
           p.Density === density && 
           p.Product === product && 
           Number(p.Length) === Number(length)
         );
       }
       
       if (!matchingProduct && color) {
         matchingProduct = productsToFilter.find(p => 
           p.Category === category && 
           p.Density === density && 
           p.Product === product && 
           p.Colors === color
         );
       }
       
       if (!matchingProduct) {
         matchingProduct = productsToFilter.find(p => 
           p.Category === category && 
           p.Density === density && 
           p.Product === product
         );
       }
       
       if (!matchingProduct) {
         rateDisplay.classList.add('hidden');
         return;
       }
       
       // Calculate rate
       let baseRate = parseFloat(matchingProduct.Rate) || 0;
       let finalRate = overridePrice || baseRate;
       
       // Get current currency and convert if needed
       const selectedCurrency = document.getElementById('quote-currency')?.value || state.currency || 'INR';
       const exchangeRates = state.rates?.rates || {};
       const currencySymbols = { 'INR': 'â‚¹', 'USD': '$', 'EUR': 'â‚¬', 'GBP': 'Â£', 'AUD': 'A$', 'SAR': 'SAR ', 'NGN': 'â‚¦', 'AED': 'Ø¯.Ø¥ ', 'JPY': 'Â¥' };
       
       let displayRate = finalRate;
       if (selectedCurrency !== 'INR') {
         const rate = exchangeRates[selectedCurrency] || 1;
         displayRate = finalRate * rate;
       }
       
       // Update display
       rateDisplay.classList.remove('hidden');
       rateAmount.textContent = `${currencySymbols[selectedCurrency] || ''}${displayRate.toFixed(2)}`;
       rateDetails.textContent = `per unit${quantity > 1 ? ` (Total: ${currencySymbols[selectedCurrency] || ''}${(displayRate * quantity).toFixed(2)})` : ''}`;
       
       // Update breakdown
       baseRateValue.textContent = `â‚¹${baseRate.toFixed(2)}`;
       currencyRateValue.textContent = selectedCurrency;
       
       if (overridePrice || selectedCurrency !== 'INR') {
         rateBreakdown.classList.remove('hidden');
       } else {
         rateBreakdown.classList.add('hidden');
       }
     }
     
     // Add event listeners for real-time rate updates
     function initDynamicRateDisplay() {
       const formElements = [
         'new-item-category',
         'new-item-density', 
         'new-item-product',
         'new-item-length',
         'new-item-color',
         'new-item-quantity',
         'new-item-override-price',
         'quote-currency',
         'quote-price-list-selector'
       ];
       
       formElements.forEach(elementId => {
         const element = document.getElementById(elementId);
         if (element) {
           element.addEventListener('change', calculateAndDisplayRate);
           element.addEventListener('input', calculateAndDisplayRate);
         }
       });
     }

     // Initialize financial controls when page loads
     document.addEventListener('DOMContentLoaded', function() {
       // Initialize financial controls after a short delay to ensure all elements are loaded
       setTimeout(() => {
         initFinancialControls();
         addInputValidation();
         initTableSorting();
         addVisualIndicators();
         
         // Initialize dynamic rate display
         initDynamicRateDisplay();
         
         // Populate salesman dropdown with additional delay
         setTimeout(() => {
           initPriceCalculatorSalesmanDropdown();
           populateSalesmanDropdown(); // For quote-maker module
         }, 1000);
         
         // Clear all quote data for fresh start
         clearAllQuoteData();
         
         // Render saved quotes list
         renderSavedQuotesList();
         
         // Set default values only if not loaded from storage
         const currencySelect = document.getElementById('currency-selector');
         if (currencySelect && !currencySelect.value) {
           currencySelect.value = 'INR';
           handleCurrencyChange();
         }
         
         // Set default dropdown values only if not loaded from storage
         const discountType = document.getElementById('discount-type');
         const taxOptions = document.getElementById('tax-options');
         const shippingOptions = document.getElementById('shipping-options');
         
         if (discountType && !discountType.value) {
           discountType.value = 'percentage';
           handleDiscountTypeChange('percentage');
         }
         
         if (taxOptions && !taxOptions.value) {
           taxOptions.value = 'tax-free';
           handleTaxTypeChange('tax-free');
         }
         
         if (shippingOptions && !shippingOptions.value) {
           shippingOptions.value = 'free';
           handleShippingTypeChange('free');
         }
         
         // Add event listeners for dropdown changes
         if (discountType) {
           discountType.addEventListener('change', function() {
             handleDiscountTypeChange(this.value);
           });
         }
         
         if (taxOptions) {
           taxOptions.addEventListener('change', function() {
             handleTaxTypeChange(this.value);
           });
         }
         
         if (shippingOptions) {
           shippingOptions.addEventListener('change', function() {
             handleShippingTypeChange(this.value);
           });
         }
       }, 500);
     });


    </script>
</body>
</html>
