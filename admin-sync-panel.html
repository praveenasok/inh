<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Synchronization Panel - InstaQuote</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- Set Google Sheets API Key before loading config -->
    <script>
        window.GOOGLE_SHEETS_API_KEY = '35bbf27b0bf3abb0a9fec63e815006a5785ec7bb';
    </script>
    <script src="google-sheets-config.js"></script>
    
    <!-- Data Management Scripts -->
    <script src="js/universal-firebase-data-manager.js"></script>
    <script src="js/local-fallback-manager.js"></script>
    <script src="js/fallback-detector.js"></script>
    <script src="js/unified-data-access.js"></script>
    <script src="comprehensive-sync-system.js"></script>
    <script src="cross-component-data-access.js"></script>
    
    <style>
        .sync-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-connected { background-color: #10b981; }
        .status-disconnected { background-color: #ef4444; }
        .status-syncing { background-color: #f59e0b; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            transition: width 0.3s ease;
        }
        
        .data-table {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .collection-card {
            transition: all 0.3s ease;
        }
        
        .collection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-blue-900 via-blue-800 to-amber-700 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <img src="images/logo.png" alt="Logo" class="h-8 w-auto opacity-90">
                    <span class="text-lg font-bold">InstaQuote - Admin Sync Panel</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="quote-maker-v2-ver3.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-white/10 transition-colors">
                        <i class="fas fa-file-invoice-dollar mr-1"></i> Quote Maker
                    </a>
                    <a href="product-catalog.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-white/10 transition-colors">
                        <i class="fas fa-th-large mr-1"></i> Catalog
                    </a>
                    <a href="price-calculator.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-white/10 transition-colors">
                        <i class="fas fa-calculator mr-1"></i> Calculator
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Data Synchronization Control Center</h1>
            <p class="text-gray-600">Comprehensive 3-stage synchronization: Google Sheets → Firebase → Local Storage</p>
            <div class="mt-2">
                <span class="text-sm text-gray-500">Device ID: </span>
                <span id="device-id" class="text-sm font-mono text-gray-700">Loading...</span>
            </div>
        </div>

        <!-- Sync Control Panel -->
        <div class="sync-card text-white p-8 mb-8">
            <div class="flex flex-col lg:flex-row items-center justify-between">
                <div class="mb-6 lg:mb-0">
                    <h2 class="text-2xl font-bold mb-2">Synchronization Control</h2>
                    <p class="opacity-90">Execute comprehensive data synchronization across all systems</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="comprehensive-sync-btn" onclick="startComprehensiveSync()" 
                            class="bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Start Comprehensive Sync
                    </button>
                    <button id="reverse-sync-btn" onclick="startReverseSync()" 
                            class="bg-amber-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-amber-600 transition-colors flex items-center">
                        <i class="fas fa-upload mr-2"></i>
                        Reverse Sync
                    </button>
                </div>
            </div>
            
            <!-- Progress Section -->
            <div id="sync-progress-section" class="mt-6 hidden">
                <div class="bg-white/10 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span id="sync-stage-text" class="font-medium">Initializing...</span>
                        <span id="sync-percentage" class="font-bold">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="sync-progress-fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div id="sync-status-text" class="text-sm opacity-75 mt-2">Ready to start synchronization</div>
                </div>
            </div>
        </div>

        <!-- Status Indicators -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Google Sheets Status -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Google Sheets</h3>
                    <span id="sheets-status-indicator" class="status-indicator status-disconnected"></span>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Status:</span>
                        <span id="sheets-connection-status" class="font-medium text-red-600">Disconnected</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Records:</span>
                        <span id="sheets-record-count" class="font-medium">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Last Sync:</span>
                        <span id="sheets-last-sync" class="font-medium text-sm">Never</span>
                    </div>
                    <div id="sheets-debug-info" class="mt-2 text-xs text-gray-500 hidden">
                        <div>Debug Info:</div>
                        <div id="sheets-debug-details"></div>
                    </div>
                    <div class="mt-3">
                        <button id="skip-sheets-btn" onclick="skipGoogleSheets()" 
                                class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-600 transition-colors">
                            Skip Google Sheets
                        </button>
                    </div>
                </div>
            </div>

            <!-- Firebase Status -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Firebase</h3>
                    <span id="firebase-status-indicator" class="status-indicator status-disconnected"></span>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Status:</span>
                        <span id="firebase-connection-status" class="font-medium text-red-600">Disconnected</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Records:</span>
                        <span id="firebase-record-count" class="font-medium">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Last Sync:</span>
                        <span id="firebase-last-sync" class="font-medium text-sm">Never</span>
                    </div>
                </div>
            </div>

            <!-- Local Storage Status -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Local Storage</h3>
                    <span id="localStorage-status-indicator" class="status-indicator status-connected"></span>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Status:</span>
                        <span id="localStorage-connection-status" class="font-medium text-green-600">Connected</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Records:</span>
                        <span id="localStorage-record-count" class="font-medium">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Last Sync:</span>
                        <span id="localStorage-last-sync" class="font-medium text-sm">Never</span>
                    </div>
                </div>
            </div>
        </div>



        <!-- Data Source Comparison Table -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Data Source Comparison</h3>
                <div class="flex gap-3">
                    <button id="clear-localStorage-btn" onclick="clearLocalStorageData()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                        Clear Local Storage Data
                    </button>
                    <button id="refresh-comparison-btn" onclick="refreshComparisonTable()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Refresh
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Metric</th>
                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">Firebase</th>
                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">Local Storage</th>
                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">Google Sheets</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border border-gray-300 px-4 py-3 font-medium text-gray-700">Product count</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="firebase-products">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="localStorage-products">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="sheets-products">-</td>
                        </tr>
                        <tr class="bg-gray-50">
                            <td class="border border-gray-300 px-4 py-3 font-medium text-gray-700">Colors count</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="firebase-colors">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="localStorage-colors">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="sheets-colors">-</td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 px-4 py-3 font-medium text-gray-700">Styles count</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="firebase-styles">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="localStorage-styles">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="sheets-styles">-</td>
                        </tr>
                        <tr class="bg-gray-50">
                            <td class="border border-gray-300 px-4 py-3 font-medium text-gray-700">Color type count</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="firebase-colortypes">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="localStorage-colortypes">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="sheets-colortypes">-</td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 px-4 py-3 font-medium text-gray-700">Category count</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="firebase-categories">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="localStorage-categories">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="sheets-categories">-</td>
                        </tr>
                        <tr class="bg-gray-50">
                            <td class="border border-gray-300 px-4 py-3 font-medium text-gray-700">Salesmen count</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="firebase-salesmen">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="localStorage-salesmen">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="sheets-salesmen">-</td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 px-4 py-3 font-medium text-gray-700">Saved quote count</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="firebase-quotes">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="localStorage-quotes">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="sheets-quotes">-</td>
                        </tr>
                        <tr class="bg-gray-50">
                            <td class="border border-gray-300 px-4 py-3 font-medium text-gray-700">Client count</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="firebase-clients">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="localStorage-clients">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="sheets-clients">-</td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 px-4 py-3 font-medium text-gray-700">Price list count</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="firebase-pricelists">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="localStorage-pricelists">-</td>
                            <td class="border border-gray-300 px-4 py-3 text-center" id="sheets-pricelists">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 text-sm text-gray-600">
                <p>Last updated: <span id="comparison-last-updated">Never</span></p>
            </div>
        </div>

        <!-- Sync Log -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Synchronization Log</h3>
            <div id="sync-log" class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">Synchronization log will appear here...</div>
            </div>
        </div>
    </div>

    <script>
        // Firebase is already initialized via firebase-config.js
        
        // Global error handler to catch unhandled errors
        window.addEventListener('error', function(event) {
            const error = event.error;
            if (error) {
                console.error('Global error caught:', {
                    message: error.message || 'Unknown error',
                    filename: event.filename || 'Unknown file',
                    lineno: event.lineno || 'Unknown line',
                    stack: error.stack || 'No stack trace'
                });
                
                // Prevent the default browser error handling for Firebase connection errors
                if (error.message && error.message.includes('firestore')) {
                    event.preventDefault();
                    return false;
                }
            }
        });
        
        // Handle unhandled promise rejections (common with Firebase)
        window.addEventListener('unhandledrejection', function(event) {
            const error = event.reason;
            console.warn('Unhandled promise rejection:', {
                message: error?.message || 'Unknown promise rejection',
                stack: error?.stack || 'No stack trace',
                reason: error
            });
            
            // Prevent the default browser handling for Firebase connection errors
            if (error && (error.message?.includes('firestore') || error.message?.includes('firebase'))) {
                event.preventDefault();
                return false;
            }
        });
        
        // Initialize fallback Google Sheets service (always available)
        window.googleSheetsService = {
            isFallbackService: true,
            async fetchProductData() {
                console.log('Google Sheets service not initialized - returning empty data');
                return [];
            },
            async fetchSalesmanData() {
                console.log('Google Sheets service not initialized - returning empty data');
                return [];
            },
            async fetchClientData() {
                console.log('Google Sheets service not initialized - returning empty data');
                return [];
            },
            async fetchColorsData() {
                console.log('Google Sheets service not initialized - returning empty data');
                return [];
            },
            async fetchStylesData() {
                console.log('Google Sheets service not initialized - returning empty data');
                return [];
            },
            async fetchPriceListsData() {
                console.log('Google Sheets service not initialized - returning empty data');
                return [];
            }
        };
        
        // Initialize Google Sheets integration
        async function initializeGoogleSheets() {
            const statusElement = document.getElementById('sheets-connection-status');
            const indicatorElement = document.getElementById('sheets-status-indicator');
            const debugInfoElement = document.getElementById('sheets-debug-info');
            const debugDetailsElement = document.getElementById('sheets-debug-details');
            
            function showDebugInfo(info) {
                if (debugDetailsElement) {
                    debugDetailsElement.innerHTML = info;
                    if (debugInfoElement) {
                        debugInfoElement.classList.remove('hidden');
                    }
                }
            }
            
            function updateStatus(text, className) {
                if (statusElement) {
                    statusElement.textContent = text;
                    statusElement.className = className;
                }
            }
            
            try {
                console.log('Starting Google Sheets initialization...');
                updateStatus('Initializing...', 'font-medium text-yellow-600');
                
                // Check if gapi is loaded
                if (typeof gapi === 'undefined') {
                    console.error('Google API client library (gapi) not loaded');
                    updateStatus('Library not loaded', 'font-medium text-red-600');
                    showDebugInfo('Google API library (gapi) not loaded. Check network connection.');
                    return false;
                }
                
                // Check API key
                if (!window.GOOGLE_SHEETS_API_KEY || window.GOOGLE_SHEETS_API_KEY === 'YOUR_GOOGLE_SHEETS_API_KEY') {
                    console.error('Google Sheets API key not configured');
                    updateStatus('API key missing', 'font-medium text-red-600');
                    showDebugInfo('Google Sheets API key not configured properly.');
                    return false;
                }
                
                console.log('Google API client library loaded, initializing...');
                console.log('API Key:', window.GOOGLE_SHEETS_API_KEY ? 'Present' : 'Missing');
                
                // Load gapi.client with retry logic
                let clientLoaded = false;
                for (let attempt = 1; attempt <= 3; attempt++) {
                    try {
                        console.log(`Attempting to load gapi.client (attempt ${attempt}/3)...`);
                        updateStatus(`Loading client (${attempt}/3)...`, 'font-medium text-yellow-600');
                        
                        await new Promise((resolve, reject) => {
                            const timeout = setTimeout(() => {
                                reject(new Error(`Google API client loading timeout after 8 seconds (attempt ${attempt})`));
                            }, 8000);
                            
                            gapi.load('client', {
                                callback: () => {
                                    clearTimeout(timeout);
                                    resolve();
                                },
                                onerror: (error) => {
                                    clearTimeout(timeout);
                                    reject(error);
                                }
                            });
                        });
                        
                        clientLoaded = true;
                        console.log('Google API client loaded successfully');
                        break;
                    } catch (error) {
                        console.warn(`Attempt ${attempt} failed:`, error.message);
                        if (attempt === 3) {
                            throw error;
                        }
                        // Wait before retry
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                if (!clientLoaded) {
                    throw new Error('Failed to load Google API client after 3 attempts');
                }
                
                // Initialize gapi.client with retry logic
                let clientInitialized = false;
                for (let attempt = 1; attempt <= 3; attempt++) {
                    try {
                        console.log(`Attempting to initialize gapi.client (attempt ${attempt}/3)...`);
                        updateStatus(`Initializing API (${attempt}/3)...`, 'font-medium text-yellow-600');
                        
                        const initConfig = {
                            apiKey: window.GOOGLE_SHEETS_API_KEY,
                            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                        };
                        
                        console.log('Init config:', initConfig);
                        
                        // Initialize with timeout
                        await Promise.race([
                            gapi.client.init(initConfig),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error(`Google API client init timeout after 10 seconds (attempt ${attempt})`)), 10000)
                            )
                        ]);
                        
                        clientInitialized = true;
                        console.log('Google Sheets API initialized successfully');
                        break;
                    } catch (error) {
                        console.warn(`Initialization attempt ${attempt} failed:`, error.message);
                        if (attempt === 3) {
                            throw error;
                        }
                        // Wait before retry
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
                
                if (!clientInitialized) {
                    throw new Error('Failed to initialize Google API client after 3 attempts');
                }
                
                console.log('API Key configured:', window.GOOGLE_SHEETS_API_KEY ? 'Yes' : 'No');
                console.log('gapi.client.sheets available:', typeof gapi.client.sheets !== 'undefined');
                
                // Test the API with a simple call
                try {
                    // First test if the API client is properly loaded
                    if (typeof gapi.client.sheets === 'undefined') {
                        throw new Error('Google Sheets API client not loaded');
                    }
                    
                    console.log('Google Sheets API client is available');
                    
                    // Try a simple test with a public spreadsheet
                    const testSpreadsheetId = '1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms'; // Google's public example sheet
                    console.log('Testing API with public spreadsheet:', testSpreadsheetId);
                    
                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: testSpreadsheetId,
                        range: 'Class Data!A1:B2'
                    });
                    
                    console.log('API test successful:', response.result);
                    
                    // Replace fallback service with the real browser-compatible Google Sheets service
                    window.googleSheetsService = {
                        async fetchProductData(spreadsheetId = '1hlfrnZnNQ0u8idg5KDmkSY4zFhLyvjLqUwAZn6HmW3s', range = 'pricelists!A:Z') {
                            try {
                                const response = await gapi.client.sheets.spreadsheets.values.get({
                                    spreadsheetId: spreadsheetId,
                                    range: range
                                });
                                return response.result.values || [];
                            } catch (error) {
                                console.error('Error fetching product data:', error);
                                return [];
                            }
                        },
                        async fetchSalesmanData(spreadsheetId = '1hlfrnZnNQ0u8idg5KDmkSY4zFhLyvjLqUwAZn6HmW3s', range = 'salesmen!A:Z') {
                            try {
                                const response = await gapi.client.sheets.spreadsheets.values.get({
                                    spreadsheetId: spreadsheetId,
                                    range: range
                                });
                                return response.result.values || [];
                            } catch (error) {
                                console.error('Error fetching salesman data:', error);
                                return [];
                            }
                        },
                        async fetchClientData(spreadsheetId = '1hlfrnZnNQ0u8idg5KDmkSY4zFhLyvjLqUwAZn6HmW3s', range = 'clients!A:Z') {
                            try {
                                const response = await gapi.client.sheets.spreadsheets.values.get({
                                    spreadsheetId: spreadsheetId,
                                    range: range
                                });
                                return response.result.values || [];
                            } catch (error) {
                                console.error('Error fetching client data:', error);
                                return [];
                            }
                        },
                        async fetchColorsData(spreadsheetId = '1hlfrnZnNQ0u8idg5KDmkSY4zFhLyvjLqUwAZn6HmW3s', range = 'colors!A:Z') {
                            try {
                                const response = await gapi.client.sheets.spreadsheets.values.get({
                                    spreadsheetId: spreadsheetId,
                                    range: range
                                });
                                return response.result.values || [];
                            } catch (error) {
                                console.error('Error fetching colors data:', error);
                                return [];
                            }
                        },
                        async fetchStylesData(spreadsheetId = '1hlfrnZnNQ0u8idg5KDmkSY4zFhLyvjLqUwAZn6HmW3s', range = 'styles!A:Z') {
                            try {
                                const response = await gapi.client.sheets.spreadsheets.values.get({
                                    spreadsheetId: spreadsheetId,
                                    range: range
                                });
                                return response.result.values || [];
                            } catch (error) {
                                console.error('Error fetching styles data:', error);
                                return [];
                            }
                        },
                        async fetchPriceListsData(spreadsheetId = '1hlfrnZnNQ0u8idg5KDmkSY4zFhLyvjLqUwAZn6HmW3s', range = 'pricelists!A:Z') {
                            try {
                                const response = await gapi.client.sheets.spreadsheets.values.get({
                                    spreadsheetId: spreadsheetId,
                                    range: range
                                });
                                // Extract unique price lists from products data
                                const data = response.result.values || [];
                                if (data.length === 0) return [];
                                
                                const headers = data[0];
                                const priceListIndex = headers.findIndex(h => 
                                    h && (h.toLowerCase().includes('pricelist') || h.toLowerCase().includes('price list'))
                                );
                                
                                if (priceListIndex === -1) return [];
                                
                                const priceLists = new Set();
                                for (let i = 1; i < data.length; i++) {
                                    const row = data[i];
                                    if (row && row[priceListIndex] && row[priceListIndex].trim()) {
                                        priceLists.add(row[priceListIndex].trim());
                                    }
                                }
                                
                                return Array.from(priceLists);
                            } catch (error) {
                                console.error('Error fetching price lists data:', error);
                                return [];
                            }
                        }
                    };
                    
                    console.log('Google Sheets service initialized successfully');
                    
                    // Update status using the proper status function
                    updateSheetsStatus({
                        connected: true,
                        recordCount: 'API Ready',
                        lastSync: new Date().toISOString()
                    });
                } catch (testError) {
                    console.error('API test failed:', testError);
                    console.error('Test error details:', {
                        message: testError.message,
                        status: testError.status,
                        code: testError.code
                    });
                    
                    // Update status as connected but with test warning
                    updateSheetsStatus({
                        connected: true,
                        recordCount: 'Test Failed',
                        lastSync: new Date().toISOString()
                    });
                    
                    showDebugInfo(`Test Error: ${testError.message || 'Unknown'}<br>Status: ${testError.status || 'N/A'}<br>Code: ${testError.code || 'N/A'}`);
                }
                
                return true;
            } catch (error) {
                console.error('Failed to initialize Google Sheets API:', error);
                
                // Safely extract error details
                const errorDetails = {
                    message: error?.message || 'Unknown error',
                    stack: error?.stack || 'No stack trace',
                    name: error?.name || 'Error',
                    code: error?.code || 'No code',
                    status: error?.status || 'No status'
                };
                
                console.error('Error details:', errorDetails);
                
                // Update status to show error
                updateStatus('Connection failed', 'font-medium text-red-600');
                
                // Show detailed error information with specific guidance
                let specificGuidance = '';
                if (errorDetails.message.includes('API key not valid') || errorDetails.status === 400) {
                    specificGuidance = `
                        <strong>🔑 API Key Issue Detected</strong><br>
                        The current API key appears to be invalid or expired.<br><br>
                        <strong>To fix this:</strong><br>
                        1. Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a><br>
                        2. Create a new API key or verify the existing one<br>
                        3. Enable Google Sheets API for your project<br>
                        4. Update the API key in the code<br><br>
                    `;
                } else if (errorDetails.message.includes('quota') || errorDetails.status === 429) {
                    specificGuidance = `
                        <strong>📊 Quota Exceeded</strong><br>
                        The API key has exceeded its daily quota.<br><br>
                        <strong>To fix this:</strong><br>
                        1. Wait for quota reset (usually 24 hours)<br>
                        2. Or increase quota limits in Google Cloud Console<br><br>
                    `;
                } else if (errorDetails.message.includes('permission') || errorDetails.status === 403) {
                    specificGuidance = `
                        <strong>🔒 Permission Denied</strong><br>
                        The API key doesn't have permission to access the spreadsheet.<br><br>
                        <strong>To fix this:</strong><br>
                        1. Make sure Google Sheets API is enabled<br>
                        2. Check if the spreadsheet is publicly accessible<br>
                        3. Verify API key permissions<br><br>
                    `;
                } else if (errorDetails.message.includes('timeout') || errorDetails.message.includes('network')) {
                    specificGuidance = `
                        <strong>🌐 Network Issue</strong><br>
                        Connection to Google Sheets API timed out.<br><br>
                        <strong>To fix this:</strong><br>
                        1. Check your internet connection<br>
                        2. Try refreshing the page<br>
                        3. Check if Google services are accessible<br><br>
                    `;
                } else {
                    specificGuidance = `
                        <strong>❓ General API Error</strong><br>
                        An unexpected error occurred during initialization.<br><br>
                        <strong>To fix this:</strong><br>
                        1. Check the browser console for more details<br>
                        2. Verify your internet connection<br>
                        3. Try refreshing the page<br>
                        4. Check Google Cloud Console for API status<br><br>
                    `;
                }

                showDebugInfo(`
                    <strong>Google Sheets API Initialization Failed</strong><br>
                    <strong>Error:</strong> ${errorDetails.message}<br>
                    <strong>Type:</strong> ${errorDetails.name}<br>
                    ${errorDetails.code !== 'No code' ? `<strong>Code:</strong> ${errorDetails.code}<br>` : ''}
                    ${errorDetails.status !== 'No status' ? `<strong>Status:</strong> ${errorDetails.status}<br>` : ''}
                    <br>
                    ${specificGuidance}
                    <strong>Current Configuration:</strong><br>
                    • API Key: ${window.GOOGLE_SHEETS_API_KEY ? 'Present (' + window.GOOGLE_SHEETS_API_KEY.substring(0, 10) + '...)' : 'Missing'}<br>
                    • gapi loaded: ${typeof gapi !== 'undefined' ? 'Yes' : 'No'}<br>
                    • gapi.client available: ${typeof gapi !== 'undefined' && gapi.client ? 'Yes' : 'No'}<br><br>
                    <strong>Need Help?</strong><br>
                    • Check the <a href="GOOGLE_SHEETS_SETUP.md" target="_blank">Setup Guide</a><br>
                    • Review the <a href="GOOGLE_SHEETS_CREDENTIALS_SETUP.md" target="_blank">Credentials Guide</a>
                `);
                
                // Keep the fallback service that returns empty arrays (don't replace it)
                console.log('Google Sheets API initialization failed, keeping fallback service that returns empty arrays');
                
                // Update status using the proper status function
                updateSheetsStatus({
                    connected: false,
                    recordCount: 'Error',
                    lastSync: 'Failed'
                });
                
                console.error('Error details:', errorDetails);
                
                let errorMessage = 'Connection failed';
                if (errorDetails.message && errorDetails.message !== 'Unknown error') {
                    errorMessage = `Failed: ${errorDetails.message}`;
                }
                
                const debugInfo = `
                    Error: ${errorDetails.message}<br>
                    Name: ${errorDetails.name}<br>
                    Code: ${errorDetails.code}<br>
                    Status: ${errorDetails.status}<br>
                    API Key: ${window.GOOGLE_SHEETS_API_KEY ? 'Present' : 'Missing'}<br>
                    gapi loaded: ${typeof gapi !== 'undefined' ? 'Yes' : 'No'}<br>
                    gapi.client available: ${typeof gapi !== 'undefined' && gapi.client ? 'Yes' : 'No'}
                `;
                
                showDebugInfo(debugInfo);
                
                // Update status using the proper status function
                updateSheetsStatus({
                    connected: false,
                    recordCount: 'Error',
                    lastSync: 'Never'
                });
                return false;
            }
        }

        // Initialize Comprehensive Sync System
        let syncSystem;
        
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Firebase first
                console.log('Initializing Firebase...');
                if (typeof initializeFirebaseApp === 'function') {
                    try {
                        initializeFirebaseApp();
                        console.log('Firebase initialized successfully');
                        
                        // Test Firebase connection with timeout
                        try {
                            const db = firebase.firestore();
                            const testPromise = db.collection('test').limit(1).get();
                            const timeoutPromise = new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Firebase connection timeout')), 5000)
                            );
                            
                            await Promise.race([testPromise, timeoutPromise]);
                            console.log('Firebase connection test successful');
                        } catch (connectionError) {
                            console.warn('Firebase connection test failed (this is expected for demo projects):', connectionError.message);
                            // Update Firebase status to show connection issue
                            setTimeout(() => {
                                updateFirebaseStatus({
                                    connected: false,
                                    recordCount: 'Connection Error',
                                    lastSync: 'Never',
                                    error: 'Demo project - connection limited'
                                });
                            }, 1000);
                        }
                    } catch (firebaseError) {
                        console.error('Firebase initialization failed:', firebaseError);
                        const errorDetails = {
                            message: firebaseError?.message || 'Unknown Firebase error',
                            code: firebaseError?.code || 'No error code'
                        };
                        console.error('Firebase error details:', errorDetails);
                        
                        // Update Firebase status to show error
                        setTimeout(() => {
                            updateFirebaseStatus({
                                connected: false,
                                recordCount: 'Init Error',
                                lastSync: 'Never',
                                error: errorDetails.message
                            });
                        }, 1000);
                    }
                } else {
                    console.error('initializeFirebaseApp function not found');
                    setTimeout(() => {
                        updateFirebaseStatus({
                            connected: false,
                            recordCount: 'Function Missing',
                            lastSync: 'Never',
                            error: 'Firebase initialization function not found'
                        });
                    }, 1000);
                }
                
                // Initialize Google Sheets with retry logic
                let sheetsInitialized = false;
                let retryCount = 0;
                const maxRetries = 3;
                
                while (!sheetsInitialized && retryCount < maxRetries) {
                    try {
                        console.log(`Attempting Google Sheets initialization (attempt ${retryCount + 1}/${maxRetries})`);
                        await initializeGoogleSheets();
                        sheetsInitialized = true;
                        console.log('Google Sheets initialized successfully');
                    } catch (sheetsError) {
                        retryCount++;
                        console.error(`Google Sheets initialization attempt ${retryCount} failed:`, sheetsError.message);
                        
                        if (retryCount < maxRetries) {
                            console.log(`Retrying in 2 seconds...`);
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        } else {
                            console.error('All Google Sheets initialization attempts failed');
                            // Update status to show initialization failed
                            setTimeout(() => {
                                updateSheetsStatus({
                                    connected: false,
                                    recordCount: 'Init Failed',
                                    lastSync: 'Never',
                                    error: `Failed after ${maxRetries} attempts: ${sheetsError.message}`
                                });
                            }, 1000);
                        }
                    }
                }
                
                syncSystem = new ComprehensiveSyncSystem();
                
                // Set up event listeners
                setupEventListeners();
                
                // Initialize the system
                await initializeSystem();
                
                // Update device ID display
                document.getElementById('device-id').textContent = syncSystem.getDeviceId();
                
                // Wait a moment for all systems to be ready, then initialize comparison table
                setTimeout(async () => {
                    // Initialize comparison table
                    await refreshComparisonTable();
                    
                    // Refresh connection status to reflect Google Sheets initialization
                    if (syncSystem && syncSystem.checkAllConnections) {
                        syncSystem.checkAllConnections();
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Error during initialization:', error);
                
                // Safely extract error details
                const errorDetails = {
                    message: error?.message || 'Unknown initialization error',
                    stack: error?.stack || 'No stack trace available',
                    name: error?.name || 'Error',
                    code: error?.code || 'No error code',
                    status: error?.status || 'No status'
                };
                
                console.error('Error details:', errorDetails);
                
                // Show user-friendly error message
                const debugElement = document.getElementById('debug-info');
                if (debugElement) {
                    debugElement.innerHTML = `
                        <div class="text-red-600 font-semibold">Initialization Error:</div>
                        <div class="text-sm mt-2">
                            ${errorDetails.message}<br>
                            <span class="text-gray-600">Check console for more details</span>
                        </div>
                    `;
                }
                
                // Still try to initialize comparison table even if initialization fails
                setTimeout(async () => {
                    try {
                        await refreshComparisonTable();
                    } catch (refreshError) {
                        console.error('Failed to refresh comparison table:', refreshError);
                    }
                }, 1000);
            }
        });

        function setupEventListeners() {
            // Sync progress updates
            syncSystem.addEventListener('sync-progress', (data) => {
                updateSyncProgress(data);
            });

            // Sync status updates
            syncSystem.addEventListener('sync-status', (data) => {
                addToSyncLog(data.message, data.type);
            });

            // Firebase status updates
            syncSystem.addEventListener('firebase-status', (status) => {
                updateFirebaseStatus(status);
            });

            // Google Sheets status updates
            syncSystem.addEventListener('sheets-status', (status) => {
                updateSheetsStatus(status);
            });

            // Local Storage status updates
            syncSystem.addEventListener('localStorage-status', (status) => {
                updateLocalStorageStatus(status);
            });

            // Sync completion
            syncSystem.addEventListener('sync-completed', (report) => {
                onSyncCompleted(report);
            });

            // Sync error
            syncSystem.addEventListener('sync-error', (error) => {
                onSyncError(error);
            });
            
            // Comparison table refresh button
            const refreshComparisonBtn = document.getElementById('refresh-comparison-btn');
            if (refreshComparisonBtn) {
                refreshComparisonBtn.addEventListener('click', refreshComparisonTable);
            }
        }

        async function initializeSystem() {
            addToSyncLog('Initializing synchronization system...', 'info');
            
            try {
                await syncSystem.initialize();
                addToSyncLog('System initialized successfully', 'success');
            } catch (error) {
                addToSyncLog(`Initialization failed: ${error.message}`, 'error');
            }
        }

        async function startComprehensiveSync() {
            const btn = document.getElementById('comprehensive-sync-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Syncing...';
            
            document.getElementById('sync-progress-section').classList.remove('hidden');
            
            try {
                await syncSystem.performComprehensiveSync();
            } catch (error) {
                addToSyncLog(`Sync failed: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Start Comprehensive Sync';
            }
        }

        async function startReverseSync() {
            const btn = document.getElementById('reverse-sync-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
            
            try {
                await syncSystem.performReverseSync();
                addToSyncLog('Reverse synchronization completed', 'success');
            } catch (error) {
                addToSyncLog(`Reverse sync failed: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-upload mr-2"></i>Reverse Sync';
            }
        }

        function updateSyncProgress(data) {
            document.getElementById('sync-stage-text').textContent = data.message;
            document.getElementById('sync-percentage').textContent = `${data.percentage}%`;
            document.getElementById('sync-progress-fill').style.width = `${data.percentage}%`;
            document.getElementById('sync-status-text').textContent = data.message;
            
            addToSyncLog(`Stage ${data.stage}: ${data.message}`, 'info');
        }

        function updateFirebaseStatus(status) {
            const indicator = document.getElementById('firebase-status-indicator');
            const connectionStatus = document.getElementById('firebase-connection-status');
            const recordCount = document.getElementById('firebase-record-count');
            const lastSync = document.getElementById('firebase-last-sync');
            
            if (status.connected) {
                indicator.className = 'status-indicator status-connected';
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'font-medium text-green-600';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                connectionStatus.textContent = 'Disconnected';
                connectionStatus.className = 'font-medium text-red-600';
            }
            
            recordCount.textContent = status.recordCount;
            lastSync.textContent = status.lastSync ? new Date(status.lastSync).toLocaleString() : 'Never';
        }

        function updateSheetsStatus(status) {
            const indicator = document.getElementById('sheets-status-indicator');
            const connectionStatus = document.getElementById('sheets-connection-status');
            const recordCount = document.getElementById('sheets-record-count');
            const lastSync = document.getElementById('sheets-last-sync');
            
            if (status.connected) {
                indicator.className = 'status-indicator status-connected';
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'font-medium text-green-600';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                connectionStatus.textContent = 'Disconnected';
                connectionStatus.className = 'font-medium text-red-600';
            }
            
            recordCount.textContent = status.recordCount;
            lastSync.textContent = status.lastSync ? new Date(status.lastSync).toLocaleString() : 'Never';
        }

        function updateLocalStorageStatus(status) {
            const indicator = document.getElementById('localStorage-status-indicator');
            const connectionStatus = document.getElementById('localStorage-connection-status');
            const recordCount = document.getElementById('localStorage-record-count');
            const lastSync = document.getElementById('localStorage-last-sync');
            
            if (status.connected) {
                indicator.className = 'status-indicator status-connected';
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'font-medium text-green-600';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                connectionStatus.textContent = 'Disconnected';
                connectionStatus.className = 'font-medium text-red-600';
            }
            
            recordCount.textContent = status.recordCount;
            lastSync.textContent = status.lastSync ? new Date(status.lastSync).toLocaleString() : 'Never';
        }





        function onSyncCompleted(report) {
            addToSyncLog('Comprehensive synchronization completed successfully!', 'success');
            addToSyncLog(`Sync Report: ${JSON.stringify(report, null, 2)}`, 'info');
            
            // Hide progress section
            setTimeout(() => {
                document.getElementById('sync-progress-section').classList.add('hidden');
            }, 3000);
        }

        function onSyncError(error) {
            addToSyncLog(`Synchronization error at stage ${error.stage}: ${error.error}`, 'error');
            
            // Hide progress section
            setTimeout(() => {
                document.getElementById('sync-progress-section').classList.add('hidden');
            }, 3000);
        }

        function addToSyncLog(message, type = 'info') {
            const logContainer = document.getElementById('sync-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `mb-1 ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-700'}`;
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function refreshComparisonTable() {
            console.log('Refreshing comparison table...');
            
            // Update timestamp
            document.getElementById('comparison-last-updated').textContent = new Date().toLocaleString();
            
            // Initialize all cells to loading state
            const metrics = ['products', 'colors', 'styles', 'colortypes', 'categories', 'salesmen', 'quotes', 'clients', 'pricelists'];
            const sources = ['firebase', 'localStorage', 'sheets'];
            
            // Set loading state
            metrics.forEach(metric => {
                sources.forEach(source => {
                    const element = document.getElementById(`${source}-${metric}`);
                    if (element) element.textContent = '...';
                });
            });
            
            // Fetch Firebase data
            await fetchFirebaseData();
            
            // Fetch localStorage data
            await fetchLocalStorageData();
            
            // Fetch Google Sheets data
            await fetchGoogleSheetsData();
            
            console.log('Comparison table refresh completed');
        }

        async function fetchFirebaseData() {
            try {
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    console.warn('Firebase not available');
                    setSourceData('firebase', {});
                    return;
                }
                
                const db = firebase.firestore();
                const data = {};
                
                // Get basic collections
                const collections = ['products', 'colors', 'styles', 'salesmen', 'quotes', 'clients', 'pricelists'];
                
                for (const collection of collections) {
                    try {
                        const snapshot = await db.collection(collection).get();
                        data[collection] = snapshot.size;
                    } catch (error) {
                        console.warn(`Firebase ${collection} error:`, error);
                        data[collection] = 0;
                    }
                }
                
                // Extract categories and color types from products
                try {
                    const productsSnapshot = await db.collection('products').get();
                    const categories = new Set();
                    const colorTypes = new Set();
                    
                    productsSnapshot.forEach(doc => {
                        const product = doc.data();
                        if (product.Category) categories.add(product.Category);
                        if (product.Colors) colorTypes.add(product.Colors);
                        if (product.Color) colorTypes.add(product.Color);
                        if (product.color) colorTypes.add(product.color);
                    });
                    
                    data.categories = categories.size;
                    data.colortypes = colorTypes.size;
                } catch (error) {
                    console.warn('Firebase products analysis error:', error);
                    data.categories = 0;
                    data.colortypes = 0;
                }
                
                setSourceData('firebase', data);
                console.log('Firebase data fetched:', data);
                
            } catch (error) {
                console.error('Firebase fetch error:', error);
                setSourceData('firebase', {});
            }
        }

        async function fetchLocalStorageData() {
            try {
                const data = {};
                
                // Get basic collections from localStorage
                const collections = ['products', 'colors', 'styles', 'salesmen', 'quotes', 'clients', 'pricelists'];
                
                for (const collection of collections) {
                    try {
                        let localData = [];
                        
                        // Try LocalFallbackManager first
                        if (window.localFallbackManager && typeof window.localFallbackManager.getData === 'function') {
                            try {
                                await window.localFallbackManager.ensureInitialized();
                                // Map salesmen to salespeople for LocalFallbackManager
                                const collectionKey = collection === 'salesmen' ? 'salespeople' : 
                                                    collection === 'pricelists' ? 'priceLists' : collection;
                                localData = await window.localFallbackManager.getData(collectionKey);
                            } catch (error) {
                                console.warn(`LocalFallbackManager ${collection} error:`, error);
                            }
                        }
                        
                        // Fallback to direct localStorage access
                        if (!localData || !Array.isArray(localData)) {
                            // Try fallback_ prefixed keys first
                            const fallbackKey = `fallback_${collection === 'salesmen' ? 'salespeople' : 
                                                                collection === 'pricelists' ? 'priceLists' : collection}`;
                            let stored = localStorage.getItem(fallbackKey);
                            
                            // If not found, try direct collection name
                            if (!stored) {
                                stored = localStorage.getItem(collection);
                            }
                            
                            // Try alternative keys for salesmen
                            if (!stored && collection === 'salesmen') {
                                stored = localStorage.getItem('salespeople') || localStorage.getItem('cloudSalesmen');
                            }
                            
                            // Try alternative keys for quotes
                            if (!stored && collection === 'quotes') {
                                stored = localStorage.getItem('savedQuotes') || localStorage.getItem('cloudQuotes');
                            }
                            
                            // Try alternative keys for clients
                            if (!stored && collection === 'clients') {
                                stored = localStorage.getItem('clientData') || localStorage.getItem('cloudClients');
                            }
                            
                            if (stored) {
                                try {
                                    localData = JSON.parse(stored);
                                } catch (parseError) {
                                    console.warn(`Parse error for ${collection}:`, parseError);
                                    localData = [];
                                }
                            }
                        }
                        
                        data[collection] = Array.isArray(localData) ? localData.length : 0;
                    } catch (error) {
                        console.warn(`LocalStorage ${collection} error:`, error);
                        data[collection] = 0;
                    }
                }
                
                // Extract categories and color types from products
                try {
                    let productsData = [];
                    if (syncSystem && typeof syncSystem.getLocalStorageData === 'function') {
                        productsData = syncSystem.getLocalStorageData('products');
                    } else {
                        const stored = localStorage.getItem('products');
                        if (stored) {
                            productsData = JSON.parse(stored);
                        }
                    }
                    
                    const categories = new Set();
                    const colorTypes = new Set();
                    
                    if (Array.isArray(productsData)) {
                        productsData.forEach(product => {
                            if (product.Category) categories.add(product.Category);
                            if (product.Colors) colorTypes.add(product.Colors);
                            if (product.Color) colorTypes.add(product.Color);
                            if (product.color) colorTypes.add(product.color);
                        });
                    }
                    
                    data.categories = categories.size;
                    data.colortypes = colorTypes.size;
                } catch (error) {
                    console.warn('LocalStorage products analysis error:', error);
                    data.categories = 0;
                    data.colortypes = 0;
                }
                
                setSourceData('localStorage', data);
                console.log('LocalStorage data fetched:', data);
                
            } catch (error) {
                console.error('LocalStorage fetch error:', error);
                setSourceData('localStorage', {});
            }
        }

        async function fetchGoogleSheetsData() {
            try {
                const data = {};
                
                // Check if Google Sheets service is available
                if (typeof window.googleSheetsService === 'undefined') {
                    console.warn('Google Sheets service not available');
                    console.log('DEBUG: window.googleSheetsService is undefined');
                    setSourceData('sheets', {});
                    return;
                }
                
                console.log('DEBUG: Google Sheets service is available, starting data fetch...');
                
                // Check if this is the fallback service
                if (window.googleSheetsService.isFallbackService) {
                    console.log('Google Sheets service is in fallback mode - showing N/A for all counts');
                    setSourceData('sheets', {
                        products: 'N/A',
                        colors: 'N/A', 
                        styles: 'N/A',
                        colortypes: 'N/A',
                        categories: 'N/A',
                        salesmen: 'N/A',
                        quotes: 'N/A',
                        clients: 'N/A',
                        pricelists: 'N/A'
                    });
                    return;
                }
                
                // Fetch data from different sheets
                try {
                    const productsData = await window.googleSheetsService.fetchProductData();
                    
                    // Exclude header row and count only non-empty rows
                    if (Array.isArray(productsData) && productsData.length > 1) {
                        const dataRows = productsData.slice(1).filter(row => row && row.length > 0 && row[0] && row[0].trim());
                        data.products = dataRows.length;
                        
                        // Extract categories and color types from products (assuming headers are in first row)
                        const categories = new Set();
                        const colorTypes = new Set();
                        const headers = productsData[0] || [];
                        
                        dataRows.forEach(row => {
                            headers.forEach((header, index) => {
                                if (header && row[index]) {
                                    const headerLower = header.toLowerCase();
                                    if (headerLower.includes('category')) {
                                        categories.add(row[index]);
                                    }
                                    if (headerLower.includes('color')) {
                                        colorTypes.add(row[index]);
                                    }
                                }
                            });
                        });
                        
                        data.categories = categories.size;
                        data.colortypes = colorTypes.size;
                    } else {
                        data.products = 0;
                        data.categories = 0;
                        data.colortypes = 0;
                    }
                } catch (error) {
                    console.warn('Google Sheets products error:', error);
                    data.products = 0;
                    data.categories = 0;
                    data.colortypes = 0;
                }
                
                try {
                    const salesmenData = await window.googleSheetsService.fetchSalesmanData();
                    // Exclude header row and count only non-empty rows
                    if (Array.isArray(salesmenData) && salesmenData.length > 1) {
                        const dataRows = salesmenData.slice(1).filter(row => row && row.length > 0 && row[0] && row[0].trim());
                        data.salesmen = dataRows.length;
                    } else {
                        data.salesmen = 0;
                    }
                } catch (error) {
                    console.warn('Google Sheets salesmen error:', error);
                    data.salesmen = 0;
                }
                
                try {
                    const clientsData = await window.googleSheetsService.fetchClientData();
                    data.clients = Array.isArray(clientsData) ? clientsData.length : 0;
                } catch (error) {
                    console.warn('Google Sheets clients error:', error);
                    data.clients = 0;
                }
                
                try {
                    const colorsData = await window.googleSheetsService.fetchColorsData();
                    data.colors = Array.isArray(colorsData) ? colorsData.length : 0;
                } catch (error) {
                    console.warn('Google Sheets colors error:', error);
                    data.colors = 0;
                }
                
                try {
                    const stylesData = await window.googleSheetsService.fetchStylesData();
                    data.styles = Array.isArray(stylesData) ? stylesData.length : 0;
                } catch (error) {
                    console.warn('Google Sheets styles error:', error);
                    data.styles = 0;
                }
                
                try {
                    const priceListsData = await window.googleSheetsService.fetchPriceListsData();
                    data.pricelists = Array.isArray(priceListsData) ? priceListsData.length : 0;
                } catch (error) {
                    console.warn('Google Sheets pricelists error:', error);
                    data.pricelists = 0;
                }
                
                // Google Sheets doesn't typically store quotes directly
                data.quotes = 0;
                
                setSourceData('sheets', data);
                console.log('Google Sheets data fetched:', data);
                
            } catch (error) {
                console.error('Google Sheets fetch error:', error);
                setSourceData('sheets', {});
            }
        }

        function setSourceData(source, data) {
            const metrics = ['products', 'colors', 'styles', 'colortypes', 'categories', 'salesmen', 'quotes', 'clients', 'pricelists'];
            
            metrics.forEach(metric => {
                const element = document.getElementById(`${source}-${metric}`);
                if (element) {
                    const value = data[metric] !== undefined ? data[metric] : 0;
                    element.textContent = value;
                }
            });
        }

        async function clearLocalStorageData() {
            if (!confirm('Are you sure you want to clear all data from Local Storage? This action cannot be undone.\n\nThis will clear all data but preserve the structure.')) {
                return;
            }

            try {
                console.log('Starting localStorage data clearing...');
                
                // Show loading state
                const clearBtn = document.getElementById('clear-localStorage-btn');
                const originalText = clearBtn.textContent;
                clearBtn.textContent = 'Clearing...';
                clearBtn.disabled = true;

                // List of all localStorage keys that contain data (not structure)
                const dataKeys = [
                    // Core collections
                    'products', 'clients', 'salespeople', 'salesmen', 'colors', 'styles', 
                    'quotes', 'orders', 'categories', 'priceLists',
                    
                    // Specific data keys found in the codebase
                    'clientData', 'clientDataTimestamp',
                    'savedQuotes', 'savedOrders', 'quoteCounter',
                    'cloudClients', 'cloudQuotes', 'cloudSalesmen',
                    'firebaseProductData', 'firebaseDataTimestamp',
                    'auditLog',
                    
                    // LocalFallbackManager collections with prefix
                    'fallback_products', 'fallback_clients', 'fallback_salespeople', 
                    'fallback_colors', 'fallback_styles', 'fallback_quotes', 
                    'fallback_orders', 'fallback_categories', 'fallback_priceLists',
                    'fallback_metadata'
                ];

                // Clear data keys while preserving structure
                let clearedCount = 0;
                dataKeys.forEach(key => {
                    if (localStorage.getItem(key) !== null) {
                        localStorage.removeItem(key);
                        clearedCount++;
                        console.log(`Cleared localStorage key: ${key}`);
                    }
                });

                // Clear any backup data (dataBackup_timestamp format)
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('dataBackup_')) {
                        localStorage.removeItem(key);
                        clearedCount++;
                        console.log(`Cleared backup key: ${key}`);
                    }
                }

                // Use LocalFallbackManager if available to properly clear and reinitialize
                if (window.localFallbackManager) {
                    try {
                        await window.localFallbackManager.clearAllData();
                        await window.localFallbackManager.initializeCollections();
                        console.log('LocalFallbackManager data cleared and reinitialized');
                    } catch (error) {
                        console.warn('LocalFallbackManager clear error:', error);
                    }
                }

                // Refresh the comparison table to show updated counts
                setTimeout(() => {
                    refreshComparisonTable();
                }, 500);

                console.log(`Successfully cleared ${clearedCount} localStorage keys`);
                alert(`Successfully cleared ${clearedCount} data items from Local Storage.\n\nData structure has been preserved and collections have been reinitialized as empty.`);

            } catch (error) {
                console.error('Error clearing localStorage data:', error);
                alert('Error occurred while clearing localStorage data. Check console for details.');
            } finally {
                // Restore button state
                const clearBtn = document.getElementById('clear-localStorage-btn');
                clearBtn.textContent = originalText;
                clearBtn.disabled = false;
            }
        }

        // Function to skip Google Sheets initialization
        function skipGoogleSheets() {
            console.log('Skipping Google Sheets initialization...');
            
            // Update Google Sheets status to indicate it's been skipped
            updateSheetsStatus('Skipped', 'font-medium text-yellow-600');
            document.getElementById('sheets-status-indicator').className = 'status-indicator status-warning';
            
            // Hide the skip button
            document.getElementById('skip-sheets-btn').style.display = 'none';
            
            // Show debug info
            const debugInfo = document.getElementById('sheets-debug-info');
            const debugDetails = document.getElementById('sheets-debug-details');
            debugInfo.classList.remove('hidden');
            debugDetails.innerHTML = 'Google Sheets initialization was manually skipped. Firebase operations are still available.';
            
            // Set a flag to indicate Google Sheets is skipped
            window.googleSheetsSkipped = true;
            
            // Initialize Firebase status check
            checkFirebaseStatus();
            
            alert('Google Sheets has been skipped. You can still use Firebase operations and local storage management.');
        }
    </script>
</body>
</html>