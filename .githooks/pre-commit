#!/bin/sh
#
# Pre-commit hook to validate data sources and ensure Firebase sync
# This ensures data consistency before commits

echo "🔍 Running pre-commit validation..."

# Validate data sources (Firebase and Google Sheets configuration)
echo "📊 Validating data sources..."
if ! npm run validate-data > /dev/null 2>&1; then
    echo "❌ Error: Data source validation failed!"
    echo "   Please check Firebase and Google Sheets configuration."
    exit 1
fi

# Check if data.json needs updating from Firebase
if [ -f "data.json" ]; then
    echo "📝 Checking if data.json needs updating from Firebase..."
    
    # Generate fresh data.json from Firebase
    if node deploy.js --sync-only; then
        echo "✅ data.json synchronized with Firebase"
        git add data.json
    else
        echo "❌ Error: Failed to sync data.json from Firebase"
        exit 1
    fi
else
    echo "📝 Creating data.json from Firebase..."
    
    # Generate data.json from Firebase
    if node deploy.js --sync-only; then
        echo "✅ data.json created from Firebase"
        git add data.json
    else
        echo "❌ Error: Failed to create data.json from Firebase"
        exit 1
    fi
fi

echo "✅ Pre-commit validation passed!"
exit 0