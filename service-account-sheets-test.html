<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Account Google Sheets Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">üîê Service Account Google Sheets Test</h1>
            
            <div class="bg-blue-50 p-4 rounded-lg mb-6">
                <h2 class="text-lg font-semibold text-blue-800 mb-2">Service Account Info</h2>
                <div class="text-sm text-blue-700">
                    <strong>Project:</strong> inh-price-list-sync<br>
                    <strong>Email:</strong> inh-price-list-sync@inh-price-list-sync.iam.gserviceaccount.com<br>
                    <strong>Auth Method:</strong> Service Account (more secure than API key)
                </div>
            </div>

            <div class="mb-6">
                <div class="flex flex-wrap gap-2">
                    <button id="testServiceAccount" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                        Test Service Account
                    </button>
                    <button id="testSheetAccess" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Test Sheet Access
                    </button>
                    <button id="shareInstructions" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                        Show Share Instructions
                    </button>
                    <button id="clearResults" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                        Clear
                    </button>
                </div>
            </div>

            <div id="results" class="space-y-4"></div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1hlfrnZnNQ0u8idg5KDmkSY4zFhLyvjLqUwAZn6HmW3s';
        const SERVICE_ACCOUNT_EMAIL = 'inh-price-list-sync@inh-price-list-sync.iam.gserviceaccount.com';
        
        function addResult(title, status, message, details = '') {
            const resultsDiv = document.getElementById('results');
            const statusColors = {
                'success': 'bg-green-100 border-green-500 text-green-700',
                'error': 'bg-red-100 border-red-500 text-red-700',
                'warning': 'bg-yellow-100 border-yellow-500 text-yellow-700',
                'info': 'bg-blue-100 border-blue-500 text-blue-700'
            };

            const statusIcons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };

            const resultDiv = document.createElement('div');
            resultDiv.className = `border-l-4 p-4 ${statusColors[status]}`;
            resultDiv.innerHTML = `
                <div class="flex items-start">
                    <span class="text-lg mr-3 mt-1">${statusIcons[status]}</span>
                    <div class="flex-1">
                        <h3 class="font-semibold">${title}</h3>
                        <p class="mt-1">${message}</p>
                        ${details ? `<div class="mt-2 text-sm opacity-75 whitespace-pre-line">${details}</div>` : ''}
                        <div class="text-xs opacity-50 mt-2">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function testServiceAccount() {
            addResult('Service Account Test', 'info', 'Testing service account authentication...');
            
            try {
                // Load the Google API client
                await new Promise((resolve, reject) => {
                    gapi.load('client:auth2', {
                        callback: resolve,
                        onerror: reject
                    });
                });

                addResult('GAPI Load', 'success', 'Google API client loaded successfully');

                // Note: In a real implementation, you would need to handle service account authentication
                // on the server side, as private keys cannot be safely used in client-side JavaScript
                addResult('Service Account Authentication', 'warning', 
                    'Service account authentication requires server-side implementation',
                    'The private key cannot be safely used in client-side JavaScript.\nYou need to either:\n1. Use an API key for client-side access, or\n2. Implement server-side authentication with the service account'
                );

            } catch (error) {
                addResult('Service Account Test', 'error', 'Failed to load Google API client', error.message);
            }
        }

        async function testSheetAccess() {
            addResult('Sheet Access Test', 'info', 'Testing direct sheet access...');
            
            try {
                // Try to access the sheet metadata without authentication (will fail if private)
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}`);
                
                if (response.status === 403) {
                    addResult('Sheet Access', 'warning', 'Sheet is private - requires authentication',
                        'The spreadsheet is not publicly accessible.\nYou need to either:\n1. Make the sheet public, or\n2. Share it with the service account email'
                    );
                } else if (response.status === 404) {
                    addResult('Sheet Access', 'error', 'Sheet not found',
                        'The spreadsheet ID might be incorrect or the sheet might not exist.'
                    );
                } else if (response.ok) {
                    const data = await response.json();
                    addResult('Sheet Access', 'success', 'Sheet is publicly accessible!',
                        `Title: ${data.properties.title}\nThis means you can use an API key for access.`
                    );
                } else {
                    addResult('Sheet Access', 'error', `HTTP ${response.status}`, await response.text());
                }
            } catch (error) {
                addResult('Sheet Access Test', 'error', 'Network error', error.message);
            }
        }

        function showShareInstructions() {
            addResult('Share Instructions', 'info', 'How to share your Google Sheet with the service account',
                `To use the service account, you need to share your Google Sheet with:
                
üìß ${SERVICE_ACCOUNT_EMAIL}

Steps:
1. Open your Google Sheet: https://docs.google.com/spreadsheets/d/${SHEET_ID}
2. Click the "Share" button (top right)
3. Add this email: ${SERVICE_ACCOUNT_EMAIL}
4. Set permission to "Viewer" or "Editor" as needed
5. Click "Send"

After sharing, the service account will be able to access your sheet programmatically.

Alternative: Create a new API key from Google Cloud Console if you prefer client-side access.`
            );
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Event listeners
        document.getElementById('testServiceAccount').addEventListener('click', testServiceAccount);
        document.getElementById('testSheetAccess').addEventListener('click', testSheetAccess);
        document.getElementById('shareInstructions').addEventListener('click', showShareInstructions);
        document.getElementById('clearResults').addEventListener('click', clearResults);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addResult('System Ready', 'info', 'Service Account Google Sheets test loaded',
                'This tool will help you test and configure Google Sheets access using your service account.'
            );
        });
    </script>
</body>
</html>