<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quote Maker - Professional Quote Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .section-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            margin-bottom: 0;
        }

        .quote-item {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .quote-item:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .currency-display {
            background: var(--success-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .admin-panel {
            background: linear-gradient(135deg, var(--accent-color), var(--warning-color));
            color: white;
        }

        .loading {
            display: none;
        }

        .loading.show {
            display: block;
        }

        @media (max-width: 768px) {
            .container-fluid {
                padding: 10px;
            }
            
            .card {
                margin-bottom: 20px;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        .quote-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .discount-input {
            max-width: 150px;
        }

        .product-search {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .search-result-item:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-quote-left me-2"></i>Quote Maker Pro
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#customer-section">Customer</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#quote-section">Quote</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#admin-section">Admin</a>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link currency-display" id="currentCurrency">USD</span>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Customer Management Section -->
        <div id="customer-section" class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="section-header">
                        <h4><i class="fas fa-user me-2"></i>Customer Information</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Customer Name *</label>
                                    <input type="text" class="form-control" id="customerName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Primary Phone *</label>
                                    <input type="tel" class="form-control" id="primaryPhone" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Alternate Phone</label>
                                    <input type="tel" class="form-control" id="alternatePhone">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email Address *</label>
                                    <input type="email" class="form-control" id="customerEmail" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Country *</label>
                                    <select class="form-select" id="customerCountry" required>
                                        <option value="">Select Country</option>
                                        <option value="US">United States</option>
                                        <option value="IN">India</option>
                                        <option value="GB">United Kingdom</option>
                                        <option value="DE">Germany</option>
                                        <option value="AE">United Arab Emirates</option>
                                        <option value="SA">Saudi Arabia</option>
                                        <option value="AU">Australia</option>
                                        <option value="NG">Nigeria</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">State/Province *</label>
                                    <select class="form-select" id="customerState" required>
                                        <option value="">Select State</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">City *</label>
                                    <select class="form-select" id="customerCity" required>
                                        <option value="">Select City</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Full Address *</label>
                                    <textarea class="form-control" id="customerAddress" rows="2" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Postal Code</label>
                                    <input type="text" class="form-control" id="postalCode">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Preferred Currency *</label>
                                    <select class="form-select" id="customerCurrency" required>
                                        <option value="USD">USD - US Dollar</option>
                                        <option value="INR">INR - Indian Rupee</option>
                                        <option value="GBP">GBP - British Pound</option>
                                        <option value="EUR">EUR - Euro</option>
                                        <option value="AED">AED - UAE Dirham</option>
                                        <option value="SAR">SAR - Saudi Riyal</option>
                                        <option value="AUD">AUD - Australian Dollar</option>
                                        <option value="NGN">NGN - Nigerian Naira</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Sales Representative</label>
                                    <select class="form-select" id="salesRep">
                                        <option value="">Select Sales Rep</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveCustomer()">
                            <i class="fas fa-save me-2"></i>Save Customer
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quote Creation Section -->
        <div id="quote-section" class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="section-header">
                        <h4><i class="fas fa-file-invoice me-2"></i>Quote Creation</h4>
                        <small>Quote #: <span id="quoteNumber">Loading...</span></small>
                    </div>
                    <div class="card-body">
                        <!-- Product Search and Add -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="product-search">
                                    <label class="form-label">Search Products</label>
                                    <input type="text" class="form-control" id="productSearch" placeholder="Type to search products...">
                                    <div class="search-results" id="searchResults"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-primary d-block" onclick="addCustomProduct()">
                                    <i class="fas fa-plus me-2"></i>Add Custom Product
                                </button>
                            </div>
                        </div>

                        <!-- Quote Items -->
                        <div id="quoteItems">
                            <h5>Quote Items</h5>
                            <div id="itemsList"></div>
                        </div>

                        <!-- Quote Summary -->
                        <div class="quote-summary">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Quote-Level Discounts</h5>
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="form-label">Discount Type</label>
                                            <select class="form-select" id="quoteLevelDiscountType">
                                                <option value="none">No Discount</option>
                                                <option value="percentage">Percentage</option>
                                                <option value="fixed">Fixed Amount</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Discount Value</label>
                                            <input type="number" class="form-control" id="quoteLevelDiscountValue" min="0" step="0.01">
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="form-label">Tax Rate (%)</label>
                                        <input type="number" class="form-control" id="taxRate" value="0" min="0" max="100" step="0.01">
                                    </div>
                                    <div class="mt-3">
                                        <label class="form-label">Shipping</label>
                                        <select class="form-select" id="shippingType">
                                            <option value="free">Free Shipping</option>
                                            <option value="paid">Paid Shipping</option>
                                        </select>
                                        <input type="number" class="form-control mt-2" id="shippingCost" placeholder="Shipping cost" min="0" step="0.01" style="display: none;">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5>Quote Summary</h5>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <span id="subtotal">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Quote Discount:</span>
                                        <span id="quoteDiscount">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Tax:</span>
                                        <span id="taxAmount">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Shipping:</span>
                                        <span id="shippingAmount">$0.00</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between h5">
                                        <strong>Total:</strong>
                                        <strong id="grandTotal">$0.00</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-primary me-2" onclick="generateQuote()">
                                    <i class="fas fa-file-pdf me-2"></i>Generate Quote
                                </button>
                                <button type="button" class="btn btn-success" onclick="saveQuote()">
                                    <i class="fas fa-save me-2"></i>Save Quote
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="admin-section" class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="section-header admin-panel">
                        <h4><i class="fas fa-cog me-2"></i>Admin Panel</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Sales Representatives</h5>
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="newSalesRepName" placeholder="Sales Rep Name">
                                </div>
                                <div class="mb-3">
                                    <input type="email" class="form-control" id="newSalesRepEmail" placeholder="Sales Rep Email">
                                </div>
                                <button type="button" class="btn btn-primary" onclick="addSalesRep()">
                                    <i class="fas fa-user-plus me-2"></i>Add Sales Rep
                                </button>
                                <div id="salesRepsList" class="mt-3"></div>
                            </div>
                            <div class="col-md-6">
                                <h5>Exchange Rates</h5>
                                <button type="button" class="btn btn-secondary" onclick="updateExchangeRates()">
                                    <i class="fas fa-sync me-2"></i>Update Exchange Rates
                                </button>
                                <div id="exchangeRates" class="mt-3"></div>
                                <div class="mt-3">
                                    <h6>Quote Statistics</h6>
                                    <p>Total Quotes: <span id="totalQuotes">0</span></p>
                                    <p>Next Quote Number: <span id="nextQuoteNumber">1</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading position-fixed top-50 start-50 translate-middle" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase JS -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCmBQE2r9I4b-YSQaOPUk8WCBxyH0erl2E",
            authDomain: "quotemaker2025-1.firebaseapp.com",
            projectId: "quotemaker2025-1",
            storageBucket: "quotemaker2025-1.firebasestorage.app",
            messagingSenderId: "441594789802",
            appId: "1:441594789802:web:090a935110288ecd7a75d3",
            measurementId: "G-FNWFPFRN3Q"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.db = db;
        window.firestore = { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, limit };
    </script>

    <script>
        // Global variables
        let currentQuoteItems = [];
        let exchangeRates = {};
        let currentCurrency = 'USD';
        let salesReps = [];
        let quoteCounter = 1;
        let products = [];
        // No pre-embedded data - products will be loaded from uploaded Excel file

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            showLoading(true);
            await loadSalesReps();
            await loadQuoteCounter();
            await updateExchangeRates();
            setupEventListeners();
            updateQuoteNumber();
            showLoading(false);
        }

        function setupEventListeners() {
            // Customer currency change
            document.getElementById('customerCurrency').addEventListener('change', function() {
                currentCurrency = this.value;
                document.getElementById('currentCurrency').textContent = currentCurrency;
                updateQuoteSummary();
            });

            // Country, state, city cascading dropdowns
            document.getElementById('customerCountry').addEventListener('change', loadStates);
            document.getElementById('customerState').addEventListener('change', loadCities);

            // Product search
            document.getElementById('productSearch').addEventListener('input', searchProducts);
            document.getElementById('productSearch').addEventListener('blur', function() {
                setTimeout(() => {
                    document.getElementById('searchResults').style.display = 'none';
                }, 200);
            });

            // Quote calculations
            document.getElementById('quoteLevelDiscountType').addEventListener('change', updateQuoteSummary);
            document.getElementById('quoteLevelDiscountValue').addEventListener('input', updateQuoteSummary);
            document.getElementById('taxRate').addEventListener('input', updateQuoteSummary);
            document.getElementById('shippingType').addEventListener('change', function() {
                const shippingCost = document.getElementById('shippingCost');
                if (this.value === 'paid') {
                    shippingCost.style.display = 'block';
                } else {
                    shippingCost.style.display = 'none';
                    shippingCost.value = '0';
                }
                updateQuoteSummary();
            });
            document.getElementById('shippingCost').addEventListener('input', updateQuoteSummary);
        }

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.add('show');
            } else {
                spinner.classList.remove('show');
            }
        }

        // Customer Management Functions
        async function saveCustomer() {
            const customerData = {
                name: document.getElementById('customerName').value,
                primaryPhone: document.getElementById('primaryPhone').value,
                alternatePhone: document.getElementById('alternatePhone').value,
                email: document.getElementById('customerEmail').value,
                country: document.getElementById('customerCountry').value,
                state: document.getElementById('customerState').value,
                city: document.getElementById('customerCity').value,
                address: document.getElementById('customerAddress').value,
                postalCode: document.getElementById('postalCode').value,
                currency: document.getElementById('customerCurrency').value,
                salesRep: document.getElementById('salesRep').value,
                createdAt: new Date()
            };

            try {
                await window.firestore.addDoc(window.firestore.collection(window.db, 'customers'), customerData);
                alert('Customer saved successfully!');
            } catch (error) {
                console.error('Error saving customer:', error);
                alert('Error saving customer. Please try again.');
            }
        }

        // Location Functions
        function loadStates() {
            const country = document.getElementById('customerCountry').value;
            const stateSelect = document.getElementById('customerState');
            const citySelect = document.getElementById('customerCity');
            
            stateSelect.innerHTML = '<option value="">Select State</option>';
            citySelect.innerHTML = '<option value="">Select City</option>';

            const states = {
                'US': ['California', 'New York', 'Texas', 'Florida', 'Illinois'],
                'IN': ['Maharashtra', 'Karnataka', 'Tamil Nadu', 'Gujarat', 'Delhi'],
                'GB': ['England', 'Scotland', 'Wales', 'Northern Ireland'],
                'DE': ['Bavaria', 'North Rhine-Westphalia', 'Baden-Württemberg', 'Lower Saxony'],
                'AE': ['Dubai', 'Abu Dhabi', 'Sharjah', 'Ajman'],
                'SA': ['Riyadh', 'Makkah', 'Eastern Province', 'Asir'],
                'AU': ['New South Wales', 'Victoria', 'Queensland', 'Western Australia'],
                'NG': ['Lagos', 'Kano', 'Rivers', 'Kaduna']
            };

            if (states[country]) {
                states[country].forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    stateSelect.appendChild(option);
                });
            }
        }

        function loadCities() {
            const state = document.getElementById('customerState').value;
            const citySelect = document.getElementById('customerCity');
            
            citySelect.innerHTML = '<option value="">Select City</option>';

            const cities = {
                'California': ['Los Angeles', 'San Francisco', 'San Diego', 'Sacramento'],
                'Maharashtra': ['Mumbai', 'Pune', 'Nagpur', 'Nashik'],
                'England': ['London', 'Manchester', 'Birmingham', 'Liverpool'],
                'Dubai': ['Dubai City', 'Deira', 'Bur Dubai', 'Jumeirah']
            };

            if (cities[state]) {
                cities[state].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        }

        // Product Search Functions
        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const resultsDiv = document.getElementById('searchResults');
            
            if (searchTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) || 
                product.description.toLowerCase().includes(searchTerm)
            );

            resultsDiv.innerHTML = '';
            filteredProducts.forEach(product => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.innerHTML = `
                    <strong>${product.name}</strong> - $${product.price}<br>
                    <small>${product.description}</small>
                `;
                div.onclick = () => addProductToQuote(product);
                resultsDiv.appendChild(div);
            });

            resultsDiv.style.display = filteredProducts.length > 0 ? 'block' : 'none';
        }

        function addProductToQuote(product) {
            const item = {
                id: Date.now(),
                productId: product.id,
                name: product.name,
                description: product.description,
                price: product.price,
                quantity: 1,
                discountType: 'none',
                discountValue: 0
            };

            currentQuoteItems.push(item);
            renderQuoteItems();
            updateQuoteSummary();
            
            document.getElementById('productSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';
        }

        function addCustomProduct() {
            const name = prompt('Product Name:');
            const price = parseFloat(prompt('Product Price:'));
            const description = prompt('Product Description:');
            
            if (name && !isNaN(price)) {
                const product = {
                    id: Date.now(),
                    name: name,
                    price: price,
                    description: description || ''
                };
                addProductToQuote(product);
            }
        }

        function renderQuoteItems() {
            const itemsList = document.getElementById('itemsList');
            itemsList.innerHTML = '';

            currentQuoteItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'quote-item';
                itemDiv.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <strong>${item.name}</strong><br>
                            <small>${item.description}</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" value="${item.quantity}" min="1" 
                                   onchange="updateItemQuantity(${index}, this.value)">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Unit Price</label>
                            <input type="number" class="form-control" value="${item.price}" step="0.01" 
                                   onchange="updateItemPrice(${index}, this.value)">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Discount Type</label>
                            <select class="form-select" onchange="updateItemDiscountType(${index}, this.value)">
                                <option value="none" ${item.discountType === 'none' ? 'selected' : ''}>No Discount</option>
                                <option value="percentage" ${item.discountType === 'percentage' ? 'selected' : ''}>Percentage</option>
                                <option value="fixed" ${item.discountType === 'fixed' ? 'selected' : ''}>Fixed Amount</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Discount Value</label>
                            <input type="number" class="form-control discount-input" value="${item.discountValue}" 
                                   min="0" step="0.01" onchange="updateItemDiscountValue(${index}, this.value)">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm d-block" onclick="removeItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12 text-end">
                            <strong>Line Total: ${formatCurrency(calculateLineTotal(item))}</strong>
                        </div>
                    </div>
                `;
                itemsList.appendChild(itemDiv);
            });
        }

        function updateItemQuantity(index, quantity) {
            currentQuoteItems[index].quantity = parseInt(quantity) || 1;
            renderQuoteItems();
            updateQuoteSummary();
        }

        function updateItemPrice(index, price) {
            currentQuoteItems[index].price = parseFloat(price) || 0;
            renderQuoteItems();
            updateQuoteSummary();
        }

        function updateItemDiscountType(index, type) {
            currentQuoteItems[index].discountType = type;
            if (type === 'none') {
                currentQuoteItems[index].discountValue = 0;
            }
            renderQuoteItems();
            updateQuoteSummary();
        }

        function updateItemDiscountValue(index, value) {
            currentQuoteItems[index].discountValue = parseFloat(value) || 0;
            renderQuoteItems();
            updateQuoteSummary();
        }

        function removeItem(index) {
            currentQuoteItems.splice(index, 1);
            renderQuoteItems();
            updateQuoteSummary();
        }

        function calculateLineTotal(item) {
            const baseTotal = item.price * item.quantity;
            let discount = 0;
            
            if (item.discountType === 'percentage') {
                discount = baseTotal * (item.discountValue / 100);
            } else if (item.discountType === 'fixed') {
                discount = item.discountValue;
            }
            
            return Math.max(0, baseTotal - discount);
        }

        function updateQuoteSummary() {
            const subtotal = currentQuoteItems.reduce((sum, item) => sum + calculateLineTotal(item), 0);
            
            // Quote-level discount
            const discountType = document.getElementById('quoteLevelDiscountType').value;
            const discountValue = parseFloat(document.getElementById('quoteLevelDiscountValue').value) || 0;
            let quoteDiscount = 0;
            
            if (discountType === 'percentage') {
                quoteDiscount = subtotal * (discountValue / 100);
            } else if (discountType === 'fixed') {
                quoteDiscount = discountValue;
            }
            
            const afterDiscount = subtotal - quoteDiscount;
            
            // Tax calculation
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const taxAmount = afterDiscount * (taxRate / 100);
            
            // Shipping
            const shippingType = document.getElementById('shippingType').value;
            const shippingAmount = shippingType === 'paid' ? 
                (parseFloat(document.getElementById('shippingCost').value) || 0) : 0;
            
            const grandTotal = afterDiscount + taxAmount + shippingAmount;
            
            // Update display
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('quoteDiscount').textContent = formatCurrency(quoteDiscount);
            document.getElementById('taxAmount').textContent = formatCurrency(taxAmount);
            document.getElementById('shippingAmount').textContent = formatCurrency(shippingAmount);
            document.getElementById('grandTotal').textContent = formatCurrency(grandTotal);
        }

        function formatCurrency(amount) {
            const rate = exchangeRates[currentCurrency] || 1;
            const convertedAmount = amount * rate;
            
            const symbols = {
                'USD': '$',
                'INR': '₹',
                'GBP': '£',
                'EUR': '€',
                'AED': 'د.إ',
                'SAR': '﷼',
                'AUD': 'A$',
                'NGN': '₦'
            };
            
            return `${symbols[currentCurrency] || currentCurrency} ${convertedAmount.toFixed(2)}`;
        }

        // Exchange Rate Functions
        async function updateExchangeRates() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                
                exchangeRates = {
                    'USD': 1,
                    'INR': data.rates.INR || 83,
                    'GBP': data.rates.GBP || 0.79,
                    'EUR': data.rates.EUR || 0.85,
                    'AED': data.rates.AED || 3.67,
                    'SAR': data.rates.SAR || 3.75,
                    'AUD': data.rates.AUD || 1.35,
                    'NGN': data.rates.NGN || 800
                };
                
                displayExchangeRates();
                updateQuoteSummary();
            } catch (error) {
                console.error('Error fetching exchange rates:', error);
                // Use fallback rates
                exchangeRates = {
                    'USD': 1, 'INR': 83, 'GBP': 0.79, 'EUR': 0.85,
                    'AED': 3.67, 'SAR': 3.75, 'AUD': 1.35, 'NGN': 800
                };
                displayExchangeRates();
            }
        }

        function displayExchangeRates() {
            const ratesDiv = document.getElementById('exchangeRates');
            ratesDiv.innerHTML = '<h6>Current Exchange Rates (vs USD)</h6>';
            
            Object.entries(exchangeRates).forEach(([currency, rate]) => {
                if (currency !== 'USD') {
                    const div = document.createElement('div');
                    div.innerHTML = `<small>1 USD = ${rate.toFixed(4)} ${currency}</small>`;
                    ratesDiv.appendChild(div);
                }
            });
        }

        // Sales Rep Functions
        async function loadSalesReps() {
            try {
                const querySnapshot = await window.firestore.getDocs(
                    window.firestore.collection(window.db, 'salesReps')
                );
                
                salesReps = [];
                querySnapshot.forEach((doc) => {
                    salesReps.push({ id: doc.id, ...doc.data() });
                });
                
                updateSalesRepDropdown();
                displaySalesReps();
            } catch (error) {
                console.error('Error loading sales reps:', error);
            }
        }

        function updateSalesRepDropdown() {
            const select = document.getElementById('salesRep');
            select.innerHTML = '<option value="">Select Sales Rep</option>';
            
            salesReps.forEach(rep => {
                const option = document.createElement('option');
                option.value = rep.id;
                option.textContent = rep.name;
                select.appendChild(option);
            });
        }

        async function addSalesRep() {
            const name = document.getElementById('newSalesRepName').value;
            const email = document.getElementById('newSalesRepEmail').value;
            
            if (!name || !email) {
                alert('Please enter both name and email.');
                return;
            }
            
            try {
                await window.firestore.addDoc(window.firestore.collection(window.db, 'salesReps'), {
                    name: name,
                    email: email,
                    createdAt: new Date()
                });
                
                document.getElementById('newSalesRepName').value = '';
                document.getElementById('newSalesRepEmail').value = '';
                
                await loadSalesReps();
                alert('Sales representative added successfully!');
            } catch (error) {
                console.error('Error adding sales rep:', error);
                alert('Error adding sales representative. Please try again.');
            }
        }

        function displaySalesReps() {
            const listDiv = document.getElementById('salesRepsList');
            listDiv.innerHTML = '';
            
            salesReps.forEach(rep => {
                const div = document.createElement('div');
                div.className = 'border p-2 mb-2 rounded';
                div.innerHTML = `
                    <strong>${rep.name}</strong><br>
                    <small>${rep.email}</small>
                    <button type="button" class="btn btn-sm btn-danger float-end" onclick="deleteSalesRep('${rep.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                listDiv.appendChild(div);
            });
        }

        async function deleteSalesRep(id) {
            if (confirm('Are you sure you want to delete this sales representative?')) {
                try {
                    await window.firestore.deleteDoc(window.firestore.doc(window.db, 'salesReps', id));
                    await loadSalesReps();
                    alert('Sales representative deleted successfully!');
                } catch (error) {
                    console.error('Error deleting sales rep:', error);
                    alert('Error deleting sales representative. Please try again.');
                }
            }
        }

        // Quote Management Functions
        async function loadQuoteCounter() {
            try {
                const querySnapshot = await window.firestore.getDocs(
                    window.firestore.query(
                        window.firestore.collection(window.db, 'quotes'),
                        window.firestore.orderBy('quoteNumber', 'desc'),
                        window.firestore.limit(1)
                    )
                );
                
                if (!querySnapshot.empty) {
                    const lastQuote = querySnapshot.docs[0].data();
                    quoteCounter = (lastQuote.quoteNumber || 0) + 1;
                } else {
                    quoteCounter = 1;
                }
                
                updateQuoteNumber();
                updateQuoteStats();
            } catch (error) {
                console.error('Error loading quote counter:', error);
                quoteCounter = 1;
                updateQuoteNumber();
            }
        }

        function updateQuoteNumber() {
            document.getElementById('quoteNumber').textContent = `QT-${String(quoteCounter).padStart(4, '0')}`;
        }

        function updateQuoteStats() {
            document.getElementById('totalQuotes').textContent = quoteCounter - 1;
            document.getElementById('nextQuoteNumber').textContent = quoteCounter;
        }

        async function saveQuote() {
            if (currentQuoteItems.length === 0) {
                alert('Please add at least one item to the quote.');
                return;
            }
            
            const customerName = document.getElementById('customerName').value;
            if (!customerName) {
                alert('Please enter customer information.');
                return;
            }
            
            const quoteData = {
                quoteNumber: quoteCounter,
                customer: {
                    name: customerName,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('primaryPhone').value,
                    address: document.getElementById('customerAddress').value,
                    country: document.getElementById('customerCountry').value,
                    currency: document.getElementById('customerCurrency').value
                },
                items: currentQuoteItems,
                quoteLevelDiscount: {
                    type: document.getElementById('quoteLevelDiscountType').value,
                    value: parseFloat(document.getElementById('quoteLevelDiscountValue').value) || 0
                },
                taxRate: parseFloat(document.getElementById('taxRate').value) || 0,
                shipping: {
                    type: document.getElementById('shippingType').value,
                    cost: parseFloat(document.getElementById('shippingCost').value) || 0
                },
                currency: currentCurrency,
                exchangeRates: exchangeRates,
                createdAt: new Date(),
                salesRep: document.getElementById('salesRep').value
            };
            
            try {
                await window.firestore.addDoc(window.firestore.collection(window.db, 'quotes'), quoteData);
                alert(`Quote QT-${String(quoteCounter).padStart(4, '0')} saved successfully!`);
                
                // Reset for next quote
                quoteCounter++;
                updateQuoteNumber();
                updateQuoteStats();
                
                // Clear current quote
                currentQuoteItems = [];
                renderQuoteItems();
                updateQuoteSummary();
                
            } catch (error) {
                console.error('Error saving quote:', error);
                alert('Error saving quote. Please try again.');
            }
        }

        function generateQuote() {
            if (currentQuoteItems.length === 0) {
                alert('Please add at least one item to the quote.');
                return;
            }
            
            // This would typically generate a PDF or open a print dialog
            // For now, we'll show a summary
            const summary = `
Quote Summary:
Quote Number: QT-${String(quoteCounter).padStart(4, '0')}
Customer: ${document.getElementById('customerName').value}
Total Items: ${currentQuoteItems.length}
Grand Total: ${document.getElementById('grandTotal').textContent}
            `;
            
            alert(summary);
            window.print();
        }
    </script>
</body>
</html>