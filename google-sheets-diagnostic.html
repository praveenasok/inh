<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets API Diagnostic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Google Sheets API Diagnostic</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Initialization Steps</h2>
            <div id="steps" class="space-y-2">
                <div id="step1" class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-gray-300 mr-3"></div>
                    <span>1. Check if gapi is loaded</span>
                </div>
                <div id="step2" class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-gray-300 mr-3"></div>
                    <span>2. Check API key configuration</span>
                </div>
                <div id="step3" class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-gray-300 mr-3"></div>
                    <span>3. Load gapi.client</span>
                </div>
                <div id="step4" class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-gray-300 mr-3"></div>
                    <span>4. Initialize gapi.client</span>
                </div>
                <div id="step5" class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-gray-300 mr-3"></div>
                    <span>5. Test API call</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Current Status</h2>
            <div id="status" class="text-gray-600">Ready to start diagnostic...</div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Debug Log</h2>
            <div id="log" class="bg-gray-50 p-4 rounded text-sm font-mono h-64 overflow-y-auto"></div>
        </div>

        <button id="startDiagnostic" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            Start Diagnostic
        </button>
        
        <button id="skipToFirebase" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded ml-4">
            Skip to Firebase Test
        </button>
    </div>

    <script>
        // API Key (same as in admin-sync-panel.html)
        const GOOGLE_SHEETS_API_KEY = '35bbf27b0bf3abb0a9fec63e815006a5785ec7bb';
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        function markStep(stepId, status) {
            const step = document.getElementById(stepId);
            const indicator = step.querySelector('div');
            if (status === 'success') {
                indicator.className = 'w-4 h-4 rounded-full bg-green-500 mr-3';
            } else if (status === 'error') {
                indicator.className = 'w-4 h-4 rounded-full bg-red-500 mr-3';
            } else if (status === 'loading') {
                indicator.className = 'w-4 h-4 rounded-full bg-yellow-500 mr-3 animate-pulse';
            }
        }
        
        async function testApiKeyValidity() {
            log('Testing API key validity...');
            
            try {
                // Test with a simple API call that doesn't require authentication
                const PUBLIC_SPREADSHEET_ID = '1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms';
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${PUBLIC_SPREADSHEET_ID}?key=${GOOGLE_SHEETS_API_KEY}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('✓ API key is valid and working!');
                    log(`Successfully accessed public spreadsheet: "${data.properties.title}"`);
                    return true;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    let details = '';
                    let recommendations = '';
                    
                    if (response.status === 400) {
                        errorMessage = 'API key is invalid or malformed';
                        details = 'The API key format is incorrect or the key doesn\'t exist.';
                        recommendations = `
                            How to fix:
                            1. Go to Google Cloud Console (https://console.cloud.google.com/apis/credentials)
                            2. Create a new API key or verify the existing one
                            3. Make sure the key is not restricted or has proper restrictions
                            4. Update the GOOGLE_SHEETS_API_KEY constant in this file
                        `;
                    } else if (response.status === 403) {
                        if (errorData.error?.message?.includes('quota')) {
                            errorMessage = 'API quota exceeded';
                            details = 'The API key has exceeded its daily quota limit.';
                            recommendations = `
                                How to fix:
                                1. Wait for quota reset (usually 24 hours)
                                2. Or increase quota limits in Google Cloud Console
                                3. Check your API usage in the console
                            `;
                        } else {
                            errorMessage = 'API key lacks necessary permissions';
                            details = 'The API key doesn\'t have permission to access Google Sheets API.';
                            recommendations = `
                                How to fix:
                                1. Go to Google Cloud Console (https://console.cloud.google.com/apis/library/sheets.googleapis.com)
                                2. Enable the Google Sheets API
                                3. Make sure your API key has access to this API
                                4. Check API key restrictions
                            `;
                        }
                    } else if (response.status === 404) {
                        errorMessage = 'Spreadsheet not found (but API key might be valid)';
                        details = 'The test spreadsheet wasn\'t found, but this might indicate the API key is working.';
                        recommendations = `
                            Note:
                            This might actually be a good sign - the API key is working but the specific spreadsheet ID is not accessible.
                        `;
                    }
                    
                    log('❌ ' + errorMessage);
                    log(details);
                    log(recommendations);
                    return false;
                }
            } catch (error) {
                log('❌ Network error during API key test');
                log(`Error: ${error.message}. Check your internet connection and try again.`);
                return false;
            }
        }
        
        async function runDiagnostic() {
            log('Starting Google Sheets API diagnostic...');
            updateStatus('Running diagnostic...');
            
            try {
                // Step 1: Check if gapi is loaded
                markStep('step1', 'loading');
                log('Step 1: Checking if gapi is loaded...');
                
                if (typeof gapi === 'undefined') {
                    throw new Error('gapi is not loaded');
                }
                
                markStep('step1', 'success');
                log('✓ gapi is loaded');
                
                // Step 2: Check API key
                markStep('step2', 'loading');
                log('Step 2: Checking API key configuration...');
                
                if (!GOOGLE_SHEETS_API_KEY || GOOGLE_SHEETS_API_KEY.includes('YOUR_')) {
                    throw new Error('API key not configured properly');
                }
                
                // Test API key validity
                const apiKeyValid = await testApiKeyValidity();
                if (!apiKeyValid) {
                    throw new Error('API key validation failed');
                }
                
                markStep('step2', 'success');
                log('✓ API key is configured and valid');
                
                // Step 3: Load gapi.client
                markStep('step3', 'loading');
                log('Step 3: Loading gapi.client...');
                
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('gapi.client load timeout'));
                    }, 10000);
                    
                    gapi.load('client', {
                        callback: () => {
                            clearTimeout(timeout);
                            resolve();
                        },
                        onerror: (error) => {
                            clearTimeout(timeout);
                            reject(error);
                        }
                    });
                });
                
                markStep('step3', 'success');
                log('✓ gapi.client loaded');
                
                // Step 4: Initialize gapi.client
                markStep('step4', 'loading');
                log('Step 4: Initializing gapi.client...');
                
                const initConfig = {
                    apiKey: GOOGLE_SHEETS_API_KEY,
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                };
                
                log('Init config: ' + JSON.stringify(initConfig));
                
                await Promise.race([
                    gapi.client.init(initConfig),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('gapi.client.init timeout')), 15000)
                    )
                ]);
                
                markStep('step4', 'success');
                log('✓ gapi.client initialized');
                
                // Step 5: Test API call
                markStep('step5', 'loading');
                log('Step 5: Testing API call...');
                
                // Test with a public spreadsheet
                const testSheetId = '1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms';
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: testSheetId,
                    range: 'Class Data!A1:B2'
                });
                
                markStep('step5', 'success');
                log('✓ API call successful');
                log('Response: ' + JSON.stringify(response.result, null, 2));
                
                updateStatus('✅ All tests passed! Google Sheets API is working.');
                
            } catch (error) {
                log('❌ Error: ' + error.message);
                updateStatus('❌ Diagnostic failed: ' + error.message);
                
                // Mark current step as error
                const steps = ['step1', 'step2', 'step3', 'step4', 'step5'];
                for (let step of steps) {
                    const indicator = document.getElementById(step).querySelector('div');
                    if (indicator.className.includes('animate-pulse')) {
                        markStep(step, 'error');
                        break;
                    }
                }
            }
        }
        
        async function testFirebaseOnly() {
            log('Testing Firebase connection only...');
            updateStatus('Testing Firebase...');
            
            try {
                // Load Firebase config
                const script = document.createElement('script');
                script.src = '/firebase-config.js';
                document.head.appendChild(script);
                
                await new Promise(resolve => {
                    script.onload = resolve;
                });
                
                log('✓ Firebase config loaded');
                
                // Initialize Firebase
                if (typeof initializeFirebaseApp === 'function') {
                    initializeFirebaseApp();
                    log('✓ Firebase initialized');
                    updateStatus('✅ Firebase is working! You can proceed with Firebase-only operations.');
                } else {
                    throw new Error('Firebase initialization function not found');
                }
                
            } catch (error) {
                log('❌ Firebase error: ' + error.message);
                updateStatus('❌ Firebase test failed: ' + error.message);
            }
        }
        
        document.getElementById('startDiagnostic').addEventListener('click', runDiagnostic);
        document.getElementById('skipToFirebase').addEventListener('click', testFirebaseOnly);
        
        // Auto-start diagnostic
        setTimeout(runDiagnostic, 1000);
    </script>
</body>
</html>