<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Source Data Comparison - INH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="js/unified-data-access.js"></script>
    <style>
        .comparison-table {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-loaded {
            background-color: #dcfce7;
            color: #166534;
        }
        .status-loading {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-empty {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        .count-cell {
            font-weight: 600;
            text-align: center;
        }
        .count-high {
            background-color: #dcfce7;
            color: #166534;
        }
        .count-medium {
            background-color: #fef3c7;
            color: #92400e;
        }
        .count-low {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .count-zero {
            background-color: #f3f4f6;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center space-x-4">
                    <h1 class="text-3xl font-bold text-gray-900">🔍 Cross-Source Data Comparison</h1>
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                        Firebase • LocalStorage • Google Sheets
                    </span>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="loadAllBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2 font-medium">
                        <span>🔄</span>
                        <span>Load All Data</span>
                    </button>
                    <button id="exportBtn" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2 font-medium">
                        <span>📊</span>
                        <span>Export CSV</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Status Dashboard -->
        <div class="mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">📊 Data Source Status</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="flex items-center justify-between p-4 bg-orange-50 rounded-lg border border-orange-200">
                        <div>
                            <h3 class="font-semibold text-orange-900">🔥 Firebase</h3>
                            <p class="text-sm text-orange-700">Cloud Database</p>
                        </div>
                        <span id="firebaseStatus" class="status-badge status-empty">Not Loaded</span>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <div>
                            <h3 class="font-semibold text-purple-900">💾 Local Storage</h3>
                            <p class="text-sm text-purple-700">Browser Storage</p>
                        </div>
                        <span id="localStatus" class="status-badge status-empty">Not Loaded</span>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-200">
                        <div>
                            <h3 class="font-semibold text-green-900">📊 Google Sheets</h3>
                            <p class="text-sm text-green-700">Spreadsheet Data</p>
                        </div>
                        <span id="sheetsStatus" class="status-badge status-empty">Not Loaded</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Table -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden comparison-table">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
                <h2 class="text-2xl font-bold">📋 Data Category Comparison</h2>
                <p class="opacity-90 mt-1">Compare data counts across all three sources</p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 border-b">Data Category</th>
                            <th class="px-6 py-4 text-center text-sm font-semibold text-gray-900 border-b">🔥 Firebase</th>
                            <th class="px-6 py-4 text-center text-sm font-semibold text-gray-900 border-b">💾 Local Storage</th>
                            <th class="px-6 py-4 text-center text-sm font-semibold text-gray-900 border-b">📊 Google Sheets</th>
                            <th class="px-6 py-4 text-center text-sm font-semibold text-gray-900 border-b">📈 Total</th>
                            <th class="px-6 py-4 text-center text-sm font-semibold text-gray-900 border-b">🎯 Primary Source</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableBody">
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">📦 Products</td>
                            <td class="px-6 py-4 count-cell" id="firebase-products">-</td>
                            <td class="px-6 py-4 count-cell" id="local-products">-</td>
                            <td class="px-6 py-4 count-cell" id="sheets-products">-</td>
                            <td class="px-6 py-4 count-cell font-bold" id="total-products">-</td>
                            <td class="px-6 py-4 text-center" id="primary-products">-</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">💰 Price Lists</td>
                            <td class="px-6 py-4 count-cell" id="firebase-pricelists">-</td>
                            <td class="px-6 py-4 count-cell" id="local-pricelists">-</td>
                            <td class="px-6 py-4 count-cell" id="sheets-pricelists">-</td>
                            <td class="px-6 py-4 count-cell font-bold" id="total-pricelists">-</td>
                            <td class="px-6 py-4 text-center" id="primary-pricelists">-</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">📂 Categories</td>
                            <td class="px-6 py-4 count-cell" id="firebase-categories">-</td>
                            <td class="px-6 py-4 count-cell" id="local-categories">-</td>
                            <td class="px-6 py-4 count-cell" id="sheets-categories">-</td>
                            <td class="px-6 py-4 count-cell font-bold" id="total-categories">-</td>
                            <td class="px-6 py-4 text-center" id="primary-categories">-</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">🎨 Color Types</td>
                            <td class="px-6 py-4 count-cell" id="firebase-colortypes">-</td>
                            <td class="px-6 py-4 count-cell" id="local-colortypes">-</td>
                            <td class="px-6 py-4 count-cell" id="sheets-colortypes">-</td>
                            <td class="px-6 py-4 count-cell font-bold" id="total-colortypes">-</td>
                            <td class="px-6 py-4 text-center" id="primary-colortypes">-</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">🌈 Colors</td>
                            <td class="px-6 py-4 count-cell" id="firebase-colors">-</td>
                            <td class="px-6 py-4 count-cell" id="local-colors">-</td>
                            <td class="px-6 py-4 count-cell" id="sheets-colors">-</td>
                            <td class="px-6 py-4 count-cell font-bold" id="total-colors">-</td>
                            <td class="px-6 py-4 text-center" id="primary-colors">-</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">✨ Styles</td>
                            <td class="px-6 py-4 count-cell" id="firebase-styles">-</td>
                            <td class="px-6 py-4 count-cell" id="local-styles">-</td>
                            <td class="px-6 py-4 count-cell" id="sheets-styles">-</td>
                            <td class="px-6 py-4 count-cell font-bold" id="total-styles">-</td>
                            <td class="px-6 py-4 text-center" id="primary-styles">-</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">👥 Salesmen</td>
                            <td class="px-6 py-4 count-cell" id="firebase-salesmen">-</td>
                            <td class="px-6 py-4 count-cell" id="local-salesmen">-</td>
                            <td class="px-6 py-4 count-cell" id="sheets-salesmen">-</td>
                            <td class="px-6 py-4 count-cell font-bold" id="total-salesmen">-</td>
                            <td class="px-6 py-4 text-center" id="primary-salesmen">-</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">💼 Quotes</td>
                            <td class="px-6 py-4 count-cell" id="firebase-quotes">-</td>
                            <td class="px-6 py-4 count-cell" id="local-quotes">-</td>
                            <td class="px-6 py-4 count-cell" id="sheets-quotes">-</td>
                            <td class="px-6 py-4 count-cell font-bold" id="total-quotes">-</td>
                            <td class="px-6 py-4 text-center" id="primary-quotes">-</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">👤 Clients</td>
                            <td class="px-6 py-4 count-cell" id="firebase-clients">-</td>
                            <td class="px-6 py-4 count-cell" id="local-clients">-</td>
                            <td class="px-6 py-4 count-cell" id="sheets-clients">-</td>
                            <td class="px-6 py-4 count-cell font-bold" id="total-clients">-</td>
                            <td class="px-6 py-4 text-center" id="primary-clients">-</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">📋 Orders</td>
                            <td class="px-6 py-4 count-cell" id="firebase-orders">-</td>
                            <td class="px-6 py-4 count-cell" id="local-orders">-</td>
                            <td class="px-6 py-4 count-cell" id="sheets-orders">-</td>
                            <td class="px-6 py-4 count-cell font-bold" id="total-orders">-</td>
                            <td class="px-6 py-4 text-center" id="primary-orders">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="text-2xl font-bold text-blue-600" id="totalDataPoints">0</div>
                <div class="text-sm text-gray-600">Total Data Points</div>
            </div>
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="text-2xl font-bold text-green-600" id="activeCategories">0</div>
                <div class="text-sm text-gray-600">Active Categories</div>
            </div>
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="text-2xl font-bold text-purple-600" id="sourcesLoaded">0/3</div>
                <div class="text-sm text-gray-600">Sources Loaded</div>
            </div>
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="text-2xl font-bold text-orange-600" id="lastUpdate">Never</div>
                <div class="text-sm text-gray-600">Last Updated</div>
            </div>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md mx-4">
            <div class="flex items-center space-x-4">
                <div class="loading-spinner"></div>
                <div>
                    <div class="font-semibold text-gray-900">Loading Data Sources</div>
                    <div class="text-sm text-gray-600" id="loadingStatus">Initializing...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class CrossSourceComparison {
            constructor() {
                this.dataAccess = new UnifiedDataAccess();
                this.data = {
                    firebase: {},
                    localStorage: {},
                    googleSheets: {}
                };
                this.categories = [
                    'products', 'pricelists', 'categories', 'colortypes', 
                    'colors', 'styles', 'salesmen', 'quotes', 'clients', 'orders'
                ];
                this.init();
            }

            init() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('loadAllBtn').addEventListener('click', () => this.loadAllData());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportToCSV());
            }

            showLoading(status = 'Loading...') {
                document.getElementById('loadingModal').classList.remove('hidden');
                document.getElementById('loadingModal').classList.add('flex');
                document.getElementById('loadingStatus').textContent = status;
            }

            hideLoading() {
                document.getElementById('loadingModal').classList.add('hidden');
                document.getElementById('loadingModal').classList.remove('flex');
            }

            updateStatus(source, status) {
                const statusElement = document.getElementById(`${source}Status`);
                statusElement.className = `status-badge status-${status}`;
                statusElement.textContent = status === 'loaded' ? 'Loaded' : 
                                          status === 'loading' ? 'Loading...' : 
                                          status === 'error' ? 'Error' : 
                                          status === 'warning' ? 'Warning' : 'Not Loaded';
            }

            async loadAllData() {
                this.showLoading('Initializing data sources...');
                
                try {
                    // Load Firebase data
                    this.updateStatus('firebase', 'loading');
                    this.showLoading('Loading Firebase collections...');
                    await this.loadFirebaseData();
                    this.updateStatus('firebase', 'loaded');

                    // Load Local Storage data
                    this.updateStatus('local', 'loading');
                    this.showLoading('Analyzing local storage...');
                    await this.loadLocalStorageData();
                    this.updateStatus('local', 'loaded');

                    // Load Google Sheets data
                    this.updateStatus('sheets', 'loading');
                    this.showLoading('Fetching Google Sheets data...');
                    await this.loadGoogleSheetsData();
                    this.updateStatus('sheets', 'loaded');

                    this.updateComparisonTable();
                    this.updateSummaryStats();
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                } finally {
                    this.hideLoading();
                }
            }

            async loadFirebaseData() {
                try {
                    // Initialize Firebase if not already done
                    if (typeof firebase === 'undefined') {
                        throw new Error('Firebase SDK not loaded');
                    }

                    if (!firebase.apps.length) {
                        firebase.initializeApp(window.firebaseConfig);
                    }

                    const db = firebase.firestore();
                    
                    // Test connection first
                    await db.enableNetwork();

                    // Load data directly from Firestore collections
                    const [
                        productsSnapshot,
                        colorsSnapshot,
                        stylesSnapshot,
                        salespeopleSnapshot,
                        quotesSnapshot,
                        clientsSnapshot,
                        ordersSnapshot
                    ] = await Promise.all([
                        db.collection('products').get().catch(() => ({ docs: [] })),
                        db.collection('colors').get().catch(() => ({ docs: [] })),
                        db.collection('styles').get().catch(() => ({ docs: [] })),
                        db.collection('salespeople').get().catch(() => ({ docs: [] })),
                        db.collection('quotes').get().catch(() => ({ docs: [] })),
                        db.collection('clients').get().catch(() => ({ docs: [] })),
                        db.collection('orders').get().catch(() => ({ docs: [] }))
                    ]);

                    // Process products and extract metadata
                    const products = [];
                    const priceLists = new Set();
                    const categories = new Set();
                    const colorTypes = new Set();

                    productsSnapshot.docs.forEach(doc => {
                        const product = { id: doc.id, ...doc.data() };
                        products.push(product);
                        
                        if (product['Price List Name'] || product.PriceListName) {
                            priceLists.add(product['Price List Name'] || product.PriceListName);
                        }
                        if (product.Category) categories.add(product.Category);
                        if (product.Colors) colorTypes.add(product.Colors);
                    });

                    this.data.firebase.products = products.length;
                    this.data.firebase.pricelists = priceLists.size;
                    this.data.firebase.categories = categories.size;
                    this.data.firebase.colortypes = colorTypes.size;

                    // Process other collections
                    this.data.firebase.colors = colorsSnapshot.docs.length;
                    this.data.firebase.styles = stylesSnapshot.docs.length;
                    this.data.firebase.salesmen = salespeopleSnapshot.docs.length;
                    this.data.firebase.quotes = quotesSnapshot.docs.length;
                    this.data.firebase.clients = clientsSnapshot.docs.length;
                    this.data.firebase.orders = ordersSnapshot.docs.length;

                    console.log('✅ Firebase data loaded successfully:', this.data.firebase);

                } catch (error) {
                    console.error('❌ Error loading Firebase data:', error);
                    this.updateStatus('firebase', 'error');
                    
                    // Set all counts to 0 on error
                    this.data.firebase = {
                        products: 0,
                        pricelists: 0,
                        categories: 0,
                        colortypes: 0,
                        colors: 0,
                        styles: 0,
                        salesmen: 0,
                        quotes: 0,
                        clients: 0,
                        orders: 0
                    };
                }
            }

            async loadLocalStorageData() {
                try {
                    this.data.localStorage = {
                        products: 0,
                        pricelists: 0,
                        categories: 0,
                        colortypes: 0,
                        colors: 0,
                        styles: 0,
                        salesmen: 0,
                        quotes: 0,
                        clients: 0,
                        orders: 0
                    };

                    // Analyze localStorage keys
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        
                        try {
                            const parsedValue = JSON.parse(value);
                            const keyLower = key.toLowerCase();
                            
                            if (keyLower.includes('product')) {
                                this.data.localStorage.products += Array.isArray(parsedValue) ? parsedValue.length : 1;
                                
                                // Extract categories and price lists from products
                                if (Array.isArray(parsedValue)) {
                                    const categories = new Set();
                                    const priceLists = new Set();
                                    const colorTypes = new Set();
                                    
                                    parsedValue.forEach(item => {
                                        if (item.Category) categories.add(item.Category);
                                        if (item['Price List Name'] || item.PriceListName) {
                                            priceLists.add(item['Price List Name'] || item.PriceListName);
                                        }
                                        if (item.Colors) colorTypes.add(item.Colors);
                                    });
                                    
                                    this.data.localStorage.categories = Math.max(this.data.localStorage.categories, categories.size);
                                    this.data.localStorage.pricelists = Math.max(this.data.localStorage.pricelists, priceLists.size);
                                    this.data.localStorage.colortypes = Math.max(this.data.localStorage.colortypes, colorTypes.size);
                                }
                            }
                            else if (keyLower.includes('color')) {
                                this.data.localStorage.colors += Array.isArray(parsedValue) ? parsedValue.length : 1;
                            }
                            else if (keyLower.includes('style')) {
                                this.data.localStorage.styles += Array.isArray(parsedValue) ? parsedValue.length : 1;
                            }
                            else if (keyLower.includes('sales')) {
                                this.data.localStorage.salesmen += Array.isArray(parsedValue) ? parsedValue.length : 1;
                            }
                            else if (keyLower.includes('quote')) {
                                this.data.localStorage.quotes += Array.isArray(parsedValue) ? parsedValue.length : 1;
                            }
                            else if (keyLower.includes('client')) {
                                this.data.localStorage.clients += Array.isArray(parsedValue) ? parsedValue.length : 1;
                            }
                            else if (keyLower.includes('order')) {
                                this.data.localStorage.orders += Array.isArray(parsedValue) ? parsedValue.length : 1;
                            }
                        } catch (e) {
                            // Handle non-JSON data
                        }
                    }
                } catch (error) {
                    console.error('Error loading localStorage data:', error);
                    this.updateStatus('local', 'error');
                }
            }

            async loadGoogleSheetsData() {
                try {
                    this.data.googleSheets = {
                        products: 0,
                        pricelists: 0,
                        categories: 0,
                        colortypes: 0,
                        colors: 0,
                        styles: 0,
                        salesmen: 0,
                        quotes: 0,
                        clients: 0,
                        orders: 0
                    };

                    // Check if Google Sheets API is available and configured
                    const API_KEY = window.GOOGLE_SHEETS_API_KEY || 'YOUR_GOOGLE_SHEETS_API_KEY';
                    const SHEET_ID = '1hlfrnZnNQ0u8idg5KDmkSY4zFhLyvjLqUwAZn6HmW3s';

                    if (API_KEY === 'YOUR_GOOGLE_SHEETS_API_KEY') {
                        console.warn('⚠️ Google Sheets API key not configured. Skipping Google Sheets data loading.');
                        this.updateStatus('sheets', 'warning');
                        return;
                    }

                    // Try to load data directly from Google Sheets API
                    try {
                        // Load Products sheet
                        const productsResponse = await fetch(
                            `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Products!A:Z?key=${API_KEY}`
                        );
                        
                        if (productsResponse.ok) {
                            const productsData = await productsResponse.json();
                            const products = this.parseSheetData(productsData.values);
                            
                            if (products && products.length > 0) {
                                this.data.googleSheets.products = products.length;
                                
                                // Extract unique values
                                const categories = new Set();
                                const priceLists = new Set();
                                const colorTypes = new Set();
                                
                                products.forEach(product => {
                                    if (product.Category) categories.add(product.Category);
                                    if (product['Price List Name'] || product.PriceListName) {
                                        priceLists.add(product['Price List Name'] || product.PriceListName);
                                    }
                                    if (product.Colors) colorTypes.add(product.Colors);
                                });
                                
                                this.data.googleSheets.categories = categories.size;
                                this.data.googleSheets.pricelists = priceLists.size;
                                this.data.googleSheets.colortypes = colorTypes.size;
                            }
                        }
                    } catch (e) {
                        console.warn('Could not load products from Google Sheets:', e);
                    }

                    try {
                        // Load Salesmen sheet
                        const salesmenResponse = await fetch(
                            `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Salesmen!A:Z?key=${API_KEY}`
                        );
                        
                        if (salesmenResponse.ok) {
                            const salesmenData = await salesmenResponse.json();
                            const salesmen = this.parseSheetData(salesmenData.values);
                            this.data.googleSheets.salesmen = salesmen?.length || 0;
                        }
                    } catch (e) {
                        console.warn('Could not load salesmen from Google Sheets:', e);
                    }

                    // Note: Other data types (colors, styles, quotes, clients, orders) 
                    // are typically not stored in Google Sheets in this setup
                    console.log('📊 Google Sheets data loaded:', this.data.googleSheets);

                } catch (error) {
                    console.error('❌ Error loading Google Sheets data:', error);
                    this.updateStatus('sheets', 'error');
                }
            }

            parseSheetData(values) {
                if (!values || values.length < 2) return [];
                
                const headers = values[0];
                const data = [];
                
                for (let i = 1; i < values.length; i++) {
                    const row = values[i];
                    const item = {};
                    
                    headers.forEach((header, index) => {
                        item[header] = row[index] || '';
                    });
                    
                    data.push(item);
                }
                
                return data;
            }

            updateComparisonTable() {
                this.categories.forEach(category => {
                    const firebaseCount = this.data.firebase[category] || 0;
                    const localCount = this.data.localStorage[category] || 0;
                    const sheetsCount = this.data.googleSheets[category] || 0;
                    const total = firebaseCount + localCount + sheetsCount;

                    // Update counts
                    this.updateCountCell(`firebase-${category}`, firebaseCount);
                    this.updateCountCell(`local-${category}`, localCount);
                    this.updateCountCell(`sheets-${category}`, sheetsCount);
                    this.updateCountCell(`total-${category}`, total);

                    // Determine primary source
                    const primarySource = this.getPrimarySource(firebaseCount, localCount, sheetsCount);
                    document.getElementById(`primary-${category}`).innerHTML = primarySource;
                });
            }

            updateCountCell(elementId, count) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = count;
                    
                    // Apply color coding
                    element.className = 'px-6 py-4 count-cell';
                    if (count === 0) {
                        element.classList.add('count-zero');
                    } else if (count < 10) {
                        element.classList.add('count-low');
                    } else if (count < 100) {
                        element.classList.add('count-medium');
                    } else {
                        element.classList.add('count-high');
                    }
                }
            }

            getPrimarySource(firebase, local, sheets) {
                const max = Math.max(firebase, local, sheets);
                if (max === 0) return '<span class="text-gray-400">No Data</span>';
                
                if (firebase === max) return '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs">🔥 Firebase</span>';
                if (local === max) return '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">💾 Local</span>';
                if (sheets === max) return '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">📊 Sheets</span>';
            }

            updateSummaryStats() {
                let totalDataPoints = 0;
                let activeCategories = 0;
                let sourcesLoaded = 0;

                // Count total data points and active categories
                this.categories.forEach(category => {
                    const firebaseCount = this.data.firebase[category] || 0;
                    const localCount = this.data.localStorage[category] || 0;
                    const sheetsCount = this.data.googleSheets[category] || 0;
                    const total = firebaseCount + localCount + sheetsCount;
                    
                    totalDataPoints += total;
                    if (total > 0) activeCategories++;
                });

                // Count loaded sources
                if (Object.keys(this.data.firebase).length > 0) sourcesLoaded++;
                if (Object.keys(this.data.localStorage).length > 0) sourcesLoaded++;
                if (Object.keys(this.data.googleSheets).length > 0) sourcesLoaded++;

                document.getElementById('totalDataPoints').textContent = totalDataPoints.toLocaleString();
                document.getElementById('activeCategories').textContent = `${activeCategories}/${this.categories.length}`;
                document.getElementById('sourcesLoaded').textContent = `${sourcesLoaded}/3`;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            }

            exportToCSV() {
                const headers = ['Category', 'Firebase', 'Local Storage', 'Google Sheets', 'Total', 'Primary Source'];
                const rows = [headers];

                this.categories.forEach(category => {
                    const firebaseCount = this.data.firebase[category] || 0;
                    const localCount = this.data.localStorage[category] || 0;
                    const sheetsCount = this.data.googleSheets[category] || 0;
                    const total = firebaseCount + localCount + sheetsCount;
                    
                    const max = Math.max(firebaseCount, localCount, sheetsCount);
                    let primarySource = 'No Data';
                    if (max > 0) {
                        if (firebaseCount === max) primarySource = 'Firebase';
                        else if (localCount === max) primarySource = 'Local Storage';
                        else if (sheetsCount === max) primarySource = 'Google Sheets';
                    }

                    rows.push([
                        category.charAt(0).toUpperCase() + category.slice(1),
                        firebaseCount,
                        localCount,
                        sheetsCount,
                        total,
                        primarySource
                    ]);
                });

                const csvContent = rows.map(row => row.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cross-source-comparison-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new CrossSourceComparison();
        });
    </script>
</body>
</html>