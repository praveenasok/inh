<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
  <title>Price List Generator ‚Äî Multi-Select + PDF</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas for HTML to canvas conversion -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- SheetJS for Excel parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* CSS Variables for Quote Maker sections */
    :root{ --indigo:#eef2ff; --mint:#ecfeff; --amber:#fff7ed; --rose:#fff1f2; --slate:#f8fafc; }
    
    /* Quote Maker section styles */
    .section { padding: 16px; margin-bottom: 16px; border-radius: 12px; border: 1px solid #e5e7eb; }
    .section.indigo { background: var(--indigo); }
    .section.mint   { background: var(--mint); }
    .section.amber  { background: var(--amber); }
    .section.rose   { background: var(--rose); }
    .section.slate  { background: var(--slate); }
    
    /* Quote Maker table styles */
    .table th, .table td { padding: 8px; text-align: left; }
    .table th { background-color: #e5e7eb; }
    #items-table.zebra tbody tr:nth-child(odd) { background-color:#ffffff; }
    #items-table.zebra tbody tr:nth-child(even) { background-color:#f9fafb; }
    
    /* Quote Maker button styles */
    .pressable { transition: transform 120ms ease, box-shadow 120ms ease; box-shadow: 0 2px 0 rgba(0,0,0,0.15); }
    .pressable:active, .pressed { transform: translateY(1px) scale(0.99); box-shadow: 0 0 0 rgba(0,0,0,0.1); }
    
    /* Quote Maker utility styles */
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    
    /* Base responsive styles */
    .shadow-soft { box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
    
    /* Touch-friendly interactive elements */
    select, button, input[type="checkbox"], input[type="text"], input[type="number"] { 
      min-height: 48px; 
      font-size: 16px; /* Prevents zoom on iOS */
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    /* Enhanced visual feedback for form elements */
    input[type="number"], input[type="text"], select {
      transition: all 0.2s ease;
    }
    
    input[type="number"]:focus, input[type="text"]:focus, select:focus {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    input[type="number"]:hover, input[type="text"]:hover, select:hover {
      border-color: #9ca3af;
    }
    
    /* Loading spinner animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .loading-spinner {
      animation: spin 1s linear infinite;
    }
    
    /* Pulse animation for loading states */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* Success/Error state indicators */
    .success-glow {
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
      border-color: #22c55e;
    }
    
    .error-glow {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
    }
    
    /* Enhanced button styles with better touch targets */
    button {
      min-height: 48px;
      padding: 12px 16px;
      font-weight: 500;
      cursor: pointer;
      touch-action: manipulation;
    }
    
    button:focus { 
      outline: 3px solid #3b82f6; 
      outline-offset: 2px; 
    }
    
    button:disabled { 
      cursor: not-allowed; 
      opacity: 0.6;
    }
    
    /* Button variants */
    .btn-primary { 
      background: #081249; 
      color: white; 
      border: 2px solid #081249;
      box-shadow: 0 4px 12px rgba(8, 18, 73, 0.3);
    }
    .btn-primary:hover:not(:disabled) { 
      background: #0a1555; 
      border-color: #0a1555;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(8, 18, 73, 0.4);
    }
    
    .btn-secondary { 
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); 
      color: #475569; 
      border: 2px solid #e2e8f0;
      box-shadow: 0 4px 12px rgba(71, 85, 105, 0.15);
    }
    .btn-secondary:hover:not(:disabled) { 
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); 
      border-color: #cbd5e1;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(71, 85, 105, 0.2);
    }
    
    .btn-info { 
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); 
      color: white; 
      border: 2px solid #2563eb;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .btn-info:hover:not(:disabled) { 
      background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%); 
      border-color: #1d4ed8;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
    }
    
    /* Responsive typography */
    .chip { 
      display: inline-flex; 
      align-items: center; 
      gap: 0.5rem; 
      padding: 0.5rem 0.75rem; 
      border-radius: 9999px; 
      background: #f1f5f9; 
      color: #334155; 
      font-size: 0.875rem;
      min-height: 36px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .chip:hover {
      background: #e2e8f0;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .chip:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Responsive grid system */
    .grid-col { 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 1rem; 
    }
    
    @media (min-width: 480px) { 
      .grid-col { 
        grid-template-columns: repeat(2, minmax(0, 1fr)); 
        gap: 0.75rem;
      }
    }
    
    @media (min-width: 768px) { 
      .grid-col { 
        grid-template-columns: repeat(3, minmax(0, 1fr)); 
        gap: 0.5rem;
      }
    }
    
    /* Fluid typography system */
     html {
       font-size: clamp(14px, 2.5vw, 16px);
     }
     
     body {
       font-size: 1rem;
       line-height: 1.6;
       font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
     }
     
     /* Responsive heading scales */
     h1 {
       font-size: clamp(1.5rem, 4vw, 2.5rem);
       line-height: 1.2;
       font-weight: 700;
       color: #081249;
     }
     
     h2 {
       font-size: clamp(1.25rem, 3vw, 2rem);
       line-height: 1.3;
       font-weight: 600;
       color: #081249;
     }
     
     h3 {
       font-size: clamp(1.125rem, 2.5vw, 1.5rem);
       line-height: 1.4;
       font-weight: 600;
       color: #081249;
     }
     
     /* Responsive text sizes */
     .text-xs { font-size: clamp(0.75rem, 1.5vw, 0.875rem); }
     .text-sm { font-size: clamp(0.875rem, 2vw, 1rem); }
     .text-base { font-size: clamp(1rem, 2.5vw, 1.125rem); }
     .text-lg { font-size: clamp(1.125rem, 3vw, 1.25rem); }
     .text-xl { font-size: clamp(1.25rem, 3.5vw, 1.5rem); }
     
     /* Enhanced readability */
     p, span, div {
       line-height: 1.6;
     }
     
     label {
       font-weight: 500;
       line-height: 1.4;
     }
     
     /* Mobile-first responsive breakpoints */
     @media (max-width: 640px) { 
       .stack-mobile { 
         flex-direction: column; 
         gap: 1rem;
       }
       
       /* Enhanced mobile typography */
       body {
         font-size: 16px; /* Prevents zoom on iOS */
         line-height: 1.7;
       }
       
       /* Better spacing on mobile */
       .mobile-padding {
         padding: 1rem;
       }
       
       /* Full-width elements on mobile */
       .mobile-full {
         width: 100%;
       }
       
       /* Hide less important elements on very small screens */
       .mobile-hide {
         display: none;
       }
       
       /* Improved mobile text spacing */
       p, div, span {
         line-height: 1.7;
       }
       
       /* Better button text on mobile */
       button {
         font-size: 16px;
         line-height: 1.4;
         letter-spacing: 0.025em;
       }
     }
    
    @media (max-width: 480px) {
      /* Extra small screens */
      .container {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }
      
      /* Smaller buttons on very small screens but still touch-friendly */
      button {
        min-height: 44px;
        padding: 10px 12px;
        font-size: 14px;
      }
      
      /* Compact grid on very small screens */
      .grid-cols-2 {
        grid-template-columns: 1fr;
      }
      
      /* Admin modal adjustments for very small screens */
      #adminModal .bg-white {
        margin: 1rem;
        max-height: calc(100vh - 2rem);
      }
      
      /* Ensure dropdowns don't overflow on small screens */
      .dropdown-list {
        max-height: 150px;
      }
      
      /* Better spacing for form elements */
      .space-y-4 > * + * {
        margin-top: 1rem;
      }
    }
    
    /* Consistent spacing utilities */
    .section-spacing {
      margin-bottom: 1.5rem;
    }
    
    @media (max-width: 640px) {
      .section-spacing {
        margin-bottom: 1rem;
      }
    }
    
    /* Responsive form elements */
    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: all 0.2s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    @media (max-width: 480px) {
      .form-input {
        padding: 0.625rem;
        font-size: 0.875rem;
      }
    }
    
    /* Responsive card layouts */
    .card-responsive {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    @media (max-width: 640px) {
      .card-responsive {
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.5rem;
      }
    }
    
    @media (max-width: 480px) {
      .card-responsive {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
      }
    }
    /* Enhanced dropdown styles for mobile */
    .custom-dropdown { 
      position: relative; 
      width: 100%; 
    }
    
    .dropdown-btn { 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      cursor: pointer;
      padding: 12px 16px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      background: white;
      min-height: 48px;
      width: 100%;
      box-sizing: border-box;
      font-size: 16px;
      transition: all 0.2s ease;
      touch-action: manipulation;
    }
    
    .dropdown-btn:hover:not(:disabled) {
      border-color: #9ca3af;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }
    
    .dropdown-btn:focus {
      outline: 3px solid #3b82f6;
      outline-offset: 2px;
      border-color: #3b82f6;
    }
    
    .dropdown-btn:active {
      transform: translateY(0);
    }
    
    .dropdown-btn:disabled { 
      cursor: not-allowed;
      background-color: #f9fafb;
      color: #6b7280;
      opacity: 0.6;
    }
    
    .dropdown-btn::after {
      content: '‚ñº';
      font-size: 14px;
      color: #6b7280;
      transition: transform 0.2s ease;
    }
    
    .dropdown-btn.open::after {
      transform: rotate(180deg);
    }
    
    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      max-height: 240px;
      overflow-y: auto;
      z-index: 1000;
      margin-top: 4px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .dropdown-list.hidden {
      display: none;
    }
    
    .dropdown-option {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 16px;
      min-height: 48px;
      transition: background-color 0.2s ease;
      touch-action: manipulation;
    }
    
    .dropdown-option:last-child {
      border-bottom: none;
    }
    
    .dropdown-option:hover {
      background-color: #f1f5f9;
    }
    
    .dropdown-option:active {
      background-color: #e2e8f0;
    }
    
    .dropdown-option input[type="checkbox"] {
      margin: 0;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .dropdown-option label {
      cursor: pointer;
      flex: 1;
      font-weight: 400;
      line-height: 1.4;
    }
    
    /* Mobile-specific dropdown optimizations */
    @media (max-width: 640px) {
      .dropdown-list {
        max-height: 200px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }
      
      .dropdown-option {
        padding: 14px 16px;
        min-height: 52px;
      }
      
      /* Better mobile header layout */
      .header-mobile {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      /* Improved mobile controls layout */
      .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-3 {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      /* Enhanced mobile layout */
      .container {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      
      /* Better mobile grid spacing */
      .grid {
        gap: 0.75rem;
      }
      
      /* Mobile-optimized preview section */
      .preview-container {
        margin: 0 -1rem;
        border-radius: 0;
      }
      
      /* Improved mobile header */
      .header-mobile {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
      
      /* Better mobile form layout */
      .form-row {
        flex-direction: column;
        gap: 1rem;
      }
      
      /* Enhanced mobile buttons */
      .mobile-button-stack {
        flex-direction: column;
        width: 100%;
      }
      
      .mobile-button-stack button {
        width: 100%;
        margin-bottom: 0.5rem;
      }
      
      /* Mobile-friendly feature images */
      .feature-images-mobile {
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
      }
      
      .mobile-feature-section {
        padding: 0.5rem !important;
      }
      
      .mobile-feature-images {
        width: 100% !important;
        max-width: 100% !important;
        gap: 0.25rem !important;
        padding: 4px !important;
        justify-content: center;
      }
      
      .mobile-feature-img {
        height: 45px !important;
        max-width: 55px !important;
        flex-shrink: 0;
      }
      
      /* Better mobile typography */
      .mobile-text-adjust {
        font-size: 14px;
        line-height: 1.5;
      }
    }
      
      .dropdown-option input[type="checkbox"] {
        width: 20px;
        height: 20px;
      }
    
    /* Navigation Menu Styles */
    .nav-btn {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      color: #475569;
      border: 2px solid #e2e8f0;
      box-shadow: 0 2px 8px rgba(71, 85, 105, 0.1);
      min-height: 48px;
      cursor: pointer;
      touch-action: manipulation;
    }
    
    .nav-btn:hover {
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      border-color: #cbd5e1;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(71, 85, 105, 0.15);
    }
    
    .nav-btn-active {
      background: linear-gradient(135deg, #081249 0%, #0a1555 100%);
      color: white;
      border-color: #081249;
      box-shadow: 0 4px 12px rgba(8, 18, 73, 0.3);
    }
    
    .nav-btn-active:hover {
      background: linear-gradient(135deg, #0a1555 0%, #0c1a66 100%);
      border-color: #0a1555;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(8, 18, 73, 0.4);
    }
    
    /* Module Content Styles */
    .module-content {
      display: none;
    }
    
    .module-content.active {
      display: block;
    }
    
    /* Responsive navigation */
    @media (max-width: 640px) {
      .nav-btn span:last-child {
        display: none;
      }
      
      .nav-btn {
        min-width: 60px;
        justify-content: center;
      }
    }
  </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800">
  <!-- Top Menu Bar -->
  <header class="bg-white shadow-soft mb-4">
    <div class="max-w-4xl mx-auto px-3 sm:px-6">
      <!-- Header with InstaQuote flush left and logo flush right -->
      <div class="flex items-center justify-between py-3">
        <!-- InstaQuote heading flush left -->
        <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold" style="line-height: 0.7;">
          <span style="color: #081249;">Insta</span><span style="color: #9b7952;">Q</span><span style="color: #081249;">uote</span>
        </h1>
        
        <!-- Logo flush right -->
        <div class="flex-shrink-0">
          <img src="images/logo.png" alt="Company Logo" class="h-12 sm:h-16 w-auto opacity-75 hover:opacity-100 transition-opacity duration-200">
        </div>
      </div>
      
      <!-- Navigation Menu below header -->
      <div class="pb-3">
        <nav class="hidden md:flex gap-2 justify-center">
          <button id="nav-price-calculator" class="nav-btn nav-btn-active btn-primary px-4 py-2 rounded-lg font-medium hover:bg-emerald-700 transition-all duration-200 flex items-center gap-2">
            <span>üìä</span>
            <span>PriceLists</span>
          </button>
          <button id="nav-quote-maker" class="nav-btn px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2">
            <span class="text-lg">üìã</span>
            <span>Quote Maker</span>
          </button>
          <button id="nav-product-catalog" class="nav-btn px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2">
            <span class="text-lg">üì¶</span>
            <span>Product Catalog</span>
          </button>
          <button id="nav-admin-panel" class="nav-btn px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2">
            <span class="text-lg">‚öôÔ∏è</span>
            <span>Admin Panel</span>
          </button>
        </nav>
      </div>
      
      <!-- Mobile Navigation Menu -->
      <nav class="md:hidden pb-3">
        <div class="flex flex-wrap justify-center gap-2">
          <button id="nav-price-calculator-mobile" class="nav-btn nav-btn-active btn-primary px-3 py-2 rounded-lg font-medium hover:bg-emerald-700 transition-all duration-200 flex items-center gap-1 text-sm">
            <span>üìä</span>
            <span>PriceLists</span>
          </button>
          <button id="nav-quote-maker-mobile" class="nav-btn px-3 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-1 text-sm">
            <span>üìã</span>
            <span>Quote</span>
          </button>
          <button id="nav-product-catalog-mobile" class="nav-btn px-3 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-1 text-sm">
            <span>üì¶</span>
            <span>Catalog</span>
          </button>
          <button id="nav-admin-panel-mobile" class="nav-btn px-3 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-1 text-sm">
            <span>‚öôÔ∏è</span>
            <span>Admin</span>
          </button>
        </div>
      </nav>
    </div>
  </header>

  <div class="max-w-4xl mx-auto p-3 sm:p-6 container">

    <!-- Module Content Container -->
    <div id="module-container">
      
      <!-- Price List Calculator Module -->
      <div id="price-calculator-module" class="module-content">
        <!-- Controls Section -->
        <div class="card-responsive section-spacing">
          <!-- First Row: Price List, Currency, Factor -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <!-- Price List Selector -->
            <div>
              <select id="priceListSelector" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                <option value="">Select Price List</option>
              </select>
            </div>
            
            <!-- Currency Selector -->
            <div>
              <select id="currency" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                <option value="INR">‚Çπ INR</option>
                <option value="USD">$ USD</option>
                <option value="EUR">‚Ç¨ EUR</option>
                <option value="GBP">¬£ GBP</option>
                <option value="AUD">A$ AUD</option>
                <option value="SAR">SAR</option>
                <option value="NGN">‚Ç¶ NAIRA</option>
                <option value="AED">ÿØ.ÿ• AED</option>
              </select>
            </div>
            
            <!-- Factor Input -->
            <div>
              <input type="number" id="priceFactor" value="" min="-100" max="1000" step="0.1" 
                     class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" 
                     placeholder="Price Factor (%)"
                     title="Price adjustment percentage: empty = no change, 10 = 10% increase, -10 = 10% decrease">
            </div>
          </div>
          
          <!-- Second Row: Category and Related Controls -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Category Selector -->
            <div>
              <select id="category" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                <option value="">Select Category</option>
              </select>
            </div>
            
            <!-- Control Options -->
            <div>
              <div class="flex flex-wrap gap-4">
                <div id="kgWrap" class="hidden">
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" id="kgMode" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700">List in KG</span>
                  </label>
                </div>
                <div id="selectAllWrap" class="hidden">
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" id="selectAll" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700">Select All</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
      
      <!-- Products, Densities, and Colors -->
      <div class="grid grid-cols-3 gap-1 mt-1">
        <!-- Products -->
        <div>
          <div class="custom-dropdown" id="productDropdown">
            <button class="dropdown-btn w-full border rounded-lg px-2 py-1 text-left bg-white disabled:opacity-60 text-sm" disabled>
              <span class="dropdown-text">Select products...</span>
            </button>
            <div class="dropdown-list hidden absolute z-10 w-full bg-white border rounded-lg shadow-lg max-h-32 overflow-y-auto">
              <!-- Options will be populated here -->
            </div>
          </div>
        </div>

        <!-- Densities -->
        <div>
          <div class="custom-dropdown" id="densityDropdown">
            <button class="dropdown-btn w-full border rounded-lg px-2 py-1 text-left bg-white disabled:opacity-60 text-sm" disabled>
              <span class="dropdown-text">Select densities...</span>
            </button>
            <div class="dropdown-list hidden absolute z-10 w-full bg-white border rounded-lg shadow-lg max-h-32 overflow-y-auto">
              <!-- Options will be populated here -->
            </div>
          </div>
        </div>

        <!-- Colors -->
        <div>
          <div class="custom-dropdown" id="colorDropdown">
            <button class="dropdown-btn w-full border rounded-lg px-2 py-1 text-left bg-white disabled:opacity-60 text-sm" disabled>
              <span class="dropdown-text">Select colors...</span>
            </button>
            <div class="dropdown-list hidden absolute z-10 w-full bg-white border rounded-lg shadow-lg max-h-32 overflow-y-auto">
              <!-- Options will be populated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Second Row -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-1 mt-1">

        <!-- Actions -->
        <div class="relative" style="margin-top: 20px;">
          <div class="flex flex-col sm:flex-row gap-1 mobile-button-stack" id="actionButtonsContainer">
            <button id="clearSegments" class="btn-secondary px-2 py-1 rounded-lg text-sm font-medium hover:bg-slate-300 transition-all duration-200 flex items-center justify-center gap-1 mobile-full" aria-label="Clear all selections" title="Clear all selections">
              <span class="text-base" aria-hidden="true">üóëÔ∏è</span>
              <span>Clear</span>
            </button>
            <button id="previewBtn" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium hover:bg-emerald-700 transition-all duration-200 flex items-center justify-center gap-1 mobile-full" aria-label="Generate preview" title="Generate preview">
              <span class="text-base" aria-hidden="true">üëÅÔ∏è</span>
              <span>Preview</span>
            </button>
            <button id="sharePdfBtn" class="btn-info px-2 py-1 rounded-lg text-sm font-medium hover:bg-blue-700 transition-all duration-200 flex items-center justify-center gap-1 mobile-full hidden" aria-label="Share PDF" title="Share PDF using device's native sharing options">
              <span class="text-base" aria-hidden="true">üì§</span>
              <span>Share PDF</span>
            </button>
          </div>
           
           <!-- Enhanced Share Popup for Mobile -->
           <div id="sharePopup" class="hidden absolute z-30 mt-2 w-full sm:w-64 bg-white border-2 rounded-xl shadow-xl p-3">
             <div class="space-y-2">
               <button id="shareDownloadPDF" class="w-full text-left px-4 py-3 text-base font-medium hover:bg-slate-100 rounded-lg flex items-center gap-3 transition-all duration-200 touch-action-manipulation">
                 <span class="text-lg">üìÑ</span> 
                 <span>Save as PDF</span>
               </button>

               <button id="downloadPNG" class="w-full text-left px-4 py-3 text-base font-medium hover:bg-slate-100 rounded-lg flex items-center gap-3 transition-all duration-200 touch-action-manipulation">
                 <span class="text-lg">üñºÔ∏è</span> 
                 <span>Download as PNG</span>
               </button>

             </div>
           </div>
         </div>

        <!-- Segments (Hidden) -->
        <div>
          <div id="segmentsList" class="flex flex-wrap gap-2" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Preview Section -->
    <div class="bg-white rounded-xl shadow-soft p-4 sm:p-6 mobile-padding preview-container">
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2 form-row">
        <h3 class="text-lg sm:text-xl font-semibold mobile-text-adjust">Preview</h3>
        <div id="pageInfo" class="text-center text-sm text-slate-500 min-w-[120px] bg-slate-50 px-3 py-1 rounded-full mobile-text-adjust" role="status" aria-live="polite"></div>
      </div>
      <div class="w-full overflow-auto border-2 border-slate-200 rounded-lg">
        <div id="htmlPreview" class="w-full bg-white min-h-[200px] p-2 sm:p-4 flex justify-center">
          <div class="w-full max-w-[595px] mx-auto" style="min-width: 320px;">
            <!-- HTML preview content will be generated here -->
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center text-xs text-slate-500 mt-6 mobile-hide">
      Assets in <code>/images</code>: <code>logo.png</code>, <code>geniusstamps.png</code>, <code>lacestamps.png</code>, <code>tapesstamps.png</code>, <code>tipsstamps.png</code>, <code>generalstamps.png</code>.
    </footer>
  </div>


  <script>
    const ADDRESS_LINES = [
      'WZ 81/1A, Guru Nanak Nagar, New Delhi 110018, India',
      'info@indiannaturalhair.com'
    ];
    const CATEGORY_STAMPS = {
      'genius weaves': 'images/geniusstamps.png',
      'wigs, closures, and toppers': 'images/lacestamps.png',
      'tapes': 'images/tapesstamps.png',
      'tips': 'images/tipsstamps.png',
      '__default': 'images/generalstamps.png'
    };
    const LOGO_PATH = 'images/logo.png';

    const FX_APIS = [
      (base) => `https://api.exchangerate-api.com/v4/latest/${base}`,
      (base) => `https://api.fixer.io/latest?base=${base}`,
      (base) => `https://open.er-api.com/v6/latest/${base}`
    ];
    const SUPPORTED = ['INR','USD','EUR','GBP','AUD','SAR','NGN','AED'];
    const SYMBOL = { INR:'‚Çπ', USD:'$', EUR:'‚Ç¨', GBP:'¬£', AUD:'A$', SAR:'SAR ', NGN:'‚Ç¶', AED:'ÿØ.ÿ• ' };
    const DEFAULT_RATES = { base:'INR',
      rates:{ INR:1, USD:0.0120, EUR:0.0110, GBP:0.0095, AUD:0.0180, SAR:0.0450, NGN:5.5000, AED:0.0440 },
      updatedAt: null, mode:'auto'
    };

    let productData = [
  {
    "Length": 4,
    "Category": "DIY",
    "Product": "Test",
    "Density": "Double Drawn"
  }
];
    let state = {
      currency:'INR', rates: { ...DEFAULT_RATES },
      category:'', selectAll:false, kg:false,
      selProducts:[], selDensities:[], selColors:[],
      segments: [], // each: { title, category, selectAll, kg, product, density, color }
      allProducts: [], // Store all products for filtering
      filteredProducts: [] // Store filtered products based on price list selection
    };

    /* DOM */
    const $ = (id) => document.getElementById(id);
    const elCurrency = $('currency');
    const elCategory = $('category'); 
    const elProductDropdown = $('productDropdown'); const elDensityDropdown = $('densityDropdown'); const elColorDropdown = $('colorDropdown');
    const elKgWrap = $('kgWrap'); const elKg = $('kgMode'); const elSelectAllWrap = $('selectAllWrap'); const elSelectAll = $('selectAll');
    const elClearSegments = $('clearSegments'); const elSegmentsList = $('segmentsList');
    const elDownloadPDF = $('downloadPDF'); const elPageInfo = $('pageInfo');

    /* Basics */
    function uniqSorted(arr) { return [...new Set(arr)].sort(); }
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function lockDropdown(dropdown, locked) { 
      const btn = dropdown.querySelector('.dropdown-btn');
      btn.disabled = locked; 
    }
    
    function getDropdownValues(dropdown) {
      return Array.from(dropdown.querySelectorAll('.dropdown-option input:checked')).map(input => input.value);
    }
    
    function setAllDropdownSelected(dropdown) {
      dropdown.querySelectorAll('.dropdown-option input').forEach(input => input.checked = true);
      updateDropdownText(dropdown);
    }
    
    function fillDropdown(dropdown, arr, placeholder) {
      const list = dropdown.querySelector('.dropdown-list');
      const btn = dropdown.querySelector('.dropdown-btn');
      
      // Add "Select All" option at the top if there are items
      const selectAllOption = arr.length > 0 ? `
        <div class="dropdown-option border-b border-gray-200 pb-1 mb-1">
          <button class="select-all-btn w-full text-left px-2 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded" data-dropdown-id="${dropdown.id}">
            ‚ö° Select All
          </button>
        </div>
      ` : '';
      
      list.innerHTML = selectAllOption + arr.map(v => `
        <div class="dropdown-option">
          <input type="checkbox" value="${escapeHTML(v)}" id="${dropdown.id}_${escapeHTML(v)}">
          <label for="${dropdown.id}_${escapeHTML(v)}">${escapeHTML(v)}</label>
        </div>
      `).join('');
      
      btn.disabled = arr.length === 0;
      
      // Add event listener for "Select All" button
      const selectAllBtn = list.querySelector('.select-all-btn');
      if (selectAllBtn) {
        selectAllBtn.addEventListener('click', (e) => {
          e.preventDefault();
          setAllDropdownSelected(dropdown);
          if (dropdown === elProductDropdown) onProductChange();
          else if (dropdown === elDensityDropdown) onDensityChange();
          else if (dropdown === elColorDropdown) onColorChange();
        });
      }
      
      // Add event listeners for checkboxes
      list.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', () => updateDropdownText(dropdown));
      });
      
      updateDropdownText(dropdown, placeholder);
    }
    
    function updateDropdownText(dropdown, placeholder = 'Select...') {
      const selected = getDropdownValues(dropdown);
      const textSpan = dropdown.querySelector('.dropdown-text');
      
      if (selected.length === 0) {
        textSpan.textContent = placeholder;
      } else if (selected.length === 1) {
        textSpan.textContent = selected[0];
      } else {
        textSpan.textContent = `${selected.length} selected`;
      }
    }

    /* Data */
    function populateCategories() {
      // Only use filtered products (based on selected price list)
      const dataSource = state.filteredProducts;
      const categories = uniqSorted(dataSource.map(i => i.Category).filter(c => c));
      elCategory.innerHTML = '<option value="">Select Category</option>' + 
        categories.map(c => `<option value="${escapeHTML(c)}">${escapeHTML(c)}</option>`).join('');
      lockDropdown(elProductDropdown,true); lockDropdown(elDensityDropdown,true); lockDropdown(elColorDropdown,true);
      
      // Clear category selection if no categories available
      if (categories.length === 0) {
        state.category = '';
        elCategory.value = '';
      }
    }

    /* Category to image mapping */
    function getCategoryImage(category) {
      const categoryImageMap = {
        'Tips': 'images/tipsstamps.png',
        'Tapes': 'images/tapesstamps.png',
        'Genius Weaves': 'images/geniusstamps.png',
        'Closures': 'images/lacestamps.png',
        'Wigs': 'images/generalstamps.png',
        'Weaves': 'images/generalstamps.png',
        'Bulk': 'images/generalstamps.png',
        'ClipOn': 'images/generalstamps.png',
        'DIY': 'images/generalstamps.png',
        'Toppers': 'images/generalstamps.png'
      };
      return categoryImageMap[category] || 'images/generalstamps.png';
    }

    /* Category to feature images mapping */
    function getCategoryFeatureImages(category) {
      const categoryFeatureMap = {
        'Bulk': ['cuticle.png', 'color.png', 'measure.png', 'durable.png', 'noshedding.png', 'cut.png'],
        'Weaves': ['cuticle.png', 'color.png', 'measure.png', 'durable.png', 'noshedding.png', 'stitch.png'],
        'Wigs': ['transparentlace.png', 'plucked.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png'],
        'Toppers': ['plucked.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png', 'cut.png'],
        'Closures': ['transparentlace.png', 'plucked.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png'],
        'Tapes': ['tapes.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png', 'cut.png'],
        'Tips': ['tips.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png', 'cut.png'],
        'Genius': ['genius.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png', 'cut.png'],
        'Genius Weaves': ['genius.png', 'cuticle.png', 'color.png', 'durable.png', 'noshedding.png', 'cut.png'],
        'DIY': ['diy.png', 'cuticle.png', 'color.png', 'measure.png', 'durable.png', 'cut.png'],
        'ClipOn': ['cuticle.png', 'color.png', 'measure.png', 'durable.png', 'noshedding.png', 'stitch.png']
      };
      const images = categoryFeatureMap[category] || [];
      return images.map(img => `images/category-images/${category}/${img}`);
    }



    /* Flow */
    function onCategoryChange(){
      // Auto-clear previous selections when category changes
      if (state.category !== elCategory.value && state.category !== '') {
        clearAllSelections();
      }
      
      state.category = elCategory.value;
      state.selProducts=[]; state.selDensities=[]; state.selColors=[];
      // Only use filtered products (based on selected price list)
      const dataSource = state.filteredProducts;
      const hasKg = dataSource.some(i => i.Category===state.category && /y/i.test(i['Can Be Sold in KG?']||''));
      elKgWrap.classList.toggle('hidden', !hasKg); if (!hasKg) elKg.checked=false;
      elSelectAllWrap.classList.toggle('hidden', !state.category); elSelectAll.checked=false; state.selectAll=false;

      const products = uniqSorted(dataSource.filter(i => i.Category===state.category).map(i => i.Product));
      fillDropdown(elProductDropdown, products, 'Select Products');
      fillDropdown(elDensityDropdown, [], 'Select Densities');
      fillDropdown(elColorDropdown, [], 'Select Colors');
      lockDropdown(elProductDropdown, !state.category); lockDropdown(elDensityDropdown, true); lockDropdown(elColorDropdown, true);
  
      
      
      
      // Initial render removed - HTML preview generates on demand
    }
    function onProductChange(){
      const selP = getDropdownValues(elProductDropdown);
      state.selProducts = selP;
      const dataSource = state.filteredProducts.length > 0 ? state.filteredProducts : productData;
      const densPool = uniqSorted(dataSource.filter(i => i.Category===state.category && (selP.length===0 || selP.includes(i.Product))).map(i => i.Density));
      fillDropdown(elDensityDropdown, densPool, 'Select Densities'); lockDropdown(elDensityDropdown,false);
      const selD = getDropdownValues(elDensityDropdown); state.selDensities = selD;
      const colorPool = uniqSorted(dataSource.filter(i => i.Category===state.category && (selP.length===0 || selP.includes(i.Product)) && (selD.length===0 || selD.includes(i.Density))).map(i => i.Colors));
      fillDropdown(elColorDropdown, colorPool, 'Select Colors'); lockDropdown(elColorDropdown,false);
      state.selColors = getDropdownValues(elColorDropdown);
      renderAllPagesToHTML();
    }
    function onDensityChange(){
      const selD = getDropdownValues(elDensityDropdown);
      state.selDensities = selD;
      const selP = state.selProducts;
      const dataSource = state.filteredProducts.length > 0 ? state.filteredProducts : productData;
      const colorPool = uniqSorted(dataSource.filter(i => i.Category===state.category && (selP.length===0 || selP.includes(i.Product)) && (selD.length===0 || selD.includes(i.Density))).map(i => i.Colors));
      fillDropdown(elColorDropdown, colorPool, 'Select Colors'); lockDropdown(elColorDropdown,false);
      state.selColors = getDropdownValues(elColorDropdown);
      renderAllPagesToHTML();
    }
    function onColorChange(){
      state.selColors = getDropdownValues(elColorDropdown);
      renderAllPagesToHTML();
    }
    function onSelectAllToggle(){
      state.selectAll = elSelectAll.checked;
      [elProductDropdown, elDensityDropdown, elColorDropdown].forEach(dropdown => { lockDropdown(dropdown, state.selectAll); });
      renderAllPagesToHTML();
    }


    /* Segments (explode combinations) */
    function explodeCombosToSegments(){
      if (!state.category) return;
      const dataSource = state.filteredProducts.length > 0 ? state.filteredProducts : productData;
      const pool = dataSource.filter(i => i.Category===state.category);
      let P = state.selectAll ? uniqSorted(pool.map(x=>x.Product)) : (state.selProducts.length? state.selProducts : uniqSorted(pool.map(x=>x.Product)));
      let D = state.selectAll ? uniqSorted(pool.map(x=>x.Density)) : (state.selDensities.length? state.selDensities : uniqSorted(pool.map(x=>x.Density)));
      let C = state.selectAll ? uniqSorted(pool.map(x=>x.Colors)) : (state.selColors.length? state.selColors : uniqSorted(pool.map(x=>x.Colors)));
      const set = new Set(); // avoid duplicates when data has repeated rows
      const next = [];
      P.forEach(p => D.forEach(d => C.forEach(c => {
        const key = `${p}::${d}::${c}`;
        const matches = pool.filter(i => i.Product===p && i.Density===d && i.Colors===c);
        if (matches.length && !set.has(key)) {
          set.add(key);
          next.push({ title: `${p} - ${d} - ${c}`, category: state.category, product:p, density:d, color:c, kg: elKg.checked });
        }
      })));
      // append
      state.segments.push(...next);
      renderSegmentsList();
      renderAllPagesToHTML();
    }

    function removeSegment(idx){ state.segments.splice(idx,1); renderSegmentsList(); renderAllPagesToHTML(); }
    function renderSegmentsList(){
      elSegmentsList.innerHTML = state.segments.map((s,idx)=>`
        <span class="chip"><span class="font-semibold">${escapeHTML(s.title)}</span>
          <button class="text-red-600" onclick="__remove(${idx})">‚úï</button>
        </span>`).join('');
    }
    window.__remove = removeSegment;

    /* Pricing rows per segment */
    function rowsForSegment(seg){
      const rows = productData.filter(i => i.Category===seg.category && i.Product===seg.product && i.Density===seg.density && i.Colors===seg.color)
        .map(i => ({
          length: (i.Length||'').toString(),
          priceINR: parseFloat(i.Rate||'0') * (seg.kg && /y/i.test(i['Can Be Sold in KG?']||'') ? 10 : 1),
          meta: i
        }))
        .sort((a,b)=>parseFloat(a.length)-parseFloat(b.length));
      return rows;
    }

    /* FX (automatic) */
    async function fetchLiveFX(){
      let ok = false;
      for (const builder of FX_APIS) {
        try {
          const url = builder('INR');
          const res = await fetch(url, { cache:'no-store' });
          if (!res.ok) continue;
          const data = await res.json();
          const ratesRaw = data.rates || (data.result==='success' && data.rates) || data;
          if (!ratesRaw) continue;
          const next = { base:'INR', rates:{}, updatedAt: Date.now(), mode:'auto' };
          SUPPORTED.forEach(k => { const v = ratesRaw[k]; if (v && typeof v === 'number') next.rates[k] = v; });
          if (Object.keys(next.rates).length >= 3) {
            state.rates = next;
            localStorage.setItem('INH_FX', JSON.stringify(next));
            ok = true;
            break;
          }
        } catch(e) { console.warn('FX API failed:', e); }
      }
      renderAllPagesToHTML();
    }

    function convertINRto(curr, amt){ const r = (state.rates.rates && state.rates.rates[curr]) || 0; return amt * (r||0); }

    /* HTML Preview Functions */
    function getProductImagePath(category, product, density) {
      const categoryLower = (category || '').toLowerCase();
      const productLower = (product || '').toLowerCase();
      const densityLower = (density || '').toLowerCase();
      
      // Product image mapping based on your specifications
      const imageMap = {
        // Weaves category
        'weaves': {
          'weaves': {
            'single drawn': 'images/Products/Weaves-SD.png',
            'double drawn': 'images/Products/Weaves-DD.png',
            'super double drawn': 'images/Products/Weaves-SDD.png'
          }
        },
        // Genius Weaves
        'genius weaves': {
          'genius weaves': 'images/Products/Genius.png'
        },
        // DIY category
        'diy': {
          'bangs': 'images/Products/Bangs.png',
          'curtain bangs': 'images/Products/Bangs.png',
          'curly faux buns': 'images/Products/CurlyBun.png',
          'bun20': 'images/Products/BUN.png',
          'bun30': 'images/Products/BUN.png',
          'flatclip ponytail': 'images/Products/FLATCLIPPONYTAIL.png',
          'highlights': 'images/Products/Highlights.png',
          'frontline-13x1': 'images/Products/Frontline.png',
          'frontline-2x1': 'images/Products/Frontline.png',
          'frontline-5x1': 'images/Products/Frontline.png',
          'single clip cover patch': 'images/Products/CoverPatch.png',
          'clutch bun': 'images/Products/ClutchBun.png'
        },
        // Closures
        'closures': {
          'closure': 'images/Products/Closure.png',
          'frontal': 'images/Products/Frontal.png',
          'frontal-13x4': 'images/Products/Frontal.png',
          'frontal-13x6': 'images/Products/Frontal.png',
          'closure-5x3': 'images/Products/Closure.png',
          'closure-4x4': 'images/Products/Closure.png',
          'closure-5x5': 'images/Products/Closure.png',
          'closure-6x6': 'images/Products/Closure.png',
          'closure-6x2': 'images/Products/Closure.png'
        },
        // Wigs
        'wigs': {
          'wig-closure5x5': 'images/Products/WIGCLOSURE.png',
          'wig-closure6x2': 'images/Products/WIGCLOSURE.png',
          'wig-dd-closure6x2': 'images/Products/WIGCLOSURE.png',
          'wig-dd-closure5x5': 'images/Products/WIGCLOSURE.png',
          'wig-silktopper': 'images/Products/SILKTOPPER.png',
          'wig-dd-frontal13x4': 'images/Products/WIGFRONTAL.png',
          'wig-dd-frontal13x6': 'images/Products/WIGFRONTAL.png',
          'wig-frontal13x6': 'images/Products/WIGFRONTAL.png',
          'wig-frontal13x4': 'images/Products/WIGFRONTAL.png'
        },
        // Bulk
        'bulk': {
          'bulk': 'images/Products/Bulk.png'
        },
        // Tapes
        'tapes': {
          'tape extension': 'images/Products/Tapes.png'
        },
        // Tips
        'tips': {
          'tips': 'images/Products/ITIPS.png',
          'tipsnano': 'images/Products/Nano.png',
          'tipsy': 'images/Products/YTIPS.png',
          'flat tips': 'images/Products/FlatTips.png',
          'u tips': 'images/Products/UTIPS.png'
        },
        // ClipOn
        'clipon': {
          'clipon classic': 'images/Products/ClipOn.png',
          'clipon seamless': 'images/Products/ClipOn.png',
          'clutch ponytail': 'images/Products/PonyTail.png',
          'halo extensions': 'images/Products/Halo.png',
          'wrap around ponytail': 'images/Products/PonyTail.png'
        },
        // Toppers
        'toppers': {
          'topper': 'images/Products/SILKTOPPER.png'
        }
      };
      
      // First try to find by category and product
      if (imageMap[categoryLower] && imageMap[categoryLower][productLower]) {
        const productMapping = imageMap[categoryLower][productLower];
        // If it's an object (like Weaves with density), check for density
        if (typeof productMapping === 'object') {
          return productMapping[densityLower] || Object.values(productMapping)[0] || '';
        }
        // If it's a direct string path
        return productMapping;
      }
      
      // Fallback: try to find by density for Weaves category
      if (categoryLower === 'weaves' && densityLower) {
        if (densityLower.includes('single drawn')) return 'images/Products/Weaves-SD.png';
        if (densityLower.includes('double drawn')) return 'images/Products/Weaves-DD.png';
        if (densityLower.includes('super double drawn')) return 'images/Products/Weaves-SDD.png';
      }
      
      return ''; // No image found
    }

    /**
     * Calculate price factor from percentage input
     * @param {number} percentage - Percentage value (e.g., 10 for 10% increase, -10 for 10% decrease)
     * @returns {number} - Factor value (e.g., 1.10 for 10% increase, 0.90 for 10% decrease)
     */
    function calculatePriceFactor(percentage) {
      // Handle edge cases
      if (typeof percentage !== 'number' || isNaN(percentage)) {
        return 1.0; // No change for invalid input
      }
      
      // Calculate factor: 1 + (percentage / 100)
      // Examples: 10 -> 1.10, -10 -> 0.90, 0 -> 1.00
      const factor = 1 + (percentage / 100);
      
      // Ensure precision and prevent negative factors
      return Math.max(0, Number(factor.toFixed(6)));
    }
    
    /**
     * Get current price factor from UI input
     * @returns {number} - Current factor value
     */
    function getCurrentPriceFactor() {
      const inputElement = document.getElementById('priceFactor');
      const inputValue = inputElement.value.trim();
      
      // If empty, return 1.0 (no price adjustment)
      if (inputValue === '' || inputValue === null || inputValue === undefined) {
        return 1.0;
      }
      
      // Parse the percentage value directly
      const percentage = parseFloat(inputValue);
      if (isNaN(percentage)) {
        return 1.0; // Default to no change for invalid input
      }
      
      return calculatePriceFactor(percentage);
    }

    function createPageHTML(segment, pageIndex) {
      const rows = rowsForSegment(segment);
      const factor = getCurrentPriceFactor();
      const unit = segment.kg ? 'Per Kg' : 'Per Piece';
      const titleText = `${segment.product.toUpperCase()} | ${segment.density.toUpperCase()} | ${segment.color.toUpperCase()} | ${state.currency} | ${unit.toUpperCase()}`;
      
      // Calculate optimal height based on content including footer space
      const baseHeight = 500; // Reduced base height for compactness
      const rowHeight = 28; // Reduced row height to match smaller cells
      const footerHeight = 120; // Minimized footer space for compact layout
      const headerSpace = 180; // Reduced header space
      const contentHeight = Math.max(baseHeight, headerSpace + 260 + (rows.length * rowHeight) + footerHeight);
      
      return `
        <div class="page-container bg-white border rounded-lg shadow-lg mx-auto" style="width: 615px; height: ${contentHeight}px; page-break-after: always; margin: 0 auto; transform-origin: center top; transform: scale(min(1, calc(100vw - 40px) / 615px));">
          <!-- Header Section -->
          <div class="header-section p-2 border-b" style="background-color: #e6eaeb;">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <img src="images/logo.png" alt="Company Logo" class="h-16 w-16 object-contain" onerror="this.style.display='none'">
                <div>
                  <h1 class="text-lg font-bold text-gray-800">${document.getElementById('priceListSelector').value === 'USA25' ? 'Indian Natural Hair, LLC' : 'Indian Natural Hair'}</h1>
                  <p class="text-gray-600 text-xs">Premium Quality Hair Products</p>
                  <p class="text-black text-xs font-medium">www.indiannaturalhair.com</p>
                </div>
              </div>
              

              
              <div>
                <img src="images/madewithbadge.png" alt="Made with Badge" class="h-12 object-contain" onerror="this.style.display='none'">
              </div>
            </div>
          </div>
          
          <!-- Category Feature Images Section Below Header -->
          ${segment.category ? `<div class="category-section border-b bg-gray-100 mobile-feature-section" style="margin: 0;">
            <div class="flex items-center justify-center p-2">
               <div class="flex items-center justify-center gap-1 flex-wrap mobile-feature-images" style="width: 558px; min-height: 91px; padding: 8px;">
                 ${getCategoryFeatureImages(segment.category).map(imagePath => 
                   `<img src="${imagePath}" alt="Feature" class="object-contain mobile-feature-img" style="height: 70px; width: auto; max-width: 85px;" onerror="this.style.display='none'">`
                 ).join('')}
               </div>
            </div>
          </div>` : ''}
          
          <!-- Product Title with Responsive Dynamic Sizing -->
          <div class="text-center py-2 px-2">
            <h3 class="font-bold text-gray-800" 
                style="font-size: ${titleText.length > 60 ? 'clamp(0.625rem, 2vw, 0.75rem)' : titleText.length > 40 ? 'clamp(0.75rem, 2.5vw, 0.875rem)' : 'clamp(0.875rem, 3vw, 1rem)'}; line-height: 1.2; word-wrap: break-word;">${titleText}</h3>
          </div>
          
          <!-- Product Table with Optimized Layout -->
          <div class="product-table mx-3 bg-white border rounded-lg overflow-hidden">
            <!-- Single Header Row -->
            <div class="table-header bg-gray-100 p-1 border-b">
              <div class="grid grid-cols-2 gap-4 items-center">
                <div class="grid grid-cols-2 gap-2">
                  <div class="text-left font-semibold text-gray-700" style="font-size: clamp(0.75rem, 2.5vw, 0.875rem);">Length</div>
                  <div class="text-right font-semibold text-gray-700" style="font-size: clamp(0.75rem, 2.5vw, 0.875rem);">Price (${state.currency})</div>
                </div>
                <div class="text-center font-semibold text-gray-700" style="font-size: clamp(0.75rem, 2.5vw, 0.875rem);">Product</div>
              </div>
            </div>
            
            <!-- Table Content -->
            <div class="table-content p-2">
              <div class="grid grid-cols-2 gap-4 items-start">
                <!-- Left Side: Length and Price Columns -->
                <div class="grid grid-cols-2 gap-2">
                  <!-- Length Column -->
                  <div class="lengths-column space-y-1">
                    ${rows.map(row => `<div class="text-left text-gray-900 font-medium py-1 px-2 bg-gray-100 rounded border min-h-[24px] flex items-center" style="font-size: clamp(0.75rem, 2.2vw, 0.875rem);">${row.length}"</div>`).join('')}
                  </div>
                  
                  <!-- Price Column -->
                  <div class="prices-column space-y-1">
                    ${rows.map(row => {
                      const converted = state.currency === 'INR' ? row.priceINR : convertINRto(state.currency, row.priceINR);
                      const adjustedPrice = (converted || 0) * factor;
                      return `<div class="text-right text-gray-900 font-semibold py-1 px-2 bg-gray-100 rounded border min-h-[24px] flex items-center justify-end" style="font-size: clamp(0.75rem, 2.2vw, 0.875rem);">${(SYMBOL[state.currency] || '')}${adjustedPrice.toFixed(2)}</div>`;
                    }).join('')}
                  </div>
                </div>
                
                <!-- Right Side: Product Image -->
                <div class="product-image-column flex justify-center items-center bg-white border rounded-lg shadow-sm" style="height: ${Math.max(150, rows.length * 28)}px;">
                  <img src="${getProductImagePath(segment.category, segment.product, segment.density)}" alt="${segment.product}" 
                       class="max-w-full max-h-full object-contain" 
                       style="width: auto; height: 90%;" 
                       onerror="this.style.display='none'">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Footer integrated within main content -->
          <div class="border-t-2 border-gray-300 rounded-lg" style="background-color: #e6eaeb;">
            <div class="text-center px-3 py-2">
              <!-- Contact Information Section -->
              <div class="grid grid-cols-3 items-start mb-2" style="font-size: clamp(0.75rem, 2vw, 0.875rem);">
                ${document.getElementById('priceListSelector').value === 'USA25' ? `
                <div class="text-left text-gray-700">
                  <div class="font-medium">8 SUMMIT CT</div>
                  <div class="font-medium">HACKENSACK NJ 07601, USA</div>
                </div>
                <div class="flex justify-center items-center">
                  <span class="font-bold text-3xl" style="color: #a37e55;">${SYMBOL[state.currency] || state.currency}</span>
                </div>
                <div class="text-right">
                  <a href="mailto:us@indiannaturalhair.com" class="text-gray-700 font-semibold hover:text-gray-900 transition-colors">us@indiannaturalhair.com</a>
                  <div class="text-gray-700 font-semibold">+1 (646) 919-2921</div>
                </div>
                ` : `
                <div class="text-left text-gray-700">
                  <div class="font-medium">WZ 81/1A, Guru Nanak Nagar</div>
                  <div class="font-medium">New Delhi 110018, India</div>
                </div>
                <div class="flex justify-center items-center">
                  <span class="font-bold text-3xl" style="color: #a37e55;">${SYMBOL[state.currency] || state.currency}</span>
                </div>
                <div class="text-right">
                  <a href="mailto:info@indiannaturalhair.com" class="text-gray-700 font-semibold hover:text-gray-900 transition-colors">info@indiannaturalhair.com</a>
                </div>
                `}
              </div>
                
              <!-- Shipping Partners & Payment Methods Section -->
              <div class="border-t border-gray-400 pt-1 pb-1">
                <div class="flex items-center justify-center gap-3 flex-wrap">
                  <!-- Shipping Partners -->
                  <img src="images/dhl-logo-official.svg" alt="DHL" class="h-5 w-auto object-contain" onerror="this.style.display='none'">
                  <img src="images/aramex-logo-official.svg" alt="Aramex" class="h-5 w-auto object-contain" onerror="this.style.display='none'">
                  <img src="images/fedex-logo-official.svg" alt="FedEx" class="h-5 w-auto object-contain" onerror="this.style.display='none'">
                  
                  <!-- Separator -->
                  <div class="h-4 w-px bg-gray-300 mx-2"></div>
                  
                  <!-- Payment Methods -->
                  <img src="images/visa-logo.svg" alt="Visa" class="h-4 w-auto object-contain" onerror="this.style.display='none'">
                  <img src="images/mastercard-logo.svg" alt="Mastercard" class="h-4 w-auto object-contain" onerror="this.style.display='none'">
                  <img src="images/amex-logo.svg" alt="American Express" class="h-4 w-auto object-contain" onerror="this.style.display='none'">
                  
                  <!-- INR-specific payment methods -->
                  ${state.currency === 'INR' ? `
                    <img src="images/paytm-logo.svg" alt="PayTM" class="h-4 w-auto object-contain" onerror="this.style.display='none'">
                    <img src="images/googlepay-logo.svg" alt="Google Pay" class="h-4 w-auto object-contain" onerror="this.style.display='none'">
                  ` : ''}
                </div>
              </div>
                
              <!-- Date and Validity Section -->
              <div class="border-t border-gray-400 pt-1 pb-1">
                <div class="text-center">
                  <p class="text-gray-600 font-medium" style="font-size: clamp(0.625rem, 1.8vw, 0.75rem);">Generated: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })} | <span class="text-red-600 font-semibold">Valid until: ${new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span></p>
                </div>
              </div>
                
              <!-- Standard Weight Section -->
              ${(() => {
                const rows = rowsForSegment(segment);
                if (rows.length > 0) {
                  const firstRow = rows[0];
                  const baseWeight = parseFloat(firstRow.meta['Standard Weight']) || 0;
                  // Only multiply by 10 if kg mode is enabled AND prices are displayed per kg (not per piece)
                  const pricesArePerKg = segment.kg && /y/i.test(firstRow.meta['Can Be Sold in KG?'] || '');
                  const displayWeight = pricesArePerKg ? baseWeight * 10 : baseWeight;
                  const weightText = displayWeight ? `${displayWeight}g` : 'N/A';
                  return `<div class="border-t border-gray-400 pt-1 pb-1">
                    <div class="text-center">
                      <p class="text-gray-600 font-medium" style="font-size: clamp(0.625rem, 1.8vw, 0.75rem);">Standard Weight: <span class="font-semibold">${weightText}</span></p>
                    </div>
                  </div>`;
                }
                return '';
              })()} 
              
              <!-- Brand Tagline Section -->
              <div class="border-t border-gray-400 pt-1">
                <p class="text-gray-700 italic font-semibold" style="font-size: clamp(0.75rem, 2vw, 0.875rem);">Premium Quality Hair Products ‚Ä¢ Trusted Worldwide ‚Ä¢ ${getCurrentPriceFactor().toFixed(2)}x</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function drawHeader(W, category){
      // Ensure context is properly set before drawing
      if (!ctx) {
        console.error('Canvas context not available for header drawing');
        return;
      }
      
      // Draw main header background - increased height for larger elements
      ctx.fillStyle='#e6eaeb'; 
      roundRect(ctx, 10, 10, W-20, 140, 15, true, false);
      
      // Company logo right-aligned - 120x120 pixels (increased from 80x80)
      const logoSize = 120;
      const logoX = W - logoSize - 15; // 15px margin from right edge
      const logoY = 10; // Top aligned within header
      try{ 
        await drawImage('images/logo.png', logoX, logoY, logoSize, logoSize);
      }catch(e){
        console.warn('Logo not found:', e);
        // Draw placeholder rectangle for logo
        ctx.fillStyle='#cccccc';
        ctx.fillRect(logoX, logoY, logoSize, logoSize);
      }
      
      // "Made with" badge left-aligned - 240x75 pixels (increased from 180x55)
      const badgeWidth = 240;
      const badgeHeight = 75;
      const badgeX = 25; // 25px margin from left edge
      const badgeY = 15; // Centered vertically within header
      try{ 
        await drawImage('images/madewithbadge.png', badgeX, badgeY, badgeWidth, badgeHeight);
      }catch(e){
        console.warn('Made with badge not found:', e);
        // Draw placeholder rectangle for badge
        ctx.fillStyle='#cccccc';
        ctx.fillRect(badgeX, badgeY, badgeWidth, badgeHeight);
      }
      
      // USA Company Information - display when USA25 price list is selected

      
      // Category feature images section below main header
      if (category) {
        ctx.fillStyle='#dddfe0'; 
        roundRect(ctx, 10, 149, W-20, 101, 15, true, false);
        
        // Draw multiple feature images in a row
        const featureImages = getCategoryFeatureImages(category);
        const imageHeight = 70;
        const imageSpacing = 4;
        const imageWidth = 85;
        const totalImagesWidth = featureImages.length * imageWidth + (featureImages.length - 1) * imageSpacing;
        const startX = (W - totalImagesWidth) / 2;
        const imageY = 159 + (91 - imageHeight) / 2;
        
        for (let i = 0; i < featureImages.length; i++) {
          const imagePath = featureImages[i];
          const imageX = startX + i * (imageWidth + imageSpacing);
          
          try {
            await drawImage(imagePath, imageX, imageY, imageWidth, imageHeight);
          } catch(e) {
            console.warn('Feature image not found:', imagePath, e);
            // Draw placeholder rectangle for missing image
            ctx.fillStyle='#cccccc';
            ctx.fillRect(imageX, imageY, imageWidth, imageHeight);
          }
        }
        
        // Add subtle border
        ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(0, 250); ctx.lineTo(W, 250); ctx.stroke();
      }
    }
    async function drawFooter(W,H,segment){
      // Footer background with proper margins - matching header color - increased height for new content
      ctx.fillStyle='#e6eaeb'; 
      roundRect(ctx, 10, H-150, W-20, 140, 15, true, false);
      
      // Footer text styling and positioning
      ctx.fillStyle='#475569'; 
      ctx.font='500 11px system-ui, -apple-system, Segoe UI, Roboto';
      
      // Address (left aligned, two rows) and email (right aligned, top row)
      const leftMargin = 25;
      const rightMargin = W - 25;
      const selectedPriceList = document.getElementById('priceListSelector').value;
      
      if (selectedPriceList === 'USA25') {
        // USA company information
        ctx.textAlign='right';
        ctx.fillText('us@indiannaturalhair.com', rightMargin, H-125);
        ctx.fillText('+1 (646) 919-2921', rightMargin, H-110);
        
        // Address on left (two lines)
        ctx.textAlign='left';
        ctx.font='500 9px system-ui, -apple-system, Segoe UI, Roboto'; // Slightly smaller font to fit
        ctx.fillText('8 SUMMIT CT', leftMargin, H-125);
        ctx.fillText('HACKENSACK NJ 07601, USA', leftMargin, H-110);
        ctx.font='500 10px system-ui, -apple-system, Segoe UI, Roboto'; // Reset font size
      } else {
        // Default Indian company information
        ctx.textAlign='right';
        ctx.fillText('info@indiannaturalhair.com', rightMargin, H-125);
        
        // Address on left (two lines)
        ctx.textAlign='left';
        ctx.font='500 9px system-ui, -apple-system, Segoe UI, Roboto'; // Slightly smaller font to fit
        ctx.fillText('WZ 81/1A, Guru Nanak Nagar', leftMargin, H-125);
        ctx.fillText('New Delhi 110018, India', leftMargin, H-110);
        ctx.font='500 10px system-ui, -apple-system, Segoe UI, Roboto'; // Reset font size
      }
      
      // Generated date and Valid until date in a single row (center)
      ctx.textAlign='center';
      ctx.fillStyle='#374151';
      ctx.font='600 10px system-ui, -apple-system, Segoe UI, Roboto';
      const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      const validUntilDate = new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      ctx.fillText(`Generated: ${currentDate} | Valid until: ${validUntilDate}`, W/2, H-95);
      
      // Standard Weight section
      if (segment) {
        const rows = rowsForSegment(segment);
        if (rows.length > 0) {
          const firstRow = rows[0];
          const baseWeight = parseFloat(firstRow.meta['Standard Weight']) || 0;
          // Only multiply by 10 if kg mode is enabled AND prices are displayed per kg (not per piece)
          const pricesArePerKg = segment.kg && /y/i.test(firstRow.meta['Can Be Sold in KG?'] || '');
          const displayWeight = pricesArePerKg ? baseWeight * 10 : baseWeight;
          const weightText = displayWeight ? `${displayWeight}g` : 'N/A';
          
          ctx.fillStyle='#475569';
          ctx.font='500 11px system-ui, -apple-system, Segoe UI, Roboto';
          ctx.fillText(`Standard Weight: ${weightText}`, W/2, H-80);
        }
      }
      
      // Combined shipping and payment partners label
      ctx.fillStyle='#374151';
      ctx.font='600 10px system-ui, -apple-system, Segoe UI, Roboto';
      ctx.fillText('SHIPPING PARTNERS & PAYMENT METHODS', W/2, H-65);
      
      // Combined logos row
      const logoY = H-50;
      const shippingLogoWidth = 45;
      const shippingLogoHeight = 15;
      const paymentLogoWidth = 30;
      const paymentLogoHeight = 15;
      
      // Determine payment logos based on currency
      const isINR = state.currency === 'INR';
      const paymentLogos = [
        'images/visa-logo.svg',
        'images/mastercard-logo.svg', 
        'images/amex-logo.svg'
      ];
      
      if (isINR) {
        paymentLogos.push('images/paytm-logo.svg', 'images/googlepay-logo.svg');
      }
      
      // Calculate total width for centering
      const shippingWidth = shippingLogoWidth * 3 + 20; // 3 shipping logos + gaps
      const separatorWidth = 20; // Space for separator
      const paymentWidth = paymentLogoWidth * paymentLogos.length + 8 * (paymentLogos.length - 1);
      const totalWidth = shippingWidth + separatorWidth + paymentWidth;
      const startX = (W - totalWidth) / 2;
      
      try {
        // Draw shipping logos
        await drawImage('images/dhl-logo-official.svg', startX, logoY, shippingLogoWidth, shippingLogoHeight);
        await drawImage('images/aramex-logo-official.svg', startX + shippingLogoWidth + 10, logoY, shippingLogoWidth, shippingLogoHeight);
        await drawImage('images/fedex-logo-official.svg', startX + (shippingLogoWidth + 10) * 2, logoY, shippingLogoWidth, shippingLogoHeight);
        
        // Draw separator line
        const separatorX = startX + shippingWidth + 10;
        ctx.fillStyle='#d1d5db';
        ctx.fillRect(separatorX, logoY, 1, 15);
        
        // Draw payment logos
        const paymentStartX = separatorX + 10;
        for (let i = 0; i < paymentLogos.length; i++) {
          const x = paymentStartX + i * (paymentLogoWidth + 8);
          await drawImage(paymentLogos[i], x, logoY, paymentLogoWidth, paymentLogoHeight);
        }
      } catch (e) {
        console.warn('Logos not found:', e);
        // Fallback text if logos fail to load
        ctx.fillStyle='#6b7280';
        ctx.font='500 8px system-ui, -apple-system, Segoe UI, Roboto';
        const fallbackText = isINR ? 'DHL ‚Ä¢ ARAMEX ‚Ä¢ FEDEX | VISA ‚Ä¢ MASTERCARD ‚Ä¢ AMEX ‚Ä¢ PAYTM ‚Ä¢ GOOGLE PAY' : 'DHL ‚Ä¢ ARAMEX ‚Ä¢ FEDEX | VISA ‚Ä¢ MASTERCARD ‚Ä¢ AMEX';
        ctx.fillText(fallbackText, W/2, logoY + 10);
      }
    }
    
    function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
      if (typeof stroke === 'undefined') stroke = true;
      if (typeof radius === 'undefined') radius = 5;
      if (typeof radius === 'number') {
        radius = {tl: radius, tr: radius, br: radius, bl: radius};
      } else {
        var defaultRadius = {tl: 0, tr: 0, br: 0, bl: 0};
        for (var side in defaultRadius) {
          radius[side] = radius[side] || defaultRadius[side];
        }
      }
      ctx.beginPath();
      ctx.moveTo(x + radius.tl, y);
      ctx.lineTo(x + width - radius.tr, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
      ctx.lineTo(x + width, y + height - radius.br);
      ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
      ctx.lineTo(x + radius.bl, y + height);
      ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
      ctx.lineTo(x, y + radius.tl);
      ctx.quadraticCurveTo(x, y, x + radius.tl, y);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }
    function tableHead(W, y, xPad){
      const lengthPriceColWidth = 180;
      const imageWidth = 250;
      
      ctx.fillStyle='#e6eaeb'; roundRect(ctx, xPad, y, W-2*xPad, 36, 10, true);
      ctx.fillStyle='#081249'; ctx.font='600 14px system-ui, -apple-system, Segoe UI, Roboto';
      
      // Length header (left side) - left aligned
      ctx.textAlign='left';
      ctx.fillText('Length', xPad + 10, y+23);
      
      // Price header (left side, next to length) - left aligned
      ctx.fillText(`Price (${SYMBOL[state.currency]||''}${state.currency})`, xPad + 90, y+23);
      
      // Product image header (right side) - center aligned
      ctx.textAlign='center';
      ctx.fillText('Product', xPad + lengthPriceColWidth + imageWidth/2, y+23);
    }

    function segmentBlockHeight(rows){ 
      const titleHeight = 24;
      const tableHeaderHeight = 36;
      const minImageHeight = 200; // Minimum height for product image
      const rowHeight = 40; // Height per data row
      const bottomMargin = 40;
      
      // Calculate dynamic table height based on number of rows
      const dynamicImageHeight = Math.max(minImageHeight, rows.length * rowHeight + 60); // 60px for padding
      
      return titleHeight + tableHeaderHeight + dynamicImageHeight + bottomMargin;
    }
    
    function calculateOptimalPageHeight(segments, W) {
      if (segments.length === 0) return 600;
      
      const seg = segments[0]; // Only calculate for first segment since we render one per page
      const baseHeaderHeight = 100;
      const categoryHeaderHeight = seg.category ? 120 : 0;
      const headerHeight = baseHeaderHeight + categoryHeaderHeight;
      const footerHeight = 80; // Minimized footer background height for compact layout
      const minContentHeight = 200;
      const contentMargin = 80; // Increased spacing between content and footer
      
      const rows = rowsForSegment(seg);
      const contentHeight = segmentBlockHeight(rows);
      
      // Ensure adequate spacing: header + content + margin + footer
      return Math.max(
        headerHeight + contentHeight + contentMargin + footerHeight,
        headerHeight + minContentHeight + contentMargin + footerHeight
      );
    }

    async function renderPage(segments, W, H){
      // Render only one segment per page with header and footer
      if (segments.length === 0) return 0;
      
      const seg = segments[0];
      const cat = seg.category;
      
      // Always draw header for this segment - ensure it's rendered
      try {
        await drawHeader(W, cat);
      } catch (e) {
        console.error('Error drawing header:', e);
        // Draw a basic header fallback
        ctx.fillStyle='#e6eaeb'; 
        roundRect(ctx, 10, 10, W-20, 80, 15, true, false);
      }
      
      let y = cat ? 269 : 160; // Start lower if category header is present - adjusted for new header height
      let xPad = 20;
      
      const rows = rowsForSegment(seg);
      
      // Title
      ctx.fillStyle='#081249'; ctx.font='700 18px system-ui, -apple-system, Segoe UI, Roboto'; ctx.textAlign='center';
      const unit = state.kg ? 'Per Kg' : 'Per Piece';
      const titleText = `${seg.product.toUpperCase()} | ${seg.density.toUpperCase()} | ${seg.color.toUpperCase()} | ${state.currency} | ${unit.toUpperCase()}`;
      ctx.fillText(titleText, W/2, y+20); y += 24;

      // Table with rounded corners and better margins - dynamic height based on data
       const tableMargin = 30;
       const tableWidth = W - 2 * tableMargin;
       
       // Calculate dynamic table dimensions based on row count
       const minImageHeight = 200;
       const rowHeight = 40;
       const dynamicImageHeight = Math.max(minImageHeight, rows.length * rowHeight + 60);
       const tableContentHeight = 36 + dynamicImageHeight; // header + content
       
       // Draw table background with rounded corners
       ctx.fillStyle='#ffffff';
       roundRect(ctx, tableMargin, y, tableWidth, tableContentHeight, 12, true);
       
       // Add subtle shadow effect
       ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
       ctx.shadowBlur = 8;
       ctx.shadowOffsetY = 4;
       
       tableHead(W, y, tableMargin); y += 36;
       
       ctx.shadowColor = 'transparent'; // Reset shadow
       ctx.shadowBlur = 0;
       ctx.shadowOffsetY = 0;
       
       // Calculate layout for 3-column table: Length+Price, Product Image
       const lengthPriceColWidth = 180;
       const imageWidth = 250;
       const imageHeight = dynamicImageHeight;
       
       // Draw product image in right column
       let imagePath = getProductImagePath(seg.category, seg.product, seg.density);
       
       const imageX = tableMargin + lengthPriceColWidth;
       const imageY = y;
       
       if (imagePath) {
         try {
           await drawImage(imagePath, imageX, imageY, imageWidth, imageHeight);
         } catch(e) {
           console.warn('Product image not found:', imagePath);
           // Draw placeholder text if image fails
           ctx.fillStyle='#64748b';
           ctx.font='500 14px system-ui, -apple-system, Segoe UI, Roboto';
           ctx.textAlign='center';
           ctx.fillText('Image not found', imageX + imageWidth/2, imageY + imageHeight/2);
         }
       }
       
       // Draw length and price data with proper spacing
       ctx.font='500 13px system-ui, -apple-system, Segoe UI, Roboto';
       const dataRowHeight = 40; // Consistent row height
       const startPadding = 30; // Top padding within table content area
       
       for (let idx = 0; idx < rows.length; idx++) {
         const row = rows[idx];
         const dataY = y + startPadding + (idx * dataRowHeight);
         
         // Length column (left side) - left aligned
         ctx.fillStyle='#444662';
         ctx.textAlign='left';
         ctx.fillText(`${row.length}"`, tableMargin + 10, dataY);
         
         // Price column (left side, next to length) - left aligned
         const converted = state.currency==='INR' ? row.priceINR : convertINRto(state.currency, row.priceINR);
         const factor = getCurrentPriceFactor();
        const adjustedPrice = (converted || 0) * factor;
         ctx.fillText(`${(SYMBOL[state.currency]||'')}${adjustedPrice.toFixed(2)}`, tableMargin + 90, dataY);
       }
       
       y += dynamicImageHeight + 20;
      
      // Draw footer for this segment
      await drawFooter(W,H,segment);
      
      return 1; // Always consume exactly one segment
    }

    function renderAllPagesToHTML(){
      const htmlPreview = document.getElementById('htmlPreview');
      const previewContainer = htmlPreview.querySelector('div');
      
      // Clear existing content
      previewContainer.innerHTML = '';
      
      if (state.segments.length === 0) {
        previewContainer.innerHTML = '<div class="text-center text-gray-500 p-8">No segments to display. Please select products and generate preview.</div>';
        document.getElementById('pageInfo').textContent = 'No pages to display';
        
        // Hide PNG download button when no segments
        const pngButton = document.getElementById('downloadPNG');
        if (pngButton) {
          pngButton.style.display = 'none';
          pngButton.disabled = true;
        }
        
        return;
      }
      
      // Generate HTML for each segment with 20px spacing
      const pagesHTML = state.segments.map((segment, index) => {
        return `<div class="page-wrapper mx-auto" style="margin-bottom: 20px;">${createPageHTML(segment, index)}</div>`;
      }).join('');
      
      previewContainer.innerHTML = pagesHTML;
      
      // Update page info
      const pageCount = state.segments.length;
      document.getElementById('pageInfo').textContent = pageCount > 1 ? `Showing all ${pageCount} pages` : 'Single page preview';
      
      // Show/hide PNG download button based on page count
      const pngButton = document.getElementById('downloadPNG');
      if (pngButton) {
        if (pageCount === 1) {
          pngButton.style.display = 'flex';
          pngButton.disabled = false;
        } else {
          pngButton.style.display = 'none';
          pngButton.disabled = true;
        }
      }
      
      return { pageCount };
    }
    
    // Canvas functions removed - now using HTML preview
    


    async function downloadPDF(){
      console.log('downloadPDF called');
      
      if (state.segments.length === 0) {
        alert('Please generate a preview first. Select a category, products, densities, and colors, then click "Generate Preview".');
        return;
      }
      
      // Show loading state with mobile-friendly feedback
      const downloadBtn = $('shareDownloadPDF');
      const originalText = downloadBtn.innerHTML;
      downloadBtn.innerHTML = '<span>‚è≥</span> <span class="hidden sm:inline">Generating PDF...</span><span class="sm:hidden">Generating...</span>';
      downloadBtn.disabled = true;
      
      // Add mobile-specific loading indicator
      const loadingOverlay = document.createElement('div');
      loadingOverlay.id = 'pdfLoadingOverlay';
      loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      loadingOverlay.innerHTML = `
        <div class="bg-white rounded-lg p-6 text-center max-w-xs mx-4">
          <div class="text-2xl mb-2">‚è≥</div>
          <div class="font-medium">Generating PDF...</div>
          <div class="text-sm text-gray-600 mt-1">Please wait</div>
        </div>
      `;
      document.body.appendChild(loadingOverlay);
      
      try {
        // Create PDF with optimized settings
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4',
          compress: true
        });
        
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        
        // Process each segment as a separate page
        for (let i = 0; i < state.segments.length; i++) {
          const segment = state.segments[i];
          
          // Create a temporary container for this segment only
          const tempContainer = document.createElement('div');
          tempContainer.style.position = 'absolute';
          tempContainer.style.left = '-9999px';
          tempContainer.style.top = '0';
          tempContainer.style.width = '615px';
          tempContainer.style.backgroundColor = '#ffffff';
          tempContainer.innerHTML = createPageHTML(segment, i);
          
          document.body.appendChild(tempContainer);
          
          try {
            // Render this segment to canvas with optimized settings
            const canvas = await html2canvas(tempContainer, {
              scale: 2, // Higher quality for PDF
              useCORS: true,
              allowTaint: true,
              backgroundColor: '#ffffff',
              width: 615,
              height: tempContainer.scrollHeight,
              logging: false,
              removeContainer: false
            });
            
            // Add new page if not the first segment
            if (i > 0) {
              pdf.addPage();
            }
            
            // Calculate optimal scaling to fit A4 page with better margins
            const marginX = 15; // 15mm side margins
            const marginY = 15; // 15mm top/bottom margins
            const maxWidth = pageWidth - (marginX * 2);
            const maxHeight = pageHeight - (marginY * 2);
            
            // Calculate scaling to fit within margins while maintaining aspect ratio
            const scaleX = maxWidth / canvas.width;
            const scaleY = maxHeight / canvas.height;
            const scale = Math.min(scaleX, scaleY);
            
            const scaledWidth = canvas.width * scale;
            const scaledHeight = canvas.height * scale;
            
            // Precise content centering for optimal alignment
            const xOffset = (pageWidth - scaledWidth) / 2;
            const yOffset = (pageHeight - scaledHeight) / 2;
            
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            pdf.addImage(imgData, 'JPEG', xOffset, yOffset, scaledWidth, scaledHeight);
            
          } finally {
            // Clean up temporary container
            document.body.removeChild(tempContainer);
          }
        }
        
        // Generate filename with format: ${Category} - ${Currency} - ${Unit}
        const category = state.segments.length > 0 ? state.segments[0].category : 'General';
        const currency = state.currency || 'INR';
        const hasKgMode = state.segments.some(seg => seg.kg);
        const unit = hasKgMode ? 'Per Kg' : 'Per Piece';
        
        // Format category name with proper capitalization
        const formattedCategory = category.split(' ').map(word => 
          word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
        ).join(' ');
        
        const filename = `${formattedCategory} - ${currency} - ${unit}.pdf`;
        
        // Save the PDF
        pdf.save(filename);
        
        console.log(`PDF generated successfully with ${state.segments.length} pages`);
        
        // Store the generated PDF for sharing
        const pdfBlob = pdf.output('blob');
        state.lastGeneratedPDF = {
          blob: pdfBlob,
          filename: filename,
          timestamp: Date.now()
        };
        
        // Reset button state
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
        
        // Remove mobile loading overlay
        const overlay = document.getElementById('pdfLoadingOverlay');
        if (overlay) overlay.remove();
        
        // Hide share popup
        $('sharePopup').classList.add('hidden');
        
        // Show enhanced success message with file opening option
        const successModal = document.createElement('div');
        successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        successModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-auto">
            <div class="text-center mb-4">
              <div class="text-3xl mb-2">‚úÖ</div>
              <h3 class="font-semibold text-lg">PDF Downloaded Successfully!</h3>
              <p class="text-gray-600 text-sm mt-1">Your file has been saved to your device</p>
            </div>
            <div class="space-y-3">
              <div class="bg-gray-50 rounded-lg p-3">
                <div class="text-sm font-medium text-gray-700">File:</div>
                <div class="text-sm text-gray-600 truncate">${filename}</div>
              </div>
              <button onclick="openDownloadedFile('${filename}', 'pdf')" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors touch-action-manipulation">
                üìÑ Open PDF File
              </button>
              <button onclick="this.parentElement.parentElement.parentElement.remove()" class="w-full px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors touch-action-manipulation">
                Close
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(successModal);
        
        // Auto-close after 10 seconds
        setTimeout(() => {
          if (successModal.parentElement) {
            successModal.remove();
          }
        }, 10000);
        
      } catch (error) {
        console.error('Error generating PDF:', error);
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
        
        // Remove mobile loading overlay
        const overlay = document.getElementById('pdfLoadingOverlay');
        if (overlay) overlay.remove();
        
        // Mobile-friendly error message
        if (window.innerWidth <= 768) {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'fixed top-4 left-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50';
          errorMsg.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="text-lg">‚ùå</span>
              <div>
                <div class="font-medium">PDF Generation Failed</div>
                <div class="text-sm">Please try again</div>
              </div>
            </div>
          `;
          document.body.appendChild(errorMsg);
          setTimeout(() => errorMsg.remove(), 4000);
        } else {
          alert('Error generating PDF: ' + error.message);
        }
      }
    }

    // Function to open downloaded files
    function openDownloadedFile(filename, fileType) {
      try {
        // For modern browsers, try to use the File System Access API or fallback methods
        if ('showOpenFilePicker' in window) {
          // Modern browsers with File System Access API
          const instructions = document.createElement('div');
          instructions.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
          instructions.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-auto">
              <div class="text-center mb-4">
                <div class="text-2xl mb-2">üìÅ</div>
                <h3 class="font-semibold text-lg">Open Downloaded File</h3>
              </div>
              <div class="space-y-3 text-sm">
                <p class="text-gray-600">To open your downloaded ${fileType.toUpperCase()} file:</p>
                <div class="bg-gray-50 rounded-lg p-3">
                  <div class="space-y-2">
                    <div class="flex items-start gap-2">
                      <span class="font-medium text-blue-600">1.</span>
                      <span>Check your Downloads folder</span>
                    </div>
                    <div class="flex items-start gap-2">
                      <span class="font-medium text-blue-600">2.</span>
                      <span>Look for: <strong>${filename}</strong></span>
                    </div>
                    <div class="flex items-start gap-2">
                      <span class="font-medium text-blue-600">3.</span>
                      <span>Double-click to open</span>
                    </div>
                  </div>
                </div>
                <div class="text-xs text-gray-500">
                  üí° Tip: Press Ctrl+J (Windows) or Cmd+Shift+J (Mac) in your browser to see recent downloads
                </div>
              </div>
              <button onclick="this.parentElement.parentElement.remove()" class="w-full mt-4 px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors touch-action-manipulation">
                Got it!
              </button>
            </div>
          `;
          document.body.appendChild(instructions);
        } else {
          // Fallback for older browsers
          const message = `Your ${fileType.toUpperCase()} file "${filename}" has been downloaded.\n\nTo open it:\n1. Check your Downloads folder\n2. Look for: ${filename}\n3. Double-click to open\n\nTip: Press Ctrl+J (Windows) or Cmd+Shift+J (Mac) to see recent downloads.`;
          alert(message);
        }
      } catch (error) {
        console.error('Error opening file:', error);
        const fallbackMessage = `File downloaded: ${filename}\n\nPlease check your Downloads folder to open the file.`;
        alert(fallbackMessage);
      }
    }

    /* Init */
    async function init(){
      console.log('Starting init function...');
      try {
        // Try to load data from embedded script first
        const embeddedElement = document.getElementById('EMBEDDED_DATA');
        if (embeddedElement && embeddedElement.textContent.trim()) {
          console.log('Loading data from embedded script...');
          productData = JSON.parse(embeddedElement.textContent);
          console.log('Loaded', productData.length, 'products from embedded data');
        } else {
          // Try to load from localStorage as fallback
          const storedData = localStorage.getItem('productData');
          if (storedData) {
            console.log('Loading data from localStorage...');
            productData = JSON.parse(storedData);
            console.log('Loaded', productData.length, 'products from localStorage');
          } else {
            // Initialize with empty data - users can upload their own Excel files
            console.log('No existing data found, initializing with empty data...');
            productData = [];
            console.log('Initialized with empty data - ready for Excel upload');
          }
        }
      } catch(e){ 
        console.error('Error during initialization:', e);
        productData=[]; 
      }
      
      // Initialize product arrays for filtering
      state.allProducts = [...productData];
      state.filteredProducts = [...productData];
      console.log('State initialized with', state.allProducts.length, 'products');
      
      // Initialize price list dropdown first
      initPriceListDropdown();
      
      // Then populate categories (will be empty initially until price list is selected)
      populateCategories();
      
      // restore FX if saved, otherwise fetch live rates
      const cached = JSON.parse(localStorage.getItem('INH_FX')||'null');
      if (cached && cached.base==='INR' && cached.rates && cached.mode==='auto'){
        state.rates = cached;
        // Auto-refresh if rates are older than 1 hour
        const hourAgo = Date.now() - (60 * 60 * 1000);
        if (!cached.updatedAt || cached.updatedAt < hourAgo) {
          fetchLiveFX();
        }
      } else {
        fetchLiveFX();
      }

      // events
      elCurrency.addEventListener('change', ()=>{ state.currency=elCurrency.value; renderAllPagesToHTML(); });


      elCategory.addEventListener('change', onCategoryChange);
      
      // Dropdown toggle functionality
      [elProductDropdown, elDensityDropdown, elColorDropdown].forEach(dropdown => {
        const btn = dropdown.querySelector('.dropdown-btn');
        const list = dropdown.querySelector('.dropdown-list');
        
        btn.addEventListener('click', (e) => {
          if (btn.disabled) return;
          e.stopPropagation();
          
          // Close other dropdowns
          [elProductDropdown, elDensityDropdown, elColorDropdown].forEach(other => {
            if (other !== dropdown) {
              other.querySelector('.dropdown-list').classList.add('hidden');
            }
          });
          
          list.classList.toggle('hidden');
        });
        

        
        // Handle checkbox changes
        list.addEventListener('change', () => {
          if (dropdown === elProductDropdown) onProductChange();
          else if (dropdown === elDensityDropdown) onDensityChange();
          else if (dropdown === elColorDropdown) onColorChange();
        });
      });
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', () => {
        [elProductDropdown, elDensityDropdown, elColorDropdown].forEach(dropdown => {
          dropdown.querySelector('.dropdown-list').classList.add('hidden');
        });
      });

      elKg.addEventListener('change', ()=>{ 
        state.kg = elKg.checked;
        // Regenerate preview if segments exist
        if (state.segments.length > 0) {
          renderAllPagesToHTML();
        }
      });

      elSelectAll.addEventListener('change', onSelectAllToggle);

  
      elClearSegments.addEventListener('click', clearAllOptions);
      $('previewBtn').addEventListener('click', generatePreview);
      $('sharePdfBtn').addEventListener('click', shareNatively);
      $('shareDownloadPDF').addEventListener('click', downloadPDF);

      $('downloadPNG').addEventListener('click', downloadPNG);

      
      // Page navigation event listeners removed - now using HTML preview
      
      // Price factor event listener
      $('priceFactor').addEventListener('input', () => {
        if (state.segments.length > 0) {
          renderAllPagesToHTML();
        }
      });




      // Close share popup when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#sharePdfBtn') && !e.target.closest('#sharePopup')) {
          $('sharePopup').classList.add('hidden');
          $('sharePdfBtn').setAttribute('aria-expanded', 'false');
        }
      });

      renderAllPagesToHTML();
    }

    // Generate Preview functionality
    function generatePreview() {
      // Validate that a category is selected
      if (!state.category) {
        alert('Please select a category first before generating a preview.');
        return;
      }
      
      // Clear existing preview content immediately to ensure fresh output
      const htmlPreview = document.getElementById('htmlPreview');
      const previewContainer = htmlPreview.querySelector('div');
      previewContainer.innerHTML = '<div class="text-center text-gray-500 p-8">Generating preview...</div>';
      document.getElementById('pageInfo').textContent = 'Generating...';
      
      // Show loading state
      const previewBtn = $('previewBtn');
      const originalText = previewBtn.innerHTML;
      previewBtn.innerHTML = '<span>‚è≥</span> <span class="hidden sm:inline">Generating...</span><span class="sm:hidden">Loading...</span>';
      previewBtn.disabled = true;
      
      // Hide Share PDF button during generation
      const sharePdfBtn = $('sharePdfBtn');
      sharePdfBtn.classList.add('hidden');
      
      // Use setTimeout to allow UI to update
      setTimeout(() => {
        try {
          // First, add the combinations to segments
          explodeCombosToSegments();
          
          // Then generate the preview
          renderAllPagesToHTML();
          
          // Reset button state
          previewBtn.innerHTML = originalText;
          previewBtn.disabled = false;
          
          // Show Share PDF button after successful generation
          sharePdfBtn.classList.remove('hidden');
          
          // Ensure all buttons have equal flex properties with improved styling
          const container = document.getElementById('actionButtonsContainer');
          const buttons = container.querySelectorAll('button');
          buttons.forEach(button => {
            button.style.flex = '1';
            // Mobile-friendly minimum width
            button.style.minWidth = window.innerWidth <= 640 ? '80px' : '120px';
            button.style.height = '52px';
            button.style.fontSize = '14px';
            button.style.fontWeight = '600';
            button.style.padding = '12px 16px';
            button.style.borderRadius = '12px';
            button.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
            button.style.whiteSpace = 'nowrap';
            button.style.overflow = 'hidden';
            button.style.textOverflow = 'ellipsis';
            button.style.transition = 'all 0.2s ease';
          });
          
          // Show success feedback
          const successMsg = document.createElement('div');
          successMsg.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50 flex items-center gap-2';
          successMsg.innerHTML = '<span class="text-lg">‚úÖ</span><span class="font-medium">Preview generated successfully!</span>';
          document.body.appendChild(successMsg);
          setTimeout(() => successMsg.remove(), 3000);
          
        } catch (error) {
          console.error('Error generating preview:', error);
          previewBtn.innerHTML = originalText;
          previewBtn.disabled = false;
          alert('Error generating preview: ' + error.message + '. Please ensure you have selected a category and try again.');
        }
      }, 100);
    }
    
    // Clear selections but keep category
    function clearAllSelections() {
      state.selProducts = [];
      state.selDensities = [];
      state.selColors = [];
      state.segments = [];
      state.selectAll = false;
      
      // Reset form elements but keep category
      elSelectAll.checked = false;
      elKg.checked = false;
      
      // Clear segments list and preview
      renderSegmentsList();
      renderAllPagesToHTML();
    }
    
    // Page navigation functions removed - now using HTML preview

    // Clear all options and reset to default state
    function clearAllOptions() {
      // Reset state
      state.category = '';
      state.selProducts = [];
      state.selDensities = [];
      state.selColors = [];
      state.segments = [];
      state.selectAll = false;
      
      // Reset form elements
      elCategory.value = '';
      elKg.checked = false;
      elSelectAll.checked = false;
      
      // Clear price factor input
      document.getElementById('priceFactor').value = '';
      
      // Clear and disable dropdowns
      fillDropdown(elProductDropdown, [], 'Select products...');
      fillDropdown(elDensityDropdown, [], 'Select densities...');
      fillDropdown(elColorDropdown, [], 'Select colors...');
      lockDropdown(elProductDropdown, true);
      lockDropdown(elDensityDropdown, true);
      lockDropdown(elColorDropdown, true);
      
      // Hide elements and reset layout
      elSelectAllWrap.classList.add('hidden');
      elKgWrap.classList.add('hidden');
      const sharePdfBtn = $('sharePdfBtn');
      sharePdfBtn.classList.add('hidden');
      
      // Reset button styling to original state
      const container = document.getElementById('actionButtonsContainer');
      const buttons = container.querySelectorAll('button');
      buttons.forEach(button => {
        button.style.flex = '';
        button.style.minWidth = '';
        button.style.height = '';
        button.style.fontSize = '';
        button.style.fontWeight = '';
        button.style.padding = '';
        button.style.borderRadius = '';
        button.style.boxShadow = '';
        button.style.whiteSpace = '';
        button.style.overflow = '';
        button.style.textOverflow = '';
        button.style.transition = '';
      });
      
      // Close share popup if open
      const sharePopup = $('sharePopup');
      sharePopup.classList.add('hidden');
      
      // Clear segments list and preview
      renderSegmentsList();
      renderAllPagesToHTML();
    }

    // Share functionality
    async function shareNatively() {
      // Check if we have a generated PDF to share
      if (!state.lastGeneratedPDF || !state.lastGeneratedPDF.blob) {
        // Generate PDF first if not available
        await downloadPDF();
        if (!state.lastGeneratedPDF || !state.lastGeneratedPDF.blob) {
          return; // PDF generation failed
        }
      }
      
      // Check if Web Share API is supported and can share files
      if (navigator.share && navigator.canShare) {
        const file = new File([state.lastGeneratedPDF.blob], state.lastGeneratedPDF.filename, {
          type: 'application/pdf'
        });
        
        const shareData = {
          title: 'Price List PDF',
          text: 'Check out this price list',
          files: [file]
        };
        
        // Check if the device can share this data
        if (navigator.canShare(shareData)) {
          try {
            await navigator.share(shareData);
            return; // Successfully shared
          } catch (error) {
            console.log('Native sharing cancelled or failed:', error);
            // Fall through to popup fallback
          }
        }
      }
      
      // Fallback to popup if Web Share API is not supported or sharing failed
      toggleSharePopup();
    }
    
    function toggleSharePopup() {
      const popup = $('sharePopup');
      const sharePdfBtn = $('sharePdfBtn');
      const isHidden = popup.classList.contains('hidden');
      
      popup.classList.toggle('hidden');
      sharePdfBtn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
    }

    async function downloadPNG() {
      // Validate that a preview exists
      const htmlPreview = document.getElementById('htmlPreview');
      if (!htmlPreview || !htmlPreview.innerHTML.trim() || htmlPreview.innerHTML.includes('No preview available')) {
        if (window.innerWidth <= 768) {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'fixed top-4 left-4 right-4 bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg z-50';
          errorMsg.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="text-lg">‚ö†Ô∏è</span>
              <span class="font-medium">Please generate a preview first</span>
            </div>
          `;
          document.body.appendChild(errorMsg);
          setTimeout(() => errorMsg.remove(), 3000);
        } else {
          alert('Please generate a preview first before downloading as PNG.');
        }
        return;
      }
      
      try {
        // Show loading state with mobile-friendly feedback
        const downloadBtn = $('downloadPNG');
        const originalText = downloadBtn.innerHTML;
        downloadBtn.innerHTML = '<span>‚è≥</span> <span class="hidden sm:inline">Generating PNG...</span><span class="sm:hidden">Generating...</span>';
        downloadBtn.disabled = true;
        
        // Use html2canvas to convert the preview to canvas
        const canvas = await html2canvas(htmlPreview, {
          scale: 2, // Higher quality
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff'
        });
        
        // Convert canvas to blob and download
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          
          // Generate filename using the same format as PDF
          const category = state.segments.length > 0 ? 
            state.segments[0].category.split(' ').map(word => 
              word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ') : 'General';
          const currency = state.currency || 'INR';
          const unit = state.kg ? 'Per Kg' : 'Per Piece';
          
          a.href = url;
          a.download = `${category} - ${currency} - ${unit}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          // Reset button state
          downloadBtn.innerHTML = originalText;
          downloadBtn.disabled = false;
          
          // Close the share popup
          $('sharePopup').classList.add('hidden');
          
          // Show enhanced success message with file opening option
          const filename = `${category} - ${currency} - ${unit}.png`;
          const successModal = document.createElement('div');
          successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
          successModal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-auto">
              <div class="text-center mb-4">
                <div class="text-3xl mb-2">‚úÖ</div>
                <h3 class="font-semibold text-lg">PNG Downloaded Successfully!</h3>
                <p class="text-gray-600 text-sm mt-1">Your image has been saved to your device</p>
              </div>
              <div class="space-y-3">
                <div class="bg-gray-50 rounded-lg p-3">
                  <div class="text-sm font-medium text-gray-700">File:</div>
                  <div class="text-sm text-gray-600 truncate">${filename}</div>
                </div>
                <button onclick="openDownloadedFile('${filename}', 'png')" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors touch-action-manipulation">
                  üñºÔ∏è Open PNG Image
                </button>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="w-full px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors touch-action-manipulation">
                  Close
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(successModal);
          
          // Auto-close after 10 seconds
          setTimeout(() => {
            if (successModal.parentElement) {
              successModal.remove();
            }
          }, 10000);
        }, 'image/png');
        
      } catch (error) {
        console.error('Error generating PNG:', error);
        
        // Mobile-friendly error message
        if (window.innerWidth <= 768) {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'fixed top-4 left-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50';
          errorMsg.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="text-lg">‚ùå</span>
              <div>
                <div class="font-medium">PNG Generation Failed</div>
                <div class="text-sm">Please try again</div>
              </div>
            </div>
          `;
          document.body.appendChild(errorMsg);
          setTimeout(() => errorMsg.remove(), 4000);
        } else {
          alert('Error generating PNG: ' + error.message);
        }
        
        // Reset button state
        const downloadBtn = $('downloadPNG');
        downloadBtn.innerHTML = '<span>üñºÔ∏è</span> Download as PNG';
        downloadBtn.disabled = false;
      }
    }

    // WhatsApp PDF sharing functionality

    




  </script>
      
      </div> <!-- End Price List Calculator Module -->
      
      <!-- Quote Maker Module -->
      <div id="quote-maker-module" class="module-content">
        <!-- Quote Details -->
        <section class="section indigo" id="quote-details">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold text-gray-800">Quote Details</h2>
            <span class="chip no-print" id="quote-chip">Draft</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div>
              <label class="block text-xs font-medium text-gray-700">Quote #</label>
              <input type="text" id="quote-number" placeholder="INV-YYYYMMDD-###" class="mt-1 w-full p-1 border rounded-lg" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">Date</label>
              <input type="date" id="quote-date" class="mt-1 w-full p-1 border rounded-lg" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">Client Name</label>
              <input type="text" id="client-name" class="mt-1 w-full p-1 border rounded-lg" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">Client Contact</label>
              <input type="text" id="client-contact" class="mt-1 w-full p-1 border rounded-lg" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">Salesman</label>
              <input type="text" id="salesman-name" class="mt-1 w-full p-1 border rounded-lg" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">Valid for (days)</label>
              <input type="number" id="valid-days" value="14" class="mt-1 w-full p-1 border rounded-lg" />
            </div>
            <div class="md:col-span-2">
              <label class="block text-xs font-medium text-gray-700">Brief Preview</label>
              <textarea id="brief-preview" class="mt-1 w-full p-1 border rounded-lg" rows="2" placeholder="e.g., Clip-on set, 18‚Äì22 inch mix, 200g total"></textarea>
            </div>
          </div>
        </section>

        <!-- Price List Selection -->
        <section class="section mint mb-4">
          <h2 class="text-lg font-semibold text-gray-800 mb-2">Price List Selection</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Select Price List</label>
              <select id="priceListSelector" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                <option value="">All Price Lists</option>
              </select>
            </div>
            <div class="flex items-center">
              <div id="price-list-status" class="text-sm text-gray-600">
                <span id="filtered-count">No price list selected</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Catalog -->
        <section class="section cyan">
          <h2 class="text-lg font-semibold text-gray-800 mb-2">Catalog</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <div>
              <label class="block text-xs font-medium text-gray-700">Category</label>
              <select id="new-item-category" class="mt-1 w-full p-1 border rounded-lg">
                <option value="">Select Category</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">Density</label>
              <select id="new-item-density" class="mt-1 w-full p-1 border rounded-lg" disabled>
                <option value="">Select Density</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">Product</label>
              <select id="new-item-product" class="mt-1 w-full p-1 border rounded-lg" disabled>
                <option value="">Select Product</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">Length</label>
              <select id="new-item-length" class="mt-1 w-full p-1 border rounded-lg">
                <option value="">Select Length</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">Quantity</label>
              <input type="number" id="new-item-quantity" value="1" min="1" class="mt-1 w-full p-1 border rounded-lg" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">Override Unit Price (in selected currency)</label>
              <input type="number" id="new-item-override-price" placeholder="Optional" class="mt-1 w-full p-1 border rounded-lg" />
            </div>
          </div>
          <div class="flex items-center gap-2 mt-2">
            <button id="add-item-btn" class="pressable px-3 py-1 bg-blue-600 text-white rounded-lg no-print">Add Item</button>
            <span class="help">Override converts back to INR using current FX.</span>
          </div>
        </section>

        <!-- Discount & Tax -->
        <section class="section rose">
          <h2 class="text-lg font-semibold text-gray-800 mb-2">Discount & Tax</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div>
              <label class="block text-xs font-medium text-gray-700">Discount</label>
              <div class="flex gap-2">
                <input type="number" id="discount-percent" placeholder="Percent (%)" class="mt-1 w-full p-1 border rounded-lg" />
                <input type="number" id="discount-amount" placeholder="Amount" class="mt-1 w-full p-1 border rounded-lg" />
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">Tax</label>
              <div class="flex gap-2">
                <input type="number" id="tax-percent" placeholder="Percent (%)" class="mt-1 w-full p-1 border rounded-lg" />
                <input type="number" id="tax-amount" placeholder="Amount" class="mt-1 w-full p-1 border rounded-lg" />
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">Shipping</label>
              <input type="number" id="shipping-cost" placeholder="Shipping Cost" class="mt-1 w-full p-1 border rounded-lg" />
            </div>
          </div>
        </section>

        <!-- Items -->
        <section class="section slate" id="items-section">
          <h2 class="text-lg font-semibold text-gray-800 mb-2">Items</h2>
          <div class="overflow-x-auto">
            <table id="items-table" class="table w-full border-collapse zebra">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Product</th>
                  <th>Variant</th>
                  <th>Length</th>
                  <th>Weight</th>
                  <th>Qty</th>
                  <th>Unit Price</th>
                  <th>Line Total</th>
                  <th class="no-print">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr><td colspan="7" class="font-semibold">Grand Total Weight</td><td id="grand-weight">‚Äî</td><td class="no-print"></td></tr>
                <tr><td colspan="7" class="font-semibold">Subtotal</td><td id="subtotal">‚Äî</td><td class="no-print"></td></tr>
                <tr><td colspan="7" class="font-semibold">Discount</td><td id="discount">‚Äî</td><td class="no-print"></td></tr>
                <tr><td colspan="7" class="font-semibold">Tax</td><td id="tax">‚Äî</td><td class="no-print"></td></tr>
                <tr><td colspan="7" class="font-semibold">Shipping</td><td id="shipping-total">‚Äî</td><td class="no-print"></td></tr>
                <tr><td colspan="7" class="font-semibold">Grand Total</td><td id="grand-total-table">‚Äî</td><td class="no-print"></td></tr>
              </tfoot>
            </table>
          </div>
          <div class="mt-2">
            <label class="block text-xs font-medium text-gray-700">Notes / Terms</label>
            <textarea id="notes-terms" class="mt-1 w-full p-1 border rounded-lg" rows="3" placeholder="Payment terms, lead time, shipping details, etc."></textarea>
          </div>
        </section>

        <div id="grand-total" class="text-xl font-bold text-right text-gray-800 mt-2">Grand Total: ‚Äî</div>

        <!-- Recall & Actions -->
        <section class="section indigo no-print">
          <h2 class="text-lg font-semibold text-gray-800 mb-2">History & Recall</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <div class="md:col-span-3">
              <label class="block text-xs font-medium text-gray-700 mb-1">Quote</label>
              <select id="recall-quote" class="w-full p-1 border rounded-lg">
                <option value="">Select a quote</option>
              </select>
              <div class="text-xs text-gray-600 mt-1">Selected is shown with ‚òë inside the option.</div>
            </div>
          </div>
          <div class="flex gap-2 mt-2">
            <button id="recall-btn" class="pressable bg-gray-800 text-white rounded-lg px-3 py-1">Recall Selected</button>
            <button id="save-quote-btn" class="pressable bg-blue-600 text-white rounded-lg px-3 py-1">Save Quote</button>
            <button id="q2o-btn" class="pressable bg-green-600 text-white rounded-lg px-3 py-1">Convert to Order</button>
          </div>
          <pre id="debug-log" class="mono text-xs bg-gray-100 p-2 rounded mt-2 overflow-x-auto"></pre>
        </section>
      </div>
      
      <!-- Product Catalog Module -->
      <div id="product-catalog-module" class="module-content">
        <!-- Enhanced Catalog Header -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 mb-6 text-white">
          <h2 class="text-2xl font-bold mb-2">Product Catalog</h2>
          <p class="text-blue-100">Discover our premium hair extension collection</p>
        </div>
        
        <!-- Modern Catalog Filters -->
        <section class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 mb-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
              <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
              </svg>
              Filters
            </h3>
            <div class="text-sm text-gray-500">
              <span id="catalog-results-count">Loading products...</span>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- Category Filter -->
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700 flex items-center">
                <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                Category
              </label>
              <select id="catalog-category" class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition-all duration-200 bg-gray-50 hover:bg-white">
                <option value="">All Categories</option>
              </select>
            </div>
            
            <!-- Search Filter -->
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700 flex items-center">
                <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Search
              </label>
              <div class="relative">
                <input type="text" id="catalog-search" placeholder="Search products by name..." class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 pl-10 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition-all duration-200 bg-gray-50 hover:bg-white" />
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </div>
            </div>
          </div>
          
          <div class="flex flex-wrap gap-3">
            <button id="catalog-filter-btn" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium px-6 py-3 rounded-lg transition-all duration-200 flex items-center shadow-md hover:shadow-lg">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
              </svg>
              Apply Filters
            </button>
            <button id="catalog-clear-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium px-6 py-3 rounded-lg transition-all duration-200 flex items-center border border-gray-300">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              Clear All
            </button>
          </div>
        </section>

        <!-- Enhanced Product Grid -->
        <section class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
              <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
              </svg>
              Our Products
            </h3>
            <div class="flex items-center space-x-4">
              <div class="text-sm text-gray-500 bg-gray-50 px-3 py-1 rounded-full">
                <span id="catalog-results-count-display">Loading...</span>
              </div>
              <div class="flex items-center space-x-2">
                <button id="grid-view-btn" class="p-2 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200 transition-colors" title="Grid View">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                  </svg>
                </button>
                <button id="list-view-btn" class="p-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors" title="List View">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Loading State -->
          <div id="catalog-loading" class="hidden flex items-center justify-center py-12">
            <div class="text-center">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p class="text-gray-600">Loading products...</p>
            </div>
          </div>
          
          <!-- Empty State -->
          <div id="catalog-empty" class="hidden text-center py-12">
            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
            <p class="text-gray-500 mb-4">Try adjusting your search criteria or browse all categories.</p>
            <button onclick="clearCatalogFilters()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
              View All Products
            </button>
          </div>
          
          <!-- Product Cards Container -->
          <div id="catalog-products-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4 sm:gap-6">
            <!-- Products will be dynamically loaded here -->
          </div>
          
          <!-- Pagination -->
          <div id="catalog-pagination" class="flex justify-center mt-6">
            <!-- Pagination controls will be added here -->
          </div>
        </section>
      </div>
      
      <!-- Admin Panel Module -->
      <div id="admin-panel-module" class="module-content">
        <div class="bg-white rounded-xl shadow-soft p-4 sm:p-6 mobile-padding">
          <h2 class="text-xl font-semibold mb-4 text-gray-800">Admin Panel</h2>
          
          <!-- Admin Functions Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <!-- Excel Data Management -->
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-4 hover:shadow-md transition-all duration-200">
              <div class="text-3xl mb-3">üìä</div>
              <h3 class="text-lg font-semibold text-gray-800 mb-2">Data Management</h3>
              <p class="text-sm text-gray-600 mb-4">Load and manage Excel data, update product catalogs</p>
              <button onclick="openAdminPanel()" class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all duration-200 hover:transform hover:scale-105">
                Open Data Manager
              </button>
            </div>
            
            <!-- System Status -->
            <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-lg p-4 hover:shadow-md transition-all duration-200">
              <div class="text-3xl mb-3">üìà</div>
              <h3 class="text-lg font-semibold text-gray-800 mb-2">System Status</h3>
              <p class="text-sm text-gray-600 mb-4">Monitor database status and application health</p>
              <button onclick="openAdminPanel()" class="w-full px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-all duration-200 hover:transform hover:scale-105">
                View Status
              </button>
            </div>
            
            <!-- Configuration -->
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-lg p-4 hover:shadow-md transition-all duration-200">
              <div class="text-3xl mb-3">‚öôÔ∏è</div>
              <h3 class="text-lg font-semibold text-gray-800 mb-2">Configuration</h3>
              <p class="text-sm text-gray-600 mb-4">Application settings and system configuration</p>
              <button onclick="openAdminPanel()" class="w-full px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium transition-all duration-200 hover:transform hover:scale-105">
                Open Settings
              </button>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Quick Actions</h3>
            <div class="flex flex-wrap gap-2">
              <button onclick="openAdminPanel()" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium transition-all duration-200">
                üìÅ Load Excel Data
              </button>
              <button onclick="updateAdminStatus()" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium transition-all duration-200">
                üîÑ Refresh Status
              </button>
              <button onclick="openAdminPanel()" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium transition-all duration-200">
                üìä View Database
              </button>
            </div>
          </div>
        </div>
      </div>
      
    </div> <!-- End Module Container -->

  <!-- Admin Panel Modal -->
  <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300">
    <div class="bg-white rounded-lg p-4 sm:p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95 opacity-0">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Admin Panel</h3>
        <button id="closeAdmin" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 p-1 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="space-y-4">
        <div class="border rounded-lg p-4">
          <h4 class="font-medium text-gray-700 mb-2">Excel Data Loader</h4>
          <p class="text-sm text-gray-600 mb-3">Load and embed Excel data directly into the application</p>
          <button id="convertExcel" class="w-full px-4 py-3 sm:py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all duration-200 hover:transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-300 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed min-h-[44px] touch-manipulation">
            <span class="convert-text">üìÅ Load Excel Data</span>
            <span class="convert-loading hidden">‚è≥ Loading...</span>
          </button>
        </div>
        

        
        <div class="border rounded-lg p-4">
          <h4 class="font-medium text-gray-700 mb-2">Database Status</h4>
          <div id="dbStatus" class="text-sm text-gray-600">
            <div>Current records: <span id="recordCount">Loading...</span></div>
            <div>Last updated: <span id="lastUpdated">Loading...</span></div>
          </div>
        </div>
        
        <div id="adminMessages" class="hidden">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <div id="adminMessageText" class="text-sm text-blue-800"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Admin Panel Functionality
    let availablePriceLists = new Set();
    
    // Initialize admin panel
    function initAdminPanel() {
      const adminModal = document.getElementById('adminModal');
      const closeAdmin = document.getElementById('closeAdmin');
      const convertExcel = document.getElementById('convertExcel');
      
      // Function to open admin panel with animation
      window.openAdminPanel = () => {
        adminModal.classList.remove('hidden');
        // Trigger animation
        setTimeout(() => {
          const modalContent = adminModal.querySelector('div > div');
          modalContent.classList.remove('scale-95', 'opacity-0');
          modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        updateAdminStatus();
      };
      
      // Close admin panel with animation
      closeAdmin.addEventListener('click', () => {
        const modalContent = adminModal.querySelector('div > div');
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
          adminModal.classList.add('hidden');
        }, 300);
      });
      
      // Close on backdrop click with animation
      adminModal.addEventListener('click', (e) => {
        if (e.target === adminModal) {
          const modalContent = adminModal.querySelector('div > div');
          modalContent.classList.remove('scale-100', 'opacity-100');
          modalContent.classList.add('scale-95', 'opacity-0');
          setTimeout(() => {
            adminModal.classList.add('hidden');
          }, 300);
        }
      });
      
      // Convert Excel functionality
      convertExcel.addEventListener('click', handleExcelConversion);
      
      // Remove INR25 functionality

    }
    
    // Update admin status display with validation
    function updateAdminStatus() {
      const recordCount = document.getElementById('recordCount');
      const lastUpdated = document.getElementById('lastUpdated');
      
      // Validate current data
      const validation = validateProductData(state.allProducts);
      
      recordCount.innerHTML = `
        <div>${validation.stats.totalProducts} total</div>
        <div class="text-xs ${validation.isValid ? 'text-green-600' : 'text-red-600'}">
          ${validation.stats.validProducts} valid
          ${validation.errors.length > 0 ? ` ‚Ä¢ ${validation.errors.length} errors` : ''}
          ${validation.warnings.length > 0 ? ` ‚Ä¢ ${validation.warnings.length} warnings` : ''}
        </div>
        <div class="text-xs text-gray-500">
          ${validation.stats.categories.size} categories ‚Ä¢ ${validation.stats.priceLists.size} price lists
        </div>
      `;
      
      lastUpdated.textContent = new Date().toLocaleString();
      
      // Show validation summary if there are issues
      if (!validation.isValid || validation.warnings.length > 0) {
        const issues = [...validation.errors, ...validation.warnings.slice(0, 3)];
        if (validation.warnings.length > 3) {
          issues.push(`... and ${validation.warnings.length - 3} more warnings`);
        }
        showAdminMessage(`Data validation: ${issues.join('; ')}`, validation.isValid ? 'warning' : 'error');
      }
    }
    
    // Enhanced Excel to JSON conversion with better error handling
    async function handleExcelConversion() {
      const convertBtn = document.getElementById('convertExcel');
      const originalText = convertBtn.innerHTML;
      
      try {
        // Validate button exists
        if (!convertBtn) {
          throw new Error('Convert button not found');
        }
        
        convertBtn.innerHTML = '‚è≥ Converting...';
        convertBtn.disabled = true;
        
        showAdminMessage('Starting Excel conversion process...', 'info');
        
        // Create file input for Excel file selection
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.xlsx,.xls';
        fileInput.multiple = true;
        
        // Promise to handle file selection
        const fileSelectionPromise = new Promise((resolve, reject) => {
          fileInput.onchange = (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) {
              reject(new Error('No files selected'));
              return;
            }
            resolve(files);
          };
          
          fileInput.oncancel = () => {
            reject(new Error('File selection cancelled'));
          };
        });
        
        // Trigger file selection
        fileInput.click();
        
        // Wait for file selection
        const selectedFiles = await fileSelectionPromise;
        
        showAdminMessage(`Processing ${selectedFiles.length} Excel file(s)...`, 'info');
        
        let allProcessedData = [];
        let processedPriceLists = new Set();
        
        // Process each selected Excel file with enhanced validation
        for (const file of selectedFiles) {
          try {
            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
              throw new Error(`File too large: ${(file.size / 1024 / 1024).toFixed(1)}MB (max 10MB)`);
            }
            
            // Validate file type
            const validTypes = ['.xlsx', '.xls'];
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            if (!validTypes.includes(fileExtension)) {
              throw new Error(`Invalid file type: ${fileExtension}. Only .xlsx and .xls files are supported.`);
            }
            
            showAdminMessage(`Processing ${file.name} (${(file.size / 1024).toFixed(1)}KB)...`, 'info');
            
            const data = await parseExcelFile(file);
            
            // Validate parsed data
            if (!data || !data.products || !Array.isArray(data.products)) {
              throw new Error('Invalid data structure returned from Excel parser');
            }
            
            if (data.products.length === 0) {
              showAdminMessage(`‚ö†Ô∏è No valid products found in ${file.name}`, 'warning');
              continue;
            }
            
            // Validate each product before adding
            const validProducts = data.products.filter(product => {
              return product && typeof product === 'object' && 
                     product.Category && product.Product && product.Rate;
            });
            
            if (validProducts.length !== data.products.length) {
              showAdminMessage(`‚ö†Ô∏è ${file.name}: ${data.products.length - validProducts.length} invalid products filtered out`, 'warning');
            }
            
            allProcessedData = allProcessedData.concat(validProducts);
            
            // Extract price list names from the PriceList field in products
            validProducts.forEach(product => {
              if (product.PriceList && product.PriceList.trim()) {
                processedPriceLists.add(product.PriceList.trim());
              }
            });
            
            showAdminMessage(`‚úÖ Processed ${file.name}: ${validProducts.length} valid products`, 'info');
            
          } catch (fileError) {
            console.error(`Error processing ${file.name}:`, fileError);
            showAdminMessage(`‚ùå Error processing ${file.name}: ${fileError.message}`, 'error');
            // Continue processing other files even if one fails
          }
        }
        
        if (allProcessedData.length > 0) {
          // Validate processed data before proceeding
          const validation = validateProductData(allProcessedData);
          
          if (!validation.isValid) {
            showAdminMessage(`‚ùå Data validation failed: ${validation.errors.slice(0, 3).join('; ')}`, 'error');
            if (validation.errors.length > 3) {
              console.error('Additional validation errors:', validation.errors.slice(3));
            }
            return;
          }
          
          if (validation.warnings.length > 0) {
            showAdminMessage(`‚ö†Ô∏è Data warnings: ${validation.warnings.slice(0, 2).join('; ')}`, 'warning');
            if (validation.warnings.length > 2) {
              console.warn('Additional validation warnings:', validation.warnings.slice(2));
            }
          }
          
          // Generate and save JSON with duplicate removal
          const cleanedData = await generateAndSaveJSON(allProcessedData, Array.from(processedPriceLists));
          
          // Validate cleaned data
          if (!cleanedData || cleanedData.length === 0) {
            throw new Error('No data remained after cleaning and validation');
          }
          
          // Update the application data with cleaned data
          state.allProducts = cleanedData;
          state.filteredProducts = [...cleanedData];
          productData = cleanedData;
          
          // Update embedded data in HTML with cleaned data
          updateEmbeddedData(cleanedData);
          
          // Update price lists
          processedPriceLists.forEach(pl => availablePriceLists.add(pl));
          updatePriceListDropdown();
          
          // Refresh the UI
          populateCategories();
          
          const successMessage = `‚úÖ Conversion completed! Processed ${cleanedData.length} unique records from ${selectedFiles.length} file(s). Added ${processedPriceLists.size} new price list(s). JSON generated and embedded in HTML.`;
          showAdminMessage(successMessage, 'success');
          updateAdminStatus();
          
        } else {
          showAdminMessage('‚ùå No valid data found in the selected files. Please check file format and content.', 'error');
        }
        
      } catch (error) {
        console.error('Excel conversion error:', error);
        
        // Categorize different types of errors
        if (error.message === 'File selection cancelled' || error.message === 'No files selected') {
          showAdminMessage('File selection cancelled.', 'info');
        } else if (error.name === 'TypeError' || error.message.includes('Cannot read property')) {
          showAdminMessage(`‚ùå Data structure error: ${error.message}. Please check file format.`, 'error');
        } else if (error.message.includes('File too large') || error.message.includes('Invalid file type')) {
          showAdminMessage(`‚ùå File validation error: ${error.message}`, 'error');
        } else if (error.message.includes('Failed to parse')) {
          showAdminMessage(`‚ùå Excel parsing error: ${error.message}. Please ensure the file is not corrupted.`, 'error');
        } else {
          showAdminMessage(`‚ùå Unexpected error during conversion: ${error.message}`, 'error');
        }
        
        // Log full error details for debugging
        console.error('Full error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        
      } finally {
        // Ensure button is always restored
        try {
          if (convertBtn) {
            convertBtn.innerHTML = originalText;
            convertBtn.disabled = false;
          }
        } catch (restoreError) {
          console.error('Error restoring button state:', restoreError);
        }
      }
    }
    
    // Parse Excel file using SheetJS
    async function parseExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // Get the first worksheet
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // Convert to JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (jsonData.length < 2) {
              reject(new Error('Excel file must contain at least a header row and one data row'));
              return;
            }
            
            // Parse the data
            const headers = jsonData[0];
            const products = [
  {
    "Length": 4,
    "Category": "DIY",
    "Product": "Test",
    "Density": "Double Drawn"
  }
];
            
            // Map common header variations to standard field names
            const headerMap = {
              'category': ['category', 'catagory', 'cat', 'type'],
              'product': ['product', 'prod', 'name', 'product name'],
              'density': ['density', 'dens', 'thickness'],
              'colors': ['colors', 'color', 'colour', 'colours'],
              'length': ['length', 'len', 'size'],
              'rate': ['rate', 'price', 'cost', 'amount'],
              'canBeSoldInKG': ['can be sold in kg?', 'kg', 'kilogram', 'can be sold in kg'],
              'standardWeight': ['standard weight', 'weight', 'std weight', 'wt'],
              'priceListName': ['price list name', 'pricelist name', 'pricelistname', 'price list', 'pricelist']
            };
            
            // Find column indices for each field
            const columnIndices = {};
            Object.keys(headerMap).forEach(field => {
              const variations = headerMap[field];
              for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || '').toString().toLowerCase().trim();
                if (variations.includes(header)) {
                  columnIndices[field] = i;
                  break;
                }
              }
            });
            
            // Process data rows
            for (let i = 1; i < jsonData.length; i++) {
              const row = jsonData[i];
              if (!row || row.length === 0) continue;
              
              const product = {
                Category: row[columnIndices.category] || '',
                Product: row[columnIndices.product] || '',
                Density: row[columnIndices.density] || '',
                Colors: row[columnIndices.colors] || '',
                Length: row[columnIndices.length] || '',
                Rate: row[columnIndices.rate] || '',
                'Can Be Sold in KG?': row[columnIndices.canBeSoldInKG] || '',
                'Standard Weight': row[columnIndices.standardWeight] || '',
                PriceList: row[columnIndices.priceListName] || ''
              };
              
              // Only add products with required fields
              if (product.Category && product.Product && product.Rate) {
                products.push(product);
              }
            }
            
            resolve({
              products: products,
              totalRows: jsonData.length - 1,
              headers: headers
            });
            
          } catch (parseError) {
            reject(new Error(`Failed to parse Excel file: ${parseError.message}`));
          }
        };
        
        reader.onerror = () => {
          reject(new Error('Failed to read the Excel file'));
        };
        
        reader.readAsArrayBuffer(file);
      });
    }
    
    // Enhanced admin message system with error logging
    function showAdminMessage(message, type = 'info', persistent = false) {
      try {
        const messagesDiv = document.getElementById('adminMessages');
        const messageText = document.getElementById('adminMessageText');
        
        if (!messagesDiv || !messageText) {
          console.error('Admin message elements not found');
          // Fallback to console and alert
          console.log(`[${type.toUpperCase()}] ${message}`);
          if (type === 'error') {
            alert(`Error: ${message}`);
          }
          return;
        }
        
        messagesDiv.classList.remove('hidden');
        messageText.textContent = message;
        
        // Log to console for debugging
        console.log(`[ADMIN ${type.toUpperCase()}] ${message}`);
        
        // Update styling based on type
        messagesDiv.className = 'border rounded-lg p-3';
        if (type === 'success') {
          messagesDiv.className += ' bg-green-50 border-green-200';
          messageText.className = 'text-sm text-green-800';
        } else if (type === 'error') {
          messagesDiv.className += ' bg-red-50 border-red-200';
          messageText.className = 'text-sm text-red-800';
          // Log errors to console for debugging
          console.error('Admin Error:', message);
        } else if (type === 'warning') {
          messagesDiv.className += ' bg-yellow-50 border-yellow-200';
          messageText.className = 'text-sm text-yellow-800';
          console.warn('Admin Warning:', message);
        } else {
          messagesDiv.className += ' bg-blue-50 border-blue-200';
          messageText.className = 'text-sm text-blue-800';
        }
        
        // Clear any existing timeout
        if (window.adminMessageTimeout) {
          clearTimeout(window.adminMessageTimeout);
        }
        
        // Auto-hide after specified time (longer for errors, persistent for critical messages)
        if (!persistent) {
          const hideDelay = type === 'error' ? 8000 : type === 'warning' ? 6000 : 5000;
          window.adminMessageTimeout = setTimeout(() => {
            if (messagesDiv) {
              messagesDiv.classList.add('hidden');
            }
          }, hideDelay);
        }
        
      } catch (error) {
        console.error('Error showing admin message:', error);
        // Ultimate fallback
        alert(`${type.toUpperCase()}: ${message}`);
      }
    }
    
    // Enhanced INR25 product removal with validation and loading states

    
    // Enhanced data integrity validation
    function validateProductData(products) {
      const validationResults = {
        isValid: true,
        errors: [],
        warnings: [],
        stats: {
          totalProducts: products.length,
          validProducts: 0,
          categories: new Set(),
          priceLists: new Set()
        }
      };
      
      if (!Array.isArray(products)) {
        validationResults.errors.push('Product data is not an array');
        validationResults.isValid = false;
        return validationResults;
      }
      
      if (products.length === 0) {
        validationResults.warnings.push('No products found in dataset');
        return validationResults;
      }
      
      const requiredFields = ['Category', 'Product', 'Rate'];
      const numericFields = ['Rate', 'Length'];
      const validCategories = new Set();
      const validPriceLists = new Set();
      
      products.forEach((product, index) => {
        let isProductValid = true;
        
        // Check if product is an object
        if (!product || typeof product !== 'object') {
          validationResults.errors.push(`Row ${index + 1}: Invalid product data structure`);
          return;
        }
        
        // Check required fields
        requiredFields.forEach(field => {
          if (!product[field] || product[field].toString().trim() === '') {
            validationResults.errors.push(`Row ${index + 1}: Missing required field '${field}'`);
            isProductValid = false;
          }
        });
        
        // Validate numeric fields
        numericFields.forEach(field => {
          if (product[field] && product[field] !== '') {
            const numValue = parseFloat(product[field]);
            if (isNaN(numValue)) {
              validationResults.warnings.push(`Row ${index + 1}: Field '${field}' value '${product[field]}' is not a valid number`);
            } else if (field === 'Rate' && numValue <= 0) {
              validationResults.warnings.push(`Row ${index + 1}: Rate must be greater than 0, found: ${numValue}`);
            } else if (field === 'Length' && numValue <= 0) {
              validationResults.warnings.push(`Row ${index + 1}: Length must be greater than 0, found: ${numValue}`);
            }
          }
        });
        
        // Validate category format
        if (product.Category) {
          const category = product.Category.toString().trim();
          if (category.length > 50) {
            validationResults.warnings.push(`Row ${index + 1}: Category name too long (${category.length} chars)`);
          }
          validCategories.add(category);
          validationResults.stats.categories.add(category);
        }
        
        // Validate product name
        if (product.Product) {
          const productName = product.Product.toString().trim();
          if (productName.length > 100) {
            validationResults.warnings.push(`Row ${index + 1}: Product name too long (${productName.length} chars)`);
          }
        }
        
        // Validate price list
        if (product.PriceList) {
          const priceList = product.PriceList.toString().trim();
          if (priceList.length > 20) {
            validationResults.warnings.push(`Row ${index + 1}: Price list name too long (${priceList.length} chars)`);
          }
          validPriceLists.add(priceList);
          validationResults.stats.priceLists.add(priceList);
        }
        
        // Validate KG field
        if (product['Can Be Sold in KG?']) {
          const kgValue = product['Can Be Sold in KG?'].toString().toLowerCase();
          if (!['y', 'n', 'yes', 'no', 'true', 'false'].includes(kgValue)) {
            validationResults.warnings.push(`Row ${index + 1}: Invalid 'Can Be Sold in KG?' value: ${product['Can Be Sold in KG?']}`);
          }
        }
        
        if (isProductValid) {
          validationResults.stats.validProducts++;
        }
      });
      
      // Check for duplicate products with enhanced key
      const productKeys = new Set();
      const duplicateGroups = new Map();
      
      products.forEach((product, index) => {
        const key = `${product.Category || ''}-${product.Product || ''}-${product.Density || ''}-${product.Colors || ''}-${product.Length || ''}-${product.PriceList || ''}`;
        
        if (productKeys.has(key)) {
          if (!duplicateGroups.has(key)) {
            duplicateGroups.set(key, []);
          }
          duplicateGroups.get(key).push(index + 1);
        }
        productKeys.add(key);
      });
      
      // Report duplicates
      duplicateGroups.forEach((rows, key) => {
        validationResults.warnings.push(`Duplicate products found in rows: ${rows.join(', ')} (${key.split('-').slice(0, 3).join(' - ')})`);
      });
      
      // Additional validation checks
      if (validCategories.size === 0) {
        validationResults.errors.push('No valid categories found');
      }
      
      if (validCategories.size > 50) {
        validationResults.warnings.push(`Large number of categories detected: ${validCategories.size}`);
      }
      
      if (validPriceLists.size > 20) {
        validationResults.warnings.push(`Large number of price lists detected: ${validPriceLists.size}`);
      }
      
      validationResults.isValid = validationResults.errors.length === 0;
      return validationResults;
    }
    
    // Initialize price list dropdown
    function initPriceListDropdown() {
      console.log('Initializing price list dropdown...');
      console.log('state.allProducts length:', state.allProducts.length);
      
      // Clear existing price lists to ensure fresh data
      availablePriceLists.clear();
      
      // Extract unique price lists from existing data
      state.allProducts.forEach(product => {
        if (product.PriceList) {
          availablePriceLists.add(product.PriceList);
        }
      });
      
      console.log('Available price lists:', Array.from(availablePriceLists));
      
      updatePriceListDropdown();
      
      // Ensure filteredProducts shows all products by default
      if (state.filteredProducts.length === 0 && state.allProducts.length > 0) {
        state.filteredProducts = [...state.allProducts];
        console.log('Set filteredProducts to show all products by default');
      }
      
      // Add event listener for price list selection
      const priceListSelector = document.getElementById('priceListSelector');
      if (priceListSelector) {
        priceListSelector.addEventListener('change', handlePriceListChange);
      } else {
        console.error('Price list selector element not found!');
      }
    }
    
    // Update price list dropdown options
    function updatePriceListDropdown() {
      const priceListSelector = document.getElementById('priceListSelector');
      
      // Clear existing options except "All Price Lists"
      priceListSelector.innerHTML = '<option value="">All Price Lists</option>';
      
      // Add price list options
      Array.from(availablePriceLists).sort().forEach(priceList => {
        const option = document.createElement('option');
        option.value = priceList;
        option.textContent = priceList;
        priceListSelector.appendChild(option);
      });
    }
    
    // Handle price list selection change
    function handlePriceListChange() {
      const selectedPriceList = document.getElementById('priceListSelector').value;
      
      if (selectedPriceList) {
        // Filter products by selected price list
        state.filteredProducts = state.allProducts.filter(product => 
          product.PriceList === selectedPriceList
        );
        showAdminMessage(`Filtered to ${state.filteredProducts.length} products from price list: ${selectedPriceList}`, 'info');
        
        // Auto-select USD currency for USA25 price list
        if (selectedPriceList === 'USA25') {
          const currencySelect = document.getElementById('currency');
          currencySelect.value = 'USD';
          state.currency = 'USD';
          renderAllPagesToHTML(); // Update preview to reflect currency change
        }
      } else {
        // Show all products
        state.filteredProducts = [...state.allProducts];
      }
      
      // Update categories and products based on filtered data
      populateCategories();
      
      // Clear current selections
      state.category = '';
      $('category').value = '';
      clearProducts();
      renderAllPagesToHTML();
      
      // Notify other modules about price list change
      notifyPriceListChange();
    }
    
    // --------- Real-time Synchronization Functions ---------
    
    // Notify other modules when price lists are updated
    async function notifyPriceListChange() {
      try {
        const currentPriceLists = Array.from(availablePriceLists);
        const response = await fetch('/api/sync-price-lists', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'price_list_updated',
            priceLists: currentPriceLists,
            sourceModule: 'priceListGenerator'
          })
        });
        
        if (response.ok) {
          console.log('Price list change notification sent successfully');
        }
      } catch (error) {
        console.error('Failed to notify price list change:', error);
      }
    }
    
    // Check for updates from other modules
    async function checkForSyncUpdates() {
      try {
        const response = await fetch('/api/sync-status');
        const data = await response.json();
        
        if (data.success && data.syncData) {
          const lastUpdate = localStorage.getItem('priceListGenerator_lastSync') || '0';
          
          if (data.syncData.timestamp > parseInt(lastUpdate)) {
            // Update available price lists from sync data
            const syncedPriceLists = data.syncData.priceLists || [];
            
            // Check if price lists have changed
            const currentPriceLists = Array.from(availablePriceLists).sort();
            const newPriceLists = syncedPriceLists.sort();
            
            if (JSON.stringify(currentPriceLists) !== JSON.stringify(newPriceLists)) {
              console.log('Price lists updated from other modules:', newPriceLists);
              
              // Update local price lists
              availablePriceLists.clear();
              newPriceLists.forEach(pl => availablePriceLists.add(pl));
              
              // Update dropdown
              updatePriceListDropdown();
              
              showAdminMessage('Price lists synchronized from other modules', 'info');
            }
            
            // Update last sync timestamp
            localStorage.setItem('priceListGenerator_lastSync', data.syncData.timestamp.toString());
          }
        }
      } catch (error) {
        console.error('Failed to check for sync updates:', error);
      }
    }
    
    // Initialize real-time synchronization
    function initializeRealTimeSync() {
      // Check for updates every 5 seconds
      setInterval(checkForSyncUpdates, 5000);
      
      // Initial check
      checkForSyncUpdates();
      
      console.log('Real-time synchronization initialized for Price List Generator');
    }
    

    
    // Generate and save JSON file
    async function generateAndSaveJSON(productData, priceLists) {
      try {
        // Remove duplicates based on a combination of key fields
        const uniqueProducts = [];
        const seen = new Set();
        
        productData.forEach(product => {
          // Create a unique key based on important fields
          const key = `${product.Category || ''}_${product.Product || ''}_${product.Density || ''}_${product.Length || ''}_${product.Colors || ''}_${product.PriceList || ''}`;
          
          if (!seen.has(key)) {
            seen.add(key);
            uniqueProducts.push(product);
          }
        });
        
        // Use unique products for further processing
        const finalProductData = uniqueProducts.length > 0 ? uniqueProducts : productData;
        
        const jsonData = {
          metadata: {
            generatedAt: new Date().toISOString(),
            totalRecords: finalProductData.length,
            uniqueRecords: uniqueProducts.length,
            duplicatesRemoved: productData.length - uniqueProducts.length,
            priceLists: priceLists,
            version: '1.0'
          },
          products: finalProductData
        };
        
        // Log the data processing results
        console.log('Data processed:', {
          totalRecords: finalProductData.length,
          uniqueRecords: uniqueProducts.length,
          duplicatesRemoved: productData.length - uniqueProducts.length,
          priceLists: priceLists
        });
        
        showAdminMessage(`‚úÖ Data processed: ${finalProductData.length} unique records (${productData.length - uniqueProducts.length} duplicates removed)`, 'success');
        
        return finalProductData; // Return the cleaned data
        
      } catch (error) {
        console.error('Error generating JSON:', error);
        showAdminMessage(`‚ùå Error generating JSON: ${error.message}`, 'error');
        throw error;
      }
    }
    
    // Update embedded data in HTML and permanently save to file
    async function updateEmbeddedData(newProductData) {
      try {
        // Clear existing application state
        state.allProducts = [];
        state.filteredProducts = [];
        state.category = '';
        state.selProducts = [];
        state.selDensities = [];
        state.selColors = [];
        
        // Clear localStorage
        localStorage.removeItem('productData');
        localStorage.removeItem('productDataTimestamp');
        
        // Update the global productData variable
        window.productData = newProductData;
        
        // Find the EMBEDDED_DATA script element
        let embeddedElement = document.getElementById('EMBEDDED_DATA');
        
        if (embeddedElement) {
          // Remove existing embedded data
          embeddedElement.remove();
        }
        
        // Create new script element with updated data
        const newScript = document.createElement('script');
        newScript.id = 'EMBEDDED_DATA';
        newScript.type = 'application/json';
        newScript.textContent = JSON.stringify(newProductData);
        
        // Insert the new script element before the main script tag
        const mainScript = document.querySelector('script:not([id="EMBEDDED_DATA"])');
        if (mainScript) {
          mainScript.parentNode.insertBefore(newScript, mainScript);
        } else {
          // Fallback: append to head
          document.head.appendChild(newScript);
        }
        
        // Note: JSON data is now embedded in the page and stored in localStorage
        console.log('Product data successfully embedded and ready for use');
        
        // Update application state with new data
        state.allProducts = [...newProductData];
        state.filteredProducts = [...newProductData];
        
        // Store in localStorage for persistence
        localStorage.setItem('productData', JSON.stringify(newProductData));
        localStorage.setItem('productDataTimestamp', new Date().toISOString());
        
        // Refresh UI components
        initPriceListDropdown();
        populateCategories();
        clearProducts();
        renderAllPagesToHTML();
        
        showAdminMessage(`‚úÖ Data successfully embedded and saved to HTML file! Loaded ${newProductData.length} products with fresh state.`, 'success');
        
      } catch (error) {
        console.error('Error updating embedded data:', error);
        showAdminMessage(`‚ùå Error updating embedded data: ${error.message}`, 'error');
      }
    }
    
    
    // Load data from localStorage on page load
    function loadStoredData() {
      try {
        const storedData = localStorage.getItem('productData');
        const timestamp = localStorage.getItem('productDataTimestamp');
        
        if (storedData && timestamp) {
          const parsedData = JSON.parse(storedData);
          if (parsedData && parsedData.length > 0) {
            // Update application data
            state.allProducts = parsedData;
            state.filteredProducts = [...parsedData];
            window.productData = parsedData;
            
            console.log(`Loaded ${parsedData.length} products from localStorage (updated: ${timestamp})`);
            
            // Debug: Check first product structure
            if (parsedData[0]) {
              console.log('First product structure:', Object.keys(parsedData[0]));
              console.log('First product PriceList field:', parsedData[0].PriceList);
              console.log('First product Price List field:', parsedData[0]['Price List']);
            }
            
            return true;
          }
        }
      } catch (error) {
        console.error('Error loading stored data:', error);
      }
      return false;
    }
    
    // Initialize admin functionality when page loads
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM Content Loaded - starting initialization...');
      initAdminPanel();
      
      // Load data from embedded script or localStorage
      await init();
      
      console.log('Final state.allProducts length:', state.allProducts.length);
      initPriceListDropdown();
      updateAdminStatus();
      
      // Initialize navigation
      initNavigation();
      
      // Initialize real-time synchronization
      initializeRealTimeSync();
    });
    
    // Navigation functionality
    function initNavigation() {
      // Set Price List Calculator as default active
      document.getElementById('price-calculator-module').classList.add('active');
      
      // Add click handlers for navigation buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // Handle both desktop and mobile button IDs
          let moduleId = this.id.replace('nav-', '').replace('-mobile', '') + '-module';
          switchModule(moduleId, this);
        });
      });
    }
    
    function switchModule(moduleId, activeBtn) {
      // Hide all modules
      document.querySelectorAll('.module-content').forEach(module => {
        module.classList.remove('active');
      });
      
      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('nav-btn-active');
      });
      
      // Show selected module
      const targetModule = document.getElementById(moduleId);
      if (targetModule) {
        targetModule.classList.add('active');
      }
      
      // Add active class to both desktop and mobile buttons for the same module
      const baseId = activeBtn.id.replace('nav-', '').replace('-mobile', '');
      const desktopBtn = document.getElementById('nav-' + baseId);
      const mobileBtn = document.getElementById('nav-' + baseId + '-mobile');
      
      if (desktopBtn) desktopBtn.classList.add('nav-btn-active');
      if (mobileBtn) mobileBtn.classList.add('nav-btn-active');
      
      // Initialize Quote Maker if switching to it
      if (moduleId === 'quote-maker-module') {
        initQuoteMaker();
      }
      
      // Initialize Product Catalog if switching to it
      if (moduleId === 'product-catalog-module') {
        initProductCatalog();
      }
    }
    
    // Quote Maker Functionality
    let quoteItems = [];
    let quoteCounter = 1;
    let quoteMakerInitialized = false;

    function initQuoteMaker() {
      if (quoteMakerInitialized) return;
      
      // Set default date
      const today = new Date().toISOString().split('T')[0];
      const quoteDateInput = document.getElementById('quote-date');
      if (quoteDateInput) {
        quoteDateInput.value = today;
      }

      // Generate quote number
      generateQuoteNumber();

      // Initialize dropdowns with product data
      populateQuoteDropdowns();

      // Add event listeners
      const addItemBtn = document.getElementById('add-item-btn');
      if (addItemBtn) {
        addItemBtn.addEventListener('click', addQuoteItem);
      }

      const saveQuoteBtn = document.getElementById('save-quote-btn');
      if (saveQuoteBtn) {
        saveQuoteBtn.addEventListener('click', saveQuote);
      }

      const q2oBtn = document.getElementById('q2o-btn');
      if (q2oBtn) {
        q2oBtn.addEventListener('click', convertToOrder);
      }
      
      quoteMakerInitialized = true;
    }

    function generateQuoteNumber() {
      const today = new Date();
      const dateStr = today.getFullYear().toString() + 
                     (today.getMonth() + 1).toString().padStart(2, '0') + 
                     today.getDate().toString().padStart(2, '0');
      const quoteNumber = `INV-${dateStr}-${quoteCounter.toString().padStart(3, '0')}`;
      
      const quoteNumberInput = document.getElementById('quote-number');
      if (quoteNumberInput) {
        quoteNumberInput.value = quoteNumber;
      }
    }

    function populateQuoteDropdowns() {
      // Populate categories from existing product data
      const categorySelect = document.getElementById('new-item-category');
      if (categorySelect && state.allProducts) {
        const categories = [...new Set(state.allProducts.map(p => p.Category).filter(c => c))];
        categorySelect.innerHTML = '<option value="">Select Category</option>';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });
        
        // Add category change listener
        categorySelect.addEventListener('change', updateQuoteDensityOptions);
      }
    }

    function updateQuoteDensityOptions() {
      const category = document.getElementById('new-item-category').value;
      const densitySelect = document.getElementById('new-item-density');
      const productSelect = document.getElementById('new-item-product');
      
      // Clear and disable dependent dropdowns
      densitySelect.innerHTML = '<option value="">Select Density</option>';
      productSelect.innerHTML = '<option value="">Select Product</option>';
      densitySelect.disabled = !category;
      productSelect.disabled = true;

      if (category && state.allProducts) {
        const densities = [...new Set(state.allProducts
          .filter(p => p.Category === category)
          .map(p => p.Density))]
          .filter(d => d);
        
        densities.forEach(density => {
          const option = document.createElement('option');
          option.value = density;
          option.textContent = density;
          densitySelect.appendChild(option);
        });

        densitySelect.addEventListener('change', updateQuoteProductOptions);
      }
    }

    function updateQuoteProductOptions() {
      const category = document.getElementById('new-item-category').value;
      const density = document.getElementById('new-item-density').value;
      const productSelect = document.getElementById('new-item-product');
      
      productSelect.innerHTML = '<option value="">Select Product</option>';
      productSelect.disabled = !density;

      if (category && density && state.allProducts) {
        const products = state.allProducts.filter(p => 
          p.Category === category && p.Density === density
        );
        
        products.forEach(product => {
          const option = document.createElement('option');
          option.value = product.Product;
          option.textContent = product.Product;
          option.dataset.price = product.Price || 0;
          option.dataset.weight = product.Weight || 0;
          productSelect.appendChild(option);
        });
      }
    }

    function addQuoteItem() {
      const category = document.getElementById('new-item-category').value;
      const density = document.getElementById('new-item-density').value;
      const productName = document.getElementById('new-item-product').value;
      const length = document.getElementById('new-item-length').value;
      const quantity = parseInt(document.getElementById('new-item-quantity').value) || 1;
      const overridePrice = parseFloat(document.getElementById('new-item-override-price').value);

      if (!category || !productName) {
        alert('Please select category and product');
        return;
      }

      const productSelect = document.getElementById('new-item-product');
      const selectedOption = productSelect.options[productSelect.selectedIndex];
      const basePrice = parseFloat(selectedOption.dataset.price) || 0;
      const weight = parseFloat(selectedOption.dataset.weight) || 0;
      const unitPrice = overridePrice || basePrice;

      const item = {
        id: Date.now(),
        category,
        density,
        product: productName,
        length: length || 'Standard',
        weight,
        quantity,
        unitPrice,
        lineTotal: unitPrice * quantity
      };

      quoteItems.push(item);
      renderQuoteItems();
      clearQuoteForm();
    }

    function renderQuoteItems() {
      const tbody = document.querySelector('#items-table tbody');
      if (!tbody) return;

      tbody.innerHTML = '';
      let totalWeight = 0;
      let subtotal = 0;

      quoteItems.forEach((item, index) => {
        const row = document.createElement('tr');
        const itemWeight = item.weight * item.quantity;
        totalWeight += itemWeight;
        subtotal += item.lineTotal;

        row.innerHTML = `
          <td class="p-2">${index + 1}</td>
          <td class="p-2">${item.product}</td>
          <td class="p-2">${item.density || '‚Äî'}</td>
          <td class="p-2">${item.length}</td>
          <td class="p-2">${itemWeight.toFixed(2)}g</td>
          <td class="p-2">${item.quantity}</td>
          <td class="p-2">${formatQuoteCurrency(item.unitPrice)}</td>
          <td class="p-2">${formatQuoteCurrency(item.lineTotal)}</td>
          <td class="p-2 no-print">
            <button onclick="removeQuoteItem(${index})" class="text-red-600 hover:text-red-800 text-sm px-2 py-1 rounded">Remove</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Update totals
      document.getElementById('grand-weight').textContent = `${totalWeight.toFixed(2)}g`;
      document.getElementById('subtotal').textContent = formatQuoteCurrency(subtotal);
      document.getElementById('discount').textContent = '‚Äî';
      document.getElementById('tax').textContent = '‚Äî';
      document.getElementById('shipping-total').textContent = '‚Äî';
      document.getElementById('grand-total-table').textContent = formatQuoteCurrency(subtotal);
    }

    function removeQuoteItem(index) {
      quoteItems.splice(index, 1);
      renderQuoteItems();
    }

    function clearQuoteForm() {
      document.getElementById('new-item-category').value = '';
      document.getElementById('new-item-density').value = '';
      document.getElementById('new-item-product').value = '';
      document.getElementById('new-item-length').value = '';
      document.getElementById('new-item-quantity').value = '1';
      document.getElementById('new-item-override-price').value = '';
      
      // Reset dependent dropdowns
      document.getElementById('new-item-density').disabled = true;
      document.getElementById('new-item-product').disabled = true;
    }

    function saveQuote() {
      const quoteData = {
        quoteNumber: document.getElementById('quote-number').value,
        date: document.getElementById('quote-date').value,
        clientName: document.getElementById('client-name').value,
        clientContact: document.getElementById('client-contact').value,
        salesman: document.getElementById('salesman-name').value,
        validDays: document.getElementById('valid-days').value,
        briefPreview: document.getElementById('brief-preview').value,
        items: quoteItems,
        notes: document.getElementById('notes-terms').value
      };

      // Save to localStorage for now
      const savedQuotes = JSON.parse(localStorage.getItem('savedQuotes') || '[]');
      savedQuotes.push(quoteData);
      localStorage.setItem('savedQuotes', JSON.stringify(savedQuotes));
      
      alert('Quote saved successfully!');
      quoteCounter++;
      generateQuoteNumber();
    }

    function convertToOrder() {
      if (quoteItems.length === 0) {
        alert('Please add items to the quote first');
        return;
      }
      
      const confirmed = confirm('Convert this quote to an order? This will save the quote and mark it as an order.');
      if (confirmed) {
        saveQuote();
        alert('Quote converted to order successfully!');
      }
    }

    function formatQuoteCurrency(amount) {
      const currency = state.currency || 'INR';
      const symbols = {
        'INR': '‚Çπ',
        'USD': '$',
        'EUR': '‚Ç¨',
        'GBP': '¬£'
      };
      return `${symbols[currency] || '‚Çπ'}${amount.toFixed(2)}`;
    }

    // Product Catalog Functions
    function initProductCatalog() {
      loadProductCatalog();
      setupCatalogEventListeners();
    }

    // Define comprehensive product catalog with proper image mapping
    const productCatalog = {
  "DIY": {
    "image": "default.png",
    "description": "DIY products",
    "variants": [
      "Double Drawn"
    ]
  }
};

    function populateCatalogFilters() {
      const categorySelect = document.getElementById('catalog-category');
      
      // Clear existing options
      categorySelect.innerHTML = '<option value="">All Categories</option>';
      
      // Add categories from product catalog
      Object.keys(productCatalog).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });
    }

    function loadProductCatalog(filters = {}) {
      populateCatalogFilters();
      
      // Get UI elements
      const productsGrid = document.getElementById('catalog-products-grid');
      const resultsCount = document.getElementById('catalog-results-count');
      const resultsCountDisplay = document.getElementById('catalog-results-count-display');
      const loadingElement = document.getElementById('catalog-loading');
      const emptyElement = document.getElementById('catalog-empty');
      
      // Show loading state
      if (loadingElement) {
        loadingElement.classList.remove('hidden');
        productsGrid.classList.add('hidden');
        if (emptyElement) emptyElement.classList.add('hidden');
      }
      
      // Simulate loading delay for better UX
      setTimeout(() => {
        // Get all products from catalog
        let products = Object.entries(productCatalog);
        
        // Apply filters
        if (filters.category) {
          products = products.filter(([category]) => category === filters.category);
        }
        
        if (filters.search) {
          const searchTerm = filters.search.toLowerCase();
          products = products.filter(([category, data]) => 
            category.toLowerCase().includes(searchTerm) ||
            data.description.toLowerCase().includes(searchTerm)
          );
        }
        
        // Update results count
        const countText = `${products.length} product${products.length !== 1 ? 's' : ''} found`;
        if (resultsCount) resultsCount.textContent = countText;
        if (resultsCountDisplay) resultsCountDisplay.textContent = countText;
        
        // Hide loading state
        if (loadingElement) loadingElement.classList.add('hidden');
        
        // Handle empty results
        if (products.length === 0) {
          if (emptyElement) {
            emptyElement.classList.remove('hidden');
            productsGrid.classList.add('hidden');
          } else {
            productsGrid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No products match your filters.</div>';
            productsGrid.classList.remove('hidden');
          }
          return;
        }
        
        // Show products grid
         productsGrid.classList.remove('hidden');
         if (emptyElement) emptyElement.classList.add('hidden');
       
         productsGrid.innerHTML = products.map(([category, data]) => {
        const imagePath = `/images/Products/${data.image}`;
        
        return `
          <div class="bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-all duration-300 overflow-hidden group cursor-pointer" 
               onclick="showProductDetails('${category}')">
            <!-- Product Image -->
            <div class="aspect-square bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center overflow-hidden relative">
              <img src="${imagePath}" 
                   alt="${category}" 
                   class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                   onerror="this.src='/images/template.png'; this.onerror=null;"
                   loading="lazy">
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all duration-300"></div>
            </div>
            
            <!-- Product Details -->
            <div class="p-4">
              <h4 class="font-bold text-gray-800 mb-2 text-base leading-tight group-hover:text-blue-600 transition-colors duration-200">${category}</h4>
              <p class="text-sm text-gray-600 mb-3 line-clamp-2">${data.description}</p>
              
              <!-- Variants Preview -->
              <div class="mb-3">
                <div class="text-xs font-medium text-gray-500 mb-1">Available Options:</div>
                <div class="flex flex-wrap gap-1">
                  ${data.variants.slice(0, 3).map(variant => 
                    `<span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-full">${variant}</span>`
                  ).join('')}
                  ${data.variants.length > 3 ? `<span class="text-xs text-gray-500">+${data.variants.length - 3} more</span>` : ''}
                </div>
              </div>
              
              <!-- Action Button -->
              <button class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-all duration-200 transform group-hover:scale-105">
                View Details
              </button>
            </div>
          </div>
        `;
        }).join('');
      }, 300); // Close setTimeout
    }

    function setupCatalogEventListeners() {
      const filterBtn = document.getElementById('catalog-filter-btn');
      const clearBtn = document.getElementById('catalog-clear-btn');
      const searchInput = document.getElementById('catalog-search');
      const gridViewBtn = document.getElementById('catalog-grid-view');
      const listViewBtn = document.getElementById('catalog-list-view');

      filterBtn.addEventListener('click', applyCatalogFilters);
      clearBtn.addEventListener('click', clearCatalogFilters);
      
      // Grid/List view toggle
      if (gridViewBtn) {
        gridViewBtn.addEventListener('click', () => {
          const productsGrid = document.getElementById('catalog-products-grid');
          productsGrid.className = productsGrid.className.replace(/grid-cols-\d+/, 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4');
          gridViewBtn.classList.add('bg-blue-500', 'text-white');
          gridViewBtn.classList.remove('bg-gray-100', 'text-gray-600');
          if (listViewBtn) {
            listViewBtn.classList.remove('bg-blue-500', 'text-white');
            listViewBtn.classList.add('bg-gray-100', 'text-gray-600');
          }
        });
      }
      
      if (listViewBtn) {
        listViewBtn.addEventListener('click', () => {
          const productsGrid = document.getElementById('catalog-products-grid');
          productsGrid.className = productsGrid.className.replace(/grid-cols-\d+/, 'grid-cols-1');
          listViewBtn.classList.add('bg-blue-500', 'text-white');
          listViewBtn.classList.remove('bg-gray-100', 'text-gray-600');
          if (gridViewBtn) {
            gridViewBtn.classList.remove('bg-blue-500', 'text-white');
            gridViewBtn.classList.add('bg-gray-100', 'text-gray-600');
          }
        });
      }
      
      // Search on Enter key and real-time search
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          applyCatalogFilters();
        }
      });
      
      // Real-time search with debounce
      let searchTimeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          applyCatalogFilters();
        }, 300);
      });
      
      // Category filter change
      document.getElementById('catalog-category').addEventListener('change', applyCatalogFilters);
      
      // Event delegation for View Details buttons
      document.addEventListener('click', (e) => {
        if (e.target.textContent === 'View Details' && e.target.closest('.group')) {
          const productCard = e.target.closest('.group');
          const categoryElement = productCard.querySelector('h3');
          if (categoryElement) {
            const category = categoryElement.textContent.trim();
            showProductDetails(category);
          }
        }
      });
    }

    function applyCatalogFilters() {
      const filters = {
        category: document.getElementById('catalog-category').value,
        search: document.getElementById('catalog-search').value
      };
      loadProductCatalog(filters);
    }

    function clearCatalogFilters() {
      document.getElementById('catalog-category').value = '';
      document.getElementById('catalog-search').value = '';
      loadProductCatalog();
    }
    
    function showProductDetails(category) {
      const product = productCatalog[category];
      if (!product) return;
      
      // Create modal for product details
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center">
            <h2 class="text-2xl font-bold text-gray-800">${category}</h2>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
          
          <div class="p-6">
            <div class="grid md:grid-cols-2 gap-6">
              <!-- Product Image -->
              <div class="aspect-square bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg overflow-hidden">
                <img src="/images/Products/${product.image}" 
                     alt="${category}" 
                     class="w-full h-full object-cover"
                     onerror="this.src='/images/template.png'; this.onerror=null;">
              </div>
              
              <!-- Product Info -->
              <div>
                <h3 class="text-xl font-semibold text-gray-800 mb-4">${category}</h3>
                <p class="text-gray-600 mb-6">${product.description}</p>
                
                <div class="mb-6">
                  <h4 class="font-semibold text-gray-800 mb-3">Available Options:</h4>
                  <div class="grid grid-cols-2 gap-2">
                    ${product.variants.map(variant => 
                      `<div class="bg-blue-50 text-blue-700 px-3 py-2 rounded-lg text-sm font-medium text-center">${variant}</div>`
                    ).join('')}
                  </div>
                </div>
                
                <div class="space-y-3">
                  <button onclick="addToQuote('${category}')" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200">
                    Add to Quote
                  </button>
                  <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all duration-200">
                    Close
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close modal on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }
    
    function addToQuote(category) {
      // Switch to quote maker module
      showModule('quote-maker-module');
      
      // Set the category in the quote maker
      const categorySelect = document.getElementById('new-item-category');
      if (categorySelect) {
        // Add option if it doesn't exist
        let optionExists = false;
        for (let option of categorySelect.options) {
          if (option.value === category) {
            optionExists = true;
            break;
          }
        }
        
        if (!optionExists) {
          const newOption = document.createElement('option');
          newOption.value = category;
          newOption.textContent = category;
          categorySelect.appendChild(newOption);
        }
        
        categorySelect.value = category;
        
        // Trigger change event to update dependent fields
        categorySelect.dispatchEvent(new Event('change'));
      }
      
      // Close the modal
      const modal = document.querySelector('.fixed.inset-0');
      if (modal) modal.remove();
      
      // Show success message
      const message = document.createElement('div');
      message.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
      message.textContent = `${category} added to quote maker`;
      document.body.appendChild(message);
      
      setTimeout(() => {
        message.remove();
      }, 3000);
    }
  </script>
</body>
</html>
